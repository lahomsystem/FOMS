{% extends "layout.html" %}

{% block title %}수납장 대시보드{% endblock %}

{% block head %}
{{ super() }}
<style>
    .storage-row { background-color: rgba(108,117,125,0.03) !important; border-left: 3px solid #6c757d; }
    .storage-row:hover { background-color: rgba(108,117,125,0.08) !important; }
    .header-received { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%) !important; color: white !important; }
    .header-inprod { background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%) !important; color: white !important; }
    .header-shipped { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important; color: white !important; }
    .summary-card { border-left: 4px solid transparent; }
    .summary-received { border-left-color: #1976d2; }
    .summary-inprod { border-left-color: #f57c00; }
    .summary-shipped { border-left-color: #17a2b8; }
    .border-left-received { border-left: 4px solid #1976d2; }
    .border-left-inprod { border-left: 4px solid #f57c00; }
    .border-left-shipped { border-left: 4px solid #17a2b8; }
    .status-dropdown { width: 100px !important; font-size: 0.8rem !important; color: #fff !important; font-weight: 600; }
    .status-dropdown option { color: #000; }
    .status-received { background-color: #1976d2 !important; border-color: #1565c0; }
    .status-inprod { background-color: #f57c00 !important; border-color: #ef6c00; }
    .status-shipped { background-color: #17a2b8 !important; border-color: #138496; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid storage-dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-box-archive text-secondary"></i> 수납장 대시보드</h1>
        <a href="{{ url_for('order_pages.add_order') }}" class="btn btn-secondary">
            <i class="fas fa-plus"></i> 새 수납장 주문 추가
        </a>
    </div>

    <!-- 검색 폼 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="get" action="{{ url_for('storage_dashboard.storage_dashboard') }}" class="d-flex">
                        <input type="text" name="search_query" class="form-control me-2" placeholder="주문번호, 고객명, 연락처, 주소, 제품 등 통합 검색" value="{{ search_query or '' }}">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> 검색</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 접수 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-received">
                <div class="card-header py-3 d-flex justify-content-between align-items-center header-received">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-inbox me-2"></i>접수 ({{ received_orders|length }}건)</h6>
                    <a href="/?is_cabinet=true" class="btn btn-sm btn-light"><i class="fas fa-list"></i> 목록으로</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">번호</th>
                                    <th style="width: 120px;">메모</th>
                                    <th style="width: 120px;">고객명</th>
                                    <th style="width: 200px;">주소</th>
                                    <th style="width: 200px;">제품</th>
                                    <th style="width: 120px;">상태</th>
                                    <th style="width: 120px;">설치 예정일</th>
                                    <th style="width: 80px;">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in received_orders %}
                                <tr data-order-id="{{ order.id }}" class="storage-row">
                                    <td>{{ order.id }}</td>
                                    <td>
                                        <textarea class="form-control form-control-sm auto-resize-textarea"
                                                  rows="1" style="font-size: 14px; min-height: 32px; resize: none; overflow: hidden;"
                                                  data-order-id="{{ order.id }}" data-field="regional_memo">{{ order.regional_memo or '' }}</textarea>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div>{{ order.customer_name }}</div>
                                            {% if order.blueprint_image_url %}
                                            <button class="btn btn-sm btn-outline-info" onclick="openBlueprintViewer({{ order.id }})" title="도면 보기">
                                                <i class="fas fa-drafting-compass"></i> 도면
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-truncate" style="max-width: 200px;" title="{{ order.address }}">{{ order.address }}</td>
                                    <td class="text-truncate" style="max-width: 150px;" title="{{ order.product }}">{{ order.product }}</td>
                                    <td>
                                        <select class="form-select form-select-sm inline-edit status-dropdown {{ 'status-received' if (order.cabinet_status or 'RECEIVED') == 'RECEIVED' else ('status-inprod' if order.cabinet_status == 'IN_PRODUCTION' else 'status-shipped') }}"
                                                data-order-id="{{ order.id }}" data-field="cabinet_status">
                                            {% for code, name in CABINET_STATUS.items() %}
                                                <option value="{{ code }}" {% if (order.cabinet_status or 'RECEIVED') == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="date" class="form-control form-control-sm inline-edit-date"
                                               value="{{ order.scheduled_date if order.scheduled_date else '' }}"
                                               data-order-id="{{ order.id }}" data-field="scheduled_date">
                                    </td>
                                    <td>
                                        <a href="{{ url_for('order_edit.edit_order', order_id=order.id, return_to='storage_dashboard') }}" class="btn btn-sm btn-outline-primary" title="수정">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if not received_orders %}
                    <div class="text-center py-4"><i class="fas fa-inbox text-muted fa-3x mb-3"></i><h5 class="text-muted">접수된 수납장 주문이 없습니다.</h5></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 제작중 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-inprod">
                <div class="card-header py-3 d-flex justify-content-between align-items-center header-inprod">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-industry me-2"></i>제작중 ({{ in_production_orders|length }}건)</h6>
                    <div class="d-flex gap-2">
                        <a href="/api/storage_dashboard/export_excel{% if search_query %}?search_query={{ search_query }}{% endif %}" 
                           class="btn btn-sm btn-light">
                            <i class="fas fa-file-excel me-1"></i> 엑셀 다운로드
                        </a>
                    <a href="/?is_cabinet=true" class="btn btn-sm btn-light"><i class="fas fa-list"></i> 목록으로</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">번호</th>
                                    <th style="width: 120px;">메모</th>
                                    <th style="width: 120px;">고객명</th>
                                    <th style="width: 130px;">전화번호</th>
                                    <th style="width: 200px;">주소</th>
                                    <th style="width: 200px;">제품</th>
                                    <th style="width: 100px;">배송비</th>
                                    <th style="width: 120px;">상태</th>
                                    <th style="width: 120px;">설치 예정일</th>
                                    <th style="width: 80px;">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in in_production_orders %}
                                <tr data-order-id="{{ order.id }}" class="storage-row">
                                    <td>{{ order.id }}</td>
                                    <td>
                                        <textarea class="form-control form-control-sm auto-resize-textarea"
                                                  rows="1" style="font-size: 14px; min-height: 32px; resize: none; overflow: hidden;"
                                                  data-order-id="{{ order.id }}" data-field="regional_memo">{{ order.regional_memo or '' }}</textarea>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div>{{ order.customer_name }}</div>
                                            {% if order.blueprint_image_url %}
                                            <button class="btn btn-sm btn-outline-info" onclick="openBlueprintViewer({{ order.id }})" title="도면 보기">
                                                <i class="fas fa-drafting-compass"></i> 도면
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>{{ order.phone }}</td>
                                    <td style="word-break: break-word; white-space: normal; max-width: 200px;">{{ order.address }}</td>
                                    <td style="word-break: break-word; white-space: normal; max-width: 200px;">{{ order.product }}</td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm inline-edit-number" 
                                               value="{{ '{:,}'.format(order.shipping_fee or 0) }}"
                                               data-order-id="{{ order.id }}" 
                                               data-field="shipping_fee"
                                               style="min-width: 90px; text-align: right;"
                                               placeholder="0">
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm inline-edit status-dropdown {{ 'status-received' if order.cabinet_status == 'RECEIVED' else ('status-inprod' if order.cabinet_status == 'IN_PRODUCTION' else 'status-shipped') }}"
                                                data-order-id="{{ order.id }}" data-field="cabinet_status">
                                            {% for code, name in CABINET_STATUS.items() %}
                                                <option value="{{ code }}" {% if order.cabinet_status == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="date" class="form-control form-control-sm inline-edit-date"
                                               value="{{ order.scheduled_date if order.scheduled_date else '' }}"
                                               data-order-id="{{ order.id }}" data-field="scheduled_date">
                                    </td>
                                    <td>
                                        <a href="{{ url_for('order_edit.edit_order', order_id=order.id, return_to='storage_dashboard') }}" class="btn btn-sm btn-outline-primary" title="수정">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if not in_production_orders %}
                    <div class="text-center py-4"><i class="fas fa-industry text-muted fa-3x mb-3"></i><h5 class="text-muted">제작중 수납장 주문이 없습니다.</h5></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 발송 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow border-left-shipped">
                <div class="card-header py-3 d-flex justify-content-between align-items-center header-shipped">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-truck me-2"></i>발송 ({{ shipped_orders|length }}건)</h6>
                    <a href="/?is_cabinet=true" class="btn btn-sm btn-light"><i class="fas fa-list"></i> 목록으로</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">번호</th>
                                    <th style="width: 120px;">메모</th>
                                    <th style="width: 120px;">고객명</th>
                                    <th style="width: 200px;">주소</th>
                                    <th style="width: 200px;">제품</th>
                                    <th style="width: 120px;">상태</th>
                                    <th style="width: 120px;">설치 예정일</th>
                                    <th style="width: 80px;">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in shipped_orders %}
                                <tr data-order-id="{{ order.id }}" class="storage-row">
                                    <td>{{ order.id }}</td>
                                    <td>
                                        <textarea class="form-control form-control-sm auto-resize-textarea"
                                                  rows="1" style="font-size: 14px; min-height: 32px; resize: none; overflow: hidden;"
                                                  data-order-id="{{ order.id }}" data-field="regional_memo">{{ order.regional_memo or '' }}</textarea>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div>{{ order.customer_name }}</div>
                                            {% if order.blueprint_image_url %}
                                            <button class="btn btn-sm btn-outline-info" onclick="openBlueprintViewer({{ order.id }})" title="도면 보기">
                                                <i class="fas fa-drafting-compass"></i> 도면
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-truncate" style="max-width: 200px;" title="{{ order.address }}">{{ order.address }}</td>
                                    <td class="text-truncate" style="max-width: 150px;" title="{{ order.product }}">{{ order.product }}</td>
                                    <td>
                                        <select class="form-select form-select-sm inline-edit status-dropdown {{ 'status-received' if order.cabinet_status == 'RECEIVED' else ('status-inprod' if order.cabinet_status == 'IN_PRODUCTION' else 'status-shipped') }}"
                                                data-order-id="{{ order.id }}" data-field="cabinet_status">
                                            {% for code, name in CABINET_STATUS.items() %}
                                                <option value="{{ code }}" {% if order.cabinet_status == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="date" class="form-control form-control-sm inline-edit-date"
                                               value="{{ order.scheduled_date if order.scheduled_date else '' }}"
                                               data-order-id="{{ order.id }}" data-field="scheduled_date">
                                    </td>
                                    <td>
                                        <a href="{{ url_for('order_edit.edit_order', order_id=order.id, return_to='storage_dashboard') }}" class="btn btn-sm btn-outline-primary" title="수정">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if not shipped_orders %}
                    <div class="text-center py-4"><i class="fas fa-truck text-muted fa-3x mb-3"></i><h5 class="text-muted">발송된 수납장 주문이 없습니다.</h5></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 인라인 편집 공통 함수 재사용 (self_measurement_dashboard와 동일한 패턴)
document.addEventListener('DOMContentLoaded', function() {
    function saveField(orderId, field, value) {
        return fetch('/api/update_order_field', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId, field_name: field, new_value: value })
        }).then(r => r.json()).then(data => { if (!data.success) alert('오류: ' + data.message); return data; });
    }

    document.querySelectorAll('.auto-resize-textarea').forEach(function(textarea) {
        function adjustHeight(el){ el.style.height='auto'; el.style.height=Math.max(32, el.scrollHeight)+'px'; }
        adjustHeight(textarea);
        textarea.addEventListener('input', function(){ adjustHeight(this); });
        textarea.addEventListener('blur', function(){ saveField(this.dataset.orderId, this.dataset.field, this.value); });
    });

    document.querySelectorAll('.inline-edit-date').forEach(function(input) {
        input.addEventListener('change', function() {
            saveField(this.dataset.orderId, this.dataset.field, this.value);
        });
    });

    // 배송비 숫자 입력 필드 인라인 편집 (콤마 포맷팅 포함)
    document.querySelectorAll('.inline-edit-number').forEach(function(input) {
        // 숫자에 콤마 추가하는 함수
        function formatNumberWithComma(value) {
            // 숫자가 아닌 문자 제거
            const numValue = value.toString().replace(/[^0-9]/g, '');
            if (!numValue) return '0';
            // 콤마 추가
            return parseInt(numValue, 10).toLocaleString('ko-KR');
        }
        
        // 콤마 제거하는 함수
        function removeComma(value) {
            return value.toString().replace(/,/g, '');
        }
        
        // 입력 시 실시간 포맷팅
        input.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const newValue = formatNumberWithComma(this.value);
            
            this.value = newValue;
            
            // 커서 위치 조정 (콤마 추가로 인한 위치 변화 보정)
            const addedCommas = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
            const newCursorPosition = Math.max(0, cursorPosition + addedCommas);
            this.setSelectionRange(newCursorPosition, newCursorPosition);
        });
        
        // 포커스 아웃 시 저장
        input.addEventListener('blur', function() {
            const numValue = parseInt(removeComma(this.value)) || 0;
            this.value = formatNumberWithComma(numValue); // 저장 후 포맷팅 유지
            saveField(this.dataset.orderId, this.dataset.field, numValue);
        });
        
        // 엔터키로도 저장 가능
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.blur();
            }
        });
    });

    // 드롭다운 색상 클래스 유틸
    function setStatusClass(selectEl){
        if (!selectEl) return;
        selectEl.classList.remove('status-received','status-inprod','status-shipped');
        const v = selectEl.value;
        if (v === 'RECEIVED') selectEl.classList.add('status-received');
        else if (v === 'IN_PRODUCTION') selectEl.classList.add('status-inprod');
        else if (v === 'SHIPPED') selectEl.classList.add('status-shipped');
    }

    // 초기 색상 반영
    document.querySelectorAll('select.status-dropdown').forEach(setStatusClass);

    // 상태 변경 델리게이션: 저장 + 즉시 DOM 이동 + 색상 갱신
    document.addEventListener('change', function(e){
        const target = e.target;
        if (!target.matches('select.status-dropdown')) return;
        const orderId = target.dataset.orderId;
        const field = target.dataset.field;
        const value = target.value;
        saveField(orderId, field, value).then(function(data){
            // 저장 성공 시 약간의 지연 후 최신 데이터 보장을 위해 새로고침
            if (data && data.success) {
                setTimeout(function(){ location.reload(); }, 400);
            }
        });
        setStatusClass(target);

        // 행을 해당 섹션 테이블로 이동
        const row = target.closest('tr');
        if (!row) return;
        let targetTbody = null;
        if (value === 'RECEIVED') {
            targetTbody = document.querySelector('.header-received').closest('.card').querySelector('tbody');
        } else if (value === 'IN_PRODUCTION') {
            targetTbody = document.querySelector('.header-inprod').closest('.card').querySelector('tbody');
        } else if (value === 'SHIPPED') {
            targetTbody = document.querySelector('.header-shipped').closest('.card').querySelector('tbody');
        }
        if (targetTbody) {
            const sourceTbody = row.parentElement;
            row.parentElement.removeChild(row);
            targetTbody.appendChild(row);

            // 카운트 갱신
            function updateCount(headerSelector){
                const card = document.querySelector(headerSelector).closest('.card');
                const count = card.querySelectorAll('tbody tr').length;
                const title = card.querySelector('h6');
                if (title) {
                    const txt = title.innerText.replace(/\(.*?건\)/, '');
                    title.innerText = txt.trim() + ` (${count}건)`;
                }
            }
            updateCount('.header-received');
            updateCount('.header-inprod');
            updateCount('.header-shipped');
        }
    });
});
</script>
{% endblock %}


