function renderMessages(messages) {
    const container = document.getElementById('messages-container');
    container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
}

// 메시지 렌더링
function renderMessage(msg) {
    const isOwn = msg.user_id == currentUserId;
    const className = isOwn ? 'own' : 'other';
    const userName = msg.user_name || '알 수 없음';
    
    let content = '';
    if (msg.message_type === 'text') {
        content = escapeHtml(msg.content || '');
    } else if (msg.attachments && msg.attachments.length > 0) {
        // 이미지 첨부파일 필터링
        const imageAttachments = msg.attachments.filter(a => a.file_type === 'image');
        const hasMultipleImages = imageAttachments.length > 1;
        
        if (imageAttachments.length > 0) {
            // 이미지들 렌더링 (다운로드 아이콘 포함)
            const imageHtml = imageAttachments.map((attachment, index) => {
                const imageUrl = attachment.url || attachment.storage_url;
                const storageKey = attachment.storage_key || '';
                const filename = attachment.filename || `image_${index + 1}.jpg`;
                
                return `
                    <div class="message-file-image-wrapper">
                        <img src="${attachment.thumbnail_url || imageUrl}" 
                             onclick="openImageLightbox('${imageUrl}')" 
                             style="cursor: zoom-in; max-width: 300px; border-radius: 8px; background-color: white; padding: 4px; display: block;">
                        <button class="chat-image-download-btn" 
                                onclick="downloadChatImage('${storageKey}', '${escapeHtml(filename)}', event)"
                                title="다운로드">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // 여러 이미지가 있으면 "전체 다운로드" 버튼 추가
            const downloadAllBtn = hasMultipleImages ? `
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="downloadAllChatImages(${msg.id}, event)"
                            title="모든 이미지 다운로드">
                        <i class="fas fa-download"></i> 전체 다운로드 (${imageAttachments.length}개)
                    </button>
                </div>
            ` : '';
            
            content = `<div class="message-file">${imageHtml}${downloadAllBtn}</div>`;
        } else {
            // 이미지가 아닌 첨부파일 처리
            const attachment = msg.attachments[0];
            if (attachment.file_type === 'video') {
                const videoUrl = attachment.url || attachment.storage_url;
                const storageKey = attachment.storage_key || '';
                const filename = attachment.filename || 'video.mp4';
                
                content = `
                    <div class="message-file" style="position: relative; display: inline-block;">
                        <video controls style="max-width: 300px;">
                            <source src="${videoUrl}">
                        </video>
                        <button class="chat-image-download-btn" 
                                onclick="downloadChatImage('${storageKey}', '${escapeHtml(filename)}', event)"
                                title="다운로드">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            } else {
                const fileUrl = attachment.url || attachment.storage_url;
                content = `<a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-download"></i> ${escapeHtml(attachment.filename)}
                           </a>`;
            }
        }
    }
    
    // 읽음 표시 (채널톡 스타일 - 실제 읽음 상태 확인)
    let readReceipt = '';
    if (isOwn && msg.read_status) {
        if (msg.read_status === 'no_other_members') {
            // 다른 멤버가 없으면 표시하지 않음
            readReceipt = '';
        } else if (msg.read_status === 'unread') {
            // 아직 아무도 읽지 않음
            readReceipt = '<div class="read-receipt" style="color: #999;"><i class="fas fa-check"></i> 전송됨</div>';
        } else if (msg.read_status === 'all_read') {
            // 모두 읽음
            readReceipt = '<div class="read-receipt"><i class="fas fa-check read-icon"></i> 읽음</div>';
        } else if (msg.read_status === 'some_read') {
            // 일부 읽음
            readReceipt = `<div class="read-receipt"><i class="fas fa-check read-icon"></i> ${msg.read_count}/${msg.total_other_members}명 읽음</div>`;
        }
    }
    
    return `
        <div class="message-item ${className}" data-message-id="${msg.id}">
            <div class="message-bubble">
                ${content}
            </div>
            <div class="message-meta">
                ${!isOwn ? userName + ' · ' : ''}${formatDateTime(msg.created_at)}
            </div>
            ${readReceipt}
        </div>
    `;
}

// 메시지 추가 (실시간)
function appendMessage(msg) {
    const container = document.getElementById('messages-container');
    
    // 중복 방지: 메시지 ID로 이미 존재하는지 확인
    if (msg.id) {
        const existingMessage = container.querySelector(`[data-message-id="${msg.id}"]`);
        if (existingMessage) {
            console.log('[appendMessage] 중복 메시지 스킵:', msg.id);
            return; // 이미 존재하는 메시지는 추가하지 않음
        }
    }
    
    // 메시지 추가
    container.innerHTML += renderMessage(msg);
}

// 메시지 전송
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!currentRoomId) {
        alert('채팅방을 선택하세요');
        return;
    }
    
    if (!message && !previewFile) {
        return;
    }
    
    const messageData = {
        room_id: currentRoomId,
        message_type: previewFile ? previewFile.type : 'text',
        content: message,
        file_info: previewFile ? previewFile.info : null
    };
    
    // Socket.IO가 연결되어 있으면 사용, 아니면 REST API로 전송
    if (socket && socket.connected) {
        socket.emit('send_message', messageData);
    } else {
        // REST API로 메시지 전송 (폴백)
        fetch('/api/chat/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(messageData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 메시지 목록 새로고침
                loadRoomDetail(currentRoomId);
            } else {
                alert('메시지 전송 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('메시지 전송 오류:', error);
            alert('메시지 전송 중 오류가 발생했습니다.');
        });
    }
    
    // 입력 필드 초기화
    input.value = '';
    removePreview();
}

// 파일 미리보기
