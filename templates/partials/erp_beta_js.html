// ============================================================
// ERP Beta JS (shared): edit_order + add_order
//
// Required globals:
// - ERP_BETA_ENABLED (boolean)
// - ORDER_ID (number; in add_order should be "let", in edit_order can be const)
// - window.__ERP_BETA_DRAFT_MODE (boolean): true on add_order, false on edit_order
// - window.__ERP_BETA_DRAFT_ENDPOINT (string): optional, default '/api/orders/erp-beta/draft'
// ============================================================

// helpers (define only if missing to avoid collisions)
if (typeof escapeHtml !== 'function') {
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
}

if (typeof formatPhoneAuto !== 'function') {
    function formatPhoneAuto(value) {
        const digits = String(value || '').replace(/[^0-9]/g, '');
        if (digits.length === 11) return `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7,11)}`;
        if (digits.length === 10) return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6,10)}`;
        return value || '';
    }
}

if (typeof adjustTextareaHeight !== 'function') {
    function adjustTextareaHeight(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }
}

function erpGetDraftEndpoint() {
    return window.__ERP_BETA_DRAFT_ENDPOINT || '/api/orders/erp-beta/draft';
}

function erpSetDraftBanner(orderId) {
    const banner = document.getElementById('erp-draft-banner');
    const idEl = document.getElementById('erp-draft-order-id');
    const link = document.getElementById('erp-draft-edit-link');
    if (idEl) idEl.textContent = String(orderId || '-');
    if (link && orderId) {
        link.href = `/edit/${orderId}`;
        link.style.display = '';
    }
    if (banner) banner.style.display = orderId ? '' : 'none';
}

function erpSetOrderId(newId) {
    try {
        const oldOrderId = ORDER_ID;
        // add_order에서는 let ORDER_ID 이므로 갱신 가능
        // edit_order에서는 draft mode가 아니므로 호출되지 않음
        ORDER_ID = parseInt(String(newId || '0'), 10) || 0;
        
        // 주문 ID가 변경될 때 파일 input 초기화 (이전 주문의 파일이 남아있지 않도록)
        if (oldOrderId !== ORDER_ID) {
            const fileInput = document.getElementById('erp-attachments-input');
            if (fileInput) {
                fileInput.value = '';
            }
        }
    } catch (e) {}

    // data attr 동기화(선택)
    const host = document.querySelector('.card[data-erp-order-id]') || document.querySelector('[data-erp-order-id]');
    if (host) {
        host.setAttribute('data-erp-order-id', String(ORDER_ID));
    }
    erpSetDraftBanner(ORDER_ID);
}

async function erpEnsureDraftOrderId() {
    if (!ERP_BETA_ENABLED) return 0;
    if (!window.__ERP_BETA_DRAFT_MODE) return ORDER_ID || 0;
    if (ORDER_ID && ORDER_ID > 0) return ORDER_ID;

    // idempotent draft 생성: 서버가 세션 기반으로 재사용
    const res = await fetch(erpGetDraftEndpoint(), { method: 'POST' });
    const data = await res.json();
    if (!data || !data.success) {
        throw new Error((data && data.message) ? data.message : `Draft 생성 실패 (HTTP ${res.status})`);
    }
    erpSetOrderId(data.order_id);
    return ORDER_ID;
}

async function erpRequireOrderIdOrWarn(contextText='') {
    try {
        const id = await erpEnsureDraftOrderId();
        if (!id) {
            erpSetStatus(`${contextText} 주문번호 생성 실패`, true);
            return 0;
        }
        return id;
    } catch (e) {
        console.error(e);
        erpSetStatus(`${contextText} ${String(e?.message || e)}`, true);
        return 0;
    }
}

// ============================================
// ERP Beta Panel (TEST) - core
// ============================================
function erpSetStatus(text, isError=false) {
    const el = document.getElementById('erp-status-text');
    if (!el) return;
    el.textContent = text || '';
    el.style.color = isError ? '#b02a37' : '#6c757d';
}

function erpFormatMoneyKRW(num) {
    const n = Number(num);
    if (!Number.isFinite(n)) return '0원';
    return `${Math.round(n).toLocaleString('ko-KR')}원`;
}

function erpRecalcItemsTotal() {
    const itemsWrap = document.getElementById('erp-items');
    const totalEl = document.getElementById('erp-items-total');
    if (!itemsWrap || !totalEl) return;
    let sum = 0;
    itemsWrap.querySelectorAll('[data-erp="price"]').forEach(inp => {
        const digits = String(inp.value || '').replace(/[^0-9]/g, '');
        if (digits) sum += parseInt(digits, 10);
    });
    totalEl.textContent = erpFormatMoneyKRW(sum);
}

function erpNewItemRow(item = {}) {
    const row = document.createElement('div');
    row.className = 'border rounded p-2 mb-2';

    const defaultConsult = (v) => {
        const s = String(v ?? '').trim();
        return s ? s : '상담';
    };

    const productName = String(item.product_name || '').trim();
    // 규격을 W, D, H로 분리 (기존 spec 필드에서 파싱 또는 별도 필드 사용)
    let specWidth = String(item.spec_width || '').trim();
    let specDepth = String(item.spec_depth || '').trim();
    let specHeight = String(item.spec_height || '').trim();
    // 기존 spec 필드가 있고 W, D, H가 없으면 파싱 시도 (예: "800x600x2000" 또는 "800*600*2000")
    if (!specWidth && !specDepth && !specHeight && item.spec) {
      const specStr = String(item.spec || '').trim();
      const parts = specStr.split(/[xX*×]/).map(s => s.trim());
      if (parts.length >= 3) {
        specWidth = parts[0];
        specDepth = parts[1];
        specHeight = parts[2];
      } else if (parts.length === 2) {
        specWidth = parts[0];
        specDepth = parts[1];
      } else if (parts.length === 1) {
        specWidth = parts[0];
      }
    }
    const internal = defaultConsult(item.internal);
    const color = defaultConsult(item.color);
    const optionDetail = defaultConsult(item.option_detail);
    const handle = defaultConsult(item.handle);
    const misc = defaultConsult(item.misc);
    const price = String(item.price ?? '').trim();
    const extraInput = String(item.extra_input ?? '').trim();

    row.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold small">항목</div>
            <button type="button" class="btn btn-sm btn-outline-danger erp-remove-item-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="row g-2">
            <div class="col-12">
                <label class="form-label mb-1 small text-primary">제품명</label>
                <input class="form-control form-control-sm" data-erp="product_name" value="${escapeHtml(productName)}">
            </div>
            <div class="col-md-3">
                <label class="form-label mb-1 small text-primary">규격 W(폭)</label>
                <input class="form-control form-control-sm" data-erp="spec_width" placeholder="폭" value="${escapeHtml(specWidth)}">
            </div>
            <div class="col-md-3">
                <label class="form-label mb-1 small text-primary">규격 D(깊이)</label>
                <input class="form-control form-control-sm" data-erp="spec_depth" placeholder="깊이" value="${escapeHtml(specDepth)}">
            </div>
            <div class="col-md-3">
                <label class="form-label mb-1 small text-primary">규격 H(높이)</label>
                <input class="form-control form-control-sm" data-erp="spec_height" placeholder="높이" value="${escapeHtml(specHeight)}">
            </div>
            <div class="col-md-6">
                <label class="form-label mb-1 small text-primary">내부</label>
                <input class="form-control form-control-sm" data-erp="internal" value="${escapeHtml(internal)}">
            </div>
            <div class="col-md-6">
                <label class="form-label mb-1 small text-primary">색상</label>
                <input class="form-control form-control-sm" data-erp="color" value="${escapeHtml(color)}">
            </div>
            <div class="col-md-6">
                <label class="form-label mb-1 small text-primary">옵션</label>
                <input class="form-control form-control-sm" data-erp="option_detail" value="${escapeHtml(optionDetail)}">
            </div>
            <div class="col-md-6">
                <label class="form-label mb-1 small text-primary">손잡이</label>
                <input class="form-control form-control-sm" data-erp="handle" value="${escapeHtml(handle)}">
            </div>
            <div class="col-md-6">
                <label class="form-label mb-1 small text-primary">기타 / 설치위치</label>
                <input class="form-control form-control-sm" data-erp="misc" value="${escapeHtml(misc)}">
            </div>
            <div class="col-md-6">
                <label class="form-label mb-1 small text-primary">항목 금액(원)</label>
                <input class="form-control form-control-sm" data-erp="price" inputmode="numeric" value="${escapeHtml(price)}">
            </div>
            <div class="col-12">
                <label class="form-label mb-1 small text-primary">추가 입력</label>
                <textarea class="form-control form-control-sm" data-erp="extra_input" rows="3" placeholder="추가 내용을 입력하세요 (여러 줄 가능)">${escapeHtml(extraInput)}</textarea>
            </div>
        </div>
    `;

    row.querySelector('.erp-remove-item-btn')?.addEventListener('click', () => {
        row.remove();
        erpRecalcItemsTotal();
    });
    row.querySelectorAll('[data-erp]').forEach(inp => {
        inp.addEventListener('input', () => {
            erpRecalcItemsTotal();
        });
    });
    setTimeout(erpRecalcItemsTotal, 0);
    return row;
}

async function erpLoadStructured() {
    if (!ERP_BETA_ENABLED) return;
    if (!ORDER_ID) return;
    
    // 주문이 변경될 때 파일 input 초기화 (이전 주문의 파일이 남아있지 않도록)
    const fileInput = document.getElementById('erp-attachments-input');
    if (fileInput) {
        fileInput.value = '';
    }
    
    erpSetStatus('불러오는 중...');
    const res = await fetch(`/api/orders/${ORDER_ID}/structured`);
    const data = await res.json();
    if (!data.success) {
        erpSetStatus(data.message || '불러오기 실패', true);
        return;
    }

    const sd = data.structured_data || {};
    const receivedDateEl = document.getElementById('erp-received-date');
    const receivedTimeEl = document.getElementById('erp-received-time');
    if (receivedDateEl) receivedDateEl.value = data.received_date || '';
    if (receivedTimeEl) receivedTimeEl.value = data.received_time || '';
    document.getElementById('erp-customer-name').value = sd?.parties?.customer?.name || '';
    document.getElementById('erp-customer-phone').value = sd?.parties?.customer?.phone || '';
    try {
        const erpManualPhone = document.getElementById('erp-manual-phone-input');
        if (!erpManualPhone || !erpManualPhone.checked) {
            document.getElementById('erp-customer-phone').value = formatPhoneAuto(document.getElementById('erp-customer-phone').value);
        }
    } catch (e) {}
    document.getElementById('erp-phone-note').value = sd?.notes?.phone_note || '';
    document.getElementById('erp-orderer').value = sd?.parties?.orderer?.name || '';
    document.getElementById('erp-manager').value = sd?.parties?.manager?.name || '';
    document.getElementById('erp-workflow-stage').value = sd?.workflow?.stage || '';
    document.getElementById('erp-urgent-flag').checked = !!sd?.flags?.urgent;
    document.getElementById('erp-urgent-reason').value = sd?.flags?.urgent_reason || '';
    // 주소 로드: 주소+상세주소는 한 필드(erp-address)에 함께 표기
    const site = sd?.site || {};
    const addressFull = site.address_full || site.address_main || '';
    const addressDetail = site.address_detail || '';
    document.getElementById('erp-address').value = addressDetail ? `${addressFull} ${addressDetail}`.trim() : addressFull;
    document.getElementById('erp-address-note').value = sd?.notes?.address_note || '';
    document.getElementById('erp-measurement-date').value = sd?.schedule?.measurement?.date || '';
    const measurementTime = sd?.schedule?.measurement?.time || '';
    const erpMeasurementTimeSelect = document.getElementById('erp-measurement-time-select');
    const erpMeasurementTimeInput = document.getElementById('erp-measurement-time');
    if (erpMeasurementTimeSelect) {
        if (measurementTime === '오전' || measurementTime === '오후' || measurementTime === '종일') {
            erpMeasurementTimeSelect.value = measurementTime;
            if (erpMeasurementTimeInput) {
                erpMeasurementTimeInput.value = '';
                erpMeasurementTimeInput.style.display = 'none';
            }
        } else {
            erpMeasurementTimeSelect.value = '__direct__';
            if (erpMeasurementTimeInput) {
                erpMeasurementTimeInput.value = measurementTime || '';
                erpMeasurementTimeInput.style.display = 'block';
            }
        }
    }
    document.getElementById('erp-measurement-note').value = sd?.notes?.measurement_note || '';
    document.getElementById('erp-construction-date').value = sd?.schedule?.construction?.date || '';
    document.getElementById('erp-raw-text').value = data.raw_order_text || (sd?.raw?.text || '');

    const itemsWrap = document.getElementById('erp-items');
    itemsWrap.innerHTML = '';
    const items = Array.isArray(sd.items) ? sd.items : [];
    if (items.length === 0) {
        itemsWrap.appendChild(erpNewItemRow({}));
    } else {
        items.forEach(it => itemsWrap.appendChild(erpNewItemRow(it)));
    }

    erpSetStatus(`불러오기 완료 (confidence: ${data.structured_confidence || sd.confidence || '-'})`);
    erpRecalcItemsTotal();
    
    // 첨부파일도 함께 로드
    if (typeof erpLoadAttachments === 'function') {
        erpLoadAttachments();
    }
}

function erpCollectStructured() {
    const itemsWrap = document.getElementById('erp-items');
    const items = [];
    let itemsTotal = 0;
    itemsWrap.querySelectorAll('.border.rounded.p-2').forEach(row => {
        const obj = {};
        row.querySelectorAll('[data-erp]').forEach(inp => {
            obj[inp.dataset.erp] = inp.value;
        });
        // W, D, H를 spec 필드로 합성 (호환성을 위해)
        const w = String(obj.spec_width || '').trim();
        const d = String(obj.spec_depth || '').trim();
        const h = String(obj.spec_height || '').trim();
        if (w || d || h) {
            const specParts = [];
            if (w) specParts.push(w);
            if (d) specParts.push(d);
            if (h) specParts.push(h);
            obj.spec = specParts.join('x');
        } else if (obj.spec) {
            // 기존 spec 필드가 있으면 유지
        } else {
            obj.spec = '';
        }
        if (obj.price) {
            const digits = String(obj.price).replace(/[^0-9]/g, '');
            obj.price = digits ? parseInt(digits, 10) : obj.price;
            if (typeof obj.price === 'number' && Number.isFinite(obj.price)) {
                itemsTotal += obj.price;
            }
        }
        items.push(obj);
    });

    return {
        entity_type: 'order_structured',
        schema_version: 1,
        confidence: null,
        totals: { items_total: itemsTotal },
        parties: {
            customer: { name: document.getElementById('erp-customer-name').value, phone: document.getElementById('erp-customer-phone').value },
            orderer: { name: document.getElementById('erp-orderer').value },
            manager: { name: document.getElementById('erp-manager').value }
        },
        site: (function() {
            const full = (document.getElementById('erp-address').value || '').trim();
            return { address_main: full, address_detail: '', address_full: full };
        })(),
        schedule: {
            measurement: (function() {
                const timeSelect = document.getElementById('erp-measurement-time-select');
                const timeInput = document.getElementById('erp-measurement-time');
                let timeValue = '';
                if (timeSelect) {
                    if (timeSelect.value === '__direct__') {
                        timeValue = timeInput ? timeInput.value : '';
                    } else {
                        timeValue = timeSelect.value;
                    }
                }
                return { date: document.getElementById('erp-measurement-date').value, time: timeValue };
            })(),
            construction: { raw: '', date: document.getElementById('erp-construction-date').value }
        },
        notes: {
            phone_note: document.getElementById('erp-phone-note').value,
            address_note: document.getElementById('erp-address-note').value,
            measurement_note: document.getElementById('erp-measurement-note').value
        },
        workflow: { stage: document.getElementById('erp-workflow-stage').value },
        flags: { urgent: !!document.getElementById('erp-urgent-flag').checked, urgent_reason: document.getElementById('erp-urgent-reason').value },
        items
    };
}

async function erpSaveStructured() {
    if (!ERP_BETA_ENABLED) return;
    if (!ORDER_ID) {
        const ok = await erpRequireOrderIdOrWarn('저장:');
        if (!ok) return;
    }
    erpSetStatus('저장 중...');
    const structured_data = erpCollectStructured();
    const raw_order_text = document.getElementById('erp-raw-text')?.value || '';
    try {
        const receivedDateEl = document.getElementById('erp-received-date');
        const receivedTimeEl = document.getElementById('erp-received-time');
        const received_date = receivedDateEl ? (receivedDateEl.value || '').trim() : '';
        const received_time = receivedTimeEl ? (receivedTimeEl.value || '').trim() : '';
        const res = await fetch(`/api/orders/${ORDER_ID}/structured`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                structured_data,
                raw_order_text,
                structured_schema_version: 1,
                structured_confidence: structured_data.confidence,
                received_date: received_date || undefined,
                received_time: received_time || undefined
            })
        });
        const data = await res.json();
        if (!data.success) {
            erpSetStatus(data.message || '저장 실패', true);
            return;
        }
        erpSetStatus('저장 완료');
    } catch (e) {
        console.error(e);
        erpSetStatus(`저장 실패: ${String(e?.message || e)}`, true);
    }
}

async function erpParseRawText() {
    const raw = document.getElementById('erp-raw-text')?.value || '';
    if (!raw.trim()) {
        alert('원문 텍스트를 입력해 주세요.');
        return;
    }
    const preview = document.getElementById('erp-parsed-preview');
    preview.textContent = '파싱 중...';
    let res;
    try {
        res = await fetch('/api/orders/parse-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ raw_text: raw })
        });
    } catch (e) {
        preview.textContent = `네트워크 오류: ${String(e?.message || e)}`;
        document.getElementById('erp-apply-btn').disabled = true;
        return;
    }

    let data = null;
    let rawText = null;
    try { data = await res.json(); } catch (e) { try { rawText = await res.text(); } catch (_) {} }

    if (!res.ok) {
        const msg = (data && (data.message || data.error)) ? (data.message || data.error) : (rawText || `HTTP ${res.status}`);
        preview.textContent = msg;
        document.getElementById('erp-apply-btn').disabled = true;
        return;
    }

    if (!data || !data.success) {
        preview.textContent = (data && data.message) ? data.message : '파싱 실패';
        document.getElementById('erp-apply-btn').disabled = true;
        return;
    }
    window.__erpParsed = data.structured_data;
    preview.textContent = JSON.stringify(data.structured_data, null, 2);
    document.getElementById('erp-apply-btn').disabled = false;
}

function erpApplyParsedToForm() {
    const sd = window.__erpParsed;
    if (!sd) return;
    document.getElementById('erp-customer-name').value = sd?.parties?.customer?.name || '';
    document.getElementById('erp-customer-phone').value = sd?.parties?.customer?.phone || '';
    try {
        const erpManualPhone = document.getElementById('erp-manual-phone-input');
        if (!erpManualPhone || !erpManualPhone.checked) {
            document.getElementById('erp-customer-phone').value = formatPhoneAuto(document.getElementById('erp-customer-phone').value);
        }
    } catch (e) {}
    document.getElementById('erp-orderer').value = sd?.parties?.orderer?.name || '';
    document.getElementById('erp-manager').value = sd?.parties?.manager?.name || '';
    document.getElementById('erp-address').value = sd?.site?.address_main || sd?.site?.address_full || '';
    document.getElementById('erp-address-detail').value = sd?.site?.address_detail || '';
    document.getElementById('erp-measurement-date').value = sd?.schedule?.measurement?.date || '';
    const measurementTime = sd?.schedule?.measurement?.time || '';
    const erpMeasurementTimeSelect = document.getElementById('erp-measurement-time-select');
    const erpMeasurementTimeInput = document.getElementById('erp-measurement-time');
    if (erpMeasurementTimeSelect) {
        if (measurementTime === '오전' || measurementTime === '오후' || measurementTime === '종일') {
            erpMeasurementTimeSelect.value = measurementTime;
            if (erpMeasurementTimeInput) {
                erpMeasurementTimeInput.value = '';
                erpMeasurementTimeInput.style.display = 'none';
            }
        } else {
            erpMeasurementTimeSelect.value = '__direct__';
            if (erpMeasurementTimeInput) {
                erpMeasurementTimeInput.value = measurementTime || '';
                erpMeasurementTimeInput.style.display = 'block';
            }
        }
    }
    document.getElementById('erp-construction-date').value = sd?.schedule?.construction?.date || '';
    document.getElementById('erp-phone-note').value = sd?.notes?.phone_note || '';
    document.getElementById('erp-address-note').value = sd?.notes?.address_note || '';
    document.getElementById('erp-measurement-note').value = sd?.notes?.measurement_note || '';

    const itemsWrap = document.getElementById('erp-items');
    itemsWrap.innerHTML = '';
    const items = Array.isArray(sd.items) ? sd.items : [];
    if (items.length === 0) {
        itemsWrap.appendChild(erpNewItemRow({}));
    } else {
        items.forEach(it => itemsWrap.appendChild(erpNewItemRow(it)));
    }

    erpSetStatus(`파싱 결과 적용 완료 (confidence: ${sd.confidence || '-'})`);
    erpRecalcItemsTotal();
}

document.addEventListener('DOMContentLoaded', function() {
    if (!ERP_BETA_ENABLED) return;

    // ERP Beta: 주소 입력 (통합 - 찾기 버튼으로 주소 검색 또는 직접 입력 가능)
    const addrInput = document.getElementById('erp-address');

    // ERP Beta: 주소 검색 모달 (선택 후 '입력' 버튼으로 한꺼번에 적용)
    const addrModalEl = document.getElementById('erpAddressSearchModal');
    const addrModal = addrModalEl ? new bootstrap.Modal(addrModalEl) : null;
    const addrModalQuery = document.getElementById('erp-address-modal-query');
    const addrModalSearchBtn = document.getElementById('erp-address-modal-search-btn');
    const addrModalStatus = document.getElementById('erp-address-modal-status');
    const addrModalResults = document.getElementById('erp-address-modal-results');
    const addrModalApplyBtn = document.getElementById('erp-address-modal-apply-btn');
    const openSearchBtn = document.getElementById('erp-address-search-btn');

    let selectedModalAddress = '';

    async function doAddressSearch(query) {
        if (!query || !query.trim()) return;
        selectedModalAddress = '';
        if (addrModalStatus) addrModalStatus.textContent = '검색 중...';
        if (addrModalResults) addrModalResults.innerHTML = '';
        try {
            const qs = new URLSearchParams({ q: query.trim(), size: '10' });
            const res = await fetch(`/api/address/search?${qs.toString()}`);
            const data = await res.json();
            if (!data.success) {
                if (addrModalStatus) addrModalStatus.textContent = data.message || '검색 실패';
                return;
            }
            const results = data.results || [];
            if (addrModalStatus) addrModalStatus.textContent = `${results.length}건 검색됨. 주소를 선택한 뒤 상세주소 입력 후 '입력' 버튼을 누르세요.`;
            results.forEach(r => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                const base = r.road_address_name || r.address_name || '-';
                const main = r.building_name ? `${base}, ${r.building_name}` : base;
                const sub = [r.building_name, r.region_3depth_name].filter(Boolean).join(' · ');
                item.innerHTML = `<div class="fw-semibold">${escapeHtml(main)}</div>${sub ? `<div class="small text-muted">${escapeHtml(sub)}</div>` : ''}`;
                item.addEventListener('click', () => {
                    selectedModalAddress = main;
                    addrModalResults.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                });
                addrModalResults.appendChild(item);
            });
        } catch (e) {
            if (addrModalStatus) addrModalStatus.textContent = `검색 실패: ${String(e?.message || e)}`;
        }
    }

    if (addrModalApplyBtn) {
        addrModalApplyBtn.addEventListener('click', () => {
            const detailEl = document.getElementById('erp-address-modal-detail');
            const detail = detailEl ? (detailEl.value || '').trim() : '';
            const full = selectedModalAddress ? (detail ? `${selectedModalAddress} ${detail}` : selectedModalAddress) : detail;
            if (addrInput) addrInput.value = full;
            if (addrModal) addrModal.hide();
        });
    }

    if (openSearchBtn && addrModal) {
        openSearchBtn.addEventListener('click', () => {
            selectedModalAddress = '';
            if (addrModalQuery) addrModalQuery.value = addrInput?.value || '';
            if (addrModalStatus) addrModalStatus.textContent = '';
            if (addrModalResults) addrModalResults.innerHTML = '';
            const detailEl = document.getElementById('erp-address-modal-detail');
            if (detailEl) detailEl.value = '';
            addrModal.show();
            setTimeout(() => addrModalQuery?.focus(), 200);
        });
    }

    if (addrModalEl) {
        addrModalEl.addEventListener('hidden.bs.modal', () => { selectedModalAddress = ''; });
    }

    if (addrModalSearchBtn) {
        addrModalSearchBtn.addEventListener('click', () => doAddressSearch(addrModalQuery?.value || ''));
    }
    if (addrModalQuery) {
        addrModalQuery.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                doAddressSearch(addrModalQuery.value);
            }
        });
    }

    // ERP Beta: 연락처 자동 포맷 처리
    const erpManualPhone = document.getElementById('erp-manual-phone-input');
    const erpPhoneInput = document.getElementById('erp-customer-phone');
    function applyErpPhoneFormat() {
        if (!erpPhoneInput) return;
        if (erpManualPhone && erpManualPhone.checked) return;
        erpPhoneInput.value = formatPhoneAuto(erpPhoneInput.value);
    }
    if (erpPhoneInput) {
        erpPhoneInput.addEventListener('input', applyErpPhoneFormat);
        erpPhoneInput.addEventListener('blur', applyErpPhoneFormat);
        erpPhoneInput.addEventListener('change', applyErpPhoneFormat);
    }
    if (erpManualPhone) {
        erpManualPhone.addEventListener('change', function() {
            if (!this.checked) applyErpPhoneFormat();
        });
    }

    // ERP Beta: 실측시간 직접 입력 처리
    const erpMeasurementTimeSelect = document.getElementById('erp-measurement-time-select');
    const erpMeasurementTimeInput = document.getElementById('erp-measurement-time');
    if (erpMeasurementTimeSelect && erpMeasurementTimeInput) {
        erpMeasurementTimeSelect.addEventListener('change', function() {
            if (this.value === '__direct__') {
                erpMeasurementTimeInput.style.display = 'block';
            } else {
                erpMeasurementTimeInput.style.display = 'none';
                erpMeasurementTimeInput.value = '';
            }
        });
    }

    // 기본 항목 1개
    const itemsWrap = document.getElementById('erp-items');
    if (itemsWrap && itemsWrap.children.length === 0) {
        itemsWrap.appendChild(erpNewItemRow({}));
        erpRecalcItemsTotal();
    }

    document.getElementById('erp-add-item-btn')?.addEventListener('click', function() {
        document.getElementById('erp-items')?.appendChild(erpNewItemRow({}));
        erpRecalcItemsTotal();
    });
    document.getElementById('erp-save-btn')?.addEventListener('click', erpSaveStructured);
    document.getElementById('erp-load-btn')?.addEventListener('click', erpLoadStructured);
    document.getElementById('erp-parse-btn')?.addEventListener('click', erpParseRawText);
    document.getElementById('erp-apply-btn')?.addEventListener('click', erpApplyParsedToForm);

    // add_order(draft) 모드에선 tab 오픈 시 draft 생성 후 로드, edit_order에선 즉시 로드
    if (!window.__ERP_BETA_DRAFT_MODE) {
        erpLoadStructured();
    }
});

// ============================================
// ERP Beta: Attachments (photo/video)
// ============================================
let __erpAttachments = [];

function erpAttachmentsSetStatus(text, isError=false) {
    const el = document.getElementById('erp-attachments-status');
    if (!el) return;
    el.textContent = text || '';
    el.classList.toggle('text-danger', !!isError);
    el.classList.toggle('text-muted', !isError);
}

function erpRenderAttachments() {
    const wrap = document.getElementById('erp-attachments-gallery');
    if (!wrap) return;
    const items = Array.isArray(__erpAttachments) ? __erpAttachments : [];
    if (!items.length) {
        wrap.innerHTML = `<div class="col-12"><div class="small text-muted">첨부된 파일이 없습니다.</div></div>`;
        return;
    }

    wrap.innerHTML = items.map(a => {
        const name = escapeHtml(a.filename || '');
        const type = a.file_type || 'file';
        const thumb = a.thumbnail_view_url || a.view_url;
        const viewUrl = a.view_url || '#';
        const downloadUrl = a.download_url || '#';

        const mediaHtml = (type === 'video')
            ? `<div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;">
                    <video src="${viewUrl}" controls preload="metadata" style="width:100%;height:100%;"></video>
               </div>`
            : `<img src="${thumb}" alt="${name}" class="img-fluid rounded" style="max-height: 220px; cursor: zoom-in; background:#fff; padding:4px;"
                    onclick="erpOpenAttachmentPreview(${a.id})">`;

        return `
            <div class="col-md-4 col-sm-6 col-12">
                <div class="card h-100">
                    <div class="card-body p-2">
                        ${mediaHtml}
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="small text-truncate" title="${name}" style="max-width: 70%;">${name}</div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" type="button" title="미리보기" onclick="erpOpenAttachmentPreview(${a.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a class="btn btn-outline-primary" href="${downloadUrl}" title="다운로드" target="_blank" rel="noopener">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="btn btn-outline-danger" type="button" title="삭제" onclick="erpDeleteAttachment(${a.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function erpLoadAttachments() {
    if (!ERP_BETA_ENABLED) return;
    if (!ORDER_ID) return;
    try {
        // 파일 input 초기화 (이전 주문의 파일이 남아있지 않도록)
        const fileInput = document.getElementById('erp-attachments-input');
        if (fileInput) {
            fileInput.value = '';
        }
        
        const res = await fetch(`/api/orders/${ORDER_ID}/attachments`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '첨부 목록 조회 실패');
        __erpAttachments = data.attachments || [];
        erpRenderAttachments();
    } catch (e) {
        console.error(e);
        erpAttachmentsSetStatus(String(e?.message || e), true);
    }
}

function erpOpenAttachmentPreview(attachmentId) {
    const a = (__erpAttachments || []).find(x => x.id === attachmentId);
    if (!a) return;
    const modalEl = document.getElementById('erpAttachmentPreviewModal');
    const body = document.getElementById('erp-attachment-preview-body');
    const dl = document.getElementById('erp-attachment-preview-download');
    if (!modalEl || !body || !dl) return;

    const viewUrl = a.view_url || '#';
    const downloadUrl = a.download_url || '#';
    dl.href = downloadUrl;

    if (a.file_type === 'video') {
        body.innerHTML = `
            <div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;">
                <video src="${viewUrl}" controls autoplay style="width:100%;height:100%;"></video>
            </div>
            <div class="small text-muted mt-2">${escapeHtml(a.filename || '')}</div>
        `;
    } else {
        body.innerHTML = `
            <img src="${viewUrl}" alt="${escapeHtml(a.filename || '')}" class="img-fluid rounded" style="background:#fff; padding:4px;">
            <div class="small text-muted mt-2">${escapeHtml(a.filename || '')}</div>
        `;
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

async function erpUploadSelectedAttachments() {
    if (!ERP_BETA_ENABLED) return;
    if (!ORDER_ID) {
        const ok = await erpRequireOrderIdOrWarn('첨부 업로드:');
        if (!ok) return;
    }
    const input = document.getElementById('erp-attachments-input');
    if (!input || !input.files || input.files.length === 0) {
        erpAttachmentsSetStatus('업로드할 파일을 선택하세요.', true);
        return;
    }

    const files = Array.from(input.files);
    erpAttachmentsSetStatus(`업로드 중... (${files.length}개)`);

    let ok = 0;
    for (const f of files) {
        const fd = new FormData();
        fd.append('file', f);
        const res = await fetch(`/api/orders/${ORDER_ID}/attachments`, { method: 'POST', body: fd });
        const data = await res.json();
        if (data.success) ok += 1;
        else console.warn('upload failed', data);
    }

    input.value = '';
    erpAttachmentsSetStatus(`업로드 완료: ${ok}/${files.length}`);
    await erpLoadAttachments();
}

async function erpDeleteAttachment(attachmentId) {
    if (!confirm('첨부파일을 삭제할까요?')) return;
    try {
        const res = await fetch(`/api/orders/${ORDER_ID}/attachments/${attachmentId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '삭제 실패');
        erpAttachmentsSetStatus('삭제 완료');
        await erpLoadAttachments();
    } catch (e) {
        console.error(e);
        erpAttachmentsSetStatus(String(e?.message || e), true);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    if (!ERP_BETA_ENABLED) return;
    document.getElementById('erp-attachments-upload-btn')?.addEventListener('click', erpUploadSelectedAttachments);

    // ERP Beta 탭이 열릴 때: ORDER_ID가 있을 때만 데이터 로드 (자동 주문 생성 제거)
    // 저장 버튼을 눌러야만 주문이 생성되고 저장됨
    document.getElementById('erp-beta-tab')?.addEventListener('shown.bs.tab', async function() {
        // 파일 input 초기화 (탭이 열릴 때마다 이전 파일 제거)
        const fileInput = document.getElementById('erp-attachments-input');
        if (fileInput) {
            fileInput.value = '';
        }
        // add_order(draft) 모드에서 아직 주문이 없을 때 접수일/접수시간을 로컬 기준으로 표기
        if (window.__ERP_BETA_DRAFT_MODE && (!ORDER_ID || ORDER_ID <= 0)) {
            const now = new Date();
            const localDateStr = [now.getFullYear(), String(now.getMonth() + 1).padStart(2, '0'), String(now.getDate()).padStart(2, '0')].join('-');
            const localTimeStr = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
            const rd = document.getElementById('erp-received-date');
            const rt = document.getElementById('erp-received-time');
            if (rd) rd.value = localDateStr;
            if (rt) rt.value = localTimeStr;
        }
        // ORDER_ID가 있을 때만 데이터 로드 (저장 버튼으로 생성된 주문이 있을 때만)
        if (ORDER_ID && ORDER_ID > 0) {
            erpLoadStructured();
            erpLoadAttachments();
            erpLoadQuest();
        }
    });
});

// ============================================
// ERP Beta: Quest System (단계별 명확한 퀘스트)
// ============================================
let __erpQuest = null;

const ERP_TEAM_LABELS = {
    CS: '라홈팀',
    SALES: '영업팀',
    MEASURE: '실측팀',
    DRAWING: '도면팀',
    PRODUCTION: '생산팀',
    CONSTRUCTION: '시공팀',
};

const ERP_QUEST_STATUS_LABELS = {
    OPEN: '오픈',
    IN_PROGRESS: '진행중',
    COMPLETED: '완료',
};

const ERP_STAGE_LABELS = {
    RECEIVED: '주문접수',
    HAPPYCALL: '해피콜',
    MEASURE: '실측',
    DRAWING: '도면',
    CONFIRM: '고객컨펌',
    PRODUCTION: '생산',
    CONSTRUCTION: '시공',
};

function erpLabel(map, code, fallback='-') {
    if (!code) return fallback;
    return map[code] || code;
}

function erpSetQuestStatus(text, isError=false) {
    const el = document.getElementById('erp-quest-status-text');
    if (!el) return;
    el.textContent = text || '';
    el.classList.toggle('text-danger', !!isError);
    el.classList.toggle('text-muted', !isError);
}

function erpRenderQuest() {
    const quest = __erpQuest;
    const container = document.getElementById('erp-quest-container');
    if (!container) return;
    
    if (!quest) {
        container.innerHTML = '<div class="alert alert-secondary">현재 단계의 Quest가 없습니다. Quest는 자동으로 생성됩니다.</div>';
        return;
    }
    
    const titleEl = document.getElementById('erp-quest-title');
    const descEl = document.getElementById('erp-quest-description');
    const statusBadgeEl = document.getElementById('erp-quest-status-badge');
    const ownerTeamEl = document.getElementById('erp-quest-owner-team');
    const approvalsEl = document.getElementById('erp-quest-approvals');
    
    if (titleEl) titleEl.textContent = quest.title || '-';
    if (descEl) descEl.textContent = quest.description || '-';
    
    const status = quest.status || 'OPEN';
    const statusLabel = erpLabel(ERP_QUEST_STATUS_LABELS, status, status);
    if (statusBadgeEl) {
        let badgeClass = 'bg-secondary';
        if (status === 'COMPLETED') badgeClass = 'bg-success';
        else if (status === 'IN_PROGRESS') badgeClass = 'bg-primary';
        statusBadgeEl.className = `badge ${badgeClass}`;
        statusBadgeEl.textContent = statusLabel;
    }
    
    if (ownerTeamEl) {
        ownerTeamEl.textContent = erpLabel(ERP_TEAM_LABELS, quest.owner_team, quest.owner_team || '-');
    }
    
    // 팀별 승인 표시
    if (approvalsEl) {
        const teamApprovals = quest.team_approvals || {};
        const requiredTeams = Object.keys(teamApprovals);
        
        if (requiredTeams.length === 0) {
            approvalsEl.innerHTML = '<div class="text-muted small">승인 필요 팀이 없습니다.</div>';
        } else {
            approvalsEl.innerHTML = requiredTeams.map(team => {
                const approval = teamApprovals[team] || {};
                const isApproved = approval.approved === true;
                const approvedBy = escapeHtml(approval.approved_by_name || approval.approved_by || '-');
                const approvedAt = approval.approved_at ? new Date(approval.approved_at).toLocaleString('ko-KR') : '-';
                const teamLabel = escapeHtml(erpLabel(ERP_TEAM_LABELS, team, team));
                const teamEscaped = escapeHtml(team);
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <div class="fw-bold">${teamLabel}</div>
                            ${isApproved ? `<small class="text-success">승인 완료 (${approvedBy}, ${approvedAt})</small>` : '<small class="text-muted">승인 대기</small>'}
                        </div>
                        <div>
                            ${!isApproved ? `
                                <button class="btn btn-sm btn-success" type="button" onclick="erpApproveQuestTeam('${teamEscaped}')">
                                    <i class="fas fa-check"></i> 승인
                                </button>
                            ` : `
                                <span class="badge bg-success"><i class="fas fa-check-circle"></i> 승인됨</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
    }
}

async function erpLoadQuest() {
    if (!ERP_BETA_ENABLED || !ORDER_ID) return;
    try {
        const res = await fetch(`/api/orders/${ORDER_ID}/quest`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Quest 조회 실패');
        __erpQuest = data.quest;
        erpRenderQuest();
        
        // 자동 전환 알림
        if (data.auto_transitioned && data.next_stage) {
            const nextStageLabel = erpLabel(ERP_STAGE_LABELS, data.next_stage, data.next_stage);
            erpSetQuestStatus(`✅ 모든 팀 승인 완료! 다음 단계(${nextStageLabel})로 자동 전환되었습니다.`);
            setTimeout(() => {
                erpLoadQuest(); // 새 Quest 로드
            }, 1000);
        }
    } catch (e) {
        console.error(e);
        erpSetQuestStatus('Quest 조회 실패', true);
    }
}

async function erpApproveQuestTeam(team) {
    if (!ERP_BETA_ENABLED || !ORDER_ID) return;
    if (!confirm(`${erpLabel(ERP_TEAM_LABELS, team, team)} 승인을 진행하시겠습니까?`)) return;
    
    erpSetQuestStatus('승인 처리 중...');
    try {
        const res = await fetch(`/api/orders/${ORDER_ID}/quest/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team })
        });
        const data = await res.json();
        if (!data.success) {
            erpSetQuestStatus(data.message || '승인 실패', true);
            return;
        }
        
        __erpQuest = data.quest;
        erpRenderQuest();
        
        if (data.all_approved) {
            if (data.auto_transitioned && data.next_stage) {
                const nextStageLabel = erpLabel(ERP_STAGE_LABELS, data.next_stage, data.next_stage);
                erpSetQuestStatus(`✅ 모든 팀 승인 완료! 다음 단계(${nextStageLabel})로 자동 전환되었습니다.`);
                setTimeout(() => {
                    erpLoadQuest(); // 새 Quest 로드
                    erpLoadStructured(); // structured_data도 새로고침
                }, 1500);
            } else {
                erpSetQuestStatus('✅ 모든 팀 승인 완료!');
            }
        } else {
            const missingTeams = data.missing_teams.map(t => erpLabel(ERP_TEAM_LABELS, t, t)).join(', ');
            erpSetQuestStatus(`승인 완료. 남은 팀: ${missingTeams}`);
        }
    } catch (e) {
        console.error(e);
        erpSetQuestStatus('승인 처리 실패', true);
    }
}

async function erpUpdateQuestStatus() {
    if (!ERP_BETA_ENABLED || !ORDER_ID) return;
    if (!__erpQuest) return;
    
    const currentStatus = __erpQuest.status || 'OPEN';
    const statuses = ['OPEN', 'IN_PROGRESS', 'COMPLETED'];
    const currentIndex = statuses.indexOf(currentStatus);
    const nextIndex = (currentIndex + 1) % statuses.length;
    const nextStatus = statuses[nextIndex];
    
    erpSetQuestStatus('상태 업데이트 중...');
    try {
        const res = await fetch(`/api/orders/${ORDER_ID}/quest/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: nextStatus })
        });
        const data = await res.json();
        if (!data.success) {
            erpSetQuestStatus(data.message || '상태 업데이트 실패', true);
            return;
        }
        
        __erpQuest = data.quest;
        erpRenderQuest();
        erpSetQuestStatus('상태 업데이트 완료');
    } catch (e) {
        console.error(e);
        erpSetQuestStatus('상태 업데이트 실패', true);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    if (!ERP_BETA_ENABLED) return;
    document.getElementById('erp-quest-status-btn')?.addEventListener('click', erpUpdateQuestStatus);
});
