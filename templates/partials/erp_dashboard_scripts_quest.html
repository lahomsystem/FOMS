        function renderBadges(alerts) {
          const a = alerts || {};
          const out = [];
          if (a.urgent) out.push('<span class="badge bg-danger me-1">긴급</span>');
          if (a.drawing_overdue) out.push('<span class="badge bg-danger me-1">도면48h</span>');
          if (a.measurement_d4) out.push('<span class="badge bg-warning text-dark me-1">실측D-4</span>');
          if (a.construction_d3) out.push('<span class="badge bg-warning text-dark me-1">시공D-3</span>');
          if (a.production_d2) out.push('<span class="badge bg-warning text-dark me-1">생산D-2</span>');
          return out.join('') || '<span class="text-muted small">경보 없음</span>';
        }

        async function approveQuestTeam(orderId, team) {
          try {
            const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ team: team })
            });
            const data = await res.json();

            if (!data.success) {
              alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
              return;
            }

            if (data.auto_transitioned && data.next_stage) {
              const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
              alert('✅ 모든 팀 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
            } else if (data.all_approved) {
              alert('✅ 모든 팀 승인 완료!');
            } else {
              const missingTeams = data.missing_teams.map(t => label(TEAM_LABELS, t, t)).join(', ');
              alert('승인 완료. 남은 팀: ' + missingTeams);
            }

            await loadQuestDetail(orderId);
            window.location.reload();
          } catch (err) {
            console.error('승인 실패:', err);
            alert('승인 중 오류가 발생했습니다.');
          }
        }

        async function approveQuestAssignee(orderId) {
          try {
            const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });
            const data = await res.json();

            if (!data.success) {
              alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
              return;
            }

            if (data.auto_transitioned && data.next_stage) {
              const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
              alert('✅ 담당자 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
            } else if (data.all_approved) {
              alert('✅ 담당자 승인 완료!');
            }

            window.location.reload();
          } catch (err) {
            console.error('승인 실패:', err);
            alert('승인 중 오류가 발생했습니다.');
          }
        }

        async function loadQuestDetail(orderId) {
          try {
            const res = await fetch(`/api/orders/${orderId}/quest`);
            const data = await res.json();
            if (data.error) {
              console.error('Quest 로드 실패:', data.error);
              return;
            }
            const questContainer = document.querySelector(`#quest-collapse-${orderId} #quest-approvals-${orderId}`);
            if (questContainer) {
              const quest = data.quest || {};
              const requiredTeams = quest.required_approvals || [];
              const teamApprovalsRaw = quest.team_approvals || {};

              let html = '';
              for (const team of requiredTeams) {
                const approvalData = teamApprovalsRaw[team];
                let approved = false;
                if (typeof approvalData === 'object' && approvalData !== null) {
                  approved = approvalData.approved === true;
                } else {
                  approved = Boolean(approvalData);
                }
                const teamLabel = label(TEAM_LABELS, team, team);
                html += `<div class="mb-2">`;
                html += `<span class="fw-semibold" style="font-size: 1rem;">${escapeHtml(teamLabel)}</span>`;
                if (approved) {
                  html += `<span class="badge bg-success ms-2" style="font-size: 1rem; padding: 0.4em 0.7em;">승인완료</span>`;
                } else {
                  html += `<button class="btn btn-primary fw-semibold ms-2" onclick="approveQuestTeam(${orderId}, '${escapeHtml(team)}')" style="font-size: 1rem; padding: 0.4rem 0.75rem;">승인</button>`;
                }
                html += `</div>`;
              }
              questContainer.innerHTML = html;
            }
          } catch (err) {
            console.error('Quest 상세 로드 실패:', err);
          }
        }
