<script>
// ì„¤ì • ì •ë³´ë¥¼ DOMì—ì„œ ê°€ì ¸ì˜¤ê¸°
const chatContainer = document.querySelector('.chat-sidebar-card');
const socketioAvailable = chatContainer ? chatContainer.getAttribute('data-socketio-available') === 'true' : false;
const userIdFromData = chatContainer ? parseInt(chatContainer.getAttribute('data-user-id') || '0', 10) : 0;

let socket = null;
let currentRoomId = null;
let currentUserId = userIdFromData;
window.SOCKETIO_AVAILABLE = window.SOCKETIO_AVAILABLE || socketioAvailable;


// ìƒˆ ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ (í†µí•©)
function handleNewMessage(data) {
    console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
    
    if (data.room_id == currentRoomId) {
        // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©”ì‹œì§€ IDì¸ì§€ í™•ì¸ (ì´ì¤‘ ë°©ì–´)
        if (data.id) {
            const container = document.getElementById('messages-container');
            const existingMessage = container.querySelector(`[data-message-id="${data.id}"]`);
            if (existingMessage) {
                console.log('[handleNewMessage] ì¤‘ë³µ ë©”ì‹œì§€ ìŠ¤í‚µ:', data.id);
                return; // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©”ì‹œì§€ëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            }
        }
        
        // í˜„ì¬ ì±„íŒ…ë°©ì´ë©´ ë©”ì‹œì§€ ì¶”ê°€
        appendMessage(data);
        scrollToBottom();
        
        // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (socket && socket.connected) {
            socket.emit('mark_read', { room_id: currentRoomId });
        } else {
            fetch(`/api/chat/rooms/${currentRoomId}/mark-read`, {
                method: 'POST'
            }).catch(err => console.error('ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err));
        }
    } else {
        // ë‹¤ë¥¸ ì±„íŒ…ë°©ì´ë©´ ì•Œë¦¼ í‘œì‹œ
        if (data.user_id != currentUserId) {
            fetch(`/api/chat/rooms/${data.room_id}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.room) {
                        showChatNotification(data, result.room);
                    } else {
                        showChatNotification(data, { id: data.room_id, name: 'ì•Œ ìˆ˜ ì—†ëŠ” ì±„íŒ…ë°©' });
                    }
                })
                .catch(err => {
                    console.error('ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', err);
                    showChatNotification(data, { id: data.room_id, name: 'ì•Œ ìˆ˜ ì—†ëŠ” ì±„íŒ…ë°©' });
                });
        }
    }
}

// Socket.IO ì´ˆê¸°í™” í•¨ìˆ˜
function initializeSocketIO() {
    try {
        if (typeof io === 'undefined') {
            console.error('Socket.IOê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        // layoutì˜ ì‹±ê¸€í†¤ ì†Œì¼“ì„ ì¬ì‚¬ìš© (í˜ì´ì§€ë‹¹ ì†Œì¼“ 1ê°œ ë³´ì¥)
        if (typeof window.getAppSocket === 'function') {
            socket = window.getAppSocket();
        } else if (window.globalSocket) {
            socket = window.globalSocket;
        } else {
            // fallback: layout ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ëŠ” ì˜ˆì™¸ ìƒí™©ì—ì„œë§Œ ì§ì ‘ ìƒì„±
            const fallbackOptions = (typeof window.getAppSocketOptions === 'function')
                ? window.getAppSocketOptions()
                : {
                    transports: ['websocket', 'polling'],
                    upgrade: true,
                    reconnection: true,
                    reconnectionAttempts: Infinity,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 20000
                };
            socket = io(fallbackOptions);
            window.globalSocket = socket;
            window.__appSocket = socket;
        }

        if (!socket) {
            console.error('Socket.IO ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return;
        }

        // í•¸ë“¤ëŸ¬ëŠ” idempotentí•˜ê²Œ ë°”ì¸ë”©í•´ì„œ ì¤‘ë³µ ë“±ë¡ì„ ë°©ì§€
        const handlers = window.__chatSocketHandlers || {
            onConnect: function() {
                console.log('Socket.IO ì—°ê²° ì„±ê³µ');
                loadRooms();
            },
            onConnectError: function(error) {
                console.error('Socket.IO ì—°ê²° ì˜¤ë¥˜:', error);
            },
            onDisconnect: function(reason) {
                console.log('Socket.IO ì—°ê²° í•´ì œ:', reason);
                if (reason === 'io server disconnect' && socket) {
                    socket.connect();
                }
            },
            onReconnect: function(attemptNumber) {
                console.log('Socket.IO ì¬ì—°ê²° ì„±ê³µ:', attemptNumber);
            },
            onNewMessage: function(data) {
                handleNewMessage(data);
            },
            onMessageRead: function(data) {
                if (data.room_id == currentRoomId) {
                    console.log('ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸:', data);
                }
            },
            onUserTyping: function(data) {
                if (data.room_id == currentRoomId && data.user_id != currentUserId) {
                    showTypingIndicator(data.user_id, data.is_typing);
                }
            }
        };
        window.__chatSocketHandlers = handlers;

        socket.off('connect', handlers.onConnect);
        socket.off('connect_error', handlers.onConnectError);
        socket.off('disconnect', handlers.onDisconnect);
        socket.off('reconnect', handlers.onReconnect);
        socket.off('new_message', handlers.onNewMessage);
        socket.off('message_read', handlers.onMessageRead);
        socket.off('user_typing', handlers.onUserTyping);

        socket.on('connect', handlers.onConnect);
        socket.on('connect_error', handlers.onConnectError);
        socket.on('disconnect', handlers.onDisconnect);
        socket.on('reconnect', handlers.onReconnect);
        socket.on('new_message', handlers.onNewMessage);
        socket.on('message_read', handlers.onMessageRead);
        socket.on('user_typing', handlers.onUserTyping);

        // ì´ë¯¸ ì—°ê²°ëœ ìƒíƒœì—ì„œ ì§„ì…í•˜ë©´ ì¦‰ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        if (socket.connected) {
            loadRooms();
        }

    } catch (error) {
        console.error('Socket.IO ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    }
}

// ============================================
// ì´ë¯¸ì§€ í™•ëŒ€/ì¶•ì†Œ ê¸°ëŠ¥ (Lightbox) - ì „ì—­ ìŠ¤ì½”í”„
// ============================================
let imageZoom = {
    scale: 1,
    minScale: 0.5,
    maxScale: 5,
    translateX: 0,
    translateY: 0,
    lastTranslateX: 0,
    lastTranslateY: 0
};

function openImageLightbox(imageUrl) {
    const lightbox = document.getElementById('image-lightbox');
    const img = document.getElementById('image-lightbox-img');
    
    if (!lightbox || !img) {
        console.error('ë¼ì´íŠ¸ë°•ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì´ë¯¸ì§€ ë¡œë“œ í›„ transform ì ìš©
    img.onload = function() {
        imageZoom.scale = 1;
        imageZoom.translateX = 0;
        imageZoom.translateY = 0;
        imageZoom.lastTranslateX = 0;
        imageZoom.lastTranslateY = 0;
        updateImageTransform();
    };
    
    // ì´ë¯¸ì§€ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ” ê²½ìš°
    if (img.complete) {
        img.onload();
    }
    
    img.src = imageUrl;
    lightbox.classList.add('active');
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', handleLightboxKeydown);
}

function closeImageLightbox(event) {
    // ì´ë²¤íŠ¸ê°€ ì—†ê±°ë‚˜ ë°°ê²½/ë‹«ê¸° ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
    if (!event || 
        event.target.id === 'image-lightbox' || 
        event.target.id === 'image-lightbox-close' || 
        event.target.closest('.image-lightbox-controls')) {
        
        const lightbox = document.getElementById('image-lightbox');
        if (lightbox) {
            lightbox.classList.remove('active');
        }
        document.removeEventListener('keydown', handleLightboxKeydown);
    }
}

function handleLightboxKeydown(e) {
    if (e.key === 'Escape') {
        closeImageLightbox(e);
    }
}

function resetImageZoom() {
    imageZoom.scale = 1;
    imageZoom.translateX = 0;
    imageZoom.translateY = 0;
    imageZoom.lastTranslateX = 0;
    imageZoom.lastTranslateY = 0;
    updateImageTransform();
}

function updateImageTransform() {
    const content = document.getElementById('image-lightbox-content');
    if (content) {
        content.style.transform = `translate(${imageZoom.translateX}px, ${imageZoom.translateY}px) scale(${imageZoom.scale})`;
    }
}

// ============================================
// ì±„íŒ… ì•Œë¦¼ íŒì—… ê´€ë¦¬ (ì±„ë„í†¡ ìŠ¤íƒ€ì¼)
// ============================================
let notificationStack = [];
const MAX_NOTIFICATIONS = 5;
const NOTIFICATION_DURATION = 5000; // 5ì´ˆ
let notificationIds = new Set(); // ì¤‘ë³µ ë°©ì§€ìš©

function showChatNotification(messageData, roomData) {
    // í˜„ì¬ ì±„íŒ…ë°©ì´ë©´ ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨
    if (messageData.room_id == currentRoomId) {
        return;
    }
    
    // ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨
    if (messageData.user_id == currentUserId) {
        return;
    }
    
    // ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€: ê°™ì€ ë©”ì‹œì§€ IDëŠ” í•œ ë²ˆë§Œ í‘œì‹œ
    const messageId = messageData.id || (messageData.room_id + '_' + messageData.created_at);
    if (notificationIds.has(messageId)) {
        return;
    }
    notificationIds.add(messageId);
    
    // ì•Œë¦¼ ìŠ¤íƒì— ì¶”ê°€
    const notificationId = 'notification-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    const notification = {
        id: notificationId,
        message: messageData,
        room: roomData,
        timestamp: new Date(),
        messageId: messageId
    };
    
    notificationStack.push(notification);
    
    // ìµœëŒ€ ê°œìˆ˜ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ì•Œë¦¼ ì œê±°
    if (notificationStack.length > MAX_NOTIFICATIONS) {
        const oldest = notificationStack.shift();
        closeNotification(oldest.id);
        if (oldest.messageId) {
            notificationIds.delete(oldest.messageId);
        }
    }
    
    // ì•Œë¦¼ DOM ìƒì„±
    const container = document.getElementById('chat-notification-container');
    if (!container) {
        console.error('ì•Œë¦¼ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const notificationEl = createNotificationElement(notification);
    container.appendChild(notificationEl);
    
    // ìë™ ë‹«ê¸° íƒ€ì´ë¨¸
    const autoCloseTimer = setTimeout(() => {
        closeNotification(notificationId);
        if (messageId) {
            notificationIds.delete(messageId);
        }
    }, NOTIFICATION_DURATION);
    
    // ì•Œë¦¼ ìš”ì†Œì— íƒ€ì´ë¨¸ ID ì €ì¥
    notificationEl.dataset.timerId = autoCloseTimer;
    
    // í´ë¦­ ì´ë²¤íŠ¸: í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
    notificationEl.addEventListener('click', function(e) {
        if (!e.target.classList.contains('chat-notification-close') && 
            !e.target.closest('.chat-notification-close')) {
            closeNotification(notificationId);
            if (messageId) {
                notificationIds.delete(messageId);
            }
            if (roomData && roomData.id) {
                selectRoom(roomData.id);
                window.focus();
            }
        }
    });
}

// showChatNotification í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (layout.htmlì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
window.showChatNotification = showChatNotification;

function createNotificationElement(notification) {
    const { message, room } = notification;
    const senderName = message.user_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
    const roomName = room ? room.name : 'ì•Œ ìˆ˜ ì—†ëŠ” ì±„íŒ…ë°©';
    const senderInitial = senderName.charAt(0).toUpperCase();
    
    // ë©”ì‹œì§€ ë‚´ìš© ì¶”ì¶œ
    let messageContent = '';
    let hasAttachment = false;
    
    if (message.message_type === 'text') {
        messageContent = escapeHtml(message.content || '(ë©”ì‹œì§€ ì—†ìŒ)');
    } else if (message.attachments && message.attachments.length > 0) {
        const attachment = message.attachments[0];
        hasAttachment = true;
        if (attachment.file_type === 'image') {
            messageContent = 'ğŸ“· ì´ë¯¸ì§€';
        } else if (attachment.file_type === 'video') {
            messageContent = 'ğŸ¥ ë™ì˜ìƒ';
        } else {
            messageContent = 'ğŸ“ ' + escapeHtml(attachment.filename || 'íŒŒì¼');
        }
    } else {
        messageContent = '(ë‚´ìš© ì—†ìŒ)';
    }
    
    // ì‹œê°„ í¬ë§·
    const timeStr = formatNotificationTime(message.created_at);
    
    const notificationEl = document.createElement('div');
    notificationEl.className = 'chat-notification';
    notificationEl.id = notification.id;
    notificationEl.dataset.roomId = message.room_id;
    
    let attachmentHtml = '';
    if (hasAttachment && message.attachments && message.attachments[0]) {
        const attachment = message.attachments[0];
        if (attachment.file_type === 'image' && attachment.thumbnail_url) {
            attachmentHtml = `<img src="${attachment.thumbnail_url}" class="chat-notification-image" alt="ì´ë¯¸ì§€">`;
        } else {
            const fileIcon = attachment.file_type === 'video' ? 'fa-video' : 'fa-file';
            attachmentHtml = `
                <div class="chat-notification-file">
                    <i class="fas ${fileIcon} chat-notification-file-icon"></i>
                    <span class="chat-notification-file-name">${escapeHtml(attachment.filename || 'íŒŒì¼')}</span>
                </div>
            `;
        }
    }
    
    notificationEl.innerHTML = `
        <div class="chat-notification-header">
            <h6 class="chat-notification-room-name">${escapeHtml(roomName)}</h6>
            <button class="chat-notification-close" type="button" aria-label="ë‹«ê¸°">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-notification-content">
            <div class="chat-notification-avatar">${senderInitial}</div>
            <div class="chat-notification-body">
                <div class="chat-notification-sender">${escapeHtml(senderName)}</div>
                <div class="chat-notification-message">${messageContent}</div>
                ${attachmentHtml}
                <div class="chat-notification-time">${timeStr}</div>
            </div>
        </div>
    `;
    
    // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€ (ì¸ë¼ì¸ onclick ëŒ€ì‹ )
    const closeBtn = notificationEl.querySelector('.chat-notification-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            closeNotification(notification.id);
            if (notification.messageId) {
                notificationIds.delete(notification.messageId);
            }
        });
    }
    
    return notificationEl;
}

function closeNotification(notificationId) {
    const notificationEl = document.getElementById(notificationId);
    if (!notificationEl) {
        return;
    }
    
    // íƒ€ì´ë¨¸ ì·¨ì†Œ
    const timerId = notificationEl.dataset.timerId;
    if (timerId) {
        clearTimeout(parseInt(timerId));
    }
    
    // messageId ì œê±°
    const notification = notificationStack.find(n => n.id === notificationId);
    if (notification && notification.messageId) {
        notificationIds.delete(notification.messageId);
    }
    
    // ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜
    notificationEl.classList.add('closing');
    
    setTimeout(() => {
        notificationEl.remove();
        // ìŠ¤íƒì—ì„œë„ ì œê±°
        notificationStack = notificationStack.filter(n => n.id !== notificationId);
    }, 300);
}

function formatNotificationTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    
    if (minutes < 1) return 'ë°©ê¸ˆ ì „';
    if (minutes < 60) return `${minutes}ë¶„ ì „`;
    if (hours < 24) return `${hours}ì‹œê°„ ì „`;
    
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

// textarea ìë™ ë†’ì´ ì¡°ì ˆ í•¨ìˆ˜ (ì±„ë„í†¡ ìŠ¤íƒ€ì¼)
function autoResizeTextarea(textarea) {
    if (!textarea) return;
    // ë†’ì´ ì´ˆê¸°í™”
    textarea.style.height = 'auto';
    // scrollHeightë¡œ ë‚´ìš© ë†’ì´ ê³„ì‚°
    const scrollHeight = textarea.scrollHeight;
    // ìµœì†Œ 38px, ìµœëŒ€ 120pxë¡œ ì œí•œ
    const newHeight = Math.max(38, Math.min(scrollHeight, 120));
    textarea.style.height = newHeight + 'px';
}

// ì±„íŒ… í˜ì´ì§€ ë†’ì´ ë™ì  ê³„ì‚° (ë°˜ì‘í˜•)
function adjustChatPageHeight() {
    const header = document.querySelector('header');
    const nav = document.querySelector('nav.navbar');
    
    if (header && nav) {
        const headerHeight = header.offsetHeight || 0;
        const navHeight = nav.offsetHeight || 0;
        const totalHeight = headerHeight + navHeight;
        
        // container-fluid ë†’ì´ ì¡°ì ˆ
        const container = document.querySelector('.container-fluid');
        if (container && container.querySelector('.chat-page-wrapper')) {
            container.style.height = `calc(100vh - ${totalHeight}px)`;
            container.style.maxHeight = `calc(100vh - ${totalHeight}px)`;
            container.style.overflow = 'hidden';
        }
    }
}

// Socket.IO ì—°ê²°
document.addEventListener('DOMContentLoaded', function() {
    // ì±„íŒ… í˜ì´ì§€ ë†’ì´ ì¡°ì ˆ
    adjustChatPageHeight();
    
    // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            adjustChatPageHeight();
        }, 100);
    });
    
    // textarea ìë™ ë†’ì´ ì¡°ì ˆ
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        // ì…ë ¥ ì‹œ ìë™ ë†’ì´ ì¡°ì ˆ
        messageInput.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
        
        // í¬ì»¤ìŠ¤ ì‹œ ì´ˆê¸° ë†’ì´ ì„¤ì •
        messageInput.addEventListener('focus', function() {
            autoResizeTextarea(this);
        });
        
        // ì´ˆê¸° ë†’ì´ ì„¤ì •
        autoResizeTextarea(messageInput);
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ë°” ë†’ì´ ê³„ì‚° ë° sticky-top ìš”ì†Œ ìœ„ì¹˜ ì¡°ì •
    function adjustStickyPositions() {
        // ì±„íŒ… í˜ì´ì§€ì—ì„œëŠ” sticky positioningì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ í•¨ìˆ˜ ë¹„í™œì„±í™”
        // ì±„íŒ… í˜ì´ì§€ì¸ì§€ í™•ì¸
        const isChatPage = document.querySelector('.chat-page-wrapper') !== null;
        if (isChatPage) {
            // ì±„íŒ… í˜ì´ì§€ì—ì„œëŠ” ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            return;
        }
        
        const header = document.querySelector('header');
        const nav = document.querySelector('nav.navbar');
        
        if (header && nav) {
            const headerHeight = header.offsetHeight;
            const navHeight = nav.offsetHeight;
            const totalHeight = headerHeight + navHeight + 20; // ì—¬ìœ  ê³µê°„ 20px
            
            // sticky-top ìš”ì†Œë“¤ ìœ„ì¹˜ ì¡°ì •
            const stickyCards = document.querySelectorAll('[data-sticky-top="true"]');
            stickyCards.forEach(card => {
                card.style.top = totalHeight + 'px';
                card.style.maxHeight = `calc(100vh - ${totalHeight + 40}px)`;
            });
            
            // min-heightê°€ í•„ìš”í•œ ìš”ì†Œë“¤ ì¡°ì •
            const minHeightCards = document.querySelectorAll('[data-min-height="true"]');
            minHeightCards.forEach(card => {
                card.style.minHeight = `calc(100vh - ${totalHeight + 40}px)`;
            });
        } else {
            // ë„¤ë¹„ê²Œì´ì…˜ ë°”ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
            const stickyCards = document.querySelectorAll('[data-sticky-top="true"]');
            stickyCards.forEach(card => {
                card.style.top = '20px';
                card.style.maxHeight = 'calc(100vh - 40px)';
            });
            
            const minHeightCards = document.querySelectorAll('[data-min-height="true"]');
            minHeightCards.forEach(card => {
                card.style.minHeight = 'calc(100vh - 40px)';
            });
        }
    }
    
    // ì´ˆê¸° ìœ„ì¹˜ ì¡°ì •
    adjustStickyPositions();
    
    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë‹¤ì‹œ ì¡°ì •
    window.addEventListener('resize', adjustStickyPositions);
    
    // Socket.IO ì´ˆê¸°í™”
    if (socketioAvailable) {
        // Socket.IO ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        if (typeof io !== 'undefined') {
            initializeSocketIO();
        } else {
            // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¼
            let attempts = 0;
            const checkIO = setInterval(function() {
                attempts++;
                if (typeof io !== 'undefined') {
                    clearInterval(checkIO);
                    initializeSocketIO();
                } else if (attempts >= 50) {
                    clearInterval(checkIO);
                    console.error('Socket.IO ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    loadRooms();
                }
            }, 100);
        }
    } else {
        loadRooms();
    }
    
    
    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
    document.getElementById('file-input').addEventListener('change', function(e) {
        handleFileSelect(e.target.files);
    });
    
    // ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ (ë¼ì´íŠ¸ë°•ìŠ¤ê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ)
    const lightbox = document.getElementById('image-lightbox');
    if (lightbox) {
        lightbox.addEventListener('wheel', function(e) {
            // ë¼ì´íŠ¸ë°•ìŠ¤ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (!lightbox.classList.contains('active')) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newScale = Math.max(imageZoom.minScale, 
                                     Math.min(imageZoom.maxScale, imageZoom.scale + delta));
            
            // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ
            const rect = lightbox.getBoundingClientRect();
            const mouseX = e.clientX - rect.left - rect.width / 2;
            const mouseY = e.clientY - rect.top - rect.height / 2;
            
            const scaleChange = newScale / imageZoom.scale;
            imageZoom.translateX = imageZoom.translateX * scaleChange + mouseX * (1 - scaleChange);
            imageZoom.translateY = imageZoom.translateY * scaleChange + mouseY * (1 - scaleChange);
            
            imageZoom.scale = newScale;
            updateImageTransform();
        }, { passive: false });
    }
    
    // ì´ë¯¸ì§€ ë“œë˜ê·¸ë¡œ ì´ë™
    const lightboxContent = document.getElementById('image-lightbox-content');
    if (lightboxContent) {
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let startTranslateX = 0;
        let startTranslateY = 0;
        
        lightboxContent.addEventListener('mousedown', function(e) {
            if (e.button === 0 && lightbox.classList.contains('active')) { // ì™¼ìª½ ë§ˆìš°ìŠ¤ ë²„íŠ¼ë§Œ
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                startTranslateX = imageZoom.translateX;
                startTranslateY = imageZoom.translateY;
                lightboxContent.style.cursor = 'grabbing';
                e.preventDefault();
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging && lightbox.classList.contains('active')) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                imageZoom.translateX = startTranslateX + deltaX;
                imageZoom.translateY = startTranslateY + deltaY;
                updateImageTransform();
            }
        });
        
        document.addEventListener('mouseup', function(e) {
            if (isDragging) {
                isDragging = false;
                lightboxContent.style.cursor = 'grab';
            }
        });
        
        // í„°ì¹˜ ì œìŠ¤ì²˜ ì§€ì› (ëª¨ë°”ì¼)
        let touchStartDistance = 0;
        let touchStartScale = 1;
        let touchStartX = 0;
        let touchStartY = 0;
        
        lightboxContent.addEventListener('touchstart', function(e) {
            if (!lightbox.classList.contains('active')) return;
            
            if (e.touches.length === 1) {
                // ë‹¨ì¼ í„°ì¹˜: ì´ë™
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                startTranslateX = imageZoom.translateX;
                startTranslateY = imageZoom.translateY;
            } else if (e.touches.length === 2) {
                // í•€ì¹˜ ì¤Œ
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                touchStartDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                touchStartScale = imageZoom.scale;
            }
        });
        
        lightboxContent.addEventListener('touchmove', function(e) {
            if (!lightbox.classList.contains('active')) return;
            
            e.preventDefault();
            
            if (e.touches.length === 1) {
                // ë‹¨ì¼ í„°ì¹˜: ì´ë™
                const deltaX = e.touches[0].clientX - touchStartX;
                const deltaY = e.touches[0].clientY - touchStartY;
                imageZoom.translateX = startTranslateX + deltaX;
                imageZoom.translateY = startTranslateY + deltaY;
                updateImageTransform();
            } else if (e.touches.length === 2) {
                // í•€ì¹˜ ì¤Œ
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                const scaleChange = currentDistance / touchStartDistance;
                imageZoom.scale = Math.max(imageZoom.minScale, 
                                         Math.min(imageZoom.maxScale, touchStartScale * scaleChange));
                updateImageTransform();
            }
        });
    }
    
    // ============================================
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
    // ============================================
    const chatInputArea = document.getElementById('chat-input-area');
    const dragOverlay = document.getElementById('drag-overlay');
    
    // ìš”ì†Œ ì¡´ì¬ í™•ì¸
    if (!chatInputArea) {
        console.error('chat-input-area ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } else if (!dragOverlay) {
        console.error('drag-overlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } else {
        // ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸
        chatInputArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            chatInputArea.classList.add('drag-over');
            dragOverlay.classList.add('active');
        });
        
        chatInputArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // ë“œë˜ê·¸ê°€ ìì‹ ìš”ì†Œë¡œ ì´ë™í•œ ê²½ìš°ëŠ” ì œì™¸
            if (!chatInputArea.contains(e.relatedTarget)) {
                chatInputArea.classList.remove('drag-over');
                dragOverlay.classList.remove('active');
            }
        });
        
        // ë“œë¡­ ì´ë²¤íŠ¸
        chatInputArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            chatInputArea.classList.remove('drag-over');
            dragOverlay.classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files);
            }
        });
    }
    
    // ì „ì²´ í™”ë©´ ë“œë˜ê·¸ ì˜¤ë²„ (ì±„íŒ… ì˜ì—­ ë°–ì—ì„œë„)
    // chatInputAreaì™€ dragOverlayê°€ ì¡´ì¬í•  ë•Œë§Œ ì²˜ë¦¬
    if (chatInputArea && dragOverlay) {
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            // ì±„íŒ… ì…ë ¥ ì˜ì—­ì´ ë³´ì´ëŠ” ê²½ìš°ì—ë§Œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            if (chatInputArea.style.display !== 'none') {
                dragOverlay.classList.add('active');
            }
        });
        
        document.addEventListener('dragleave', function(e) {
            e.preventDefault();
            // ë“œë˜ê·¸ê°€ ì™„ì „íˆ ë²—ì–´ë‚œ ê²½ìš°
            if (!e.relatedTarget || e.relatedTarget === document.body) {
                dragOverlay.classList.remove('active');
            }
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
            dragOverlay.classList.remove('active');
            
            // ì±„íŒ… ì…ë ¥ ì˜ì—­ì´ ë³´ì´ëŠ” ê²½ìš°ì—ë§Œ íŒŒì¼ ì²˜ë¦¬
            if (chatInputArea.style.display !== 'none' && e.dataTransfer.files.length > 0) {
                const files = e.dataTransfer.files;
                handleFileSelect(files);
            }
        });
    }
});

// ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
function loadRooms() {
    fetch('/api/chat/rooms')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderRooms(data.rooms);
                
                // URL íŒŒë¼ë¯¸í„°ì—ì„œ room_id í™•ì¸ ë° ìë™ ì„ íƒ
                const urlParams = new URLSearchParams(window.location.search);
                const roomIdFromUrl = urlParams.get('room_id');
                
                if (roomIdFromUrl) {
                    const roomId = parseInt(roomIdFromUrl, 10);
                    if (roomId && !isNaN(roomId)) {
                        // ì±„íŒ…ë°©ì´ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
                        const roomExists = data.rooms.some(room => room.id === roomId);
                        if (roomExists) {
                            // ì•½ê°„ì˜ ì§€ì—° í›„ ì„ íƒ (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
                            setTimeout(() => {
                                selectRoom(roomId);
                            }, 100);
                        } else {
                            console.warn(`ì±„íŒ…ë°© ID ${roomId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

// ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
function renderRooms(rooms) {
    const container = document.getElementById('rooms-list');
    
    if (rooms.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }
    
    container.innerHTML = rooms.map(room => {
        const lastMessage = room.last_message ? 
            (room.last_message.content || 'íŒŒì¼') : 'ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤';
        const unreadBadge = room.unread_count > 0 ? 
            `<span class="unread-badge">${room.unread_count}</span>` : '';
        
        return `
            <div class="chat-room-item" onclick="selectRoom(${room.id})" data-room-id="${room.id}">
                <div class="room-name">${escapeHtml(room.name)}</div>
                <div class="room-last-message">${escapeHtml(lastMessage)}</div>
                <div class="room-meta">
                    <span>${formatDate(room.updated_at || room.created_at)}</span>
                    ${unreadBadge}
                </div>
            </div>
        `;
    }).join('');
}

// ì±„íŒ…ë°© ì„ íƒ
function selectRoom(roomId) {
    currentRoomId = roomId;
    
    // URL ì—…ë°ì´íŠ¸ (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ê´€ë¦¬)
    const url = new URL(window.location);
    url.searchParams.set('room_id', roomId);
    window.history.pushState({ room_id: roomId }, '', url);
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('.chat-room-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // null ì²´í¬ ì¶”ê°€
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (roomElement) {
        roomElement.classList.add('active');
    }
    
    // Socket.IO ë°© ì…ì¥ (socketì´ ì¡´ì¬í•  ë•Œë§Œ)
    if (socket && socket.connected) {
        socket.emit('join_room', { room_id: roomId });
    }
    
    // ì±„íŒ…ë°© ìƒì„¸ ì •ë³´ ë¡œë“œ
    loadRoomDetail(roomId);
}

// ì±„íŒ…ë°© ìƒì„¸ ì •ë³´ ë¡œë“œ
function loadRoomDetail(roomId) {
    fetch(`/api/chat/rooms/${roomId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderRoomHeader(data.room);
                renderMessages(data.room.messages);
                document.getElementById('chat-input-area').style.display = 'block';
                updateChatHeader();  // ê²€ìƒ‰ ë²„íŠ¼ í‘œì‹œ
                scrollToBottom();
                
                // ì±„íŒ…ë°© ì…ì¥ ì‹œ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (socket && socket.connected) {
                    socket.emit('mark_read', { room_id: roomId });
                } else {
                    // REST APIë¡œ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
                    fetch(`/api/chat/rooms/${roomId}/mark-read`, {
                        method: 'POST'
                    }).catch(err => console.error('ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err));
                }
            }
        })
        .catch(error => {
            console.error('ì±„íŒ…ë°© ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

// ì±„íŒ…ë°© í—¤ë” ë Œë”ë§
function renderRoomHeader(room) {
    const header = document.getElementById('chat-header');
    const orderWidgetContainer = document.getElementById('chat-order-widget-container');
    let orderWidget = '';
    
    // ì£¼ë¬¸ ì •ë³´ ìœ„ì ¯ (Quest 12) - í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
    if (room.order) {
        const order = room.order;
        
        // ë¯¸ì²˜ë¦¬ í•­ëª© í™•ì¸
        let unprocessedBadges = '';
        const unprocessedItems = [];
        if (!order.manager_name) {
            unprocessedItems.push('<span class="badge bg-danger">ë‹´ë‹¹ì ë¯¸ì§€ì •</span>');
        }
        if (!order.scheduled_date) {
            unprocessedItems.push('<span class="badge bg-danger">ì„¤ì¹˜ì¼ ë¯¸ì§€ì •</span>');
        }
        unprocessedBadges = unprocessedItems.length > 0 
            ? `<div class="unprocessed-badges">${unprocessedItems.join('')}</div>` 
            : '-';
        
        // ìƒíƒœ ì˜µì…˜ ìƒì„±
        const statusList = {
            'RECEIVED': 'ì ‘ìˆ˜',
            'MEASURED': 'ì‹¤ì¸¡',
            'REGIONAL_MEASURED': 'ì§€ë°©ì‹¤ì¸¡',
            'SCHEDULED': 'ì„¤ì¹˜ ì˜ˆì •',
            'SHIPPED_PENDING': 'ìƒì°¨ ì˜ˆì •',
            'COMPLETED': 'ì™„ë£Œ',
            'AS_RECEIVED': 'AS ì ‘ìˆ˜',
            'AS_COMPLETED': 'AS ì™„ë£Œ',
            'ON_HOLD': 'ë³´ë¥˜'
        };
        
        // order.status ê°’ ì •ê·œí™” ë° ë””ë²„ê¹…
        const currentStatus = (order.status || 'RECEIVED').toString().trim().toUpperCase();
        console.log('Order ID:', order.id, 'Current Status:', currentStatus, 'Raw Status:', order.status);
        
        let statusOptions = '';
        for (const [code, name] of Object.entries(statusList)) {
            const codeUpper = code.toUpperCase();
            const selected = (currentStatus === codeUpper) ? 'selected' : '';
            statusOptions += `<option value="${code}" ${selected}>${name}</option>`;
        }
        
        // statusOptionsê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
        if (!statusOptions) {
            console.warn('Status options is empty, using default');
            statusOptions = '<option value="RECEIVED" selected>ì ‘ìˆ˜</option>';
        }
        
        console.log('Generated status options:', statusOptions.substring(0, 200));
        
        orderWidget = `
            <div class="chat-order-widget-table">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0" style="table-layout: auto; width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">ë²ˆí˜¸</th>
                                <th>ê³ ê°ëª…</th>
                                <th>ì£¼ì†Œ</th>
                                <th>ì œí’ˆ</th>
                                <th style="width: 100px;">ìƒíƒœ</th>
                                <th style="width: 100px;">ì‹¤ì¸¡ì¼</th>
                                <th style="width: 150px;">ë¯¸ì²˜ë¦¬ í•­ëª©</th>
                                <th style="width: 120px;">ë‹´ë‹¹ì</th>
                                <th style="width: 140px;">ì„¤ì¹˜ ì˜ˆì •ì¼</th>
                                <th style="width: 80px;">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>#${order.id}</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div>
                                            <div>${escapeHtml(order.customer_name || '-')}</div>
                                            <small class="text-muted">${escapeHtml(order.phone || '-')}</small>
                                        </div>
                                        ${order.blueprint_image_url ? `
                                            <button class="btn btn-sm btn-outline-info" onclick="openBlueprintViewer(${order.id})" title="ë„ë©´ ë³´ê¸°">
                                                <i class="fas fa-drafting-compass"></i> ë„ë©´
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                                <td title="${escapeHtml(order.address || '-')}">
                                    ${escapeHtml(order.address || '-')}
                                </td>
                                <td title="${escapeHtml(order.product || '-')}">
                                    ${escapeHtml(order.product || '-')}
                                </td>
                                <td>
                                    <select class="form-select form-select-sm status-dropdown status-${(currentStatus || 'RECEIVED').toLowerCase().replace(/_/g, '_')}" 
                                            data-order-id="${order.id}" 
                                            data-current-status="${currentStatus || 'RECEIVED'}"
                                            onchange="updateOrderStatus(${order.id}, this.value); if(typeof applyStatusColor === 'function') applyStatusColor(this);">
                                        ${statusOptions || '<option value="RECEIVED" selected>ì ‘ìˆ˜</option>'}
                                    </select>
                                </td>
                                <td>${order.measurement_date || '-'}</td>
                                <td>${unprocessedBadges}</td>
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm" 
                                           value="${escapeHtml(order.manager_name || '')}"
                                           placeholder="ë‹´ë‹¹ì ì…ë ¥"
                                           data-order-id="${order.id}"
                                           data-field="manager_name"
                                           onblur="updateOrderField(${order.id}, 'manager_name', this.value)">
                                </td>
                                <td>
                                    <input type="date" 
                                           class="form-control form-control-sm" 
                                           value="${order.scheduled_date || ''}"
                                           data-order-id="${order.id}"
                                           data-field="scheduled_date"
                                           onchange="updateOrderField(${order.id}, 'scheduled_date', this.value)">
                                </td>
                                <td>
                                    <a href="/edit/${order.id}" 
                                       class="btn btn-sm btn-outline-secondary" 
                                       title="ìˆ˜ì •"
                                       target="_blank">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        orderWidgetContainer.innerHTML = orderWidget;
        orderWidgetContainer.style.display = 'block';
        // order-widget-containerì˜ topì„ chat-header ë†’ì´ë¡œ ì„¤ì •
        const headerHeight = header.offsetHeight;
        orderWidgetContainer.style.top = headerHeight + 'px';
    } else {
        orderWidgetContainer.innerHTML = '';
        orderWidgetContainer.style.display = 'none';
    }
    
    // ë©¤ë²„ ëª©ë¡ í‘œì‹œ
    const membersHtml = room.members ? room.members.map(m => {
        const userName = m.user_name || (m.user ? m.user.name : 'ì•Œ ìˆ˜ ì—†ìŒ');
        return `<span class="badge bg-secondary me-1">${escapeHtml(userName)}</span>`;
    }).join('') : '';
    
    // í—¤ë”ì—ëŠ” ì±„íŒ…ë°© ì •ë³´ì™€ ë²„íŠ¼ë§Œ í‘œì‹œ
    header.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h5 class="mb-0">${escapeHtml(room.name)}</h5>
                ${room.description ? `<small class="text-muted">${escapeHtml(room.description)}</small>` : ''}
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleSearch()" title="ë©”ì‹œì§€ ê²€ìƒ‰">
                    <i class="fas fa-search"></i>
                </button>
                ${room.created_by == currentUserId ? `<button class="btn btn-sm btn-outline-secondary me-1" onclick="showEditRoomNameModal(${room.id}, '${escapeHtml(room.name)}')" title="ì´ë¦„ ìˆ˜ì •">
                    <i class="fas fa-edit"></i>
                </button>` : ''}
                ${!room.order ? `<button class="btn btn-sm btn-outline-info me-1" onclick="showConnectOrderModal(${room.id})" title="ì£¼ë¬¸ ì—°ê²°">
                    <i class="fas fa-link"></i> ì£¼ë¬¸ ì—°ê²°
                </button>` : `<button class="btn btn-sm btn-outline-warning me-1" onclick="disconnectOrder(${room.id})" title="ì£¼ë¬¸ ì—°ê²° í•´ì œ">
                    <i class="fas fa-unlink"></i> ì—°ê²° í•´ì œ
                </button>`}
                <button class="btn btn-sm btn-outline-primary me-1" onclick="showInviteMemberModal(${room.id})" title="ë©¤ë²„ ì´ˆëŒ€">
                    <i class="fas fa-user-plus"></i> ì´ˆëŒ€
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRoom(${room.id})" title="ì±„íŒ…ë°© ì‚­ì œ">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        ${membersHtml ? `<div class="mb-0"><small class="text-muted">ë©¤ë²„: </small>${membersHtml}</div>` : ''}
    `;
}

// ë©”ì‹œì§€ ëª©ë¡ ë Œë”ë§
function renderMessages(messages) {
    const container = document.getElementById('messages-container');
    container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
}

// ë©”ì‹œì§€ ë Œë”ë§
function renderMessage(msg) {
    const isOwn = msg.user_id == currentUserId;
    const className = isOwn ? 'own' : 'other';
    const userName = msg.user_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
    
    let content = '';
    if (msg.message_type === 'text') {
        content = escapeHtml(msg.content || '');
    } else if (msg.attachments && msg.attachments.length > 0) {
        // ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ í•„í„°ë§
        const imageAttachments = msg.attachments.filter(a => a.file_type === 'image');
        const hasMultipleImages = imageAttachments.length > 1;
        
        if (imageAttachments.length > 0) {
            // ì´ë¯¸ì§€ë“¤ ë Œë”ë§ (ë‹¤ìš´ë¡œë“œ ì•„ì´ì½˜ í¬í•¨)
            const imageHtml = imageAttachments.map((attachment, index) => {
                const imageUrl = attachment.url || attachment.storage_url;
                const storageKey = attachment.storage_key || '';
                const filename = attachment.filename || `image_${index + 1}.jpg`;
                
                return `
                    <div class="message-file-image-wrapper">
                        <img src="${attachment.thumbnail_url || imageUrl}" 
                             onclick="openImageLightbox('${imageUrl}')" 
                             style="cursor: zoom-in; max-width: 300px; border-radius: 8px; background-color: white; padding: 4px; display: block;">
                        <button class="chat-image-download-btn" 
                                onclick="downloadChatImage('${storageKey}', '${escapeHtml(filename)}', event)"
                                title="ë‹¤ìš´ë¡œë“œ">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // ì—¬ëŸ¬ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ "ì „ì²´ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ ì¶”ê°€
            const downloadAllBtn = hasMultipleImages ? `
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="downloadAllChatImages(${msg.id}, event)"
                            title="ëª¨ë“  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ">
                        <i class="fas fa-download"></i> ì „ì²´ ë‹¤ìš´ë¡œë“œ (${imageAttachments.length}ê°œ)
                    </button>
                </div>
            ` : '';
            
            content = `<div class="message-file">${imageHtml}${downloadAllBtn}</div>`;
        } else {
            // ì´ë¯¸ì§€ê°€ ì•„ë‹Œ ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬
            const attachment = msg.attachments[0];
            if (attachment.file_type === 'video') {
                const videoUrl = attachment.url || attachment.storage_url;
                const storageKey = attachment.storage_key || '';
                const filename = attachment.filename || 'video.mp4';
                
                content = `
                    <div class="message-file" style="position: relative; display: inline-block;">
                        <video controls style="max-width: 300px;">
                            <source src="${videoUrl}">
                        </video>
                        <button class="chat-image-download-btn" 
                                onclick="downloadChatImage('${storageKey}', '${escapeHtml(filename)}', event)"
                                title="ë‹¤ìš´ë¡œë“œ">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            } else {
                const fileUrl = attachment.url || attachment.storage_url;
                content = `<a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                              <i class="fas fa-download"></i> ${escapeHtml(attachment.filename)}
                           </a>`;
            }
        }
    }
    
    // ì½ìŒ í‘œì‹œ (ì±„ë„í†¡ ìŠ¤íƒ€ì¼ - ì‹¤ì œ ì½ìŒ ìƒíƒœ í™•ì¸)
    let readReceipt = '';
    if (isOwn && msg.read_status) {
        if (msg.read_status === 'no_other_members') {
            // ë‹¤ë¥¸ ë©¤ë²„ê°€ ì—†ìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            readReceipt = '';
        } else if (msg.read_status === 'unread') {
            // ì•„ì§ ì•„ë¬´ë„ ì½ì§€ ì•ŠìŒ
            readReceipt = '<div class="read-receipt" style="color: #999;"><i class="fas fa-check"></i> ì „ì†¡ë¨</div>';
        } else if (msg.read_status === 'all_read') {
            // ëª¨ë‘ ì½ìŒ
            readReceipt = '<div class="read-receipt"><i class="fas fa-check read-icon"></i> ì½ìŒ</div>';
        } else if (msg.read_status === 'some_read') {
            // ì¼ë¶€ ì½ìŒ
            readReceipt = `<div class="read-receipt"><i class="fas fa-check read-icon"></i> ${msg.read_count}/${msg.total_other_members}ëª… ì½ìŒ</div>`;
        }
    }
    
    return `
        <div class="message-item ${className}" data-message-id="${msg.id}">
            <div class="message-bubble">
                ${content}
            </div>
            <div class="message-meta">
                ${!isOwn ? userName + ' Â· ' : ''}${formatDateTime(msg.created_at)}
            </div>
            ${readReceipt}
        </div>
    `;
}

// ë©”ì‹œì§€ ì¶”ê°€ (ì‹¤ì‹œê°„)
function appendMessage(msg) {
    const container = document.getElementById('messages-container');
    
    // ì¤‘ë³µ ë°©ì§€: ë©”ì‹œì§€ IDë¡œ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if (msg.id) {
        const existingMessage = container.querySelector(`[data-message-id="${msg.id}"]`);
        if (existingMessage) {
            console.log('[appendMessage] ì¤‘ë³µ ë©”ì‹œì§€ ìŠ¤í‚µ:', msg.id);
            return; // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©”ì‹œì§€ëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        }
    }
    
    // ë©”ì‹œì§€ ì¶”ê°€
    container.innerHTML += renderMessage(msg);
}

// ë©”ì‹œì§€ ì „ì†¡
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!currentRoomId) {
        alert('ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
    }
    
    if (!message && !previewFile) {
        return;
    }
    
    const messageData = {
        room_id: currentRoomId,
        message_type: previewFile ? previewFile.type : 'text',
        content: message,
        file_info: previewFile ? previewFile.info : null
    };
    
    // Socket.IOê°€ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ REST APIë¡œ ì „ì†¡
    if (socket && socket.connected) {
        socket.emit('send_message', messageData);
    } else {
        // REST APIë¡œ ë©”ì‹œì§€ ì „ì†¡ (í´ë°±)
        fetch('/api/chat/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(messageData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadRoomDetail(currentRoomId);
            } else {
                alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + data.message);
            }
        })
        .catch(error => {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            alert('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    input.value = '';
    removePreview();
}

// íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
let previewFile = null;

function handleFileSelect(files) {
    if (files.length === 0) return;
    
    // ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê²½ê³ 
    if (!currentRoomId) {
        alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const file = files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', currentRoomId);
    
    // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ë° null ì²´í¬
    const preview = document.getElementById('file-preview');
    let content = document.getElementById('preview-content');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
    if (!preview) {
        console.error('file-preview ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        alert('íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // preview-contentê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!content && preview) {
        content = document.createElement('div');
        content.id = 'preview-content';
        preview.appendChild(content);
    }
    
    // chat-input-area í‘œì‹œ ë³´ì¥
    if (chatInputArea && chatInputArea.style.display === 'none') {
        chatInputArea.style.display = 'block';
    }
    
    // contentê°€ ì—¬ì „íˆ nullì´ë©´ previewë¥¼ ì§ì ‘ ì‚¬ìš©
    const finalContent = content || preview;
    finalContent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—…ë¡œë“œ ì¤‘...';
    preview.classList.add('active');
    
    // íŒŒì¼ ì—…ë¡œë“œ
    fetch('/api/chat/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewFile = {
                type: data.file_info.file_type,
                info: data.file_info
            };
            showPreview(data.file_info);
        } else {
            preview.classList.remove('active');
            if (finalContent) finalContent.innerHTML = '';
            alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        preview.classList.remove('active');
        if (finalContent) finalContent.innerHTML = '';
        alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function showPreview(fileInfo) {
    const preview = document.getElementById('file-preview');
    let content = document.getElementById('preview-content');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
    if (!preview) {
        console.error('file-preview ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // preview-contentê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!content && preview) {
        content = document.createElement('div');
        content.id = 'preview-content';
        preview.appendChild(content);
    }
    
    // chat-input-areaê°€ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ í‘œì‹œ
    if (chatInputArea && chatInputArea.style.display === 'none') {
        chatInputArea.style.display = 'block';
    }
    
    // contentê°€ ì—¬ì „íˆ nullì´ë©´ previewë¥¼ ì§ì ‘ ì‚¬ìš©
    const finalContent = content || preview;
    
    // X ë²„íŠ¼ HTML
    const removeBtn = '<button type="button" class="file-remove-btn" onclick="removePreview()" title="íŒŒì¼ ì‚­ì œ">Ã—</button>';
    
    if (fileInfo.file_type === 'image') {
        const imageUrl = fileInfo.thumbnail_url || fileInfo.url || fileInfo.storage_url;
        finalContent.innerHTML = `<div style="position: relative; display: inline-block;">${removeBtn}<img src="${imageUrl}" style="max-width: 200px; background-color: white; padding: 4px; border-radius: 8px; display: block;"></div>`;
    } else if (fileInfo.file_type === 'video') {
        const videoUrl = fileInfo.url || fileInfo.storage_url;
        finalContent.innerHTML = `<div style="position: relative; display: inline-block;">${removeBtn}<video controls style="max-width: 200px; border-radius: 8px; display: block;"><source src="${videoUrl}"></video></div>`;
    } else {
        finalContent.innerHTML = `<div style="position: relative; display: inline-block; padding: 8px 12px; background-color: white; border-radius: 8px; border: 1px solid #ddd;">${removeBtn}<i class="fas fa-file"></i> ${escapeHtml(fileInfo.filename)}</div>`;
    }
    
    preview.classList.add('active');
}

function removePreview() {
    previewFile = null;
    const preview = document.getElementById('file-preview');
    const content = document.getElementById('preview-content');
    
    if (preview) {
        preview.classList.remove('active');
    }
    
    if (content) {
        content.innerHTML = '';
    }
    
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.value = '';
    }
}

// ì±„íŒ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadChatImage(storageKey, filename, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    if (!storageKey) {
        alert('ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ë‹¤ìš´ë¡œë“œ API í˜¸ì¶œ
    const downloadUrl = `/api/chat/download/${encodeURIComponent(storageKey)}`;
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = filename;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ì „ì²´ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadAllChatImages(messageId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // í˜„ì¬ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ ë°ì´í„°ì—ì„œ attachments ì°¾ê¸°
    fetch(`/api/chat/messages/${messageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.message && data.message.attachments) {
                const imageAttachments = data.message.attachments.filter(a => a.file_type === 'image');
                
                if (imageAttachments.length === 0) {
                    alert('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ê° ì´ë¯¸ì§€ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
                imageAttachments.forEach((attachment, index) => {
                    setTimeout(() => {
                        const storageKey = attachment.storage_key || '';
                        const filename = attachment.filename || `image_${index + 1}.jpg`;
                        if (storageKey) {
                            downloadChatImage(storageKey, filename, null);
                        }
                    }, index * 300); // 300ms ê°„ê²©ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
                });
            } else {
                alert('ë©”ì‹œì§€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ë©”ì‹œì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
            alert('ë©”ì‹œì§€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
function loadUsers() {
    fetch('/api/chat/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderUserList(data.users);
            } else {
                document.getElementById('user-select-container').innerHTML = 
                    '<div class="text-center text-muted py-2">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        })
        .catch(error => {
            console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            document.getElementById('user-select-container').innerHTML = 
                '<div class="text-center text-danger py-2">ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        });
}

function renderUserList(users) {
    const container = document.getElementById('user-select-container');
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-2">ì´ˆëŒ€í•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    container.innerHTML = users.map(user => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${user.id}" id="user-${user.id}">
            <label class="form-check-label" for="user-${user.id}">
                ${escapeHtml(user.name)} (${escapeHtml(user.username)})
            </label>
        </div>
    `).join('');
}

// ìƒˆ ì±„íŒ…ë°© ìƒì„±
function showCreateRoomModal() {
    loadUsers();  // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
    clearOrderSelection();  // ì£¼ë¬¸ ì„ íƒ ì´ˆê¸°í™”
    const modal = new bootstrap.Modal(document.getElementById('createRoomModal'));
    modal.show();
}

function createRoom() {
    const name = document.getElementById('room-name').value.trim();
    const description = document.getElementById('room-description').value.trim();
    
    if (!name) {
        alert('ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }
    
    // ì„ íƒëœ ë©¤ë²„ ID ìˆ˜ì§‘
    const selectedUsers = Array.from(document.querySelectorAll('#user-select-container input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));
    
    fetch('/api/chat/rooms', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            description: description,
            member_ids: selectedUsers,  // ë©¤ë²„ ID ë°°ì—´ ì¶”ê°€
            order_id: selectedOrderId || null  // ì£¼ë¬¸ ID ì¶”ê°€
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createRoomModal')).hide();
            document.getElementById('room-name').value = '';
            document.getElementById('room-description').value = '';
            // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
            document.querySelectorAll('#user-select-container input[type="checkbox"]').forEach(cb => cb.checked = false);
            clearOrderSelection();  // ì£¼ë¬¸ ì„ íƒ ì´ˆê¸°í™”
            loadRooms();
            selectRoom(data.room.id);
        } else {
            alert('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì±„íŒ…ë°© ìƒì„± ì˜¤ë¥˜:', error);
        alert('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'ë°©ê¸ˆ';
    if (minutes < 60) return `${minutes}ë¶„ ì „`;
    if (hours < 24) return `${hours}ì‹œê°„ ì „`;
    if (days < 7) return `${days}ì¼ ì „`;
    
    return date.toLocaleDateString('ko-KR');
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

// ì£¼ë¬¸ ìƒì„¸ ë³´ê¸° (Quest 12)
function viewOrderDetail(orderId) {
    window.open(`/edit/${orderId}`, '_blank');
}

// ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateOrderStatus(orderId, newStatus) {
    fetch('/api/update_order_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: orderId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('ì£¼ë¬¸ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // ìƒíƒœ ë“œë¡­ë‹¤ìš´ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
            if (selectElement) {
                // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
                selectElement.classList.remove('status-received', 'status-measured', 'status-regional_measured', 
                                              'status-scheduled', 'status-shipped_pending', 'status-completed', 
                                              'status-as_received', 'status-as_completed', 'status-on_hold');
                // ìƒˆë¡œìš´ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€
                if (newStatus) {
                    selectElement.classList.add('status-' + newStatus.toLowerCase());
                }
                // applyStatusColor í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ
                if (typeof applyStatusColor === 'function') {
                    applyStatusColor(selectElement);
                }
            }
            // ì£¼ë¬¸ì´ ì—°ê²°ëœ ê²½ìš° í—¤ë”ë¥¼ ë‹¤ì‹œ ë Œë”ë§
            if (currentRoomId) {
                loadRoomDetail(currentRoomId);
            }
        } else {
            alert('ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì£¼ë¬¸ í•„ë“œ ì—…ë°ì´íŠ¸ (ë‹´ë‹¹ì, ì„¤ì¹˜ ì˜ˆì •ì¼ ë“±)
function updateOrderField(orderId, field, value) {
    fetch('/api/update_order_field', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: orderId,
            field: field,
            value: value || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`ì£¼ë¬¸ ${field}ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            // ì£¼ë¬¸ì´ ì—°ê²°ëœ ê²½ìš° í—¤ë”ë¥¼ ë‹¤ì‹œ ë Œë”ë§
            if (currentRoomId) {
                loadRoomDetail(currentRoomId);
            }
        } else {
            alert(`ì£¼ë¬¸ ${field} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ` + data.message);
        }
    })
    .catch(error => {
        console.error(`ì£¼ë¬¸ ${field} ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:`, error);
        alert(`ì£¼ë¬¸ ${field} ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
    });
}

// ì£¼ë¬¸ ì—°ê²° ê´€ë ¨ í•¨ìˆ˜ë“¤
let selectedOrderId = null;
let connectRoomId = null;

function searchOrdersForRoom(query) {
    if (!query || query.length < 2) {
        document.getElementById('order-search-results').style.display = 'none';
        return;
    }
    
    fetch(`/api/chat/search-orders?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('order-search-results');
            if (data.success && data.orders.length > 0) {
                resultsDiv.innerHTML = data.orders.map(order => `
                    <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectOrderForRoom(${order.id}, '${escapeHtml(order.customer_name)}', '${escapeHtml(order.product || '-')}')">
                        <strong>ì£¼ë¬¸ #${order.id}</strong> - ${escapeHtml(order.customer_name)}<br>
                        <small class="text-muted">${escapeHtml(order.product || '-')} | ${escapeHtml(order.status || '-')}</small>
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('ì£¼ë¬¸ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        });
}

function selectOrderForRoom(orderId, customerName, product) {
    selectedOrderId = orderId;
    document.getElementById('selected-order').style.display = 'block';
    document.getElementById('selected-order-name').textContent = `ì£¼ë¬¸ #${orderId} - ${customerName} (${product})`;
    document.getElementById('order-search-results').style.display = 'none';
    document.getElementById('order-search').value = '';
}

function clearOrderSelection() {
    selectedOrderId = null;
    document.getElementById('selected-order').style.display = 'none';
    document.getElementById('order-search').value = '';
    document.getElementById('order-search-results').style.display = 'none';
}

function showConnectOrderModal(roomId) {
    connectRoomId = roomId;
    selectedOrderId = null;
    document.getElementById('connect-order-search').value = '';
    document.getElementById('connect-order-results').innerHTML = '<div class="text-center text-muted py-2">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
    const modal = new bootstrap.Modal(document.getElementById('connectOrderModal'));
    modal.show();
}

function searchOrdersForConnect(query) {
    if (!query || query.length < 2) {
        document.getElementById('connect-order-results').innerHTML = '<div class="text-center text-muted py-2">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
        return;
    }
    
    fetch(`/api/chat/search-orders?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('connect-order-results');
            if (data.success && data.orders.length > 0) {
                resultsDiv.innerHTML = data.orders.map(order => `
                    <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="connectOrderToRoom(${order.id}, '${escapeHtml(order.customer_name)}')">
                        <strong>ì£¼ë¬¸ #${order.id}</strong> - ${escapeHtml(order.customer_name)}<br>
                        <small class="text-muted">${escapeHtml(order.product || '-')} | ${escapeHtml(order.status || '-')}</small>
                    </div>
                `).join('');
            } else {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        })
        .catch(error => {
            console.error('ì£¼ë¬¸ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        });
}

function connectOrderToRoom(orderId, customerName) {
    if (!connectRoomId) return;
    
    fetch(`/api/chat/rooms/${connectRoomId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: orderId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('connectOrderModal')).hide();
            loadRoomDetail(connectRoomId);
        } else {
            alert('ì£¼ë¬¸ ì—°ê²° ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì£¼ë¬¸ ì—°ê²° ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function disconnectOrder(roomId) {
    if (!confirm('ì£¼ë¬¸ ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    fetch(`/api/chat/rooms/${roomId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRoomDetail(roomId);
        } else {
            alert('ì£¼ë¬¸ ì—°ê²° í•´ì œ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì£¼ë¬¸ ì—°ê²° í•´ì œ ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì±„íŒ…ë°© ì´ë¦„ ìˆ˜ì •
function showEditRoomNameModal(roomId, currentName) {
    const newName = prompt('ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentName);
    if (!newName || newName.trim() === '' || newName.trim() === currentName) {
        return;
    }
    
    fetch(`/api/chat/rooms/${roomId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: newName.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRoomDetail(roomId);
            loadRooms(); // ì±„íŒ…ë°© ëª©ë¡ë„ ì—…ë°ì´íŠ¸
        } else {
            alert('ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì´ë¦„ ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ì´ë¦„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë©¤ë²„ ì´ˆëŒ€ ê´€ë ¨ í•¨ìˆ˜ë“¤
let inviteRoomId = null;

function showInviteMemberModal(roomId) {
    inviteRoomId = roomId;
    loadUsersForInvite(roomId);
    const modal = new bootstrap.Modal(document.getElementById('inviteMemberModal'));
    modal.show();
}

function loadUsersForInvite(roomId) {
    // í˜„ì¬ ë©¤ë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    fetch(`/api/chat/rooms/${roomId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const currentMemberIds = data.room.members.map(m => m.user_id);
                loadUsersForInviteList(currentMemberIds);
            } else {
                document.getElementById('invite-user-select-container').innerHTML = 
                    '<div class="text-center text-danger py-2">ì±„íŒ…ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        })
        .catch(error => {
            console.error('ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            document.getElementById('invite-user-select-container').innerHTML = 
                '<div class="text-center text-danger py-2">ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        });
}

function loadUsersForInviteList(excludeIds) {
    fetch('/api/chat/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ì´ë¯¸ ë©¤ë²„ì¸ ì‚¬ìš©ì ì œì™¸
                const availableUsers = data.users.filter(u => !excludeIds.includes(u.id));
                renderInviteUserList(availableUsers);
            } else {
                document.getElementById('invite-user-select-container').innerHTML = 
                    '<div class="text-center text-danger py-2">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        })
        .catch(error => {
            console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            document.getElementById('invite-user-select-container').innerHTML = 
                '<div class="text-center text-danger py-2">ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        });
}

function renderInviteUserList(users) {
    const container = document.getElementById('invite-user-select-container');
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-2">ì´ˆëŒ€í•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    container.innerHTML = users.map(user => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${user.id}" id="invite-user-${user.id}">
            <label class="form-check-label" for="invite-user-${user.id}">
                ${escapeHtml(user.name)} (${escapeHtml(user.username)})
            </label>
        </div>
    `).join('');
}

function inviteMembers() {
    if (!inviteRoomId) {
        alert('ì±„íŒ…ë°© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const selectedUsers = Array.from(document.querySelectorAll('#invite-user-select-container input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));
    
    if (selectedUsers.length === 0) {
        alert('ì´ˆëŒ€í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
    }
    
    // ì—¬ëŸ¬ ì‚¬ìš©ìë¥¼ í•œ ë²ˆì— ì´ˆëŒ€
    Promise.all(selectedUsers.map(userId => 
        fetch(`/api/chat/rooms/${inviteRoomId}/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId })
        })
    ))
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(results => {
        const failed = results.filter(r => !r.success);
        const successCount = results.length - failed.length;
        
        if (failed.length > 0) {
            alert(`${successCount}ëª… ì´ˆëŒ€ ì™„ë£Œ. ${failed.length}ëª… ì‹¤íŒ¨: ${failed.map(f => f.message).join(', ')}`);
        } else {
            alert(`${successCount}ëª…ì´ ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        bootstrap.Modal.getInstance(document.getElementById('inviteMemberModal')).hide();
        // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
        document.querySelectorAll('#invite-user-select-container input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // ì±„íŒ…ë°© ì •ë³´ ìƒˆë¡œê³ ì¹¨
        if (currentRoomId === inviteRoomId) {
            loadRoomDetail(inviteRoomId);
        }
        loadRooms();
    })
    .catch(error => {
        console.error('ë©¤ë²„ ì´ˆëŒ€ ì˜¤ë¥˜:', error);
        alert('ë©¤ë²„ ì´ˆëŒ€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì±„íŒ…ë°© ì‚­ì œ í•¨ìˆ˜
function deleteRoom(roomId) {
    if (!confirm('ì •ë§ ì´ ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ë©”ì‹œì§€ì™€ íŒŒì¼ì´ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    fetch(`/api/chat/rooms/${roomId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            currentRoomId = null;
            document.getElementById('chat-header').innerHTML = '<div class="text-center text-muted py-4" style="flex: 1;">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</div><button class="btn btn-sm btn-outline-secondary" onclick="toggleSearch()" title="ë©”ì‹œì§€ ê²€ìƒ‰" style="display: none;" id="search-btn"><i class="fas fa-search"></i></button>';
            document.getElementById('chat-order-widget-container').innerHTML = '';
            document.getElementById('chat-order-widget-container').style.display = 'none';
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('chat-input-area').style.display = 'none';
            loadRooms();
        } else {
            alert('ì±„íŒ…ë°© ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        console.error('ì±„íŒ…ë°© ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì±„íŒ…ë°© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì±„ë„í†¡ ìŠ¤íƒ€ì¼ ì¶”ê°€ ê¸°ëŠ¥

// íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
let typingTimeout = null;
let typingUsers = {};

function handleTyping() {
    if (!currentRoomId || !socket || !socket.connected) return;
    
    // íƒ€ì´í•‘ ì¤‘ ì´ë²¤íŠ¸ ì „ì†¡
    socket.emit('typing', {
        room_id: currentRoomId,
        is_typing: true
    });
    
    // 3ì´ˆ í›„ íƒ€ì´í•‘ ì¤‘ì§€
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        if (socket && socket.connected) {
            socket.emit('typing', {
                room_id: currentRoomId,
                is_typing: false
            });
        }
    }, 3000);
}

function showTypingIndicator(userId, isTyping) {
    const container = document.getElementById('messages-container');
    let indicator = document.getElementById('typing-indicator');
    
    if (isTyping) {
        typingUsers[userId] = true;
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'typing-indicator';
            container.appendChild(indicator);
        }
        // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨íˆ ì²˜ë¦¬)
        indicator.textContent = 'ì…ë ¥ ì¤‘...';
    } else {
        delete typingUsers[userId];
        if (Object.keys(typingUsers).length === 0 && indicator) {
            indicator.remove();
        }
    }
}

// ë©”ì‹œì§€ ê²€ìƒ‰ ê¸°ëŠ¥
function toggleSearch() {
    const searchDiv = document.getElementById('message-search');
    if (searchDiv.style.display === 'none') {
        searchDiv.style.display = 'block';
        document.getElementById('search-input').focus();
    } else {
        closeSearch();
    }
}

function closeSearch() {
    document.getElementById('message-search').style.display = 'none';
    document.getElementById('search-input').value = '';
    // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
    if (currentRoomId) {
        loadRoomDetail(currentRoomId);
    }
}

function searchMessages(query) {
    if (!currentRoomId || !query.trim()) {
        return;
    }
    
    // ê°„ë‹¨í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²€ìƒ‰
    const messages = document.querySelectorAll('.message-item');
    messages.forEach(msg => {
        const text = msg.textContent.toLowerCase();
        if (text.includes(query.toLowerCase())) {
            msg.style.backgroundColor = '#fff3cd';
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            msg.style.backgroundColor = '';
        }
    });
}

// ì „ì—­ ê²€ìƒ‰ ê¸°ëŠ¥
function performGlobalSearch(query) {
    const resultsDiv = document.getElementById('global-search-results');
    const roomsList = document.getElementById('rooms-list');
    
    if (!query || query.length < 2) {
        resultsDiv.style.display = 'none';
        roomsList.style.display = 'block';
        return;
    }
    
    fetch(`/api/chat/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                resultsDiv.innerHTML = data.results.map(result => {
                    let html = '';
                    if (result.type === 'message') {
                        const contentPreview = result.content ? escapeHtml(result.content.substring(0, 50)) + (result.content.length > 50 ? '...' : '') : 'ë©”ì‹œì§€';
                        html = `
                            <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectRoomAndHighlight(${result.room_id}, ${result.message_id})">
                                <strong>${escapeHtml(result.room_name || 'ì•Œ ìˆ˜ ì—†ìŒ')}</strong><br>
                                <small>ë©”ì‹œì§€: ${contentPreview}</small><br>
                                <small class="text-muted">${escapeHtml(result.user_name || 'ì•Œ ìˆ˜ ì—†ìŒ')} | ${result.created_at || ''}</small>
                            </div>
                        `;
                    } else if (result.type === 'room') {
                        html = `
                            <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectRoom(${result.room_id})">
                                <strong>ì±„íŒ…ë°©: ${escapeHtml(result.room_name)}</strong>
                                ${result.description ? `<br><small class="text-muted">${escapeHtml(result.description)}</small>` : ''}
                            </div>
                        `;
                    } else if (result.type === 'order') {
                        html = `
                            <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectRoom(${result.room_id})">
                                <strong>${escapeHtml(result.room_name || 'ì•Œ ìˆ˜ ì—†ìŒ')}</strong><br>
                                <small>ì£¼ë¬¸ #${result.order_id}: ${escapeHtml(result.customer_name || '-')} | ${escapeHtml(result.phone || '-')} | ${escapeHtml(result.address || '-')}</small>
                            </div>
                        `;
                    }
                    return html;
                }).join('');
                resultsDiv.style.display = 'block';
                roomsList.style.display = 'none';
            } else {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                resultsDiv.style.display = 'block';
                roomsList.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('ì „ì²´ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            resultsDiv.innerHTML = '<div class="text-center text-danger py-2">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            resultsDiv.style.display = 'block';
        });
}

function selectRoomAndHighlight(roomId, messageId) {
    selectRoom(roomId);
    setTimeout(() => {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            messageElement.style.backgroundColor = '#fff3cd';
            setTimeout(() => {
                messageElement.style.backgroundColor = '';
            }, 3000);
        }
    }, 500);
}

// ì±„íŒ…ë°© í—¤ë”ì— ê²€ìƒ‰ ë²„íŠ¼ í‘œì‹œ
function updateChatHeader() {
    const searchBtn = document.getElementById('search-btn');
    if (currentRoomId && searchBtn) {
        searchBtn.style.display = 'block';
    } else if (searchBtn) {
        searchBtn.style.display = 'none';
    }
}
</script>
