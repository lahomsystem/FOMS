// 파일 미리보기
let previewFile = null;

function handleFileSelect(files) {
    if (files.length === 0) return;
    
    // 채팅방이 선택되지 않았으면 경고
    if (!currentRoomId) {
        alert('채팅방을 먼저 선택해주세요.');
        return;
    }
    
    const file = files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', currentRoomId);
    
    // 요소 가져오기 및 null 체크
    const preview = document.getElementById('file-preview');
    let content = document.getElementById('preview-content');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // 요소가 없으면 에러 처리
    if (!preview) {
        console.error('file-preview 요소를 찾을 수 없습니다.');
        alert('파일 미리보기 영역을 찾을 수 없습니다.');
        return;
    }
    
    // preview-content가 없으면 생성
    if (!content && preview) {
        content = document.createElement('div');
        content.id = 'preview-content';
        preview.appendChild(content);
    }
    
    // chat-input-area 표시 보장
    if (chatInputArea && chatInputArea.style.display === 'none') {
        chatInputArea.style.display = 'block';
    }
    
    // content가 여전히 null이면 preview를 직접 사용
    const finalContent = content || preview;
    finalContent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 업로드 중...';
    preview.classList.add('active');
    
    // 파일 업로드
    fetch('/api/chat/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewFile = {
                type: data.file_info.file_type,
                info: data.file_info
            };
            showPreview(data.file_info);
        } else {
            preview.classList.remove('active');
            if (finalContent) finalContent.innerHTML = '';
            alert('파일 업로드 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('파일 업로드 오류:', error);
        preview.classList.remove('active');
        if (finalContent) finalContent.innerHTML = '';
        alert('파일 업로드 중 오류가 발생했습니다.');
    });
}

function showPreview(fileInfo) {
    const preview = document.getElementById('file-preview');
    let content = document.getElementById('preview-content');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // 요소가 없으면 에러 처리
    if (!preview) {
        console.error('file-preview 요소를 찾을 수 없습니다.');
        return;
    }
    
    // preview-content가 없으면 생성
    if (!content && preview) {
        content = document.createElement('div');
        content.id = 'preview-content';
        preview.appendChild(content);
    }
    
    // chat-input-area가 숨겨져 있으면 표시
    if (chatInputArea && chatInputArea.style.display === 'none') {
        chatInputArea.style.display = 'block';
    }
    
    // content가 여전히 null이면 preview를 직접 사용
    const finalContent = content || preview;
    
    // X 버튼 HTML
    const removeBtn = '<button type="button" class="file-remove-btn" onclick="removePreview()" title="파일 삭제">×</button>';
    
    if (fileInfo.file_type === 'image') {
        const imageUrl = fileInfo.thumbnail_url || fileInfo.url || fileInfo.storage_url;
        finalContent.innerHTML = `<div style="position: relative; display: inline-block;">${removeBtn}<img src="${imageUrl}" style="max-width: 200px; background-color: white; padding: 4px; border-radius: 8px; display: block;"></div>`;
    } else if (fileInfo.file_type === 'video') {
        const videoUrl = fileInfo.url || fileInfo.storage_url;
        finalContent.innerHTML = `<div style="position: relative; display: inline-block;">${removeBtn}<video controls style="max-width: 200px; border-radius: 8px; display: block;"><source src="${videoUrl}"></video></div>`;
    } else {
        finalContent.innerHTML = `<div style="position: relative; display: inline-block; padding: 8px 12px; background-color: white; border-radius: 8px; border: 1px solid #ddd;">${removeBtn}<i class="fas fa-file"></i> ${escapeHtml(fileInfo.filename)}</div>`;
    }
    
    preview.classList.add('active');
}

function removePreview() {
    previewFile = null;
    const preview = document.getElementById('file-preview');
    const content = document.getElementById('preview-content');
    
    if (preview) {
        preview.classList.remove('active');
    }
    
    if (content) {
        content.innerHTML = '';
    }
    
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.value = '';
    }
}

// 채팅 이미지 다운로드 함수
function downloadChatImage(storageKey, filename, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    if (!storageKey) {
        alert('다운로드할 수 없습니다. 파일 정보가 없습니다.');
        return;
    }
    
    // 다운로드 API 호출
    const downloadUrl = `/api/chat/download/${encodeURIComponent(storageKey)}`;
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = filename;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 전체 이미지 다운로드 함수
function downloadAllChatImages(messageId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // 현재 채팅방의 메시지 데이터에서 attachments 찾기
    fetch(`/api/chat/messages/${messageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.message && data.message.attachments) {
                const imageAttachments = data.message.attachments.filter(a => a.file_type === 'image');
                
                if (imageAttachments.length === 0) {
                    alert('다운로드할 이미지가 없습니다.');
                    return;
                }
                
                // 각 이미지를 순차적으로 다운로드
                imageAttachments.forEach((attachment, index) => {
                    setTimeout(() => {
                        const storageKey = attachment.storage_key || '';
                        const filename = attachment.filename || `image_${index + 1}.jpg`;
                        if (storageKey) {
                            downloadChatImage(storageKey, filename, null);
                        }
                    }, index * 300); // 300ms 간격으로 다운로드
                });
            } else {
                alert('메시지 정보를 가져올 수 없습니다.');
            }
        })
        .catch(error => {
            console.error('메시지 조회 오류:', error);
            alert('메시지 정보를 가져오는 중 오류가 발생했습니다.');
        });
}
