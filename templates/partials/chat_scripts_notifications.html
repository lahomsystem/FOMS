// ============================================
// ì±„íŒ… ì•Œë¦¼ íŒì—… ê´€ë¦¬ (ì±„ë„í†¡ ìŠ¤íƒ€ì¼)
// ============================================
let notificationStack = [];
const MAX_NOTIFICATIONS = 5;
const NOTIFICATION_DURATION = 5000; // 5ì´ˆ
let notificationIds = new Set(); // ì¤‘ë³µ ë°©ì§€ìš©

function showChatNotification(messageData, roomData) {
    // í˜„ì¬ ì±„íŒ…ë°©ì´ë©´ ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨
    if (messageData.room_id == currentRoomId) {
        return;
    }
    
    // ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨
    if (messageData.user_id == currentUserId) {
        return;
    }
    
    // ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€: ê°™ì€ ë©”ì‹œì§€ IDëŠ” í•œ ë²ˆë§Œ í‘œì‹œ
    const messageId = messageData.id || (messageData.room_id + '_' + messageData.created_at);
    if (notificationIds.has(messageId)) {
        return;
    }
    notificationIds.add(messageId);
    
    // ì•Œë¦¼ ìŠ¤íƒì— ì¶”ê°€
    const notificationId = 'notification-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    const notification = {
        id: notificationId,
        message: messageData,
        room: roomData,
        timestamp: new Date(),
        messageId: messageId
    };
    
    notificationStack.push(notification);
    
    // ìµœëŒ€ ê°œìˆ˜ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ì•Œë¦¼ ì œê±°
    if (notificationStack.length > MAX_NOTIFICATIONS) {
        const oldest = notificationStack.shift();
        closeNotification(oldest.id);
        if (oldest.messageId) {
            notificationIds.delete(oldest.messageId);
        }
    }
    
    // ì•Œë¦¼ DOM ìƒì„±
    const container = document.getElementById('chat-notification-container');
    if (!container) {
        console.error('ì•Œë¦¼ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const notificationEl = createNotificationElement(notification);
    container.appendChild(notificationEl);
    
    // ìë™ ë‹«ê¸° íƒ€ì´ë¨¸
    const autoCloseTimer = setTimeout(() => {
        closeNotification(notificationId);
        if (messageId) {
            notificationIds.delete(messageId);
        }
    }, NOTIFICATION_DURATION);
    
    // ì•Œë¦¼ ìš”ì†Œì— íƒ€ì´ë¨¸ ID ì €ì¥
    notificationEl.dataset.timerId = autoCloseTimer;
    
    // í´ë¦­ ì´ë²¤íŠ¸: í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
    notificationEl.addEventListener('click', function(e) {
        if (!e.target.classList.contains('chat-notification-close') && 
            !e.target.closest('.chat-notification-close')) {
            closeNotification(notificationId);
            if (messageId) {
                notificationIds.delete(messageId);
            }
            if (roomData && roomData.id) {
                selectRoom(roomData.id);
                window.focus();
            }
        }
    });
}

// showChatNotification í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (layout.htmlì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
window.showChatNotification = showChatNotification;

function createNotificationElement(notification) {
    const { message, room } = notification;
    const senderName = message.user_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
    const roomName = room ? room.name : 'ì•Œ ìˆ˜ ì—†ëŠ” ì±„íŒ…ë°©';
    const senderInitial = senderName.charAt(0).toUpperCase();
    
    // ë©”ì‹œì§€ ë‚´ìš© ì¶”ì¶œ
    let messageContent = '';
    let hasAttachment = false;
    
    if (message.message_type === 'text') {
        messageContent = escapeHtml(message.content || '(ë©”ì‹œì§€ ì—†ìŒ)');
    } else if (message.attachments && message.attachments.length > 0) {
        const attachment = message.attachments[0];
        hasAttachment = true;
        if (attachment.file_type === 'image') {
            messageContent = 'ğŸ“· ì´ë¯¸ì§€';
        } else if (attachment.file_type === 'video') {
            messageContent = 'ğŸ“¥ ë™ì˜ìƒ';
        } else {
            messageContent = 'ğŸ“ ' + escapeHtml(attachment.filename || 'íŒŒì¼');
        }
    } else {
        messageContent = '(ë‚´ìš© ì—†ìŒ)';
    }
    
    // ì‹œê°„ í¬ë§·
    const timeStr = formatNotificationTime(message.created_at);
    
    const notificationEl = document.createElement('div');
    notificationEl.className = 'chat-notification';
    notificationEl.id = notification.id;
    notificationEl.dataset.roomId = message.room_id;
    
    let attachmentHtml = '';
    if (hasAttachment && message.attachments && message.attachments[0]) {
        const attachment = message.attachments[0];
        if (attachment.file_type === 'image' && attachment.thumbnail_url) {
            attachmentHtml = `<img src="${attachment.thumbnail_url}" class="chat-notification-image" alt="ì´ë¯¸ì§€">`;
        } else {
            const fileIcon = attachment.file_type === 'video' ? 'fa-video' : 'fa-file';
            attachmentHtml = `
                <div class="chat-notification-file">
                    <i class="fas ${fileIcon} chat-notification-file-icon"></i>
                    <span class="chat-notification-file-name">${escapeHtml(attachment.filename || 'íŒŒì¼')}</span>
                </div>
            `;
        }
    }
    
    notificationEl.innerHTML = `
        <div class="chat-notification-header">
            <h6 class="chat-notification-room-name">${escapeHtml(roomName)}</h6>
            <button class="chat-notification-close" type="button" aria-label="ë‹«ê¸°">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-notification-content">
            <div class="chat-notification-avatar">${senderInitial}</div>
            <div class="chat-notification-body">
                <div class="chat-notification-sender">${escapeHtml(senderName)}</div>
                <div class="chat-notification-message">${messageContent}</div>
                ${attachmentHtml}
                <div class="chat-notification-time">${timeStr}</div>
            </div>
        </div>
    `;
    
    // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€ (ì¸ë¼ì¸ onclick ëŒ€ì‹ )
    const closeBtn = notificationEl.querySelector('.chat-notification-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            closeNotification(notification.id);
            if (notification.messageId) {
                notificationIds.delete(notification.messageId);
            }
        });
    }
    
    return notificationEl;
}

function closeNotification(notificationId) {
    const notificationEl = document.getElementById(notificationId);
    if (!notificationEl) {
        return;
    }
    
    // íƒ€ì´ë¨¸ ì·¨ì†Œ
    const timerId = notificationEl.dataset.timerId;
    if (timerId) {
        clearTimeout(parseInt(timerId));
    }
    
    // messageId ì œê±°
    const notification = notificationStack.find(n => n.id === notificationId);
    if (notification && notification.messageId) {
        notificationIds.delete(notification.messageId);
    }
    
    // ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜
    notificationEl.classList.add('closing');
    
    setTimeout(() => {
        notificationEl.remove();
        // ìŠ¤íƒì—ì„œë„ ì œê±°
        notificationStack = notificationStack.filter(n => n.id !== notificationId);
    }, 300);
}

function formatNotificationTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    
    if (minutes < 1) return 'ë°©ê¸ˆ ì „';
    if (minutes < 60) return `${minutes}ë¶„ ì „`;
    if (hours < 24) return `${hours}ì‹œê°„ ì „`;
    
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}
