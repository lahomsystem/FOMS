{% extends "layout.html" %}

{% block content %}
{% set filters = filters or {} %}
<div class="container-fluid erp-dashboard erp-pro" data-can-edit-erp="{{ 'true' if can_edit_erp|default(false) else 'false' }}">
  <script>
    const MY_ID = "{{ current_user.id }}";
    const MY_TEAM = "{{ current_user.team }}";
    const MY_NAME = "{{ current_user.name }}";
    const MY_ROLE = "{{ current_user.role }}";
  </script>
  <!-- Modern Header -->
  <header class="erp-pro-header">
    <h1 class="erp-pro-header__title">
      <i class="fas fa-layer-group"></i>
      <span>ERP 프로세스 대시보드</span>
    </h1>
    <div class="erp-pro-header__actions">
      <!-- 알림 버튼 -->

      <a class="erp-pro-btn erp-pro-btn--primary" href="{{ url_for('order_pages.add_order', open='erp-beta') }}">
        <i class="fas fa-plus"></i>
        <span>주문 생성</span>
      </a>
      <a class="erp-pro-btn erp-pro-btn--secondary" href="{{ url_for('order_pages.index') }}">
        <i class="fas fa-home"></i>
        <span class="d-none d-md-inline">홈</span>
      </a>
    </div>
  </header>
  {% set erp_sub_nav_active = 'dashboard' %}
  {% include 'partials/erp_sub_nav.html' %}

  <!-- Process Map - Modern Pipeline Design -->
  <div class="erp-pro-card">
    <div class="erp-pro-card__header erp-pro-card__header--with-alerts">
      <h3 class="erp-pro-card__title">
        <i class="fas fa-project-diagram"></i>
        프로세스 맵
      </h3>
      <div class="erp-pro-alerts">
        <div
          class="erp-pro-alert erp-pro-alert--danger {% if filters.get('alert_type') == 'urgent' %}erp-pro-alert--active{% endif %}"
          data-alert-type="urgent" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-bolt"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">긴급 발주</span>
            <span class="erp-pro-alert__value">{{ kpis.urgent_count }}</span>
          </div>
        </div>
        <div
          class="erp-pro-alert erp-pro-alert--warning {% if filters.get('alert_type') == 'measurement_d4' %}erp-pro-alert--active{% endif %}"
          data-alert-type="measurement_d4" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-ruler-combined"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">실측 D-4</span>
            <span class="erp-pro-alert__value">{{ kpis.measurement_d4_count }}</span>
          </div>
        </div>
        <div
          class="erp-pro-alert erp-pro-alert--warning {% if filters.get('alert_type') == 'construction_d3' %}erp-pro-alert--active{% endif %}"
          data-alert-type="construction_d3" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-tools"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">시공 D-3</span>
            <span class="erp-pro-alert__value">{{ kpis.construction_d3_count }}</span>
          </div>
        </div>
        <div
          class="erp-pro-alert erp-pro-alert--info {% if filters.get('alert_type') == 'production_d2' %}erp-pro-alert--active{% endif %}"
          data-alert-type="production_d2" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-industry"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">생산 D-2</span>
            <span class="erp-pro-alert__value">{{ kpis.production_d2_count }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="erp-pro-card__body">
      <div class="erp-pro-pipeline">
        {% for step in process_steps %}
        {% set is_step_active = (filters.get('stage') or '') == step.label %}
        <div class="erp-pro-pipeline__stage {% if is_step_active %}erp-pro-pipeline__stage--active{% endif %}"
          data-stage="{{ step.label }}" role="button" tabindex="0" title="클릭하면 '{{ step.label }}' 단계만 표시">
          <div class="erp-pro-pipeline__count">
            {{ step.count }}
            {% if step.overdue > 0 %}
            <span class="erp-pro-badge erp-pro-badge--danger erp-pro-badge--sm" title="지연">{{ step.overdue }}</span>
            {% endif %}
            {% if step.imminent > 0 %}
            <span class="erp-pro-badge erp-pro-badge--warning erp-pro-badge--sm" title="임박">{{ step.imminent }}</span>
            {% endif %}
          </div>
          <div class="erp-pro-pipeline__label">{{ step.label }}</div>
        </div>
        {% if not loop.last %}
        <div class="erp-pro-pipeline__connector">
          <i class="fas fa-chevron-right"></i>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 3-Panel Layout -->
  {% include 'partials/erp_dashboard_styles.html' %}

  <div class="erp-dashboard-layout">
    {% include 'partials/erp_dashboard_filters.html' %}
    {% include 'partials/erp_dashboard_grid.html' %}

  </div>

  {% include 'partials/erp_dashboard_modals.html' %}

  <div id="erp-dashboard-config" data-team-labels="{{ team_labels|tojson|e }}" data-stage-labels="{{ stage_labels|tojson|e }}" style="display:none" aria-hidden="true"></div>
  {% include 'partials/erp_dashboard_scripts.html' %}


      <!-- 알림 패널 -->
      <div id="notification-panel" class="notification-panel" style="display: none;">
        <div class="notification-panel__header">
          <h4><i class="fas fa-bell"></i> 알림</h4>
          <button class="notification-panel__close" onclick="toggleNotificationPanel()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="notification-panel__actions">
          <button class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsRead()">
            <i class="fas fa-check-double"></i> 모두 읽음
          </button>
        </div>
        <div class="notification-panel__list" id="notification-list">
          <div class="notification-empty">알림이 없습니다.</div>
        </div>
      </div>

      <style>
        /* 도면 수정 창구 이미지 뷰어 (채널톡 스타일) */
        #drawing-gateway-image-viewer {
          position: fixed;
          inset: 0;
          z-index: 20000;
        }

        #drawing-gateway-viewer-backdrop {
          position: absolute;
          inset: 0;
          background: rgba(10, 14, 22, 0.45);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
        }

        #drawing-gateway-viewer-close {
          position: absolute;
          top: 16px;
          right: 16px;
          width: 42px;
          height: 42px;
          border-radius: 50%;
          border: 0;
          background: rgba(255, 255, 255, 0.12);
          color: #fff;
          z-index: 3;
        }

        .drawing-gateway-viewer-nav {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          width: 48px;
          height: 48px;
          border-radius: 999px;
          border: 0;
          background: rgba(255, 255, 255, 0.15);
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 3;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.16s ease, transform 0.16s ease;
        }

        #drawing-gateway-image-viewer.gateway-nav-visible .drawing-gateway-viewer-nav {
          opacity: 1;
          pointer-events: auto;
          transform: translateY(-50%) scale(1);
        }

        #drawing-gateway-viewer-prev {
          left: 18px;
        }

        #drawing-gateway-viewer-next {
          right: 18px;
        }

        @media (hover: none) {
          #drawing-gateway-image-viewer.gateway-has-multiple .drawing-gateway-viewer-nav {
            opacity: 1;
            pointer-events: auto;
          }
        }

        #drawing-gateway-viewer-stage {
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          cursor: default;
          z-index: 2;
          touch-action: none;
        }

        #drawing-gateway-viewer-image {
          max-width: 90vw;
          max-height: 82vh;
          width: auto;
          height: auto;
          object-fit: contain;
          user-select: none;
          border: none;
          box-shadow: none;
          transform-origin: center center;
          transition: transform 0.08s ease-out;
        }

        #drawing-gateway-viewer-zoom-badge {
          position: absolute;
          top: 18px;
          left: 18px;
          padding: 4px 8px;
          font-size: 12px;
          color: #fff;
          border-radius: 6px;
          background: rgba(0, 0, 0, 0.45);
          display: none;
          z-index: 3;
        }

        #drawing-gateway-viewer-footer {
          position: absolute;
          bottom: 16px;
          left: 50%;
          transform: translateX(-50%);
          min-width: 280px;
          max-width: 80vw;
          padding: 8px 14px;
          border-radius: 10px;
          background: rgba(20, 24, 33, 0.55);
          color: #fff;
          text-align: center;
          z-index: 3;
        }

        #drawing-gateway-viewer-filename {
          font-size: 13px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        #drawing-gateway-viewer-counter {
          font-size: 12px;
          opacity: 0.85;
          margin-top: 2px;
        }

        .drawing-gateway-thumb-wrap {
          width: 112px;
        }

        .drawing-gateway-thumb {
          width: 110px;
          height: 84px;
          border-radius: 8px;
          overflow: hidden;
          border: 1px solid #e6e9ef;
          cursor: zoom-in;
          background: #fff;
        }

        .drawing-gateway-thumb img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }

        /* 알림 배지 */
        .notification-badge {
          position: absolute;
          top: -5px;
          right: -5px;
          background: #ff4757;
          color: white;
          font-size: 10px;
          font-weight: bold;
          padding: 2px 6px;
          border-radius: 10px;
          min-width: 18px;
          text-align: center;
        }

        .erp-pro-btn--icon {
          position: relative;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(255, 255, 255, 0.1);
          border: none;
          color: white;
          cursor: pointer;
          transition: all 0.2s;
        }

        .erp-pro-btn--icon:hover {
          background: rgba(255, 255, 255, 0.2);
        }

        /* 알림 패널 */
        .notification-panel {
          position: fixed;
          top: 70px;
          right: 20px;
          width: 380px;
          max-height: 500px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
          z-index: 9999;
          overflow: hidden;
        }

        .notification-panel__header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 16px 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .notification-panel__header h4 {
          margin: 0;
          font-size: 16px;
        }

        .notification-panel__close {
          background: none;
          border: none;
          color: white;
          font-size: 18px;
          cursor: pointer;
          opacity: 0.8;
        }

        .notification-panel__close:hover {
          opacity: 1;
        }

        .notification-panel__actions {
          padding: 10px 20px;
          border-bottom: 1px solid #eee;
          text-align: right;
        }

        .notification-panel__list {
          max-height: 380px;
          overflow-y: auto;
        }

        .notification-item {
          padding: 14px 20px;
          border-bottom: 1px solid #f0f0f0;
          cursor: pointer;
          transition: background 0.2s;
        }

        .notification-item:hover {
          background: #f8f9fa;
        }

        .notification-item--unread {
          background: #f0f5ff;
          border-left: 3px solid #667eea;
        }

        .notification-item__header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
        }

        .notification-item__title {
          font-weight: 600;
          color: #333;
          font-size: 14px;
        }

        .notification-item__time {
          font-size: 11px;
          color: #999;
        }

        .notification-item__message {
          font-size: 13px;
          color: #666;
          line-height: 1.4;
        }

        .notification-item__target {
          margin-top: 6px;
          font-size: 11px;
          color: #667eea;
        }

        .notification-empty {
          padding: 40px 20px;
          text-align: center;
          color: #999;
        }
      </style>

      <script>
        // 알림 시스템 JavaScript
        let notificationPanelOpen = false;

        async function loadNotificationBadge() {
          try {
            const res = await fetch('/erp/api/notifications/badge');
            if (!res.ok) return;
            const contentType = res.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) return;
            const data = await res.json();
            const badge = document.getElementById('notification-badge');
            if (badge) {
              if (data.count > 0) {
                badge.textContent = data.count > 99 ? '99+' : data.count;
                badge.style.display = 'block';
              } else {
                badge.style.display = 'none';
              }
            }
          } catch (e) {
            console.error('Notification badge error:', e);
          }
        }

        async function loadNotifications() {
          const list = document.getElementById('notification-list');
          try {
            const res = await fetch('/erp/api/notifications?limit=20');
            if (!res.ok) {
              if (res.status === 429 && list) {
                list.innerHTML = '<div class="notification-empty">요청이 많아 잠시 후 다시 시도해 주세요.</div>';
              }
              return;
            }
            const contentType = res.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
              if (list) list.innerHTML = '<div class="notification-empty">알림을 불러올 수 없습니다.</div>';
              return;
            }
            const data = await res.json();

            if (!data.success || !data.notifications || data.notifications.length === 0) {
              list.innerHTML = '<div class="notification-empty">알림이 없습니다.</div>';
              return;
            }

            list.innerHTML = data.notifications.map(n => `
          <div class="notification-item ${n.is_read ? '' : 'notification-item--unread'}" 
               data-id="${n.id}" 
               data-order-id="${n.order_id}"
               onclick="handleNotificationClick(${n.id}, ${n.order_id}, '${String(n.notification_type || '').replace(/'/g, "\\'")}', '${String(n.deep_tab || '').replace(/'/g, "\\'")}', '${String(n.deep_event_id || '').replace(/'/g, "\\'")}', '${String(n.deep_target_no || '').replace(/'/g, "\\'")}')">
            <div class="notification-item__header">
              <span class="notification-item__title">${escapeHtml(n.title)}</span>
              <span class="notification-item__time">${formatNotificationTime(n.created_at)}</span>
            </div>
            <div class="notification-item__message">${escapeHtml(n.message)}</div>
            <div class="notification-item__target">
              ${n.target_manager_name ? '담당: ' + escapeHtml(n.target_manager_name) : (n.target_team ? '팀: ' + escapeHtml(n.target_team) : '')}
            </div>
          </div>
        `).join('');
          } catch (e) {
            console.error('Load notifications error:', e);
          }
        }

        function toggleNotificationPanel() {
          const panel = document.getElementById('notification-panel');
          notificationPanelOpen = !notificationPanelOpen;
          panel.style.display = notificationPanelOpen ? 'block' : 'none';

          if (notificationPanelOpen) {
            loadNotifications();
          }
        }

        async function handleNotificationClick(notificationId, orderId, notificationType, deepTab, deepEventId, deepTargetNo) {
          // 읽음 처리
          try {
            await fetch(`/erp/api/notifications/${notificationId}/read`, { method: 'POST' });
            loadNotificationBadge();

            // 해당 주문 상세로 이동
            if (orderId) {
              if (notificationType === 'DRAWING_TRANSFERRED' || notificationType === 'DRAWING_REVISION') {
                const tab = deepTab || (notificationType === 'DRAWING_REVISION' ? 'requests' : 'timeline');
                let url = `/erp/drawing-workbench/${orderId}?tab=${encodeURIComponent(tab)}`;
                if (deepEventId) url += `&event_id=${encodeURIComponent(deepEventId)}`;
                if (deepTargetNo) url += `&target_no=${encodeURIComponent(deepTargetNo)}`;
                window.location.href = url;
              } else {
                window.location.href = `/edit/${orderId}`;
              }
            }
          } catch (e) {
            console.error('Notification click error:', e);
          }
        }

        async function markAllNotificationsRead() {
          try {
            const res = await fetch('/erp/api/notifications/read-all', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
              loadNotificationBadge();
              loadNotifications();
            }
          } catch (e) {
            console.error('Mark all read error:', e);
          }
        }

        function formatNotificationTime(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr.replace(' ', 'T'));
          const now = new Date();
          const diff = (now - date) / 1000;

          if (diff < 60) return '방금';
          if (diff < 3600) return Math.floor(diff / 60) + '분 전';
          if (diff < 86400) return Math.floor(diff / 3600) + '시간 전';
          if (diff < 604800) return Math.floor(diff / 86400) + '일 전';

          return dateStr.split(' ')[0];
        }

        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = String(text);
          return div.innerHTML;
        }

        // 페이지 로드 시 배지 업데이트
        document.addEventListener('DOMContentLoaded', function () {
          loadNotificationBadge();

          // 60초마다 배지 업데이트 (rate-limit 여유 확보)
          setInterval(loadNotificationBadge, 60000);
        });

        // 패널 외부 클릭 시 닫기
        document.addEventListener('click', function (e) {
          const panel = document.getElementById('notification-panel');
          const btn = document.getElementById('notification-btn');
          if (notificationPanelOpen && !panel.contains(e.target) && !btn.contains(e.target)) {
            toggleNotificationPanel();
          }
        });
      </script>
    </div>
    {% endblock %}
