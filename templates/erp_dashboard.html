{% extends "layout.html" %}

{% block content %}
{% set filters = filters or {} %}
<div class="container-fluid erp-dashboard erp-pro" data-can-edit-erp-beta="{{ 'true' if can_edit_erp_beta|default(false) else 'false' }}">
  <script>
    const MY_ID = "{{ current_user.id }}";
    const MY_TEAM = "{{ current_user.team }}";
    const MY_NAME = "{{ current_user.name }}";
    const MY_ROLE = "{{ current_user.role }}";
  </script>
  <!-- Modern Header -->
  <header class="erp-pro-header">
    <h1 class="erp-pro-header__title">
      <i class="fas fa-layer-group"></i>
      <span>ERP 프로세스 대시보드</span>
    </h1>
    <div class="erp-pro-header__actions">
      <!-- 알림 버튼 -->

      <a class="erp-pro-btn erp-pro-btn--primary" href="{{ url_for('add_order', open='erp-beta') }}">
        <i class="fas fa-plus"></i>
        <span>주문 생성</span>
      </a>
      <a class="erp-pro-btn erp-pro-btn--secondary" href="{{ url_for('index') }}">
        <i class="fas fa-home"></i>
        <span class="d-none d-md-inline">홈</span>
      </a>
    </div>
  </header>
  {% set erp_sub_nav_active = 'dashboard' %}
  {% include 'partials/erp_sub_nav.html' %}

  <!-- Top Alerts - Modern Design -->
  <div class="erp-pro-alerts">
    <div
      class="erp-pro-alert erp-pro-alert--danger {% if filters.get('alert_type') == 'urgent' %}erp-pro-alert--active{% endif %}"
      data-alert-type="urgent" role="button" tabindex="0">
      <div class="erp-pro-alert__icon">
        <i class="fas fa-bolt"></i>
      </div>
      <div class="erp-pro-alert__content">
        <span class="erp-pro-alert__label">긴급 발주</span>
        <span class="erp-pro-alert__value">{{ kpis.urgent_count }}</span>
      </div>
    </div>
    <div
      class="erp-pro-alert erp-pro-alert--warning {% if filters.get('alert_type') == 'measurement_d4' %}erp-pro-alert--active{% endif %}"
      data-alert-type="measurement_d4" role="button" tabindex="0">
      <div class="erp-pro-alert__icon">
        <i class="fas fa-ruler-combined"></i>
      </div>
      <div class="erp-pro-alert__content">
        <span class="erp-pro-alert__label">실측 D-4</span>
        <span class="erp-pro-alert__value">{{ kpis.measurement_d4_count }}</span>
      </div>
    </div>
    <div
      class="erp-pro-alert erp-pro-alert--warning {% if filters.get('alert_type') == 'construction_d3' %}erp-pro-alert--active{% endif %}"
      data-alert-type="construction_d3" role="button" tabindex="0">
      <div class="erp-pro-alert__icon">
        <i class="fas fa-tools"></i>
      </div>
      <div class="erp-pro-alert__content">
        <span class="erp-pro-alert__label">시공 D-3</span>
        <span class="erp-pro-alert__value">{{ kpis.construction_d3_count }}</span>
      </div>
    </div>
    <div
      class="erp-pro-alert erp-pro-alert--info {% if filters.get('alert_type') == 'production_d2' %}erp-pro-alert--active{% endif %}"
      data-alert-type="production_d2" role="button" tabindex="0">
      <div class="erp-pro-alert__icon">
        <i class="fas fa-industry"></i>
      </div>
      <div class="erp-pro-alert__content">
        <span class="erp-pro-alert__label">생산 D-2</span>
        <span class="erp-pro-alert__value">{{ kpis.production_d2_count }}</span>
      </div>
    </div>
  </div>

  <!-- Process Map - Modern Pipeline Design -->
  <div class="erp-pro-card">
    <div class="erp-pro-card__header">
      <h3 class="erp-pro-card__title">
        <i class="fas fa-project-diagram"></i>
        프로세스 맵
      </h3>
    </div>
    <div class="erp-pro-card__body">
      <div class="erp-pro-pipeline">
        {% for step in process_steps %}
        {% set is_step_active = (filters.get('stage') or '') == step.label %}
        <div class="erp-pro-pipeline__stage {% if is_step_active %}erp-pro-pipeline__stage--active{% endif %}"
          data-stage="{{ step.label }}" role="button" tabindex="0" title="클릭하면 '{{ step.label }}' 단계만 표시">
          <div class="erp-pro-pipeline__count">
            {{ step.count }}
            {% if step.overdue > 0 %}
            <span class="erp-pro-badge erp-pro-badge--danger erp-pro-badge--sm" title="지연">{{ step.overdue }}</span>
            {% endif %}
            {% if step.imminent > 0 %}
            <span class="erp-pro-badge erp-pro-badge--warning erp-pro-badge--sm" title="임박">{{ step.imminent }}</span>
            {% endif %}
          </div>
          <div class="erp-pro-pipeline__label">{{ step.label }}</div>
        </div>
        {% if not loop.last %}
        <div class="erp-pro-pipeline__connector">
          <i class="fas fa-chevron-right"></i>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 3-Panel Layout -->
  <style>
    /* ============================================
       제품 항목 테이블 - 모바일 스타일 기반 (PC는 그리드만 추가)
       ============================================ */
    .erp-row-selected {
      background: rgba(13, 110, 253, .08) !important;
    }

    .erp-detail-panel {
      position: sticky;
      top: 76px;
      max-height: calc(100vh - 92px);
      overflow: auto;
    }

    .erp-kv {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .erp-kv .k {
      color: #6c757d;
    }

    .erp-kv .v {
      font-weight: 600;
      text-align: right;
    }

    /* ERP 대시보드 내부 섹션에 padding 적용 */
    .erp-dashboard>.d-flex,
    .erp-dashboard>.row,
    .erp-dashboard>.card {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    /* 상단 알람 타일: 1줄 고정 레이아웃 */
    .erp-alert-row {
      flex-wrap: nowrap;
      overflow: hidden;
    }

    .erp-alert-col {
      flex: 0 0 25%;
      max-width: 25%;
    }

    /* erp-dashboard-layout은 전체 너비 사용, 내부 요소에 padding 적용 */
    .erp-dashboard-layout {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 16px;
      align-items: start;
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      padding-left: 1rem;
      padding-right: 1rem;
      box-sizing: border-box !important;
      margin: 0 !important;
    }

    .erp-dashboard-filters,
    .erp-dashboard-workqueue {
      min-width: 0;
    }

    .erp-dashboard-workqueue {
      min-width: 0;
      flex: 1;
    }

    @media (max-width: 1400px) {
      .erp-dashboard-layout {
        grid-template-columns: 240px minmax(0, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .erp-dashboard-layout {
        grid-template-columns: 220px minmax(0, 1fr);
      }
    }

    @media (max-width: 992px) {
      .erp-alert-row {
        --bs-gutter-x: 0.35rem;
        --bs-gutter-y: 0.35rem;
      }

      .erp-alert-col {
        flex: 0 0 25%;
        max-width: 25%;
      }

      .erp-process-row {
        overflow-x: auto;
      }

      .erp-dashboard-layout {
        grid-template-columns: 1fr;
        width: 100%;
        max-width: 100%;
        gap: 12px;
      }

      .erp-dashboard-workqueue {
        width: 100%;
        max-width: 100%;
      }
    }

    /* 제품 항목 카드 그리드 (모바일 + PC 공통, 전역) */
    .erp-product-items-grid {
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: 1rem !important;
      width: 100% !important;
    }

    .erp-product-items-card {
      border: 1px solid #dee2e6 !important;
      border-radius: 8px !important;
      padding: 1rem !important;
      background: #fff !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    }

    .erp-product-items-row {
      display: grid !important;
      grid-template-columns: 70px minmax(0, 1fr) !important;
      column-gap: 4px !important;
      padding: 0.4rem 0 !important;
      border-bottom: 1px solid #f0f0f0 !important;
    }

    .erp-product-items-row:last-child {
      border-bottom: none !important;
    }

    .erp-product-items-label {
      font-weight: 700 !important;
      color: #0d6efd !important;
      font-size: var(--erp-detail-font, 1.1rem) !important;
      white-space: nowrap !important;
    }

    .erp-product-items-value {
      color: #212529 !important;
      font-size: var(--erp-detail-font, 1.1rem) !important;
      font-weight: 700 !important;
      white-space: normal !important;
      word-break: normal !important;
      overflow-wrap: break-word !important;
      min-width: 0 !important;
    }

    @media (min-width: 993px) {
      .erp-product-items-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    }

    /* 가독성 개선 스타일 - 텍스트 크기 증가 */
    #erp-grid {
      font-size: 1rem;
    }

    #erp-grid thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      padding: 1rem 0.75rem;
      white-space: nowrap;
      font-size: 1rem;
    }

    #erp-grid thead th:last-child {
      border-right: none;
    }

    #erp-grid tbody td {
      padding: 1rem 0.75rem;
      vertical-align: middle;
      border-bottom: 1px solid #e9ecef;
      border-right: 1px solid #e9ecef;
      font-size: 1rem;
    }

    #erp-grid tbody td:last-child {
      border-right: none;
    }

    #erp-grid tbody tr:hover {
      background-color: #f8f9fa;
    }

    #erp-grid .fw-bold {
      font-weight: 600 !important;
      color: #212529;
      font-size: 1rem;
    }

    #erp-grid .text-muted {
      color: #6c757d !important;
      font-size: 0.95rem;
    }

    /* 키워드 강조 */
    #erp-grid .badge {
      font-weight: 600;
      padding: 0.5em 0.75em;
      font-size: 0.95rem;
    }

    #erp-grid .badge.bg-danger {
      background-color: #dc3545 !important;
      color: #fff !important;
    }

    #erp-grid .badge.bg-warning {
      background-color: #ffc107 !important;
      color: #000 !important;
    }

    #erp-grid .badge.bg-success {
      background-color: #198754 !important;
      color: #fff !important;
    }

    #erp-grid .badge.bg-secondary {
      background-color: #6c757d !important;
      color: #fff !important;
    }

    #erp-grid .badge.bg-info {
      background-color: #0dcaf0 !important;
      color: #000 !important;
    }

    #erp-grid .badge.bg-primary {
      background-color: #0d6efd !important;
      color: #fff !important;
    }

    /* 버튼 스타일 개선 */
    #erp-grid .btn-sm {
      font-weight: 500;
      padding: 0.4rem 0.75rem;
      font-size: 1rem;
    }

    /* 텍스트 가독성 */
    #erp-grid .text-truncate {
      max-width: 200px;
      font-size: 1rem;
    }

    /* 열기 버튼 잘림 방지 */
    #erp-grid .erp-open-btn-icon {
      white-space: nowrap;
    }

    /* 경보 컬럼: 배지 겹침 방지 및 세로 정렬 */
    #erp-grid tbody td:nth-child(1) {
      padding: 0.5rem 0.75rem;
      vertical-align: top;
    }

    #erp-grid tbody td:nth-child(1) .badge {
      font-size: 0.85rem !important;
      padding: 0.35em 0.6em !important;
      margin: 0 0 4px 0;
      white-space: nowrap;
      display: block;
      line-height: 1.2;
      width: fit-content;
    }

    #erp-grid tbody td:nth-child(1) .badge:last-child {
      margin-bottom: 0;
    }

    /* 단계 컬럼: 배지 겹침 방지 */
    #erp-grid tbody td:nth-child(2) {
      padding: 0.5rem 0.75rem;
      vertical-align: middle;
    }

    #erp-grid tbody td:nth-child(2) .badge {
      font-size: 0.85rem !important;
      padding: 0.35em 0.6em !important;
      margin: 0 0 4px 0;
      white-space: nowrap;
      display: block;
      line-height: 1.2;
      width: fit-content;
    }

    #erp-grid tbody td:nth-child(2) .badge:last-child {
      margin-bottom: 0;
    }

    /* 작업 큐 가로 스크롤 및 최소 너비 확보 */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }

    /* 제품 항목은 overflow-x 제외 (그리드 레이아웃 사용) */
    .table-responsive.erp-product-items-wrapper {
      overflow-x: visible !important;
    }


    /* PC 화면: 미니멀 테이블 디자인 (UI/UX Pro Max) */
    @media (min-width: 993px) {
      .table-responsive {
        overflow-x: auto !important;
        overflow-y: visible;
        width: 100% !important;
        max-width: 100% !important;
      }

      #erp-grid {
        width: 100% !important;
        table-layout: auto !important;
        border-collapse: separate;
        border-spacing: 0;
      }

      #erp-grid thead th {
        border-right: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
      }

      #erp-grid thead th:last-child {
        border-right: none;
      }

      #erp-grid thead th,
      #erp-grid tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        vertical-align: top;
      }

      #erp-grid tbody td {
        border-right: 1px solid #f0f0f0;
      }

      #erp-grid tbody td:last-child {
        border-right: none;
      }

      /* 경보 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(1),
      #erp-grid tbody td:nth-child(1) {
        width: 90px;
        min-width: 90px;
      }

      #erp-grid tbody td:nth-child(1) {
        vertical-align: top;
      }

      #erp-grid tbody td:nth-child(1) .badge {
        display: block;
        margin-bottom: 3px;
        font-size: 0.75rem;
        padding: 0.25rem 0.4rem;
      }

      #erp-grid tbody td:nth-child(1) .badge:last-child {
        margin-bottom: 0;
      }

      /* 단계 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(2),
      #erp-grid tbody td:nth-child(2) {
        width: 80px;
        min-width: 80px;
      }

      #erp-grid tbody td:nth-child(2) .badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.5rem;
      }

      /* 퀘스트 컬럼 - 중간 */
      #erp-grid thead th:nth-child(3),
      #erp-grid tbody td:nth-child(3) {
        width: 180px;
        min-width: 180px;
      }

      /* 고객 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(4),
      #erp-grid tbody td:nth-child(4) {
        width: 90px;
        min-width: 90px;
      }

      /* 연락처 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(5),
      #erp-grid tbody td:nth-child(5) {
        width: 120px;
        min-width: 120px;
      }

      /* 주소 컬럼 - 제일 넓게 */
      #erp-grid thead th:nth-child(6),
      #erp-grid tbody td:nth-child(6) {
        width: 280px;
        min-width: 280px;
        max-width: 350px;
      }

      /* 제품 컬럼 - 두 번째로 넓게 */
      #erp-grid thead th:nth-child(7),
      #erp-grid tbody td:nth-child(7) {
        width: 200px;
        min-width: 200px;
        max-width: 250px;
      }

      #erp-grid tbody td:nth-child(7) div {
        line-height: 1.4;
        margin-bottom: 2px;
      }

      #erp-grid tbody td:nth-child(7) div:last-child {
        margin-bottom: 0;
      }

      /* 실측일 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(8),
      #erp-grid tbody td:nth-child(8) {
        width: 100px;
        min-width: 100px;
      }

      /* 시공일 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(9),
      #erp-grid tbody td:nth-child(9) {
        width: 100px;
        min-width: 100px;
      }

      /* 담당 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(10),
      #erp-grid tbody td:nth-child(10) {
        width: 70px;
        min-width: 70px;
      }

      /* 첨부 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(11),
      #erp-grid tbody td:nth-child(11) {
        width: 60px;
        min-width: 60px;
        text-align: center;
      }

      /* 상세 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(12),
      #erp-grid tbody td:nth-child(12) {
        width: 60px;
        min-width: 60px;
        text-align: center;
      }

      /* 열기 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(13),
      #erp-grid tbody td:nth-child(13) {
        width: 50px;
        min-width: 50px;
        text-align: center;
      }

      #erp-grid .erp-open-btn-icon {
        display: inline-flex;
      }

      #erp-grid .erp-quest-cell {
        white-space: normal !important;
      }

      /* 행 호버 효과 */
      #erp-grid tbody tr:hover {
        background-color: #f8f9fa;
      }
    }

    @media (min-width: 993px) and (max-width: 1600px) {
      #erp-grid {
        width: 100% !important;
      }

      #erp-grid .erp-open-btn-icon {
        display: inline-flex;
      }
    }


    /* 프로세스 맵 1줄 고정 */
    .erp-process-row {
      flex-wrap: nowrap;
      overflow-x: auto;
      align-items: stretch;
      padding-bottom: 2px;
    }

    .erp-process-col {
      flex: 0 0 auto;
      min-width: 100px;
    }

    .erp-pro-pipeline__stage {
      min-width: 100px;
      padding: 0.4rem !important;
      box-shadow: none !important;
    }

    .erp-pro-pipeline__stage .fw-bold {
      font-size: 1.05rem;
    }

    .erp-pro-pipeline__stage .text-muted {
      font-size: 0.9rem;
    }

    .erp-pro-pipeline__stage .badge {
      font-size: 0.75rem;
      padding: 0.2em 0.45em;
    }

    /* 상단 알람 타일 미니멀 */
    .erp-alert-card .card-body {
      padding: 0.4rem 0.5rem !important;
    }

    .erp-alert-card .fw-bold {
      font-size: 0.9rem !important;
    }

    .erp-alert-card .badge {
      font-size: 0.85rem !important;
      padding: 0.35em 0.6em !important;
    }

    /* 필터 1줄 레이아웃 */
    #erp-filters-form.erp-filter-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #erp-filters-form .erp-filter-main {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
    }

    #erp-filters-form .erp-filter-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: nowrap;
    }

    #erp-filters-form .collapse {
      width: 100%;
    }

    #erp-filters-form .erp-filter-advanced-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
    }

    #erp-filters-form .erp-filter-advanced-bottom {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }

    #erp-filters-form .form-control,
    #erp-filters-form .form-select,
    #erp-filters-form .btn {
      font-size: 0.85rem;
      padding: 0.3rem 0.45rem;
    }

    #erp-filters-form .form-control {
      max-width: 160px;
      min-width: 120px;
    }

    .erp-dashboard-filters .card-body {
      padding: 0.6rem 0.7rem;
    }

    .erp-dashboard-filters .fw-bold {
      font-size: 0.95rem;
    }

    /* 주문 상세 텍스트 크기 통일 */
    .erp-order-detail {
      --erp-detail-font: 1.2rem;
    }

    .erp-order-detail .erp-detail-label,
    .erp-order-detail .erp-detail-value,
    .erp-order-detail .erp-detail-text {
      font-size: var(--erp-detail-font) !important;
    }

    .order-detail-content {
      font-size: 1.2rem !important;
    }

    .erp-schedule-card .erp-detail-text,
    .erp-schedule-card .erp-detail-label,
    .erp-schedule-card .erp-detail-value {
      font-size: 0.9rem !important;
    }

    .erp-schedule-card .card-title {
      font-size: 0.95rem !important;
    }

    /* 열기 버튼: 아이콘만 */
    .erp-open-btn-icon {
      background: transparent !important;
      border: 0 !important;
      padding: 0 !important;
      color: #6c757d;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .erp-open-btn-icon i {
      font-size: 0.95rem;
    }

    /* 미니멀 아이콘/텍스트 크기 통일 */
    .erp-dashboard .fas,
    .erp-dashboard .far {
      font-size: 0.95rem;
    }

    @media (max-width: 992px) {
      .table-responsive {
        overflow-x: visible;
        width: 100%;
      }

      .erp-dashboard .row.g-3.mb-4 {
        --bs-gutter-x: 0.35rem;
        --bs-gutter-y: 0.35rem;
      }

      .erp-alert-card {
        border-radius: 8px !important;
      }

      .erp-alert-card .card-body {
        padding: 0.3rem 0.35rem !important;
      }

      .erp-alert-card .fw-bold {
        font-size: 0.65rem !important;
      }

      .erp-alert-card .badge {
        font-size: 0.6rem !important;
        padding: 0.18rem 0.35rem !important;
      }

      .erp-process-step {
        min-width: 64px !important;
        padding: 0.25rem !important;
        border-radius: 8px !important;
        box-shadow: none !important;
      }

      .erp-process-step .fw-bold {
        font-size: 0.75rem !important;
      }

      .erp-process-step .badge {
        font-size: 0.55rem !important;
        padding: 0.15em 0.3em !important;
      }

      .erp-process-step .text-muted {
        font-size: 0.6rem !important;
      }

      .erp-dashboard-workqueue .card-body {
        font-size: 0.8rem !important;
      }

      #erp-grid tbody tr.erp-main-row td {
        font-size: 0.78rem !important;
        grid-template-columns: 58px 1fr;
      }

      #erp-grid tbody tr.erp-main-row td .badge,
      #erp-grid tbody tr.erp-main-row td .btn,
      #erp-grid tbody tr.erp-main-row td a {
        font-size: 0.72rem !important;
      }

      .erp-product-items-label,
      .erp-product-items-value {
        font-size: 0.8rem !important;
      }

      /* 모바일: 카카오/채널톡 느낌으로 폰트/아이콘 축소 */
      .erp-dashboard .badge.fs-6 {
        font-size: 0.6rem !important;
        padding: 0.2rem 0.35rem !important;
      }

      .erp-process-step {
        min-width: 64px !important;
        padding: 0.25rem !important;
      }

      .erp-process-step .fw-bold {
        font-size: 0.75rem !important;
      }

      .erp-process-step .badge {
        font-size: 0.55rem !important;
        padding: 0.15em 0.3em !important;
      }

      .erp-process-step .text-muted {
        font-size: 0.6rem !important;
      }

      .erp-dashboard .btn,
      .erp-dashboard .form-select,
      .erp-dashboard .form-control {
        font-size: 0.78rem !important;
      }

      .erp-dashboard .btn i,
      .erp-dashboard .nav-link i {
        font-size: 0.78rem !important;
      }

      #erp-grid tbody tr.erp-main-row {
        padding: 0.5rem;
      }

      #erp-grid tbody tr.erp-main-row td {
        font-size: 0.78rem;
        grid-template-columns: 58px 1fr;
      }

      #erp-grid tbody tr.erp-main-row td .badge,
      #erp-grid tbody tr.erp-main-row td .btn,
      #erp-grid tbody tr.erp-main-row td a {
        font-size: 0.72rem !important;
      }

      .erp-product-items-label,
      .erp-product-items-value {
        font-size: 0.8rem !important;
      }

      .erp-dashboard-workqueue {
        width: 100%;
        max-width: 100%;
        padding: 0;
      }

      .erp-dashboard-workqueue .card {
        width: 100%;
        margin: 0;
      }

      .erp-dashboard-workqueue .card-body {
        padding: 1rem;
        width: 100%;
      }

      #erp-grid {
        min-width: 0;
        width: 100%;
        table-layout: auto;
        display: block;
      }

      #erp-grid thead {
        display: none;
      }

      #erp-grid,
      #erp-grid tbody,
      #erp-grid tr,
      #erp-grid td {
        display: block;
        width: 100%;
        max-width: 100%;
      }

      #erp-grid tr.erp-main-row {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fff;
        width: 100%;
        box-sizing: border-box;
      }

      /* 모바일 작업 큐: 라벨 80px 고정 + 값은 가상 세로선(2열)에 맞춤 (상위 CSS 무관) */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td {
        padding: 0.5rem 0;
        border: none;
        border-bottom: 1px solid #f0f0f0;
        font-size: 1rem;
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px;
        white-space: normal;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        align-items: start;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td:last-child {
        border-bottom: none;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td>* {
        grid-column: 2 !important;
        margin-left: 0 !important;
        padding-left: 0 !important;
        justify-self: start !important;
        max-width: 100%;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td .badge,
      .erp-dashboard #erp-grid tbody tr.erp-main-row td .btn,
      .erp-dashboard #erp-grid tbody tr.erp-main-row td a {
        margin-left: 0 !important;
        padding-left: 0 !important;
      }

      /* 모바일: 첨부, 상세, 열기 - grid 유지, 값 2열 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="첨부"],
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="상세"],
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="열기"] {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
        align-items: center;
      }

      /* 모바일: 열기 헤더 삭제 및 버튼 중앙 정렬 */
      #erp-grid tbody tr.erp-main-row td[data-label="열기"]::before {
        display: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        grid-template-columns: none !important;
        border-bottom: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon {
        margin: 0 auto;
        justify-self: center;
      }

      /* 모바일: 경보 컬럼 - grid 유지, 배지들을 값 영역(2열)에 정렬 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td:nth-child(1) {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
      }

      #erp-grid tbody tr.erp-main-row td:nth-child(1) .badge {
        display: inline-block !important;
        margin-right: 4px !important;
        margin-bottom: 0 !important;
        width: fit-content !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }

      #erp-grid tbody tr.erp-main-row td:nth-child(1) .badge:last-child {
        margin-right: 0 !important;
      }

      /* 모바일: 단계 컬럼 - 배지 정렬 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td:nth-child(2) {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
      }

      #erp-grid tbody tr.erp-main-row td:nth-child(2) .badge {
        display: inline-block;
        margin-right: 4px;
        margin-bottom: 0;
        width: fit-content;
      }

      /* 모바일: 퀘스트 컬럼 - grid 유지, 값 2열 정렬 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"] {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"] .d-inline-flex {
        grid-column: 2 !important;
        justify-self: start;
        margin-left: 0 !important;
        padding-left: 0 !important;
      }

      /* 모바일: 헤더(라벨) 1열 고정, 값은 2열 가상 세로선에 맞춤 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td::before {
        content: attr(data-label);
        grid-column: 1 !important;
        width: 80px !important;
        max-width: 80px !important;
        min-width: 80px !important;
        box-sizing: border-box;
        color: #0d6efd;
        font-weight: 700;
        white-space: nowrap;
        font-size: 1rem;
        text-align: left;
        align-self: start;
        padding-right: 8px;
        min-height: 1.5em;
        overflow: hidden;
      }

      /* 모바일: 모든 값 텍스트 볼드체 적용 */
      #erp-grid tbody tr.erp-main-row td {
        font-weight: 700 !important;
        color: #212529 !important;
      }

      #erp-grid tbody tr.erp-main-row td span:not(.badge):not(.btn),
      #erp-grid tbody tr.erp-main-row td div,
      #erp-grid tbody tr.erp-main-row td text {
        font-weight: 700 !important;
        color: #212529 !important;
      }

      /* 모바일: 배지와 버튼도 볼드체 유지 */
      #erp-grid tbody tr.erp-main-row td .badge,
      #erp-grid tbody tr.erp-main-row td .btn {
        font-weight: 700 !important;
      }

      #erp-grid tbody tr:not(.erp-main-row) td {
        display: block;
        width: 100%;
        max-width: 100%;
        padding: 0;
        box-sizing: border-box;
      }

      #erp-grid tbody tr:not(.erp-main-row) td::before {
        content: none;
      }

      #erp-grid .erp-open-btn-icon {
        display: inline-flex;
      }

      #erp-grid .erp-cell-actions {
        justify-content: flex-end;
        align-items: center;
        grid-template-columns: 75px 1fr;
      }

      /* 모바일: 퀘스트 셀 - grid 유지, 값 정렬 */
      #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"]::before {
        grid-column: 1;
        align-self: start;
      }

      #erp-grid .erp-quest-cell .btn {
        white-space: normal;
        text-align: left;
        line-height: 1.25;
        width: auto !important;
        flex-shrink: 0 !important;
      }

      .erp-drawing-gateway-card {
        width: 100%;
        border: 1px solid #d7e7ff;
        border-radius: 12px;
        background: linear-gradient(180deg, #f8fbff 0%, #ffffff 100%);
        padding: 10px 10px 9px;
        box-shadow: 0 3px 10px rgba(13, 110, 253, 0.08);
      }

      .erp-drawing-gateway-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
      }

      .erp-drawing-gateway-title {
        font-size: 0.94rem;
        font-weight: 700;
        color: #0d6efd;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .erp-drawing-gateway-meta {
        font-size: 0.8rem;
        color: #6c757d;
        line-height: 1.45;
        margin-bottom: 8px;
      }

      .erp-drawing-gateway-summary {
        border: 1px solid #e8eef9;
        background: #fff;
        border-radius: 10px;
        padding: 7px 8px;
        margin-bottom: 8px;
      }

      .erp-drawing-gateway-summary-head {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.77rem;
        color: #6c757d;
        margin-bottom: 3px;
      }

      .erp-drawing-gateway-summary-main {
        font-size: 0.82rem;
        color: #334155;
        line-height: 1.45;
      }

      .erp-drawing-gateway-summary-note {
        margin-top: 3px;
        font-size: 0.78rem;
        color: #b45309;
        background: #fff7ed;
        border: 1px solid #fed7aa;
        border-radius: 8px;
        padding: 3px 6px;
      }

      .erp-drawing-gateway-timeline {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 6px;
      }

      .erp-drawing-gateway-timeline-item {
        border: 1px solid #e6edf8;
        background: #f8fbff;
        border-radius: 9px;
        padding: 6px 7px;
      }

      .erp-drawing-gateway-timeline-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 2px;
        font-size: 0.76rem;
        color: #64748b;
      }

      .erp-drawing-gateway-timeline-action {
        font-size: 0.77rem;
        font-weight: 700;
        color: #1d4ed8;
      }

      .erp-drawing-gateway-timeline-note {
        font-size: 0.78rem;
        color: #374151;
      }

      .erp-drawing-gateway-thumbs {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
      }

      .erp-drawing-gateway-thumb {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        border: 1px solid #dbe5f5;
        object-fit: cover;
        cursor: zoom-in;
        background: #fff;
      }

      /* 퀘스트 상황판에서는 어떤 이미지도 썸네일 크기로 강제 */
      .erp-quest-cell .erp-drawing-gateway-card img,
      .erp-quest-cell .erp-drawing-gateway-card .drawing-gateway-thumb img {
        width: 44px !important;
        height: 44px !important;
        max-width: 44px !important;
        max-height: 44px !important;
        object-fit: cover !important;
        border-radius: 8px;
      }

      .erp-quest-cell .erp-drawing-gateway-card .drawing-gateway-thumb,
      .erp-quest-cell .erp-drawing-gateway-card .drawing-gateway-thumb-wrap {
        width: 44px !important;
        min-width: 44px !important;
        max-width: 44px !important;
        height: 44px !important;
        overflow: hidden !important;
      }

      .erp-drawing-gateway-thumb-more {
        min-width: 44px;
        height: 44px;
        border-radius: 8px;
        border: 1px dashed #bfdbfe;
        background: #eff6ff;
        color: #1d4ed8;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 8px;
      }

      .erp-drawing-gateway-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .erp-drawing-gateway-actions .btn {
        font-size: 0.8rem;
        padding: 0.26rem 0.52rem;
      }

      .erp-drawing-quest-todo {
        font-size: 0.82rem;
        color: #1f2937;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 5px 7px;
        margin-bottom: 8px;
      }

      .erp-drawing-quest-recent {
        font-size: 0.78rem;
        color: #475569;
        margin-bottom: 8px;
      }

      .drawing-target-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(132px, 1fr));
        gap: 8px;
      }

      .drawing-target-card {
        border: 1px solid #dbe5f5;
        border-radius: 10px;
        background: #fff;
        padding: 6px;
        cursor: pointer;
        transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
      }

      .drawing-target-card:hover {
        border-color: #8cb8ff;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.12);
        transform: translateY(-1px);
      }

      .drawing-target-card.is-active {
        border-color: #0d6efd;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.18);
      }

      .drawing-target-card-thumb {
        width: 100%;
        height: 74px;
        border-radius: 7px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 5px;
      }

      .drawing-target-card-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .drawing-target-card-meta {
        font-size: 0.76rem;
        color: #334155;
        line-height: 1.3;
      }

      .drawing-target-card-meta .num {
        font-weight: 700;
        color: #0d6efd;
      }

      .drawing-target-selected-pill {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(13, 110, 253, 0.95);
        color: #fff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.35);
      }

      .drawing-target-card.is-active .drawing-target-card-meta .num {
        color: #084298;
      }

      @media (max-width: 768px) {
        .drawing-target-card-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 8px;
        }
      }

      .erp-drawing-workbench {
        display: grid;
        grid-template-columns: minmax(0, 1.6fr) minmax(260px, 1fr);
        gap: 12px;
      }

      .erp-drawing-workbench-log {
        background: #fff;
        border: 1px solid #e5edf8;
        border-radius: 10px;
        padding: 10px;
        min-height: 160px;
      }

      .erp-drawing-workbench-actions {
        background: #f8fbff;
        border: 1px solid #d8e7ff;
        border-radius: 10px;
        padding: 10px;
      }

      .erp-drawing-workbench-actions-sticky {
        position: sticky;
        top: 10px;
      }

      .erp-drawing-workbench-tabs .nav-link {
        font-size: 0.82rem;
        padding: 0.32rem 0.55rem;
      }

      .erp-drawing-workbench-pane {
        border: 1px solid #e5edf8;
        border-radius: 8px;
        background: #fff;
        padding: 8px;
        min-height: 124px;
      }

      @media (max-width: 992px) {
        .erp-drawing-workbench {
          grid-template-columns: 1fr;
        }
      }

      #erp-grid .erp-quest-cell .badge {
        margin-top: 0 !important;
        flex-shrink: 0 !important;
      }

      /* 모바일: 첨부, 상세, 열기 버튼 사이즈 고정 (진행중 배지 사이즈) - 992px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="첨부"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge i {
        font-size: 1rem !important;
        padding: 0.4em 0.7em !important;
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        display: inline-block !important;
      }

      /* 모바일: 상세 버튼 아이콘 크기 조정 (첨부 버튼과 동일한 크기) */
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge i {
        font-size: 0.85rem !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      /* 모바일: 상세 버튼 전체 크기 조정 (첨부와 동일) */
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge {
        padding: 0.4em 0.7em !important;
        min-width: 2.5em !important;
        max-width: 2.5em !important;
        width: 2.5em !important;
        height: 2.5em !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon,
      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon i {
        font-size: 1rem !important;
        padding: 0 !important;
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
      }

      /* 모바일: 필터 적용/초기화 버튼 사이즈 고정 - 992px 이하 */
      #erp-filters-form .btn-primary,
      #erp-filters-form .btn-outline-secondary {
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        font-size: 1rem !important;
        padding: 0.4em 0.7em !important;
      }

      /* 모바일: 다른 테이블 (제품 항목 제외) */
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) {
        overflow-x: auto;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) table {
        width: 100%;
        min-width: 100%;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) table,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) thead,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) tbody,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) tr,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td {
        display: block !important;
        width: 100% !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) thead {
        display: none !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) tr {
        border: 1px solid #dee2e6 !important;
        border-radius: 8px !important;
        margin-bottom: 1rem !important;
        padding: 0.75rem !important;
        background: #fff !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td {
        padding: 0.5rem 0 !important;
        border: none !important;
        display: grid !important;
        grid-template-columns: 80px 1fr !important;
        gap: 8px !important;
        width: 100% !important;
        max-width: 100% !important;
        font-size: 1.2rem !important;
        text-align: left !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td[data-label^="규격"] {
        text-align: left !important;
        width: 100% !important;
        max-width: 100% !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td[data-label]::before {
        content: attr(data-label) ":" !important;
        font-weight: 700 !important;
        color: #0d6efd !important;
        font-size: 1.2rem !important;
        display: block !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td.text-end {
        text-align: left !important;
      }
    }

    @media (max-width: 576px) {
      .erp-dashboard-workqueue .card-body {
        padding: 0.75rem;
      }

      #erp-grid tbody tr.erp-main-row {
        padding: 0.875rem;
        margin-bottom: 0.875rem;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td {
        grid-template-columns: 70px minmax(0, 1fr) !important;
        gap: 10px;
        font-size: 0.95rem;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td::before {
        font-size: 0.9rem;
        text-align: left;
        align-self: start;
        padding-right: 8px;
        width: 70px !important;
        max-width: 70px !important;
        min-width: 70px !important;
      }

      /* 모바일: 퀘스트 셀을 flex로 변경하여 헤더와 버튼을 같은 줄에 배치 - 576px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"] {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        grid-template-columns: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"]::before {
        flex-shrink: 0 !important;
        margin-right: 0 !important;
      }

      #erp-grid .erp-quest-cell .btn {
        width: auto !important;
        flex-shrink: 0 !important;
      }

      #erp-grid .erp-quest-cell .badge {
        margin-top: 0 !important;
        flex-shrink: 0 !important;
      }

      /* 모바일: 열기 헤더 삭제 및 버튼 중앙 정렬 - 576px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="열기"]::before {
        display: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] {
        justify-content: center !important;
      }

      #erp-grid .erp-cell-actions {
        grid-template-columns: 70px 1fr;
      }

      /* 모바일: 경보/단계 배지 작게 */
      #erp-grid tbody td:nth-child(1) .badge,
      #erp-grid tbody td:nth-child(2) .badge {
        font-size: 0.7rem !important;
        padding: 0.2em 0.45em !important;
        line-height: 1.1;
      }

      /* 모바일: 첨부, 상세, 열기 버튼 사이즈 고정 (진행중 배지 사이즈) - 576px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="첨부"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge i,
      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon,
      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon i {
        font-size: 1rem !important;
        padding: 0 !important;
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
      }

      /* 모바일: 필터 적용/초기화 버튼 사이즈 고정 - 576px 이하 */
      #erp-filters-form .btn-primary,
      #erp-filters-form .btn-outline-secondary {
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        font-size: 1rem !important;
        padding: 0.4em 0.7em !important;
      }

      #erp-grid tbody td:nth-child(1),
      #erp-grid tbody td:nth-child(2) {
        gap: 2px;
        padding: 0.3rem 0.5rem;
      }
    }

    /* 전체 텍스트 크기 증가 */
    .card-body {
      font-size: 0.95rem;
    }

    .card-body .small {
      font-size: 0.9rem !important;
    }

    .card-body h5,
    .card-body h6 {
      font-size: 1.1rem;
    }

    .card-body .fw-bold {
      font-size: 1rem;
    }

    /* 프로세스 맵 호버 효과 */
    .erp-pro-pipeline__stage {
      transition: all 0.2s ease;
    }

    .erp-pro-pipeline__stage:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
    }
  </style>

  <div class="erp-dashboard-layout">
    <!-- Left: Filters -->
    <div class="erp-dashboard-filters">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-3 text-dark" style="font-size: 1.15rem;"><i class="fas fa-filter text-primary"></i> 필터
          </div>
          <form method="get" action="{{ url_for('erp_beta.erp_dashboard') }}" class="erp-filter-row"
            id="erp-filters-form">
            {% if filters.get('alert_type') %}
            <input type="hidden" name="alert_type" value="{{ filters.get('alert_type') }}">
            {% endif %}
            <div class="erp-filter-main">
              <input class="form-control form-control-sm" name="q" placeholder="검색(고객/연락/주소/담당)"
                value="{{ (filters.get('q') or '') }}">
              <div class="erp-filter-actions">
                <button class="btn btn-primary btn-sm fw-semibold" type="submit" aria-label="검색">
                  <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm fw-semibold" type="button" data-bs-toggle="collapse"
                  data-bs-target="#erp-filter-advanced" aria-expanded="false" aria-label="필터 상세">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
            </div>
            <div class="collapse" id="erp-filter-advanced">
              <div class="erp-filter-advanced-row mt-2">
                <select class="form-select form-select-sm" name="stage">
                  <option value="">단계: 전체</option>
                  <option value="주문접수" {% if filters.get('stage')=='주문접수' %}selected{% endif %}>주문접수</option>
                  <option value="해피콜" {% if filters.get('stage')=='해피콜' %}selected{% endif %}>해피콜</option>
                  <option value="실측" {% if filters.get('stage')=='실측' %}selected{% endif %}>실측</option>
                  <option value="도면" {% if filters.get('stage')=='도면' %}selected{% endif %}>도면</option>
                  <option value="고객컨펌" {% if filters.get('stage')=='고객컨펌' %}selected{% endif %}>고객컨펌</option>
                  <option value="생산" {% if filters.get('stage')=='생산' %}selected{% endif %}>생산</option>
                  <option value="시공" {% if filters.get('stage')=='시공' %}selected{% endif %}>시공</option>
                </select>

                <select class="form-select form-select-sm" name="team">
                  <option value="">팀: 전체</option>
                  <option value="CS" {% if filters.get('team')=='CS' %}selected{% endif %}>라홈팀</option>
                  <option value="SALES" {% if filters.get('team')=='SALES' %}selected{% endif %}>영업팀</option>
                  <option value="MEASURE" {% if filters.get('team')=='MEASURE' %}selected{% endif %}>실측팀</option>
                  <option value="DRAWING" {% if filters.get('team')=='DRAWING' %}selected{% endif %}>도면팀</option>
                  <option value="PRODUCTION" {% if filters.get('team')=='PRODUCTION' %}selected{% endif %}>생산팀</option>
                  <option value="CONSTRUCTION" {% if filters.get('team')=='CONSTRUCTION' %}selected{% endif %}>시공팀
                  </option>
                </select>
                {% if is_admin %}

                {% endif %}
              </div>
              <div class="erp-filter-advanced-bottom mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="f-urgent" name="urgent" {% if
                    filters.get('urgent')=='1' %}checked{% endif %} style="width: 1.2em; height: 1.2em;">
                  <label class="form-check-label fw-semibold" for="f-urgent" style="font-size: 0.9rem;">긴급만</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="f-has-alert" name="has_alert" {% if
                    filters.get('has_alert')=='1' %}checked{% endif %} style="width: 1.2em; height: 1.2em;">
                  <label class="form-check-label fw-semibold" for="f-has-alert" style="font-size: 0.9rem;">경보만</label>
                </div>
                <a class="btn btn-outline-secondary btn-sm fw-semibold"
                  href="{{ url_for('erp_beta.erp_dashboard') }}">초기화</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Middle: Grid -->
    <div class="erp-dashboard-workqueue">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-table text-primary"></i> 작업 큐</h5>
              <small class="text-muted">주문 처리 및 퀘스트 관리</small>
            </div>
            <div>
              <span class="badge bg-primary fs-6 px-3 py-2">표시: <strong>{{ orders|length }}</strong>건</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle" id="erp-grid">
              <thead>
                <tr>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">경보</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">단계</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">퀘스트</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">고객</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">연락처</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">주소</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">제품</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">실측일</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">시공일</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">담당</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">첨부</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">상세</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;"></th>
                </tr>
              </thead>
              <tbody>
                {% for o in orders %}
                <tr class="erp-main-row" data-order-id="{{ o.id }}">
                  <td data-label="경보">
                    {% if o.alerts.urgent %}<span class="badge bg-danger fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">긴급</span>{% endif %}
                    {% if o.alerts.drawing_overdue %}<span class="badge bg-danger fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">도면48h</span>{% endif %}
                    {% if o.alerts.measurement_d4 %}
                    {% set meas_d = o.alerts['measurement_days'] if 'measurement_days' in o.alerts else none %}
                    <span class="badge bg-warning text-dark fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">실측D-{{ meas_d if meas_d is not none else '4'
                      }}</span>
                    {% endif %}
                    {% if o.alerts.construction_d3 %}
                    {% set cons_d = o.alerts['construction_days'] if 'construction_days' in o.alerts else none %}
                    <span class="badge bg-warning text-dark fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">시공D-{{ cons_d if cons_d is not none else '3'
                      }}</span>
                    {% endif %}
                    {% if o.alerts.production_d2 %}
                    {% set prod_d = o.alerts['production_days'] if 'production_days' in o.alerts else none %}
                    <span class="badge bg-warning text-dark fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">생산D-{{ prod_d if prod_d is not none else '2'
                      }}</span>
                    {% endif %}
                  </td>
                  <td data-label="단계"><span class="badge bg-secondary"
                      style="font-size: 1.1rem; padding: 0.5em 0.7em;">{{ o.stage }}</span></td>
                  <td data-label="퀘스트" class="erp-quest-cell erp-wrap">
                    {% if o.current_quest %}
                    <div class="d-inline-flex align-items-center gap-2">
                      {% if o.current_quest.all_approved %}
                      <span class="badge bg-success" style="font-size: 1rem; padding: 0.4em 0.7em;">완료</span>
                      {% else %}
                      <span class="badge bg-warning" style="font-size: 1rem; padding: 0.4em 0.7em;">진행중</span>
                      {% endif %}
                      <button class="btn btn-sm btn-outline-info fw-semibold" type="button" data-bs-toggle="collapse"
                        data-bs-target="#quest-collapse-{{ o.id }}" aria-expanded="false"
                        aria-controls="quest-collapse-{{ o.id }}" style="font-size: 1.1rem; padding: 0.5em 0.8em;">
                        <i class="fas fa-chevron-down"></i>
                        {% if o.current_quest.all_approved %}
                        <i class="fas fa-check-circle text-success"></i>
                        {% endif %}
                        <strong>{{ o.current_quest.title }}</strong>
                      </button>
                    </div>
                    <div class="collapse mt-2" id="quest-collapse-{{ o.id }}">
                      <div class="card card-body border-0 bg-light">
                        <div class="fw-bold mb-3" style="font-size: 1.05rem;"><i
                            class="fas fa-flag-checkered text-primary"></i> 현재 단계 퀘스트</div>

                        <div class="card mb-3 shadow-sm">
                          <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                              <div>
                                <h5 class="card-title mb-2 fw-bold" style="font-size: 1.05rem;">{{ o.current_quest.title
                                  }}</h5>

                              </div>
                              <span
                                class="badge {% if o.current_quest.all_approved %}bg-success{% else %}bg-warning{% endif %}"
                                style="font-size: 0.9rem; padding: 0.4em 0.6em;">
                                {% if o.current_quest.all_approved %}완료{% else %}진행중{% endif %}
                              </span>
                            </div>
                            <div class="mb-3">
                              <div class="text-muted mb-2 fw-semibold" style="font-size: 0.9rem;">담당 팀</div>
                              <div class="fw-bold" style="font-size: 1rem;">{{
                                team_labels.get(o.current_quest.owner_team, o.current_quest.owner_team) or '-' }}</div>
                            </div>
                            <div class="mb-3">
                              <div class="text-muted mb-2 fw-semibold" style="font-size: 0.9rem;">승인</div>
                              <div id="quest-approvals-{{ o.id }}">
                                {% if o.current_quest.approval_mode == 'assignee' %}
                                <!-- 담당자 기반: 지정 담당자 이름 표시 + 승인 버튼 -->
                                {% set assignee_approval = o.current_quest.assignee_approval or {} %}
                                {% set assignee_names = o.current_quest.assignee_display_names or [] %}
                                {% if assignee_approval.get('approved') %}
                                <div class="mb-2">
                                  <span class="fw-semibold" style="font-size: 0.9rem;">{{ assignee_names|join(', ') or '담당자' }}</span>
                                  <span class="badge bg-success ms-2"
                                    style="font-size: 0.9rem; padding: 0.3em 0.6em;">✓ {{ assignee_approval.get('approved_by_name', '') }} 승인완료</span>
                                </div>
                                {% else %}
                                <div class="mb-2">
                                  <span class="fw-semibold" style="font-size: 0.9rem;">{{ assignee_names|join(', ') or '담당자 지정 필요' }}</span>
                                  {% if can_edit_erp_beta|default(false) or o.current_quest.can_assignee_approve|default(false) %}
                                  <button class="btn btn-primary fw-semibold ms-2 erp-btn-approve-assignee"
                                    data-order-id="{{ o.id }}"
                                    style="font-size: 0.9rem; padding: 0.3rem 0.6rem;">
                                    <i class="fas fa-check"></i> 승인
                                  </button>
                                  {% else %}
                                  <span class="text-muted small ms-2">(수정 권한 없음)</span>
                                  {% endif %}
                                </div>
                                {% endif %}
                                {% else %}
                                <!-- 팀 기반 승인 (기존) -->
                                {% for team in o.current_quest.required_approvals %}
                                {% set approved = o.current_quest.team_approvals.get(team, False) %}
                                <div class="mb-2">
                                  <span class="fw-semibold" style="font-size: 0.9rem;">{{ team_labels.get(team, team)
                                    }}</span>
                                  {% if approved %}
                                  <span class="badge bg-success ms-2"
                                    style="font-size: 0.9rem; padding: 0.3em 0.6em;">승인완료</span>
                                  {% else %}
                                  {% if can_edit_erp_beta|default(false) %}
                                  {% set order_id_approve = o.id %}
                                  {% set team_name = team %}
                                  <button class="btn btn-primary fw-semibold ms-2 erp-btn-approve-team"
                                    data-order-id="{{ order_id_approve }}" data-team="{{ team_name }}"
                                    style="font-size: 0.9rem; padding: 0.3rem 0.6rem;">승인</button>
                                  {% else %}
                                  <span class="text-muted small ms-2">(수정 권한 없음)</span>
                                  {% endif %}
                                  {% endif %}
                                </div>
                                {% endfor %}
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% else %}
                    {% if o.stage in ['도면', 'DRAWING'] %}
                    {% set sd = o.structured_data or {} %}
                    {% set drawing_obj = sd.get('drawing') or {} %}
                    {% set drawing_status = (drawing_obj.get('status') or sd.get('drawing_status') or 'PENDING')|upper %}
                    {% set drawing_transferred = sd.get('drawing_transferred') %}
                    {% set drawing_files = sd.get('drawing_current_files') or [] %}
                    {% set thumb_ns = namespace(images=[]) %}
                    {% for f in drawing_files %}
                    {% if f is mapping %}
                    {% set fn = ((f.get('filename') or f.get('key') or '')|lower) %}
                    {% if ('.jpg' in fn) or ('.jpeg' in fn) or ('.png' in fn) or ('.gif' in fn) or ('.webp' in fn) or ('.bmp' in fn) or ('.svg' in fn) %}
                    {% if thumb_ns.images|length < 2 %}
                    {% set thumb_ns.images = thumb_ns.images + [f] %}
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                    {% set drawing_history = sd.get('drawing_transfer_history') or [] %}
                    {% set latest_history = drawing_history|last if drawing_history else none %}
                    {% set recent_history = drawing_history[-3:] if drawing_history else [] %}
                    {% set assignments = sd.get('assignments') or {} %}
                    {% set ns = namespace(draftsman_names=[]) %}
                    {% for a in (sd.get('drawing_assignees') or []) %}
                    {% if a is mapping and a.get('name') %}
                    {% set ns.draftsman_names = ns.draftsman_names + [a.get('name')] %}
                    {% elif a is string %}
                    {% set ns.draftsman_names = ns.draftsman_names + [a] %}
                    {% endif %}
                    {% endfor %}
                    {% set draftsman_text = ns.draftsman_names|join(', ') if ns.draftsman_names else '미지정' %}
                    {% set has_assignee = (ns.draftsman_names|length > 0) or ((assignments.get('drawing_assignee_user_ids') or [])|length > 0) %}
                    {% set drawing_status_label = '작업중' %}
                    {% set drawing_status_badge = 'bg-secondary' %}
                    {% if drawing_status == 'TRANSFERRED' %}
                    {% set drawing_status_label = '확정 대기' %}
                    {% set drawing_status_badge = 'bg-warning text-dark' %}
                    {% elif drawing_status == 'RETURNED' %}
                    {% set drawing_status_label = '수정 요청됨' %}
                    {% set drawing_status_badge = 'bg-danger' %}
                    {% elif drawing_status in ['CONFIRMED', 'DONE'] %}
                    {% set drawing_status_label = '완료' %}
                    {% set drawing_status_badge = 'bg-success' %}
                    {% endif %}
                    {% set todo_text = '지금: 도면 담당자가 도면 전달을 진행해 주세요.' %}
                    {% if not has_assignee %}
                    {% set todo_text = '지금: 도면 담당자 지정이 필요합니다.' %}
                    {% elif drawing_status == 'TRANSFERRED' %}
                    {% set todo_text = '지금: 주문 담당자가 수령 확정 또는 수정 요청을 선택해야 합니다.' %}
                    {% elif drawing_status == 'RETURNED' %}
                    {% set todo_text = '지금: 도면 담당자가 수정본을 재전달해야 합니다.' %}
                    {% elif drawing_status in ['CONFIRMED', 'DONE'] %}
                    {% set todo_text = '지금: 도면 확인 완료. 다음 단계 진행 상태를 확인해 주세요.' %}
                    {% endif %}
                    <div class="erp-drawing-gateway-card">
                      <div class="erp-drawing-gateway-head">
                        <span class="erp-drawing-gateway-title">
                          <i class="fas fa-drafting-compass"></i> 도면 창구
                        </span>
                        <span class="badge {{ drawing_status_badge }}">{{ drawing_status_label }}</span>
                      </div>
                      <div class="erp-drawing-quest-todo">
                        <i class="fas fa-bolt text-primary"></i> {{ todo_text }}
                      </div>
                      <div class="erp-drawing-gateway-meta">
                        도면 담당: <strong>{{ draftsman_text }}</strong><br />
                        주문 담당: <strong>{{ o.manager_name or '-' }}</strong>
                        {% if drawing_transferred and drawing_files %}
                        <br />전달 파일: <strong>{{ drawing_files|length }}개</strong>
                        {% endif %}
                      </div>
                      {% if latest_history %}
                      {% set h = latest_history %}
                      {% set h_action = h.get('action') or '' %}
                      {% set h_action_label = '기타' %}
                      {% if h_action == 'TRANSFER' %}
                      {% set h_action_label = '도면 전달' %}
                      {% elif h_action == 'REQUEST_REVISION' %}
                      {% set h_action_label = '수정 요청' %}
                      {% elif h_action == 'CANCEL_TRANSFER' %}
                      {% set h_action_label = '전달 취소' %}
                      {% endif %}
                      <div class="erp-drawing-quest-recent">
                        <i class="fas fa-history"></i>
                        최근: <strong>{{ h_action_label }}</strong>
                        · {{ h.get('by_user_name') or '-' }}
                        · {{ h.get('transferred_at') or h.get('at') or '-' }}
                      </div>
                      {% endif %}
                      <div class="small text-muted mb-1">
                        첨부 요약: 최신본 {{ drawing_files|length }}개
                      </div>
                      <div class="erp-drawing-gateway-actions">
                        <a class="btn btn-primary"
                          href="{{ url_for('erp_beta.erp_drawing_workbench_detail', order_id=o.id) }}?tab=timeline">
                          <i class="fas fa-comments"></i> 별도 작업실 열기
                        </a>
                      </div>
                    </div>
                    {% else %}
                    <span class="text-muted" style="font-size: 1.1rem;">-</span>
                    {% endif %}
                    {% endif %}
                  </td>
                  <td data-label="고객" class="fw-bold erp-wrap" style="font-size: 1.1rem; color: #212529;">{{
                    o.customer_name }}</td>
                  <td data-label="연락처" style="font-size: 1.1rem; color: #495057;">{{ o.phone }}</td>
                  <td data-label="주소" class="erp-wrap"
                    style="font-size: 1.1rem; color: #495057; word-break: break-word;">{{ o.address }}</td>
                  <td data-label="제품" class="erp-wrap"
                    style="font-size: 1.1rem; color: #495057; word-break: break-word;">
                    {% if o.is_erp_beta and o.structured_data and o.structured_data.get('items') %}
                    {% set items = o.structured_data.get('items', []) %}
                    {% for item in items %}
                    <div>{{ item.get('product_name', '-') }}</div>
                    {% endfor %}
                    {% else %}
                    {{ o.product or '-' }}
                    {% endif %}
                  </td>
                  <td data-label="실측일" class="fw-semibold" style="font-size: 1.1rem; color: #495057;">{{
                    o.measurement_date or '-' }}</td>
                  <td data-label="시공일" class="fw-semibold" style="font-size: 1.1rem; color: #495057;">{{
                    o.construction_date or '-' }}</td>
                  <td data-label="담당" style="font-size: 1.1rem; color: #495057;">{{ o.manager_name or '-' }}</td>
                  <td data-label="첨부">
                    {% if o.has_media %}
                    {% set order_id_att = o.id %}
                    <span class="badge bg-primary text-white fw-bold erp-btn-attachments-preview"
                      style="cursor: pointer; font-size: 1rem !important; padding: 0.4em 0.7em !important; text-align: center; display: inline-block;"
                      data-order-id="{{ order_id_att }}" title="첨부 파일 미리보기">{{ o.attachments_count
                      }}</span>
                    {% else %}
                    <span class="text-muted" style="font-size: 1.1rem;">-</span>
                    {% endif %}
                  </td>
                  <td data-label="상세" class="text-center">
                    {% set order_id_detail = o.id %}
                    {% if can_edit_erp_beta|default(false) %}
                    <a class="badge bg-info text-white fw-bold"
                      href="{{ url_for('edit_order', order_id=order_id_detail) }}?open=erp-beta" title="제품 상세정보"
                      style="cursor: pointer; font-size: 1rem !important; padding: 0.4em 0.7em !important; text-align: center; display: inline-block; text-decoration: none;">
                      <i class="fas fa-clipboard-list" style="font-size: 1rem !important;"></i>
                    </a>
                    {% else %}
                    <span class="text-muted small">(수정 권한 없음)</span>
                    {% endif %}
                  </td>
                  <td data-label="열기" class="text-end erp-cell-actions">
                    <button class="erp-open-btn-icon" type="button" data-bs-toggle="collapse"
                      data-bs-target="#order-detail-collapse-{{ o.id }}" aria-expanded="false"
                      aria-controls="order-detail-collapse-{{ o.id }}" title="열기">
                      <i class="fas fa-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Order Detail Slide -->
                <tr>
                  <td colspan="12" class="p-0">
                    <div class="collapse" id="order-detail-collapse-{{ o.id }}">
                      <div class="card card-body border-0 bg-light">
                        <div class="fw-bold mb-3 erp-order-detail-title"><i class="fas fa-info-circle"></i> 주문 상세</div>
                        <div id="order-detail-content-{{ o.id }}" class="order-detail-content">
                          <div class="text-muted small">로딩 중...</div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- 첨부 파일 카테고리 모달 -->
  <div class="modal fade" id="erpAttachmentsCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-paperclip"></i> 첨부 파일</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex flex-wrap gap-2 mb-3" id="erp-attachments-category-tabs"></div>
          <div class="row g-2" id="erp-attachments-category-gallery"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>
  </div>



  <!-- Draftsman Assign Modal -->
  <div class="modal fade" id="erpDraftsmanAssignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-users-cog"></i> 도면 담당자 지정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">도면 작업을 수행할 담당자를 선택해주세요. <strong>도면팀 소속 직원만</strong> 선택 가능합니다. (다중 선택 가능)</p>
          <div id="erp-draftsman-list" class="list-group">
            <div class="text-center text-muted">로딩 중...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="saveDraftsmanAssignment()">저장</button>
        </div>
      </div>
    </div>
  </div>

      <!-- Drawing Revision Request Modal -->
      <div class="modal fade" id="erpDrawingRevisionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title text-danger"><i class="fas fa-undo"></i> 도면 수정 요청</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted small mb-3">
                도면 수정 요청 사항을 입력해주세요.<br>
                요청 시 상태가 <strong>'수정 요청됨(반려)'</strong>으로 변경되며 도면팀에 알림이 전송됩니다.
              </p>
              <div class="mb-3">
                <label for="drawing-revision-note" class="form-label fw-bold">수정 요청 사유 (필수)</label>
                <textarea class="form-control" id="drawing-revision-note" rows="4"
                  placeholder="예: 거실장 높이 2400으로 변경 요망, 색상 변경 확인 필요 등"></textarea>
              </div>
              <div class="mb-3">
                <label for="drawing-revision-target-key" class="form-label fw-bold">수정 대상 도면 선택</label>
                <div id="drawing-revision-target-cards" class="drawing-target-card-grid mb-2"></div>
                <select class="form-select d-none" id="drawing-revision-target-key">
                  <option value="">도면 선택</option>
                </select>
                <div class="form-text" id="drawing-revision-target-help">카드를 클릭해 수정 대상 번호를 선택하세요.</div>
              </div>
              <div class="mb-3">
                <label for="drawing-revision-files" class="form-label fw-bold">요청 참고 사진 (선택, 다중 가능)</label>
                <input class="form-control" type="file" id="drawing-revision-files" multiple accept="image/*">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-danger" onclick="submitDrawingRevision()">
                <i class="fas fa-paper-plane"></i> 수정 요청 보내기
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Drawing Transfer Modal -->
      <div class="modal fade" id="erpDrawingTransferModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-paper-plane"></i> 도면 전달 및 파일 업로드</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted small mb-3">
                작업 완료된 도면 파일을 업로드하고 전달 사항을 입력하세요.<br>
                전달 후 상태가 <strong>'확정 대기'</strong>로 변경되며 담당자에게 알림이 전송됩니다.
              </p>
              <div class="mb-3">
                <label for="drawing-transfer-files" class="form-label fw-bold">도면 파일 (다중 선택 가능)</label>
                <input class="form-control" type="file" id="drawing-transfer-files" multiple
                  accept="image/*,.pdf,.zip,.dwg">
              </div>
              <div class="mb-3">
                <label for="drawing-transfer-note" class="form-label fw-bold">전달 사항 (메모)</label>
                <textarea class="form-control" id="drawing-transfer-note" rows="3"
                  placeholder="예: 1차 도면 완료, 확인 부탁드립니다."></textarea>
              </div>
              <div class="mb-3" id="drawing-transfer-replace-wrap" style="display:none;">
                <label for="drawing-transfer-replace-key" class="form-label fw-bold">교체할 기존 도면 선택</label>
                <div id="drawing-transfer-replace-cards" class="drawing-target-card-grid mb-2"></div>
                <select class="form-select d-none" id="drawing-transfer-replace-key">
                  <option value="">선택 안 함 (새 번호로 추가)</option>
                </select>
                <div class="form-text" id="drawing-transfer-replace-help">카드를 클릭해 교체할 번호를 선택하세요.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-primary" onclick="submitDrawingTransfer()">
                <i class="fas fa-paper-plane"></i> 전달하기
              </button>
            </div>
          </div>
        </div>
      </div>

      <script>
        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = String(text);
          return div.innerHTML;
        }

        function showErpToast(message, type = 'info') {
          const id = 'erp-toast-container';
          let container = document.getElementById(id);
          if (!container) {
            container = document.createElement('div');
            container.id = id;
            container.style.position = 'fixed';
            container.style.top = '84px';
            container.style.right = '16px';
            container.style.zIndex = '30000';
            container.style.display = 'grid';
            container.style.gap = '8px';
            container.style.maxWidth = '320px';
            document.body.appendChild(container);
          }
          const palette = {
            success: { bg: '#ecfdf5', bd: '#10b981', fg: '#065f46' },
            error: { bg: '#fef2f2', bd: '#ef4444', fg: '#991b1b' },
            info: { bg: '#eff6ff', bd: '#3b82f6', fg: '#1e3a8a' },
          };
          const p = palette[type] || palette.info;
          const toast = document.createElement('div');
          toast.style.background = p.bg;
          toast.style.border = `1px solid ${p.bd}`;
          toast.style.color = p.fg;
          toast.style.borderRadius = '10px';
          toast.style.padding = '9px 11px';
          toast.style.fontSize = '13px';
          toast.style.boxShadow = '0 6px 16px rgba(0,0,0,0.12)';
          toast.textContent = String(message || '');
          container.appendChild(toast);
          setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.22s ease';
            setTimeout(() => toast.remove(), 240);
          }, 2200);
        }


        // === 표시용 한글 라벨(저장은 영문 코드 유지) ===
        const TEAM_LABELS = JSON.parse('{{ team_labels| tojson | safe }}');
        const STAGE_LABELS = JSON.parse('{{ stage_labels| tojson | safe }}');
        const CAN_EDIT_ERP_BETA = (document.querySelector('.erp-dashboard')?.dataset?.canEditErpBeta || 'false') === 'true';

        function label(map, code, fallback = '-') {
          if (!code) return fallback;
          return map[code] || code;
        }

        let __selectedOrderId = null;
        let __attachmentsCache = {};
        let __currentAttachmentList = [];
        let __currentAttachmentIndex = 0;
        let __drawingCurrentFilesByOrder = {};
        let __activeAttachmentCategory = 'measurement';
        let __attachmentsByCategory = {
          measurement: [],
          drawing: [],
          construction: []
        };

        const ATTACHMENT_CATEGORY_META = {
          measurement: { label: '실측', icon: 'fa-ruler-combined' },
          drawing: { label: '도면', icon: 'fa-drafting-compass' },
          construction: { label: '시공', icon: 'fa-hammer' }
        };

        function normalizeAttachmentCategory(category) {
          const c = String(category || '').trim().toLowerCase();
          if (c === 'drawing' || c === 'construction') return c;
          return 'measurement';
        }

        function getAttachmentCategoryLabel(category) {
          const key = normalizeAttachmentCategory(category);
          return (ATTACHMENT_CATEGORY_META[key] || ATTACHMENT_CATEGORY_META.measurement).label;
        }

        function renderAttachmentCategoryTabs() {
          const tabsEl = document.getElementById('erp-attachments-category-tabs');
          if (!tabsEl) return;
          const keys = ['measurement', 'drawing', 'construction'];
          tabsEl.innerHTML = keys.map((key) => {
            const meta = ATTACHMENT_CATEGORY_META[key];
            const count = (__attachmentsByCategory[key] || []).length;
            const isActive = key === __activeAttachmentCategory;
            const activeCls = isActive ? 'btn-primary' : 'btn-outline-primary';
            return `
              <button type="button" class="btn btn-sm ${activeCls}" onclick="selectAttachmentCategory('${key}')">
                <i class="fas ${meta.icon}"></i> ${meta.label}
                <span class="badge ${isActive ? 'bg-light text-dark' : 'bg-primary text-white'} ms-1">${count}</span>
              </button>
            `;
          }).join('');
        }

        function renderAttachmentCategoryGallery() {
          const galleryEl = document.getElementById('erp-attachments-category-gallery');
          if (!galleryEl) return;
          const list = __attachmentsByCategory[__activeAttachmentCategory] || [];
          if (!list.length) {
            galleryEl.innerHTML = `
              <div class="col-12">
                <div class="text-muted small p-3 border rounded bg-light">
                  ${getAttachmentCategoryLabel(__activeAttachmentCategory)} 카테고리에 첨부 파일이 없습니다.
                </div>
              </div>
            `;
            return;
          }

          galleryEl.innerHTML = list.map((a, index) => {
            const name = escapeHtml(a.filename || '');
            const type = a.file_type || 'file';
            const thumb = a.thumbnail_view_url || a.view_url || '#';
            const viewUrl = a.view_url || '#';
            const downloadUrl = a.download_url || '#';

            const mediaHtml = (type === 'video')
              ? `<div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;">
                  <video src="${viewUrl}" controls preload="metadata" style="width:100%;height:100%;"></video>
                </div>`
              : (type === 'image')
                ? `<img src="${thumb}" alt="${name}" class="img-fluid rounded"
                    style="max-height: 180px; object-fit: contain; width:100%; cursor: zoom-in; background:#fff; padding:4px;"
                    onclick="openAttachmentFromCategory('${__activeAttachmentCategory}', ${index})">`
                : `<div class="border rounded d-flex flex-column align-items-center justify-content-center bg-light"
                    style="height: 180px;">
                    <i class="fas fa-file-alt text-secondary mb-2" style="font-size: 2rem;"></i>
                    <div class="small text-muted text-center px-2">문서 파일</div>
                   </div>`;

            return `
              <div class="col-md-4 col-sm-6 col-12">
                <div class="card h-100">
                  <div class="card-body p-2">
                    ${mediaHtml}
                    <div class="d-flex justify-content-between align-items-center mt-2">
                      <div class="small text-truncate" title="${name}" style="max-width: 70%;">${name}</div>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" type="button" title="미리보기"
                          onclick="openAttachmentFromCategory('${__activeAttachmentCategory}', ${index})">
                          <i class="fas fa-eye"></i>
                        </button>
                        <a class="btn btn-outline-primary" href="${downloadUrl}" title="다운로드" target="_blank" rel="noopener">
                          <i class="fas fa-download"></i>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        function selectAttachmentCategory(category) {
          __activeAttachmentCategory = normalizeAttachmentCategory(category);
          renderAttachmentCategoryTabs();
          renderAttachmentCategoryGallery();
        }

        function openAttachmentFromCategory(category, index) {
          const key = normalizeAttachmentCategory(category);
          const list = __attachmentsByCategory[key] || [];
          if (!list.length) return;
          __activeAttachmentCategory = key;
          __currentAttachmentList = list;
          showAttachmentAtIndex(index);
        }

        function drawingActionLabel(action) {
          const map = {
            TRANSFER: '도면 전달',
            REQUEST_REVISION: '수정 요청',
            CANCEL_TRANSFER: '전달 취소'
          };
          return map[action] || (action || '기타');
        }

        function drawingTargetLabel(h) {
          if (!h || typeof h !== 'object') return '';
          const n = Number(h.target_drawing_number || h.replace_target_number || 0);
          return n > 0 ? `${n}번 대상` : '';
        }

        let __drawingGatewayImageGroups = {};
        let __drawingGatewayViewerFiles = [];
        let __drawingGatewayViewerIndex = 0;
        let __drawingGatewayViewerScale = 1;
        let __drawingGatewayViewerPanX = 0;
        let __drawingGatewayViewerPanY = 0;
        let __drawingGatewayViewerDragging = false;
        let __drawingGatewayViewerStartX = 0;
        let __drawingGatewayViewerStartY = 0;
        let __drawingGatewayViewerStartPanX = 0;
        let __drawingGatewayViewerStartPanY = 0;
        let __drawingGatewayViewerTouchDistance = 0;
        let __drawingGatewayViewerTouchScale = 1;
        let __drawingGatewayViewerBound = false;

        function gatewayFileName(f) {
          return String((f && f.filename) || '첨부파일');
        }

        function gatewayViewUrl(f) {
          return String((f && f.view_url) || ((f && f.key) ? `/api/files/view/${f.key}` : '#'));
        }

        function gatewayDownloadUrl(f) {
          return String((f && f.download_url) || ((f && f.key) ? `/api/files/download/${f.key}` : '#'));
        }

        function isGatewayImageFile(f) {
          const probe = `${gatewayFileName(f)} ${gatewayViewUrl(f)} ${String((f && f.key) || '')}`.toLowerCase();
          return /\.(jpg|jpeg|png|gif|webp|bmp|svg|heic|heif)(\?|$)/.test(probe);
        }

        function getDrawingGatewayViewerElements() {
          return {
            root: document.getElementById('drawing-gateway-image-viewer'),
            backdrop: document.getElementById('drawing-gateway-viewer-backdrop'),
            closeBtn: document.getElementById('drawing-gateway-viewer-close'),
            prevBtn: document.getElementById('drawing-gateway-viewer-prev'),
            nextBtn: document.getElementById('drawing-gateway-viewer-next'),
            stage: document.getElementById('drawing-gateway-viewer-stage'),
            image: document.getElementById('drawing-gateway-viewer-image'),
            zoomBadge: document.getElementById('drawing-gateway-viewer-zoom-badge'),
            filename: document.getElementById('drawing-gateway-viewer-filename'),
            counter: document.getElementById('drawing-gateway-viewer-counter')
          };
        }

        function applyDrawingGatewayViewerTransform() {
          const { image, zoomBadge } = getDrawingGatewayViewerElements();
          if (!image || !zoomBadge) return;
          image.style.transform = `translate(${__drawingGatewayViewerPanX}px, ${__drawingGatewayViewerPanY}px) scale(${__drawingGatewayViewerScale})`;
          zoomBadge.textContent = `${Math.round(__drawingGatewayViewerScale * 100)}%`;
          zoomBadge.style.display = __drawingGatewayViewerScale === 1 ? 'none' : 'block';
          positionDrawingGatewayViewerNav();
        }

        function positionDrawingGatewayViewerNav() {
          const { root, image, prevBtn, nextBtn } = getDrawingGatewayViewerElements();
          if (!root || !image || !prevBtn || !nextBtn) return;
          if (!root.classList.contains('gateway-has-multiple')) return;

          const rootRect = root.getBoundingClientRect();
          const imgRect = image.getBoundingClientRect();
          if (!imgRect.width || !imgRect.height || !rootRect.width || !rootRect.height) return;

          const navSize = 48;
          const edgePad = 10;
          const minX = 12;
          const maxX = Math.max(minX, rootRect.width - navSize - 12);
          const centerY = Math.max(28, Math.min(rootRect.height - 28, (imgRect.top - rootRect.top) + (imgRect.height / 2)));

          let leftX = (imgRect.left - rootRect.left) + edgePad;
          let rightX = (imgRect.right - rootRect.left) - navSize - edgePad;
          leftX = Math.max(minX, Math.min(maxX, leftX));
          rightX = Math.max(minX, Math.min(maxX, rightX));
          if (rightX - leftX < navSize + 12) {
            leftX = Math.max(minX, leftX - 24);
            rightX = Math.min(maxX, rightX + 24);
          }

          prevBtn.style.left = `${leftX}px`;
          prevBtn.style.right = 'auto';
          prevBtn.style.top = `${centerY}px`;

          nextBtn.style.left = `${rightX}px`;
          nextBtn.style.right = 'auto';
          nextBtn.style.top = `${centerY}px`;
        }

        function resetDrawingGatewayViewerTransform() {
          __drawingGatewayViewerScale = 1;
          __drawingGatewayViewerPanX = 0;
          __drawingGatewayViewerPanY = 0;
          applyDrawingGatewayViewerTransform();
        }

        function zoomDrawingGatewayViewerAt(deltaY, clientX, clientY) {
          const { stage } = getDrawingGatewayViewerElements();
          if (!stage) return;
          const rect = stage.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          const x = clientX - centerX;
          const y = clientY - centerY;

          const oldScale = __drawingGatewayViewerScale;
          const zoomFactor = deltaY > 0 ? 0.9 : 1.1;
          __drawingGatewayViewerScale = Math.max(0.5, Math.min(10, __drawingGatewayViewerScale * zoomFactor));

          if (__drawingGatewayViewerScale !== oldScale) {
            const ratio = __drawingGatewayViewerScale / oldScale;
            __drawingGatewayViewerPanX = x - (x - __drawingGatewayViewerPanX) * ratio;
            __drawingGatewayViewerPanY = y - (y - __drawingGatewayViewerPanY) * ratio;
          }
          applyDrawingGatewayViewerTransform();
        }

        function updateDrawingGatewayViewerNav() {
          const { prevBtn, nextBtn, counter, root } = getDrawingGatewayViewerElements();
          const total = __drawingGatewayViewerFiles.length;
          const current = __drawingGatewayViewerIndex + 1;
          const hasMultiple = total > 1;
          if (counter) counter.textContent = `${current} / ${total}`;
          if (prevBtn) prevBtn.style.display = hasMultiple ? 'flex' : 'none';
          if (nextBtn) nextBtn.style.display = hasMultiple ? 'flex' : 'none';
          if (root) {
            root.classList.toggle('gateway-has-multiple', hasMultiple);
            if (!hasMultiple) root.classList.remove('gateway-nav-visible');
          }
          requestAnimationFrame(positionDrawingGatewayViewerNav);
        }

        function renderDrawingGatewayViewerImage() {
          const { image, filename } = getDrawingGatewayViewerElements();
          if (!image || !filename) return;
          const current = __drawingGatewayViewerFiles[__drawingGatewayViewerIndex];
          if (!current) return;
          image.src = gatewayViewUrl(current);
          image.alt = gatewayFileName(current);
          filename.textContent = gatewayFileName(current);
          resetDrawingGatewayViewerTransform();
          updateDrawingGatewayViewerNav();
        }

        function showPrevDrawingGatewayImage() {
          if (!__drawingGatewayViewerFiles.length) return;
          __drawingGatewayViewerIndex = (__drawingGatewayViewerIndex - 1 + __drawingGatewayViewerFiles.length) % __drawingGatewayViewerFiles.length;
          renderDrawingGatewayViewerImage();
        }

        function showNextDrawingGatewayImage() {
          if (!__drawingGatewayViewerFiles.length) return;
          __drawingGatewayViewerIndex = (__drawingGatewayViewerIndex + 1) % __drawingGatewayViewerFiles.length;
          renderDrawingGatewayViewerImage();
        }

        function closeDrawingGatewayImageViewer() {
          const { root } = getDrawingGatewayViewerElements();
          if (!root) return;
          root.classList.remove('gateway-nav-visible');
          root.classList.add('d-none');
          root.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }

        function openDrawingGatewayImageViewer(groupKey, index) {
          const files = __drawingGatewayImageGroups[groupKey] || [];
          if (!files.length) return;
          
          if (window.GlobalImageViewer) {
             const viewerFiles = files.map(f => ({
                view_url: gatewayViewUrl(f),
                download_url: gatewayDownloadUrl(f),
                filename: gatewayFileName(f),
                file_type: 'image'
             }));
             window.GlobalImageViewer.open(viewerFiles, index || 0);
          } else {
             console.error('GlobalImageViewer not found');
             alert('이미지 뷰어를 불러올 수 없습니다.');
          }
        }

        function initDrawingGatewayImageViewer() {
          if (__drawingGatewayViewerBound) return;
          const { backdrop, closeBtn, prevBtn, nextBtn, stage, root, image } = getDrawingGatewayViewerElements();
          if (!stage || !root || !image) return;
          __drawingGatewayViewerBound = true;

          if (backdrop) backdrop.addEventListener('click', closeDrawingGatewayImageViewer);
          if (closeBtn) closeBtn.addEventListener('click', closeDrawingGatewayImageViewer);
          if (prevBtn) prevBtn.addEventListener('click', showPrevDrawingGatewayImage);
          if (nextBtn) nextBtn.addEventListener('click', showNextDrawingGatewayImage);

          root.addEventListener('mouseenter', () => {
            if (root.classList.contains('gateway-has-multiple')) {
              root.classList.add('gateway-nav-visible');
            }
          });
          root.addEventListener('mousemove', () => {
            if (root.classList.contains('gateway-has-multiple')) {
              root.classList.add('gateway-nav-visible');
            }
          });
          root.addEventListener('mouseleave', () => {
            root.classList.remove('gateway-nav-visible');
          });
          image.addEventListener('load', () => requestAnimationFrame(positionDrawingGatewayViewerNav));
          window.addEventListener('resize', () => {
            if (!root.classList.contains('d-none')) requestAnimationFrame(positionDrawingGatewayViewerNav);
          });

          document.addEventListener('keydown', (e) => {
            if (root.classList.contains('d-none')) return;
            if (e.key === 'Escape') closeDrawingGatewayImageViewer();
            else if (e.key === 'ArrowLeft') showPrevDrawingGatewayImage();
            else if (e.key === 'ArrowRight') showNextDrawingGatewayImage();
          });

          stage.addEventListener('wheel', (e) => {
            if (root.classList.contains('d-none')) return;
            e.preventDefault();
            zoomDrawingGatewayViewerAt(e.deltaY, e.clientX, e.clientY);
          }, { passive: false });

          stage.addEventListener('mousedown', (e) => {
            if (__drawingGatewayViewerScale <= 1) return;
            __drawingGatewayViewerDragging = true;
            stage.style.cursor = 'grabbing';
            __drawingGatewayViewerStartX = e.clientX;
            __drawingGatewayViewerStartY = e.clientY;
            __drawingGatewayViewerStartPanX = __drawingGatewayViewerPanX;
            __drawingGatewayViewerStartPanY = __drawingGatewayViewerPanY;
            e.preventDefault();
          });

          document.addEventListener('mousemove', (e) => {
            if (!__drawingGatewayViewerDragging) return;
            __drawingGatewayViewerPanX = __drawingGatewayViewerStartPanX + (e.clientX - __drawingGatewayViewerStartX);
            __drawingGatewayViewerPanY = __drawingGatewayViewerStartPanY + (e.clientY - __drawingGatewayViewerStartY);
            applyDrawingGatewayViewerTransform();
          });

          document.addEventListener('mouseup', () => {
            if (!__drawingGatewayViewerDragging) return;
            __drawingGatewayViewerDragging = false;
            stage.style.cursor = __drawingGatewayViewerScale > 1 ? 'grab' : 'default';
          });

          stage.addEventListener('dblclick', () => resetDrawingGatewayViewerTransform());

          stage.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
              __drawingGatewayViewerStartX = e.touches[0].clientX;
              __drawingGatewayViewerStartY = e.touches[0].clientY;
              __drawingGatewayViewerStartPanX = __drawingGatewayViewerPanX;
              __drawingGatewayViewerStartPanY = __drawingGatewayViewerPanY;
            } else if (e.touches.length === 2) {
              const t1 = e.touches[0];
              const t2 = e.touches[1];
              __drawingGatewayViewerTouchDistance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
              __drawingGatewayViewerTouchScale = __drawingGatewayViewerScale;
            }
          }, { passive: true });

          stage.addEventListener('touchmove', (e) => {
            if (root.classList.contains('d-none')) return;
            if (e.touches.length === 1 && __drawingGatewayViewerScale > 1) {
              e.preventDefault();
              const t = e.touches[0];
              __drawingGatewayViewerPanX = __drawingGatewayViewerStartPanX + (t.clientX - __drawingGatewayViewerStartX);
              __drawingGatewayViewerPanY = __drawingGatewayViewerStartPanY + (t.clientY - __drawingGatewayViewerStartY);
              applyDrawingGatewayViewerTransform();
            } else if (e.touches.length === 2) {
              e.preventDefault();
              const t1 = e.touches[0];
              const t2 = e.touches[1];
              const distance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
              __drawingGatewayViewerScale = Math.max(0.5, Math.min(10, __drawingGatewayViewerTouchScale * (distance / (__drawingGatewayViewerTouchDistance || distance))));
              applyDrawingGatewayViewerTransform();
            }
          }, { passive: false });
        }

        function renderGatewayFiles(files, groupKey) {
          if (!Array.isArray(files) || files.length === 0) return '';

          const imageFiles = files.filter(isGatewayImageFile);
          __drawingGatewayImageGroups[groupKey] = imageFiles;

          const imageItems = imageFiles.map((f, idx) => {
            const name = escapeHtml(gatewayFileName(f));
            const viewUrl = escapeHtml(gatewayViewUrl(f));
            const downloadUrl = escapeHtml(gatewayDownloadUrl(f));
            return `
              <div class="drawing-gateway-thumb-wrap me-2 mb-2">
                <div class="drawing-gateway-thumb" onclick="openDrawingGatewayImageViewer('${groupKey}', ${idx})">
                  <img src="${viewUrl}" alt="${name}">
                </div>
                <div class="small text-truncate mt-1" title="${name}" style="max-width: 110px;">${name}</div>
                <a href="${downloadUrl}" target="_blank" rel="noopener" class="small text-muted">
                  <i class="fas fa-download"></i>
                </a>
              </div>
            `;
          }).join('');

          const fileItems = files.filter(f => !isGatewayImageFile(f)).map((f) => {
            const name = escapeHtml(gatewayFileName(f));
            const viewUrl = escapeHtml(gatewayViewUrl(f));
            const downloadUrl = escapeHtml(gatewayDownloadUrl(f));
            return `
              <div class="d-flex align-items-center gap-1 me-2 mb-1">
                <i class="fas fa-paperclip text-secondary"></i>
                <a href="${viewUrl}" target="_blank" rel="noopener" class="small">${name}</a>
                <a href="${downloadUrl}" target="_blank" rel="noopener" class="small text-muted">
                  <i class="fas fa-download"></i>
                </a>
              </div>
            `;
          }).join('');

          return `
            <div class="d-flex flex-wrap mt-1">
              ${imageItems}
              ${fileItems}
            </div>
          `;
        }


        function renderDrawingGatewayTimeline(history) {
          if (!Array.isArray(history) || history.length === 0) {
            return '<div class="text-muted small">아직 요청/전달 이력이 없습니다.</div>';
          }
          const sorted = [...history].reverse();
          return sorted.map((h, idx) => {
            const action = drawingActionLabel(h.action);
            const byName = escapeHtml(h.by_user_name || '알 수 없음');
            const when = escapeHtml(h.transferred_at || h.at || '');
            const note = escapeHtml(h.note || '');
            const targetLabel = escapeHtml(drawingTargetLabel(h));
            const groupKey = `gateway_${idx}_${String(h.transferred_at || h.at || '').replace(/[^0-9A-Za-z]/g, '')}`;
            const filesHtml = renderGatewayFiles(h.files || [], groupKey);
            const badgeClass = h.action === 'REQUEST_REVISION'
              ? 'bg-danger'
              : (h.action === 'TRANSFER' ? 'bg-primary' : 'bg-secondary');
            return `
              <div class="border rounded p-2 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div>
                    <span class="badge ${badgeClass}">${action}</span>
                    <span class="small text-muted ms-2">${byName}</span>
                    ${targetLabel ? `<span class="badge bg-info text-dark ms-1">${targetLabel}</span>` : ''}
                  </div>
                  <span class="small text-muted">${when}</span>
                </div>
                ${note ? `<div class="small mt-1">${note}</div>` : ''}
                ${filesHtml}
              </div>
            `;
          }).join('');
        }


        // 주문의 첨부 파일 미리보기 (첨부 배지 클릭 시) - 좌우 네비게이션 지원
        async function openAttachmentsPreview(orderId, initialCategory = 'measurement') {
          try {
            // 캐시 확인
            let aList = null;
            if (__attachmentsCache[orderId]) {
              aList = __attachmentsCache[orderId];
            } else {
              const res = await fetch(`/api/orders/${orderId}/attachments`);
              const data = await res.json();
              aList = (data && data.attachments) || [];
              __attachmentsCache[orderId] = aList;
            }

            if (aList.length > 0) {
              __attachmentsByCategory = { measurement: [], drawing: [], construction: [] };
              aList.forEach((a) => {
                const key = normalizeAttachmentCategory(a.category);
                const normalized = Object.assign({}, a, { category: key });
                if (!__attachmentsByCategory[key]) __attachmentsByCategory[key] = [];
                __attachmentsByCategory[key].push(normalized);
              });

              let targetCategory = normalizeAttachmentCategory(initialCategory);
              const targetList = __attachmentsByCategory[targetCategory] || [];
              if (!targetList.length) {
                if (__attachmentsByCategory.drawing.length) targetCategory = 'drawing';
                else if (__attachmentsByCategory.measurement.length) targetCategory = 'measurement';
                else if (__attachmentsByCategory.construction.length) targetCategory = 'construction';
              }
              __activeAttachmentCategory = targetCategory;

              renderAttachmentCategoryTabs();
              renderAttachmentCategoryGallery();
              const modalEl = document.getElementById('erpAttachmentsCategoryModal');
              if (modalEl) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
              }
            } else {
              showErpToast('첨부 파일이 없습니다.', 'info');
            }
          } catch (err) {
            console.error('첨부 파일 로드 실패:', err);
            showErpToast('첨부 파일을 불러올 수 없습니다.', 'error');
          }
        }

        // GlobalImageViewer로 연결하는 레거시 호환 함수
        function openAttachmentPreviewModal(attachmentId, viewUrl, downloadUrl, filename, fileType) {
          if (window.GlobalImageViewer) {
            const singleFile = {
              view_url: viewUrl,
              download_url: downloadUrl,
              filename: filename,
              file_type: fileType
            };

            // 같은 주문의 첨부 캐시가 있으면 이미지 묶음으로 열어 좌우 이동 가능하게 처리
            const orderMatch = String(viewUrl || '').match(/\/orders\/(\d+)\//);
            const orderId = orderMatch ? Number(orderMatch[1]) : 0;
            const cached = orderId ? (__attachmentsCache[orderId] || []) : [];

            const isImage = (a) => {
              if (!a) return false;
              const ft = String(a.file_type || '').toLowerCase();
              if (ft === 'image') return true;
              const probe = String(a.view_url || a.filename || '').toLowerCase();
              return /\.(jpg|jpeg|png|gif|webp|bmp|svg|heic|heif)(\?|$)/.test(probe);
            };

            if (String(fileType || '').toLowerCase() === 'image' && Array.isArray(cached) && cached.length > 1) {
              const imageFiles = cached
                .filter(isImage)
                .map((a) => ({
                  view_url: a.view_url || '',
                  download_url: a.download_url || (a.view_url || ''),
                  filename: a.filename || '이미지',
                  file_type: 'image'
                }))
                .filter((a) => !!a.view_url);

              if (imageFiles.length > 1) {
                let startIndex = 0;
                if (attachmentId) {
                  const idxById = cached.filter(isImage).findIndex((a) => Number(a.id || 0) === Number(attachmentId));
                  if (idxById >= 0) startIndex = idxById;
                }
                if (startIndex === 0) {
                  const idxByUrl = imageFiles.findIndex((a) => String(a.view_url) === String(viewUrl));
                  if (idxByUrl >= 0) startIndex = idxByUrl;
                }
                window.GlobalImageViewer.open(imageFiles, startIndex);
                return;
              }
            }

            // 기본: 단일 파일로 열기
            window.GlobalImageViewer.open([singleFile], 0);
          } else {
            console.error('GlobalImageViewer not found');
            alert('이미지 뷰어를 불러올 수 없습니다.');
          }
        }

        // 특정 인덱스의 첨부 파일 표시
        function showAttachmentAtIndex(index) {
          if (!__currentAttachmentList || index < 0 || index >= __currentAttachmentList.length) {
            return;
          }

          __currentAttachmentIndex = index;
          
          if (window.GlobalImageViewer) {
             window.GlobalImageViewer.open(__currentAttachmentList, index);
          } else {
              console.error('GlobalImageViewer not found');
              showErpToast('이미지 뷰어를 불러올 수 없습니다.', 'error');
          }
        }

        function getDrawingCurrentFiles(orderId) {
          const list = __drawingCurrentFilesByOrder[orderId];
          return Array.isArray(list) ? list : [];
        }

        function getDrawingTargetNumber(orderId, key) {
          if (!key) return null;
          const list = getDrawingCurrentFiles(orderId);
          const idx = list.findIndex(f => String((f && f.key) || '') === String(key));
          return idx >= 0 ? (idx + 1) : null;
        }

        function isDrawingImageFile(f) {
          const probe = String((f && f.filename) || (f && f.key) || '').toLowerCase();
          return /\.(jpg|jpeg|png|gif|webp|bmp|svg|heic|heif)(\?|$)/.test(probe);
        }

        function buildDrawingTargetCards(orderId, selectedKey, opts = {}) {
          const files = getDrawingCurrentFiles(orderId);
          const includeNone = !!opts.includeNone;
          const role = opts.role || 'revision';
          const selected = String(selectedKey || '');
          const cards = [];

          if (includeNone) {
            cards.push(`
              <button type="button"
                class="drawing-target-card ${selected ? '' : 'is-active'}"
                data-role="${escapeHtml(role)}"
                data-key="">
                <div class="drawing-target-card-thumb"><i class="fas fa-plus text-secondary"></i></div>
                <div class="drawing-target-card-meta">
                  <span class="num">새 번호 추가</span><br />
                  기존 도면 유지
                </div>
              </button>
            `);
          }

          files.forEach((f, idx) => {
            const key = String((f && f.key) || '');
            const filename = String((f && f.filename) || `도면 ${idx + 1}`);
            const viewUrl = String((f && f.view_url) || (key ? `/api/files/view/${key}` : ''));
            const activeCls = key === selected ? 'is-active' : '';
            const selectedBadge = key === selected ? '<span class="drawing-target-selected-pill">선택됨</span>' : '';
            const thumbHtml = isDrawingImageFile(f)
              ? `<img src="${escapeHtml(viewUrl)}" alt="${escapeHtml(filename)}">`
              : `<i class="fas fa-file-alt text-secondary"></i>`;
            cards.push(`
              <button type="button"
                class="drawing-target-card ${activeCls}"
                data-role="${escapeHtml(role)}"
                data-key="${encodeURIComponent(key)}">
                <div class="drawing-target-card-thumb">${selectedBadge}${thumbHtml}</div>
                <div class="drawing-target-card-meta">
                  <span class="num">${idx + 1}번</span><br />
                  <span title="${escapeHtml(filename)}">${escapeHtml(filename)}</span>
                </div>
              </button>
            `);
          });

          return cards.join('');
        }

        function syncDrawingTargetCardSelection(role, selectedKey) {
          document.querySelectorAll(`.drawing-target-card[data-role="${role}"]`).forEach((el) => {
            const raw = String(el.getAttribute('data-key') || '');
            const key = raw ? decodeURIComponent(raw) : '';
            if (String(selectedKey || '') === key) el.classList.add('is-active');
            else el.classList.remove('is-active');
          });
        }

        function selectDrawingTargetByCard(role, key) {
          const selectedKey = String(key || '');
          if (role === 'revision') {
            const selectEl = document.getElementById('drawing-revision-target-key');
            if (selectEl) selectEl.value = selectedKey;
            syncDrawingTargetCardSelection('revision', selectedKey);
          } else if (role === 'replace') {
            const selectEl = document.getElementById('drawing-transfer-replace-key');
            if (selectEl) selectEl.value = selectedKey;
            syncDrawingTargetCardSelection('replace', selectedKey);
          }
        }

        function renderRevisionTargetSelector(orderId) {
          const cardsEl = document.getElementById('drawing-revision-target-cards');
          const selectEl = document.getElementById('drawing-revision-target-key');
          const helpEl = document.getElementById('drawing-revision-target-help');
          if (!selectEl || !cardsEl) return;
          const files = getDrawingCurrentFiles(orderId);
          let html = '<option value="">도면 선택</option>';
          files.forEach((f, idx) => {
            const key = String((f && f.key) || '');
            const filename = String((f && f.filename) || `도면 ${idx + 1}`);
            html += `<option value="${escapeHtml(key)}">${idx + 1}번 · ${escapeHtml(filename)}</option>`;
          });
          selectEl.innerHTML = html;
          if (files.length === 1) {
            selectEl.value = String((files[0] && files[0].key) || '');
          }
          cardsEl.innerHTML = buildDrawingTargetCards(orderId, selectEl.value, { role: 'revision' });
          syncDrawingTargetCardSelection('revision', selectEl.value);
          selectEl.onchange = () => syncDrawingTargetCardSelection('revision', selectEl.value);
          if (helpEl) {
            helpEl.textContent = files.length > 1
              ? '여러 장입니다. 수정 요청할 도면 번호를 선택해주세요.'
              : (files.length === 1
                ? '현재 1장입니다. 자동 선택되었습니다.'
                : '현재 전달된 도면이 없습니다.');
          }
        }

        function renderTransferReplaceSelector(orderId, isRetransfer) {
          const wrapEl = document.getElementById('drawing-transfer-replace-wrap');
          const cardsEl = document.getElementById('drawing-transfer-replace-cards');
          const selectEl = document.getElementById('drawing-transfer-replace-key');
          const helpEl = document.getElementById('drawing-transfer-replace-help');
          if (!wrapEl || !selectEl || !cardsEl) return;
          const files = getDrawingCurrentFiles(orderId);
          wrapEl.style.display = files.length ? '' : 'none';
          if (!files.length) {
            selectEl.innerHTML = '<option value="">교체할 도면 없음</option>';
            cardsEl.innerHTML = '';
            return;
          }

          let html = `<option value="">${isRetransfer ? '교체할 도면을 선택하세요' : '선택 안 함 (새 번호로 추가)'}</option>`;
          files.forEach((f, idx) => {
            const key = String((f && f.key) || '');
            const filename = String((f && f.filename) || `도면 ${idx + 1}`);
            html += `<option value="${escapeHtml(key)}">${idx + 1}번 삭제 후 교체 · ${escapeHtml(filename)}</option>`;
          });
          selectEl.innerHTML = html;
          if (isRetransfer && files.length === 1) {
            selectEl.value = String((files[0] && files[0].key) || '');
          } else {
            selectEl.value = '';
          }
          cardsEl.innerHTML = buildDrawingTargetCards(orderId, selectEl.value, { role: 'replace', includeNone: !isRetransfer });
          syncDrawingTargetCardSelection('replace', selectEl.value);
          selectEl.onchange = () => syncDrawingTargetCardSelection('replace', selectEl.value);
          if (helpEl) {
            helpEl.textContent = isRetransfer
              ? '재전송 시 교체할 번호를 선택하세요. (여러 장이면 필수)'
              : '필요 시 기존 번호를 교체하거나, 선택 안 하면 새 번호로 추가됩니다.';
          }
        }

        let __currentTransferOrderId = null;

        let __isRetransfer = false;
        function openTransferDrawingModal(orderId, isRetransfer = false) {
          __currentTransferOrderId = orderId;
          __isRetransfer = isRetransfer;

          // Reset Inputs
          document.getElementById('drawing-transfer-files').value = '';
          document.getElementById('drawing-transfer-note').value = '';
          const replaceSelectEl = document.getElementById('drawing-transfer-replace-key');
          if (replaceSelectEl) replaceSelectEl.value = '';

          // Update Modal Title/Text based on mode
          const titleEl = document.querySelector('#erpDrawingTransferModal .modal-title');
          const descEl = document.querySelector('#erpDrawingTransferModal .modal-body p');
          const submitBtn = document.querySelector('#erpDrawingTransferModal .modal-footer .btn-primary');

          if (isRetransfer) {
            titleEl.innerHTML = '<i class="fas fa-sync"></i> 도면 재전송 (수정본)';
            descEl.innerHTML = `
            <span class="text-danger fw-bold"><i class="fas fa-exclamation-triangle"></i> 주의: 선택한 번호의 기존 도면만 삭제 후 수정본으로 교체됩니다.</span><br>
            수정본 파일을 업로드하고 교체할 번호를 선택하세요.
          `;
            submitBtn.innerHTML = '<i class="fas fa-sync"></i> 재전송하기';
            submitBtn.classList.replace('btn-primary', 'btn-warning');
          } else {
            titleEl.innerHTML = '<i class="fas fa-paper-plane"></i> 도면 전달 및 파일 업로드';
            descEl.innerHTML = `
             작업 완료된 도면 파일을 업로드하고 전달 사항을 입력하세요.<br>
             전달 후 상태가 <strong>'확정 대기'</strong>로 변경되며 담당자에게 알림이 전송됩니다.
          `;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 전달하기';
            submitBtn.classList.replace('btn-warning', 'btn-primary');
          }

          renderTransferReplaceSelector(orderId, isRetransfer);

          const modal = new bootstrap.Modal(document.getElementById('erpDrawingTransferModal'));
          modal.show();
        }

        async function submitDrawingTransfer() {
          if (!__currentTransferOrderId) return;

          const noteInput = document.getElementById('drawing-transfer-note');
          const note = noteInput ? noteInput.value.trim() : '';
          const filesInput = document.getElementById('drawing-transfer-files');
          const files = filesInput ? filesInput.files : [];
          const replaceSelectEl = document.getElementById('drawing-transfer-replace-key');
          const replaceTargetKey = (replaceSelectEl && replaceSelectEl.value) ? String(replaceSelectEl.value).trim() : '';
          const currentFiles = getDrawingCurrentFiles(__currentTransferOrderId);
          if (__isRetransfer && currentFiles.length > 1 && !replaceTargetKey) {
            showErpToast('수정본 재전송 시 교체할 도면 번호를 선택해주세요.', 'info');
            return;
          }

          const msg = __isRetransfer
            ? '선택한 기존 도면이 삭제되고 새 파일로 대체됩니다.\n정말 재전송 하시겠습니까?'
            : '도면을 전달하시겠습니까?';

          if (!confirm(msg)) return;

          let createdFiles = []; // Track uploaded files to send to transfer API

          // 1. File Upload First (if any)
          if (files.length > 0) {
            try {
              // Upload files sequentially or in parallel
              // Since app.py expects 'file' key per request, we loop.
              const uploadPromises = Array.from(files).map(async (file) => {
                const formData = new FormData();
                formData.append('file', file); // Should match backend expectation
                formData.append('category', 'drawing');
                formData.append('note', '[도면 전달 첨부] ' + note); // Optional, backend might ignore for attachments

                const upRes = await fetch(`/api/orders/${__currentTransferOrderId}/attachments`, {
                  method: 'POST',
                  body: formData
                });
                const upData = await upRes.json();
                if (!upData.success) {
                  throw new Error(file.name + ' 업로드 실패: ' + (upData.message || upData.error));
                }
                // app.py upload endpoint returns { success, attachment: {...} }
                const att = upData.attachment || {};
                if (att.storage_key) {
                  return {
                    key: att.storage_key,
                    filename: att.filename || file.name,
                    view_url: att.view_url || `/api/files/view/${att.storage_key}`,
                    download_url: att.download_url || `/api/files/download/${att.storage_key}`,
                  };
                }
                return null;
              });

              const results = await Promise.all(uploadPromises);
              createdFiles = results.filter(r => r !== null);
            } catch (e) {
              console.error(e);
              showErpToast(e.message || '파일 업로드 중 오류가 발생했습니다.', 'error');
              return;
            }
          }

          // 2. Transfer Call
          try {
            const bodyData = {
              note: note,
              files: createdFiles, // Send list of uploaded files [ {key, filename}... ]
              is_retransfer: __isRetransfer,
              replace_target_key: replaceTargetKey || null,
              replace_target_number: getDrawingTargetNumber(__currentTransferOrderId, replaceTargetKey),
            };
            // If retransfer, we can add flag if backend needs it explicit (backend currently infers from files existence + status, but let's be safe if we accepted `is_retransfer` param? 
            // Backend logic I wrote checks `new_files` presence.

            const res = await fetch(`/api/orders/${__currentTransferOrderId}/transfer-drawing`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(bodyData)
            });
            const data = await res.json();

            if (data.success) {
              showErpToast(data.message || '도면이 전달되었습니다.', 'success');
              // Close modal
              const modalEl = document.getElementById('erpDrawingTransferModal');
              const modal = bootstrap.Modal.getInstance(modalEl);
              if (modal) modal.hide();

              window.location.reload();
            } else {
              showErpToast('오류: ' + data.message, 'error');
            }
          } catch (err) {
            console.error('Drawing transfer error:', err);
            showErpToast('도면 전달 중 오류가 발생했습니다.', 'error');
          }
        }

        async function cancelDrawingTransfer(orderId) {
          if (!confirm('정말 도면 전달을 취소하시겠습니까?\n상태가 [작업중]으로 되돌아가며 최신 전달 파일/이력이 정리됩니다.')) return;

          try {
            const res = await fetch(`/api/orders/${orderId}/cancel-transfer`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
              showErpToast(data.message || '전달이 취소되었습니다.', 'success');
              window.location.reload();
            } else {
              showErpToast('취소 실패: ' + data.message, 'error');
            }
          } catch (e) {
            console.error(e);
            showErpToast('오류가 발생했습니다.', 'error');
          }
        }

        let __currentRevisionOrderId = null;
        function openRevisionRequestModal(orderId) {
          __currentRevisionOrderId = orderId;
          document.getElementById('drawing-revision-note').value = '';
          const revisionTargetSelect = document.getElementById('drawing-revision-target-key');
          if (revisionTargetSelect) revisionTargetSelect.value = '';
          const revisionFilesInput = document.getElementById('drawing-revision-files');
          if (revisionFilesInput) revisionFilesInput.value = '';
          renderRevisionTargetSelector(orderId);
          const modal = new bootstrap.Modal(document.getElementById('erpDrawingRevisionModal'));
          modal.show();
        }

        async function uploadRevisionGatewayFiles(orderId, files) {
          const uploadPromises = Array.from(files).map(async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch(`/api/orders/${orderId}/drawing-gateway-upload`, {
              method: 'POST',
              body: formData
            });
            const data = await res.json();
            if (!data.success || !data.file) {
              throw new Error(file.name + ' 업로드 실패: ' + (data.message || '알 수 없는 오류'));
            }
            return data.file;
          });
          return Promise.all(uploadPromises);
        }

        async function submitDrawingRevision() {
          if (!__currentRevisionOrderId) return;
          const note = document.getElementById('drawing-revision-note').value.trim();
          const targetSelect = document.getElementById('drawing-revision-target-key');
          const targetKey = targetSelect ? String(targetSelect.value || '').trim() : '';
          const filesInput = document.getElementById('drawing-revision-files');
          const files = filesInput ? Array.from(filesInput.files || []) : [];
          const currentFiles = getDrawingCurrentFiles(__currentRevisionOrderId);
          if (!note) {
            showErpToast('수정 요청 사항(메모)을 입력해주세요.', 'info');
            return;
          }
          if (currentFiles.length > 1 && !targetKey) {
            showErpToast('수정할 도면 번호를 선택해주세요.', 'info');
            return;
          }

          if (!confirm('수정 요청을 보내시겠습니까? (도면팀에게 알림이 전송됩니다)')) return;

          try {
            let uploadedFiles = [];
            if (files.length > 0) {
              uploadedFiles = await uploadRevisionGatewayFiles(__currentRevisionOrderId, files);
            }

            const res = await fetch(`/api/orders/${__currentRevisionOrderId}/request-revision`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                note: note,
                files: uploadedFiles,
                target_drawing_key: targetKey || null,
                target_drawing_number: getDrawingTargetNumber(__currentRevisionOrderId, targetKey),
              })
            });
            const data = await res.json();
            if (data.success) {
              showErpToast(data.message || '수정 요청이 전송되었습니다.', 'success');
              window.location.reload();
            } else {
              showErpToast('요청 실패: ' + data.message, 'error');
            }
          } catch (e) {
            console.error(e);
            showErpToast('오류가 발생했습니다.', 'error');
          }
        }

        async function confirmDrawingReceipt(orderId) {
          if (!confirm('도면 수령을 확정하고 다음 단계로 진행하시겠습니까?')) return;

          try {
            const res = await fetch(`/api/orders/${orderId}/confirm-drawing-receipt`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });

            const contentType = (res.headers.get('content-type') || '').toLowerCase();
            const data = contentType.includes('application/json')
              ? await res.json()
              : { success: false, message: await res.text() };

            if (data.success) {
              showErpToast(data.message || '수령 확정되었습니다.', 'success');
              window.location.reload();
            } else {
              showErpToast('오류: ' + (data.message || `HTTP ${res.status}`), 'error');
            }
          } catch (err) {
            console.error('Drawing confirm error:', err);
            showErpToast('도면 확정 중 오류가 발생했습니다.', 'error');
          }
        }

        async function toggleRevisionChecklist(orderId, requestAtEnc, byUserId, nextChecked) {
          try {
            const requestAt = decodeURIComponent(String(requestAtEnc || ''));
            const payload = {
              request_at: requestAt,
              by_user_id: byUserId ? Number(byUserId) : null,
              checked: !!nextChecked,
            };
            const res = await fetch(`/api/orders/${orderId}/request-revision-check`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!data.success) {
              showErpToast(data.message || '요청 반영 체크 저장 실패', 'error');
              return;
            }

            showErpToast(data.message || '요청 반영 체크가 저장되었습니다.', 'success');
            await loadOrderDetail(orderId);
            setTimeout(() => {
              const tabBtn = document.querySelector(`[data-bs-target="#wb-requests-${orderId}"]`);
              if (tabBtn) {
                try { bootstrap.Tab.getOrCreateInstance(tabBtn).show(); } catch (_) { }
              }
            }, 120);
          } catch (e) {
            console.error(e);
            showErpToast('요청 반영 체크 저장 중 오류가 발생했습니다.', 'error');
          }
        }

        let __currentAssignOrderId = null;
        let __drawingUsersCache = null;

        async function openDraftsmanAssignModal(orderId) {
          __currentAssignOrderId = orderId;
          const modalEl = document.getElementById('erpDraftsmanAssignModal');
          const listEl = document.getElementById('erp-draftsman-list');
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

          modal.show();

          if (!__drawingUsersCache) {
            try {
              const res = await fetch('/erp/api/users?team=DRAWING');
              const data = await res.json();
              if (data.success) {
                __drawingUsersCache = data.users;
              }
            } catch (e) {
              console.error(e);
              listEl.innerHTML = '<div class="text-danger">사용자 목록 로드 실패</div>';
              return;
            }
          }

          // Render List
          // Fetch current assignment to check boxes
          let currentAssignees = [];
          try {
            // We need structured data, hopefully cached or fetch again. 
            // Ideally passeed args, but simpler to fetch light structured data or use what we have in DOM if possible
            // For now, let's just show list unchecke or checked if we store it globally.
            // Actually loadOrderDetail stores in cache? No.
            // Let's just list users.
          } catch (e) { }

          const users = __drawingUsersCache || [];
          if (users.length === 0) {
            listEl.innerHTML = '<div class="text-muted text-center">도면팀 사용자가 없습니다.</div>';
          } else {
            listEl.innerHTML = users.map(u => `
                <label class="list-group-item d-flex gap-2">
                    <input class="form-check-input flex-shrink-0" type="checkbox" value="${u.id}" name="draftsman_user">
                    <span>
                        <strong>${u.name}</strong>
                        <small class="text-muted ms-1">(${u.team})</small>
                    </span>
                </label>
            `).join('');
          }
        }

        async function saveDraftsmanAssignment() {
          if (!__currentAssignOrderId) return;

          const checkboxes = document.querySelectorAll('input[name="draftsman_user"]:checked');
          const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

          if (userIds.length === 0) {
            alert('최소 한 명 이상의 담당자를 선택해주세요.');
            return;
          }

          try {
            const res = await fetch(`/api/orders/${__currentAssignOrderId}/assign-draftsman`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_ids: userIds })
            });
            const data = await res.json();

            if (data.success) {
              alert(data.message);
              bootstrap.Modal.getInstance(document.getElementById('erpDraftsmanAssignModal')).hide();
              // Refresh detail
              loadOrderDetail(__currentAssignOrderId);
            } else {
              alert('오류: ' + data.message);
            }
          } catch (e) {
            console.error(e);
            alert('저장 중 오류가 발생했습니다.');
          }
        }


        function renderBadges(alerts) {
          const a = alerts || {};
          const out = [];
          if (a.urgent) out.push('<span class="badge bg-danger me-1">긴급</span>');
          if (a.drawing_overdue) out.push('<span class="badge bg-danger me-1">도면48h</span>');
          if (a.measurement_d4) out.push('<span class="badge bg-warning text-dark me-1">실측D-4</span>');
          if (a.construction_d3) out.push('<span class="badge bg-warning text-dark me-1">시공D-3</span>');
          if (a.production_d2) out.push('<span class="badge bg-warning text-dark me-1">생산D-2</span>');
          return out.join('') || '<span class="text-muted small">경보 없음</span>';
        }

        async function approveQuestTeam(orderId, team) {
          try {
            const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ team: team })
            });
            const data = await res.json();

            // success 필드 확인 (API는 success 필드를 반환함)
            if (!data.success) {
              alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
              return;
            }

            // 자동 단계 전환 알림
            if (data.auto_transitioned && data.next_stage) {
              const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
              alert('✅ 모든 팀 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
            } else if (data.all_approved) {
              alert('✅ 모든 팀 승인 완료!');
            } else {
              const missingTeams = data.missing_teams.map(t => label(TEAM_LABELS, t, t)).join(', ');
              alert('승인 완료. 남은 팀: ' + missingTeams);
            }

            // 슬라이드 내 Quest 정보 업데이트
            await loadQuestDetail(orderId);
            // 페이지 새로고침 (주문 목록 업데이트)
            window.location.reload();
          } catch (err) {
            console.error('승인 실패:', err);
            alert('승인 중 오류가 발생했습니다.');
          }
        }

        async function approveQuestAssignee(orderId) {
          try {
            const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({}) // 담당자 승인은 team 파라미터 불필요
            });
            const data = await res.json();

            // success 필드 확인
            if (!data.success) {
              alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
              return;
            }

            // 자동 단계 전환 알림
            if (data.auto_transitioned && data.next_stage) {
              const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
              alert('✅ 담당자 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
            } else if (data.all_approved) {
              alert('✅ 담당자 승인 완료!');
            }

            // 페이지 새로고침
            window.location.reload();
          } catch (err) {
            console.error('승인 실패:', err);
            alert('승인 중 오류가 발생했습니다.');
          }
        }

        async function loadQuestDetail(orderId) {
          try {
            const res = await fetch(`/api/orders/${orderId}/quest`);
            const data = await res.json();
            if (data.error) {
              console.error('Quest 로드 실패:', data.error);
              return;
            }
            // 슬라이드 내 Quest 정보 업데이트
            const questContainer = document.querySelector(`#quest-collapse-${orderId} #quest-approvals-${orderId}`);
            if (questContainer) {
              const quest = data.quest || {};
              const requiredTeams = quest.required_approvals || [];
              const teamApprovalsRaw = quest.team_approvals || {};

              let html = '';
              for (const team of requiredTeams) {
                // team_approvals는 딕셔너리 형태일 수 있음: {team: {"approved": True, ...}} 또는 {team: True}
                const approvalData = teamApprovalsRaw[team];
                let approved = false;
                if (typeof approvalData === 'object' && approvalData !== null) {
                  approved = approvalData.approved === true;
                } else {
                  approved = Boolean(approvalData);
                }
                const teamLabel = label(TEAM_LABELS, team, team);
                html += `<div class="mb-2">`;
                html += `<span class="fw-semibold" style="font-size: 1rem;">${escapeHtml(teamLabel)}</span>`;
                if (approved) {
                  html += `<span class="badge bg-success ms-2" style="font-size: 1rem; padding: 0.4em 0.7em;">승인완료</span>`;
                } else {
                  html += `<button class="btn btn-primary fw-semibold ms-2" onclick="approveQuestTeam(${orderId}, '${escapeHtml(team)}')" style="font-size: 1rem; padding: 0.4rem 0.75rem;">승인</button>`;
                }
                html += `</div>`;
              }
              questContainer.innerHTML = html;
            }
          } catch (err) {
            console.error('Quest 상세 로드 실패:', err);
          }
        }

        async function loadOrderDetail(orderId) {
          const container = document.getElementById(`order-detail-content-${orderId}`);
          if (!container) return;

          try {
            container.innerHTML = '<div class="text-muted small">로딩 중...</div>';

            const [structured, attachments] = await Promise.all([
              fetch(`/api/orders/${orderId}/structured`).then(r => r.json()).catch(err => {
                console.error('Structured data fetch error:', err);
                return { success: false, structured_data: {} };
              }),
              fetch(`/api/orders/${orderId}/attachments`).then(r => r.json()).catch(err => {
                console.error('Attachments fetch error:', err);
                return { success: false, attachments: [] };
              }),
            ]);

            const sd = (structured && structured.structured_data) || {};
            const customer = (((sd.parties || {}).customer || {}).name) || '-';
            const orderer = (((sd.parties || {}).orderer || {}).name) || '-';
            const phone = (((sd.parties || {}).customer || {}).phone) || '-';
            // 주소: address_full 우선, 없으면 address_main + address_detail 조합, 없으면 address_main만
            const site = sd.site || {};
            const addressFull = site.address_full || '';
            const addressMain = site.address_main || '';
            const addressDetail = site.address_detail || '';
            const address = addressFull || (addressMain && addressDetail ? `${addressMain} ${addressDetail}`.trim() : addressMain) || addressDetail || '-';
            // 특이사항: notes 객체에서 읽기 (erpbeta 저장 경로와 일치)
            const notes = sd.notes || {};
            const addressNote = (notes.address_note || '').trim();
            const phoneNote = (notes.phone_note || '').trim();
            const measureNote = (notes.measurement_note || '').trim();
            const measure = (((sd.schedule || {}).measurement || {}).date) || '-';
            const construct = (((sd.schedule || {}).construction || {}).date) || '-';
            const manager = (((sd.parties || {}).manager || {}).name) || '-';
            const stage = (((sd.workflow || {}).stage)) || '-';
            const urgent = ((sd.flags || {}).urgent) || false;
            __drawingCurrentFilesByOrder[orderId] = Array.isArray(sd.drawing_current_files) ? sd.drawing_current_files : [];

            // 담당팀: 현재 단계의 담당팀으로 자동 계산
            const STAGE_TO_TEAM = {
              'RECEIVED': 'CS',
              'HAPPYCALL': 'CS',
              'MEASURE': 'SALES',
              'DRAWING': 'DRAWING',
              'CONFIRM': 'SALES',
              'PRODUCTION': 'PRODUCTION',
              'CONSTRUCTION': 'CONSTRUCTION',
              'CS': 'CS',
              'COMPLETED': 'CS',
              'AS': 'CS'
            };
            let ownerTeam = STAGE_TO_TEAM[stage] || '-';
            // 실측/고객컨펌에서 발주사에 '라홈' 포함 시 라홈팀(CS)으로 변경
            if (stage === 'MEASURE' || stage === 'CONFIRM') {
              const ordererName = (((sd.parties || {}).orderer || {}).name || '').trim();
              if (ordererName && ordererName.includes('라홈')) {
                ownerTeam = 'CS';
              }
            }

            // 제품 항목 (모든 상세 정보 표시)
            const items = (sd.items || []) || [];
            let itemsHtml = '';
            if (items.length > 0) {
              let gridHtml = '<div class="erp-product-items-grid mt-3">';
              items.forEach(item => {
                // 규격을 W, D, H로 분리
                let specW = item.spec_width || '';
                let specD = item.spec_depth || '';
                let specH = item.spec_height || '';
                // 기존 spec 필드가 있고 W, D, H가 없으면 파싱
                if (!specW && !specD && !specH && item.spec) {
                  const specStr = String(item.spec || '').trim();
                  const parts = specStr.split(/[xX*×]/).map(s => s.trim());
                  if (parts.length >= 3) {
                    specW = parts[0];
                    specD = parts[1];
                    specH = parts[2];
                  } else if (parts.length === 2) {
                    specW = parts[0];
                    specD = parts[1];
                  } else if (parts.length === 1) {
                    specW = parts[0];
                  }
                }
                // 규격을 한 줄로 통합 (모바일용)
                const specParts = [];
                if (specW && specW !== '-') specParts.push(`W:${specW}`);
                if (specD && specD !== '-') specParts.push(`D:${specD}`);
                if (specH && specH !== '-') specParts.push(`H:${specH}`);
                const specCombined = specParts.length > 0 ? specParts.join(' × ') : '-';
                const priceText = item.price ? item.price.toLocaleString('ko-KR') + '원' : '-';

                // 값이 빈 문자열이거나 null/undefined일 때 '-'로 표시
                const safeValue = (val) => {
                  if (val === null || val === undefined || val === '') return '-';
                  return String(val).trim() || '-';
                };

                gridHtml += `<div class="erp-product-items-card">
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">제품명:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.product_name || item.name))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">규격:</span>
                <span class="erp-product-items-value">${escapeHtml(specCombined)}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">내부:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.internal))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">색상:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.color))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">옵션:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.option_detail || item.options))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">손잡이:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.handle))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">기타:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.misc))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">금액:</span>
                <span class="erp-product-items-value">${escapeHtml(priceText)}</span>
              </div>
            </div>`;
              });
              gridHtml += '</div>';
              itemsHtml = gridHtml;
            } else {
              itemsHtml = '<div class="text-muted mt-3" style="font-size: 1rem;">제품 항목 없음</div>';
            }

            // 첨부 파일 (여백 최소화, 미리보기 기능)
            // API 응답 구조 확인: attachments.attachments 또는 attachments (배열 직접 반환)
            let aList = [];
            if (attachments) {
              if (Array.isArray(attachments)) {
                aList = attachments;
              } else if (attachments.attachments && Array.isArray(attachments.attachments)) {
                aList = attachments.attachments;
              } else if (attachments.success !== false && attachments.attachments) {
                // success가 true이고 attachments가 있는 경우
                aList = attachments.attachments;
              } else if (attachments.success === false) {
                console.warn('Attachments API returned error:', attachments.message || 'Unknown error');
                aList = [];
              } else {
                // 디버깅: 응답 구조 확인
                console.log('Attachments API response structure:', attachments);
                aList = [];
              }
            } else {
              console.warn('Attachments response is null or undefined');
            }
            // 첨부 파일 캐시 저장
            __attachmentsCache[orderId] = aList;

            let attachmentsHtml = '';
            if (aList.length > 0) {
              attachmentsHtml = '<div class="d-flex flex-wrap gap-1 mt-2">';
              aList.forEach(a => {
                const name = escapeHtml(a.filename || '');
                const viewUrl = a.view_url || '#';
                const thumb = a.thumbnail_view_url || viewUrl;
                const downloadUrl = a.download_url || viewUrl;
                const fileType = a.file_type || 'image';
                if (fileType === 'video') {
                  attachmentsHtml += `<div class="position-relative" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'video')">
                <div style="width: 80px; height: 60px; background: #000; display: flex; align-items: center; justify-content: center;">
                  <video src="${viewUrl}" preload="metadata" style="width:100%;height:100%;object-fit:cover;"></video>
                </div>
                <div class="position-absolute top-0 start-0 bg-dark bg-opacity-75 text-white p-1" style="font-size: 10px;"><i class="fas fa-play"></i></div>
              </div>`;
                } else if (fileType === 'file') {
                  attachmentsHtml += `<div class="position-relative d-flex align-items-center justify-content-center" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; background:#f8f9fa;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'file')">
                <i class="fas fa-file-alt text-secondary"></i>
              </div>`;
                } else {
                  attachmentsHtml += `<div class="position-relative" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'image')">
                <img src="${thumb}" style="width: 80px; height: 60px; object-fit: cover; background:#fff; display: block;" alt="${name}">
              </div>`;
                }
              });
              attachmentsHtml += '</div>';
            } else {
              attachmentsHtml = '<div class="text-muted small mt-2">첨부 없음</div>';
            }

            // 모바일 여부 확인 (992px 이하)
            const isMobile = window.innerWidth <= 992;

            const basicInfoHtml = isMobile ? '' : `
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold"><i class="fas fa-info-circle text-primary"></i> 기본 정보</h5>
                  <div class="erp-detail-text">
                    <div class="mb-3"><strong class="erp-detail-label">고객명:</strong> <span class="erp-detail-value">${escapeHtml(customer)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">발주사:</strong> <span class="erp-detail-value">${escapeHtml(orderer)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">연락처:</strong> <span class="erp-detail-value">${escapeHtml(phone)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">주소:</strong> <span class="erp-detail-value">${escapeHtml(address)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">담당자:</strong> <span class="erp-detail-value">${escapeHtml(manager)}</span></div>
                  </div>
                </div>
              </div>
            </div>`;

            const noteRows = [];
            if (addressNote) {
              noteRows.push(`<div class="mb-3"><strong class="erp-detail-label">주소특이:</strong> <span class="erp-detail-value">${escapeHtml(addressNote)}</span></div>`);
            }
            if (phoneNote) {
              noteRows.push(`<div class="mb-3"><strong class="erp-detail-label">연락특이:</strong> <span class="erp-detail-value">${escapeHtml(phoneNote)}</span></div>`);
            }
            if (measureNote) {
              noteRows.push(`<div class="mb-3"><strong class="erp-detail-label">실측특이:</strong> <span class="erp-detail-value">${escapeHtml(measureNote)}</span></div>`);
            }
            const notesHtml = noteRows.join('');

            const scheduleHtml = `
            <div class="${isMobile ? 'col-12' : 'col-md-6'}">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold"><i class="fas fa-calendar text-primary"></i> 일정 및 특이사항</h5>
                  <div class="erp-detail-text">
                    ${isMobile ? '' : `<div class="mb-3"><strong class="erp-detail-label">실측일:</strong> <span class="erp-detail-value">${escapeHtml(measure)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">시공일:</strong> <span class="erp-detail-value">${escapeHtml(construct)}</span></div>`}
                    ${notesHtml}
                  </div>
                </div>
              </div>
            </div>`;

            // 도면 전달 버튼 (DRAWING 단계일 때만)
            let actionHtml = '';
            if (stage === 'DRAWING') {
              const canEdit = typeof CAN_EDIT_ERP_BETA !== 'undefined' && CAN_EDIT_ERP_BETA;
              const drawingStatus = sd.drawing_status || 'PENDING'; // PENDING, TRANSFERRED, CONFIRMED
              const assignees = Array.isArray(sd.drawing_assignees) ? sd.drawing_assignees : [];
              const assignments = sd.assignments || {};
              const assigneeIds = Array.isArray(assignments.drawing_assignee_user_ids)
                ? assignments.drawing_assignee_user_ids.map(x => Number(x)).filter(x => Number.isFinite(x))
                : [];
              const hasAssignee = assignees.length > 0 || assigneeIds.length > 0;
              const myIdNum = Number(MY_ID);
              const isAssigned = assignees.some(u => Number(u.id) === myIdNum) || assigneeIds.includes(myIdNum);
              const isDrawingTeam = (MY_TEAM === 'DRAWING');
              const isSalesTeam = (MY_TEAM === 'SALES');
              // Manager matches current user name? or admin
              const isManager = (manager === MY_NAME);
              const isAdmin = (MY_ROLE === 'ADMIN');
              const canDrawingAssign = canEdit || isDrawingTeam || isAdmin;
              const canDrawingWork = (isDrawingTeam || isAssigned || isAdmin) && hasAssignee;

              const assigneeNames = assignees.map(u => u.name).filter(Boolean).join(', ') || (assigneeIds.length ? `${assigneeIds.length}명 지정` : '');

              // 1. 도면 담당자 지정 버튼 (수정 권한 + 영업/담당자/관리자/도면팀)
              let assignBtn = '';

              if (canDrawingAssign && (isSalesTeam || isManager || isAdmin || isDrawingTeam)) {
                assignBtn = `
                    <button class="btn btn-outline-primary btn-sm" onclick="openDraftsmanAssignModal(${orderId})">
                        <i class="fas fa-user-plus"></i> 담당자 지정
                    </button>
                 `;
              }

              let statusBadge = '';
              let mainBtn = '';


              // --- [수정] 상태별 버튼 로직 강화 ---

              if (drawingStatus === 'TRANSFERRED') {
                statusBadge = '<span class="badge bg-warning text-dark ms-2">확정 대기중</span>';

                // 1. 영업/담당자/관리자: [수령 확정] OR [수정 요청]
                if (canEdit && (isSalesTeam || isManager || isAdmin)) {
                  mainBtn = `
                <div class="d-flex gap-2">
                    <button class="btn btn-success flex-grow-1" onclick="confirmDrawingReceipt(${orderId})">
                        <i class="fas fa-check-double"></i> 수령 확정
                    </button>
                    <button class="btn btn-warning" onclick="openRevisionRequestModal(${orderId})">
                        <i class="fas fa-undo"></i> 수정 요청
                    </button>
                </div>
              `;
                } else {
                  // 도면팀인 경우: [재전송] (기존 파일 삭제됨), [전달 취소]
                  if (canDrawingWork) {
                    mainBtn = `
                        <div class="d-flex gap-2">
                             <button class="btn btn-primary flex-grow-1" onclick="openTransferDrawingModal(${orderId}, true)">
                                <i class="fas fa-sync"></i> 재전송
                            </button>
                            <button class="btn btn-outline-danger" onclick="cancelDrawingTransfer(${orderId})">
                                <i class="fas fa-times"></i> 전달 취소
                            </button>
                        </div>
                        <div class="text-muted small mt-1">
                            <i class="fas fa-info-circle"></i> 재전송 시 <span class="text-danger fw-bold">기존 파일이 삭제</span>되고 새 파일로 대체됩니다.
                        </div>
                    `;
                  } else {
                    mainBtn = `<button class="btn btn-secondary" disabled>확정 대기중</button>`;
                  }
                }
              } else if (drawingStatus === 'RETURNED') {
                statusBadge = '<span class="badge bg-danger ms-2">수정 요청됨</span>';
                // 수정 요청 상태에서는 도면팀이 다시 재전송(업로드) 해야 함
                if (canDrawingWork) {
                  mainBtn = `
                    <button class="btn btn-primary" onclick="openTransferDrawingModal(${orderId}, true)">
                        <i class="fas fa-paper-plane"></i> 수정본 전달 (재전송)
                    </button>
                     <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle"></i> 수정 요청 사항을 확인 후 다시 전달해주세요.
                    </div>
                `;
                } else {
                  mainBtn = `<button class="btn btn-secondary" disabled>수정 작업 대기중</button>`;
                }
              } else {
                // PENDING or WORKING
                statusBadge = '<span class="badge bg-secondary ms-2">작업중</span>';
                // Only Drawing Team or Assigned Draftsman can transfer (and must have ERP edit permission)
                if (canDrawingWork) {
                  mainBtn = `
                        <button class="btn btn-primary" onclick="openTransferDrawingModal(${orderId}, false)">
                            <i class="fas fa-paper-plane"></i> 도면 전달
                        </button>
                    `;
                } else {
                  // 담당자 미지정이면 도면 전달 불가
                  if (!hasAssignee) {
                    mainBtn = `<small class="text-muted">도면 작업 대기중 (담당자 미지정)</small>`;
                  } else {
                    mainBtn = `<button class="btn btn-secondary" disabled>작업 관리는 담당자만 가능</button>`;
                  }
                }
              }
              const drawHistory = Array.isArray(sd.drawing_transfer_history) ? sd.drawing_transfer_history : [];
              const gatewayHistoryHtml = renderDrawingGatewayTimeline(drawHistory);
              const revisionRequests = drawHistory
                .filter(h => h && h.action === 'REQUEST_REVISION')
                .slice()
                .reverse();
              const requestTabHtml = revisionRequests.length
                ? revisionRequests.slice(0, 8).map((h, idx) => {
                  const when = escapeHtml(h.transferred_at || h.at || '-');
                  const requestAtRaw = String(h.at || h.transferred_at || '');
                  const requestAtEnc = encodeURIComponent(requestAtRaw);
                  const by = escapeHtml(h.by_user_name || '-');
                  const byUserId = Number(h.by_user_id || 0) || '';
                  const note = escapeHtml(h.note || '요청 메모 없음');
                  const targetNo = Number(h.target_drawing_number || 0);
                  const targetBadge = targetNo > 0 ? `<span class="badge bg-info text-dark ms-1">${targetNo}번 대상</span>` : '';
                  const reviewCheck = (h.review_check && typeof h.review_check === 'object') ? h.review_check : {};
                  const isChecked = !!reviewCheck.checked;
                  const checkedBy = escapeHtml(reviewCheck.checked_by_name || '-');
                  const checkedAt = escapeHtml(reviewCheck.checked_at || '-');
                  const pinBadge = idx === 0 ? '<span class="badge bg-danger ms-1">최신 요청</span>' : '';
                  const checkBadge = isChecked
                    ? `<span class="badge bg-success ms-1">반영 완료</span>`
                    : `<span class="badge bg-secondary ms-1">미완료</span>`;
                  const toggleBtn = `
                    <button class="btn btn-sm ${isChecked ? 'btn-outline-secondary' : 'btn-outline-success'} mt-2"
                      onclick="toggleRevisionChecklist(${orderId}, '${requestAtEnc}', '${String(byUserId)}', ${isChecked ? 'false' : 'true'})">
                      <i class="fas ${isChecked ? 'fa-rotate-left' : 'fa-check'}"></i>
                      ${isChecked ? '완료 해제' : '반영 완료'}
                    </button>
                  `;
                  const checkMeta = isChecked
                    ? `<div class="small text-success mt-1"><i class="fas fa-user-check"></i> ${checkedBy} · ${checkedAt}</div>`
                    : '';
                  return `
                    <div class="border rounded p-2 mb-2 bg-white">
                      <div class="small text-muted mb-1">${when} · ${by} ${pinBadge} ${checkBadge} ${targetBadge}</div>
                      <div class="small">${note}</div>
                      ${checkMeta}
                      ${toggleBtn}
                    </div>
                  `;
                }).join('')
                : '<div class="text-muted small">수정 요청 이력이 없습니다.</div>';

              const transferEvents = drawHistory.filter(h => h && h.action === 'TRANSFER');
              const latestTransfer = transferEvents.length ? transferEvents[transferEvents.length - 1] : null;
              const prevTransfer = transferEvents.length > 1 ? transferEvents[transferEvents.length - 2] : null;
              const latestFiles = Array.isArray((latestTransfer || {}).files) ? latestTransfer.files : [];
              const prevFiles = Array.isArray((prevTransfer || {}).files) ? prevTransfer.files : [];
              const compareFilesHtml = `
                <div class="row g-2">
                  <div class="col-md-6">
                    <div class="border rounded p-2 h-100 bg-light">
                      <div class="fw-semibold small mb-1">이전본 ${prevTransfer ? '' : '(없음)'}</div>
                      <div class="small text-muted mb-2">${prevTransfer ? escapeHtml(prevTransfer.transferred_at || '-') : '-'}</div>
                      ${prevTransfer ? renderGatewayFiles(prevFiles, `wb_prev_${orderId}`) : '<div class="text-muted small">비교할 이전 전달본이 없습니다.</div>'}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-2 h-100 bg-light">
                      <div class="fw-semibold small mb-1">최신본 ${latestTransfer ? '' : '(없음)'}</div>
                      <div class="small text-muted mb-2">${latestTransfer ? escapeHtml(latestTransfer.transferred_at || '-') : '-'}</div>
                      ${latestTransfer ? renderGatewayFiles(latestFiles, `wb_latest_${orderId}`) : '<div class="text-muted small">최신 전달본이 없습니다.</div>'}
                    </div>
                  </div>
                </div>
              `;

              let currentTaskText = '도면 담당자가 도면 전달을 진행해 주세요.';
              if (!hasAssignee) currentTaskText = '도면 담당자를 먼저 지정해야 합니다.';
              else if (drawingStatus === 'TRANSFERRED') currentTaskText = '주문 담당자가 수령 확정 또는 수정 요청을 선택해야 합니다.';
              else if (drawingStatus === 'RETURNED') currentTaskText = '도면 담당자가 요청사항 반영 후 수정본을 전달해야 합니다.';
              else if (drawingStatus === 'CONFIRMED') currentTaskText = '도면 수령 확정 완료. 다음 단계 진행을 확인해 주세요.';
              const checklist = [
                { label: '도면 담당자 지정', ok: hasAssignee },
                { label: '최신 전달본 확인', ok: latestFiles.length > 0 || (Array.isArray(sd.drawing_current_files) && sd.drawing_current_files.length > 0) },
                { label: '요청사항 검토', ok: drawingStatus !== 'RETURNED' || revisionRequests.length > 0 },
              ];
              const checklistHtml = `
                <div class="bg-white border rounded p-2 mb-2">
                  <div class="small fw-semibold mb-1"><i class="fas fa-list-check text-primary"></i> 작업 체크리스트</div>
                  ${checklist.map(item => `
                    <div class="small ${item.ok ? 'text-success' : 'text-secondary'}">
                      <i class="fas ${item.ok ? 'fa-check-circle' : 'fa-circle'}"></i> ${escapeHtml(item.label)}
                    </div>
                  `).join('')}
                </div>
              `;

              const workbenchTabsHtml = `
                <ul class="nav nav-pills nav-sm mb-2 erp-drawing-workbench-tabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#wb-timeline-${orderId}" type="button" role="tab">타임라인</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#wb-requests-${orderId}" type="button" role="tab">요청사항</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#wb-compare-${orderId}" type="button" role="tab">파일 비교</button>
                  </li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active erp-drawing-workbench-pane" id="wb-timeline-${orderId}" role="tabpanel">
                    ${gatewayHistoryHtml}
                  </div>
                  <div class="tab-pane fade erp-drawing-workbench-pane" id="wb-requests-${orderId}" role="tabpanel">
                    ${requestTabHtml}
                  </div>
                  <div class="tab-pane fade erp-drawing-workbench-pane" id="wb-compare-${orderId}" role="tabpanel">
                    ${compareFilesHtml}
                  </div>
                </div>
              `;

              actionHtml = `
            <div class="col-12">
              <div class="card bg-light border-primary">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                    <h5 class="card-title fw-bold text-primary mb-1">
                      <i class="fas fa-drafting-compass"></i> 도면 창구 상세 (작업실)
                      ${statusBadge}
                    </h5>
                    <p class="mb-0 text-muted small">
                      도면 담당: <strong>${assigneeNames || '미지정'}</strong>
                      ${assignBtn}
                      ${!canDrawingAssign ? '<span class="text-muted small ms-1">(수정 권한 없음)</span>' : ''}
                    </p>
                  </div>
                  <div class="erp-drawing-workbench">
                    <div class="erp-drawing-workbench-log">
                      <div class="fw-semibold mb-2"><i class="fas fa-exchange-alt text-primary"></i> 도면 창구 이력/요청</div>
                      ${workbenchTabsHtml}
                    </div>
                    <div class="erp-drawing-workbench-actions">
                      <div class="erp-drawing-workbench-actions-sticky">
                        <div class="fw-semibold mb-2"><i class="fas fa-bolt text-primary"></i> 지금 필요한 작업</div>
                        <div class="small text-dark bg-white border rounded p-2 mb-2">${escapeHtml(currentTaskText)}</div>
                        ${checklistHtml}
                        ${mainBtn}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;
            }

            container.innerHTML = `
          <div class="row g-3 erp-order-detail">
            ${basicInfoHtml}
            ${scheduleHtml}
            ${actionHtml}
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-3"><i class="fas fa-box text-primary"></i> 제품 항목</h5>
                  ${itemsHtml}
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-3"><i class="fas fa-paperclip text-primary"></i> 첨부 파일 <span class="badge bg-secondary" style="font-size: 1rem;">${aList.length}개</span></h5>
                  ${attachmentsHtml}
                </div>
              </div>
            </div>
          </div>
        `;

          } catch (err) {
            console.error('주문 상세 로드 실패:', err);
            container.innerHTML = '<div class="text-danger small">로드 실패: ' + escapeHtml(err.message) + '</div>';
          }
        }

        document.addEventListener('DOMContentLoaded', () => {
          // 필터 폼 제출 시 alert_type 파라미터 유지
          const form = document.getElementById('erp-filters-form');
          if (form) {
            form.addEventListener('submit', function (e) {
              const url = new URL(window.location.href);
              const currentAlertType = url.searchParams.get('alert_type');
              if (currentAlertType) {
                let alertTypeInput = this.querySelector('input[name="alert_type"]');
                if (!alertTypeInput) {
                  alertTypeInput = document.createElement('input');
                  alertTypeInput.type = 'hidden';
                  alertTypeInput.name = 'alert_type';
                  this.appendChild(alertTypeInput);
                }
                alertTypeInput.value = currentAlertType;
              }
            });
          }

          // 주문 상세 collapse 오픈 시: 상세 로드 완료 후 navbar 바로 아래로 정렬
          document.querySelectorAll('.collapse[id^="order-detail-collapse-"]').forEach(collapseEl => {
            collapseEl.addEventListener('shown.bs.collapse', async function () {
              const orderId = this.id.replace('order-detail-collapse-', '');

              const alignDetailUnderNavbar = () => {
                const nav = document.querySelector('nav.navbar');
                const navHeight = nav ? nav.offsetHeight : 56;
                const titleEl = this.querySelector('.erp-order-detail-title') || this;
                const targetTop = window.scrollY + titleEl.getBoundingClientRect().top - navHeight - 8;
                window.scrollTo({ top: Math.max(0, targetTop), behavior: 'auto' });
              };

              // 1차: collapse 오픈 직후 정렬
              alignDetailUnderNavbar();

              // 2차: 상세 내용 렌더 완료 후 다시 정렬 (높이 변동 보정)
              await loadOrderDetail(parseInt(orderId, 10));
              requestAnimationFrame(alignDetailUnderNavbar);
              setTimeout(alignDetailUnderNavbar, 120);
            });
          });

          // 딥링크 포커스: ?focus=drawing-gateway&order_id=1955&tab=timeline|requests|compare
          (() => {
            try {
              const url = new URL(window.location.href);
              const focus = (url.searchParams.get('focus') || '').toLowerCase();
              const orderId = String(url.searchParams.get('order_id') || '').trim();
              const tabRaw = (url.searchParams.get('tab') || 'timeline').toLowerCase();
              const tabKey = (tabRaw === 'request' || tabRaw === 'requests')
                ? 'requests'
                : (tabRaw === 'file' || tabRaw === 'files' || tabRaw === 'compare' ? 'compare' : 'timeline');
              if (focus !== 'drawing-gateway' || !orderId) return;

              const collapseEl = document.getElementById(`order-detail-collapse-${orderId}`);
              if (!collapseEl) return;
              const bs = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
              bs.show();

              const activateTab = () => {
                const tabBtn = document.querySelector(`[data-bs-target="#wb-${tabKey}-${orderId}"]`);
                if (!tabBtn) return;
                try {
                  bootstrap.Tab.getOrCreateInstance(tabBtn).show();
                } catch (_) { }
              };

              // 상세 렌더링 완료 타이밍 보정
              setTimeout(activateTab, 450);
              setTimeout(activateTab, 900);
            } catch (_) { }
          })();

          // 프로세스 맵 & 알림 타일 클릭 → "해당 필터만" URL 파라미터 적용 후 리로드
          const applyFilter = (name, value) => {
            const singleFilterNames = ['stage', 'alert_type', 'urgent', 'has_alert', 'team', 'q'];
            const url = new URL(window.location.href);
            const params = url.searchParams;

            // 기존 단일 필터 전부 제거
            singleFilterNames.forEach((fieldName) => params.delete(fieldName));

            // 클릭한 필터만 설정
            if (value) {
              params.set(name, value);
            }

            // URL 이동 (GET)
            window.location.href = `${url.pathname}?${params.toString()}`;
          };

          // 프로세스 맵 (Pipeline Stages)
          document.querySelectorAll('.erp-pro-pipeline__stage[data-stage]').forEach(el => {
            const handler = () => applyFilter('stage', el.dataset.stage || '');
            el.addEventListener('click', handler);
            el.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handler();
              }
            });
          });

          // 알림 타일 (Alert Tiles)
          document.querySelectorAll('.erp-pro-alert[data-alert-type]').forEach(el => {
            const handler = () => applyFilter('alert_type', el.dataset.alertType || '');
            el.addEventListener('click', handler);
            el.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handler();
              }
            });
          });

          // 이벤트 위임: 퀘스트 승인, 첨부 미리보기 등
          document.body.addEventListener('click', function (e) {
            const targetCard = e.target.closest('.drawing-target-card');
            if (targetCard) {
              const role = String(targetCard.getAttribute('data-role') || '');
              const rawKey = String(targetCard.getAttribute('data-key') || '');
              const key = rawKey ? decodeURIComponent(rawKey) : '';
              selectDrawingTargetByCard(role, key);
              return;
            }

            // 승인 버튼
            const approveBtn = e.target.closest('.erp-btn-approve-team');
            if (approveBtn) {
              const orderId = approveBtn.dataset.orderId;
              const team = approveBtn.dataset.team;
              if (typeof approveQuestTeam === 'function') {
                approveQuestTeam(Number(orderId), team);
              } else {
                console.warn('approveQuestTeam is not defined');
              }
            }

            const approveAssigneeBtn = e.target.closest('.erp-btn-approve-assignee');
            if (approveAssigneeBtn) {
              const orderId = Number(approveAssigneeBtn.dataset.orderId);
              if (typeof approveQuestAssignee === 'function') {
                approveQuestAssignee(orderId);
              }
            }

            const drawingThumb = e.target.closest('.erp-drawing-gateway-thumb');
            if (drawingThumb) {
              const viewUrl = drawingThumb.dataset.viewUrl || '#';
              const downloadUrl = drawingThumb.dataset.downloadUrl || viewUrl;
              const filename = drawingThumb.dataset.filename || '';
              const fileType = drawingThumb.dataset.fileType || 'image';
              if (typeof openAttachmentPreviewModal === 'function') {
                openAttachmentPreviewModal(0, viewUrl, downloadUrl, filename, fileType);
              }
            }

            const openDrawingAttBtn = e.target.closest('.erp-btn-open-drawing-attachments');
            if (openDrawingAttBtn) {
              const orderId = Number(openDrawingAttBtn.dataset.orderId);
              if (typeof openAttachmentsPreview === 'function') {
                openAttachmentsPreview(orderId, 'drawing');
              }
            }

            const confirmReceiptBtn = e.target.closest('.erp-btn-confirm-drawing-receipt');
            if (confirmReceiptBtn) {
              const orderId = Number(confirmReceiptBtn.dataset.orderId);
              if (typeof confirmDrawingReceipt === 'function') {
                confirmDrawingReceipt(orderId);
              }
            }

            const revisionReqBtn = e.target.closest('.erp-btn-open-revision-request');
            if (revisionReqBtn) {
              const orderId = Number(revisionReqBtn.dataset.orderId);
              if (typeof openRevisionRequestModal === 'function') {
                openRevisionRequestModal(orderId);
              }
            }

            const cancelTransferBtn = e.target.closest('.erp-btn-cancel-drawing-transfer');
            if (cancelTransferBtn) {
              const orderId = Number(cancelTransferBtn.dataset.orderId);
              if (typeof cancelDrawingTransfer === 'function') {
                cancelDrawingTransfer(orderId);
              }
            }

            const openTransferBtn = e.target.closest('.erp-btn-open-transfer-drawing');
            if (openTransferBtn) {
              const orderId = Number(openTransferBtn.dataset.orderId);
              const isRetransfer = String(openTransferBtn.dataset.retransfer || 'false') === 'true';
              if (typeof openTransferDrawingModal === 'function') {
                openTransferDrawingModal(orderId, isRetransfer);
              }
            }

            // 첨부파일 미리보기 버튼
            const attBtn = e.target.closest('.erp-btn-attachments-preview');
            if (attBtn) {
              const orderId = attBtn.dataset.orderId;
              if (typeof openAttachmentsPreview === 'function') {
                openAttachmentsPreview(Number(orderId));
              }
            }
          });

          // 도면 수정 창구 이미지 뷰어 초기화
          initDrawingGatewayImageViewer();
        });
      </script>

      <!-- 알림 패널 -->
      <div id="notification-panel" class="notification-panel" style="display: none;">
        <div class="notification-panel__header">
          <h4><i class="fas fa-bell"></i> 알림</h4>
          <button class="notification-panel__close" onclick="toggleNotificationPanel()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="notification-panel__actions">
          <button class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsRead()">
            <i class="fas fa-check-double"></i> 모두 읽음
          </button>
        </div>
        <div class="notification-panel__list" id="notification-list">
          <div class="notification-empty">알림이 없습니다.</div>
        </div>
      </div>

      <style>
        /* 도면 수정 창구 이미지 뷰어 (채널톡 스타일) */
        #drawing-gateway-image-viewer {
          position: fixed;
          inset: 0;
          z-index: 20000;
        }

        #drawing-gateway-viewer-backdrop {
          position: absolute;
          inset: 0;
          background: rgba(10, 14, 22, 0.45);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
        }

        #drawing-gateway-viewer-close {
          position: absolute;
          top: 16px;
          right: 16px;
          width: 42px;
          height: 42px;
          border-radius: 50%;
          border: 0;
          background: rgba(255, 255, 255, 0.12);
          color: #fff;
          z-index: 3;
        }

        .drawing-gateway-viewer-nav {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          width: 48px;
          height: 48px;
          border-radius: 999px;
          border: 0;
          background: rgba(255, 255, 255, 0.15);
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 3;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.16s ease, transform 0.16s ease;
        }

        #drawing-gateway-image-viewer.gateway-nav-visible .drawing-gateway-viewer-nav {
          opacity: 1;
          pointer-events: auto;
          transform: translateY(-50%) scale(1);
        }

        #drawing-gateway-viewer-prev {
          left: 18px;
        }

        #drawing-gateway-viewer-next {
          right: 18px;
        }

        @media (hover: none) {
          #drawing-gateway-image-viewer.gateway-has-multiple .drawing-gateway-viewer-nav {
            opacity: 1;
            pointer-events: auto;
          }
        }

        #drawing-gateway-viewer-stage {
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          cursor: default;
          z-index: 2;
          touch-action: none;
        }

        #drawing-gateway-viewer-image {
          max-width: 90vw;
          max-height: 82vh;
          width: auto;
          height: auto;
          object-fit: contain;
          user-select: none;
          border: none;
          box-shadow: none;
          transform-origin: center center;
          transition: transform 0.08s ease-out;
        }

        #drawing-gateway-viewer-zoom-badge {
          position: absolute;
          top: 18px;
          left: 18px;
          padding: 4px 8px;
          font-size: 12px;
          color: #fff;
          border-radius: 6px;
          background: rgba(0, 0, 0, 0.45);
          display: none;
          z-index: 3;
        }

        #drawing-gateway-viewer-footer {
          position: absolute;
          bottom: 16px;
          left: 50%;
          transform: translateX(-50%);
          min-width: 280px;
          max-width: 80vw;
          padding: 8px 14px;
          border-radius: 10px;
          background: rgba(20, 24, 33, 0.55);
          color: #fff;
          text-align: center;
          z-index: 3;
        }

        #drawing-gateway-viewer-filename {
          font-size: 13px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        #drawing-gateway-viewer-counter {
          font-size: 12px;
          opacity: 0.85;
          margin-top: 2px;
        }

        .drawing-gateway-thumb-wrap {
          width: 112px;
        }

        .drawing-gateway-thumb {
          width: 110px;
          height: 84px;
          border-radius: 8px;
          overflow: hidden;
          border: 1px solid #e6e9ef;
          cursor: zoom-in;
          background: #fff;
        }

        .drawing-gateway-thumb img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }

        /* 알림 배지 */
        .notification-badge {
          position: absolute;
          top: -5px;
          right: -5px;
          background: #ff4757;
          color: white;
          font-size: 10px;
          font-weight: bold;
          padding: 2px 6px;
          border-radius: 10px;
          min-width: 18px;
          text-align: center;
        }

        .erp-pro-btn--icon {
          position: relative;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(255, 255, 255, 0.1);
          border: none;
          color: white;
          cursor: pointer;
          transition: all 0.2s;
        }

        .erp-pro-btn--icon:hover {
          background: rgba(255, 255, 255, 0.2);
        }

        /* 알림 패널 */
        .notification-panel {
          position: fixed;
          top: 70px;
          right: 20px;
          width: 380px;
          max-height: 500px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
          z-index: 9999;
          overflow: hidden;
        }

        .notification-panel__header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 16px 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .notification-panel__header h4 {
          margin: 0;
          font-size: 16px;
        }

        .notification-panel__close {
          background: none;
          border: none;
          color: white;
          font-size: 18px;
          cursor: pointer;
          opacity: 0.8;
        }

        .notification-panel__close:hover {
          opacity: 1;
        }

        .notification-panel__actions {
          padding: 10px 20px;
          border-bottom: 1px solid #eee;
          text-align: right;
        }

        .notification-panel__list {
          max-height: 380px;
          overflow-y: auto;
        }

        .notification-item {
          padding: 14px 20px;
          border-bottom: 1px solid #f0f0f0;
          cursor: pointer;
          transition: background 0.2s;
        }

        .notification-item:hover {
          background: #f8f9fa;
        }

        .notification-item--unread {
          background: #f0f5ff;
          border-left: 3px solid #667eea;
        }

        .notification-item__header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
        }

        .notification-item__title {
          font-weight: 600;
          color: #333;
          font-size: 14px;
        }

        .notification-item__time {
          font-size: 11px;
          color: #999;
        }

        .notification-item__message {
          font-size: 13px;
          color: #666;
          line-height: 1.4;
        }

        .notification-item__target {
          margin-top: 6px;
          font-size: 11px;
          color: #667eea;
        }

        .notification-empty {
          padding: 40px 20px;
          text-align: center;
          color: #999;
        }
      </style>

      <script>
        // 알림 시스템 JavaScript
        let notificationPanelOpen = false;

        async function loadNotificationBadge() {
          try {
            const res = await fetch('/erp/api/notifications/badge');
            const data = await res.json();
            const badge = document.getElementById('notification-badge');
            if (badge) {
              if (data.count > 0) {
                badge.textContent = data.count > 99 ? '99+' : data.count;
                badge.style.display = 'block';
              } else {
                badge.style.display = 'none';
              }
            }
          } catch (e) {
            console.error('Notification badge error:', e);
          }
        }

        async function loadNotifications() {
          try {
            const res = await fetch('/erp/api/notifications?limit=20');
            const data = await res.json();
            const list = document.getElementById('notification-list');

            if (!data.success || !data.notifications || data.notifications.length === 0) {
              list.innerHTML = '<div class="notification-empty">알림이 없습니다.</div>';
              return;
            }

            list.innerHTML = data.notifications.map(n => `
          <div class="notification-item ${n.is_read ? '' : 'notification-item--unread'}" 
               data-id="${n.id}" 
               data-order-id="${n.order_id}"
               onclick="handleNotificationClick(${n.id}, ${n.order_id}, '${String(n.notification_type || '').replace(/'/g, "\\'")}', '${String(n.deep_tab || '').replace(/'/g, "\\'")}', '${String(n.deep_event_id || '').replace(/'/g, "\\'")}', '${String(n.deep_target_no || '').replace(/'/g, "\\'")}')">
            <div class="notification-item__header">
              <span class="notification-item__title">${escapeHtml(n.title)}</span>
              <span class="notification-item__time">${formatNotificationTime(n.created_at)}</span>
            </div>
            <div class="notification-item__message">${escapeHtml(n.message)}</div>
            <div class="notification-item__target">
              ${n.target_manager_name ? '담당: ' + escapeHtml(n.target_manager_name) : (n.target_team ? '팀: ' + escapeHtml(n.target_team) : '')}
            </div>
          </div>
        `).join('');
          } catch (e) {
            console.error('Load notifications error:', e);
          }
        }

        function toggleNotificationPanel() {
          const panel = document.getElementById('notification-panel');
          notificationPanelOpen = !notificationPanelOpen;
          panel.style.display = notificationPanelOpen ? 'block' : 'none';

          if (notificationPanelOpen) {
            loadNotifications();
          }
        }

        async function handleNotificationClick(notificationId, orderId, notificationType, deepTab, deepEventId, deepTargetNo) {
          // 읽음 처리
          try {
            await fetch(`/erp/api/notifications/${notificationId}/read`, { method: 'POST' });
            loadNotificationBadge();

            // 해당 주문 상세로 이동
            if (orderId) {
              if (notificationType === 'DRAWING_TRANSFERRED' || notificationType === 'DRAWING_REVISION') {
                const tab = deepTab || (notificationType === 'DRAWING_REVISION' ? 'requests' : 'timeline');
                let url = `/erp/drawing-workbench/${orderId}?tab=${encodeURIComponent(tab)}`;
                if (deepEventId) url += `&event_id=${encodeURIComponent(deepEventId)}`;
                if (deepTargetNo) url += `&target_no=${encodeURIComponent(deepTargetNo)}`;
                window.location.href = url;
              } else {
                window.location.href = `/edit/${orderId}`;
              }
            }
          } catch (e) {
            console.error('Notification click error:', e);
          }
        }

        async function markAllNotificationsRead() {
          try {
            const res = await fetch('/erp/api/notifications/read-all', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
              loadNotificationBadge();
              loadNotifications();
            }
          } catch (e) {
            console.error('Mark all read error:', e);
          }
        }

        function formatNotificationTime(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr.replace(' ', 'T'));
          const now = new Date();
          const diff = (now - date) / 1000;

          if (diff < 60) return '방금';
          if (diff < 3600) return Math.floor(diff / 60) + '분 전';
          if (diff < 86400) return Math.floor(diff / 3600) + '시간 전';
          if (diff < 604800) return Math.floor(diff / 86400) + '일 전';

          return dateStr.split(' ')[0];
        }

        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = String(text);
          return div.innerHTML;
        }

        // 페이지 로드 시 배지 업데이트
        document.addEventListener('DOMContentLoaded', function () {
          loadNotificationBadge();

          // 30초마다 배지 업데이트
          setInterval(loadNotificationBadge, 30000);
        });

        // 패널 외부 클릭 시 닫기
        document.addEventListener('click', function (e) {
          const panel = document.getElementById('notification-panel');
          const btn = document.getElementById('notification-btn');
          if (notificationPanelOpen && !panel.contains(e.target) && !btn.contains(e.target)) {
            toggleNotificationPanel();
          }
        });
      </script>
    </div>
    {% endblock %}