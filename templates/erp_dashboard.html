{% extends "layout.html" %}

{% block content %}
{% set filters = filters or {} %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1 fw-bold text-dark"><i class="fas fa-layer-group text-primary"></i> ERP 프로세스 대시보드</h3>
      <div class="text-muted fw-normal">프로세스/경보/긴급발주를 한 화면에서 확인</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('index') }}"><i class="fas fa-home"></i> 홈</a>
    </div>
  </div>

  <!-- Top Alerts -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      {% set is_urgent_active = filters.get('alert_type') == 'urgent' %}
      {% set urgent_style = 'cursor: pointer; transition: all 0.2s;' %}
      {% if is_urgent_active %}
        {% set urgent_style = urgent_style + ' background-color: #f0f7ff;' %}
      {% endif %}
      <div class="card border-danger shadow-sm erp-alert-card {% if is_urgent_active %}border-primary border-2{% endif %}" data-alert-type="urgent" style="{{ urgent_style }}" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='';">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold text-danger fs-6"><i class="fas fa-bolt"></i> <strong>긴급 발주</strong></div>
            <span class="badge bg-danger fs-6 px-3 py-2"><strong>{{ kpis.urgent_count }}</strong></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      {% set is_measurement_active = filters.get('alert_type') == 'measurement_d4' %}
      {% set measurement_style = 'cursor: pointer; transition: all 0.2s;' %}
      {% if is_measurement_active %}
        {% set measurement_style = measurement_style + ' background-color: #f0f7ff;' %}
      {% endif %}
      <div class="card border-warning shadow-sm erp-alert-card {% if is_measurement_active %}border-primary border-2{% endif %}" data-alert-type="measurement_d4" style="{{ measurement_style }}" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='';">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold text-warning fs-6"><i class="fas fa-ruler-combined"></i> <strong>실측 D-4</strong></div>
            <span class="badge bg-warning text-dark fs-6 px-3 py-2"><strong>{{ kpis.measurement_d4_count }}</strong></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      {% set is_construction_active = filters.get('alert_type') == 'construction_d3' %}
      {% set construction_style = 'cursor: pointer; transition: all 0.2s;' %}
      {% if is_construction_active %}
        {% set construction_style = construction_style + ' background-color: #f0f7ff;' %}
      {% endif %}
      <div class="card border-warning shadow-sm erp-alert-card {% if is_construction_active %}border-primary border-2{% endif %}" data-alert-type="construction_d3" style="{{ construction_style }}" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='';">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold text-warning fs-6"><i class="fas fa-tools"></i> <strong>시공 D-3</strong></div>
            <span class="badge bg-warning text-dark fs-6 px-3 py-2"><strong>{{ kpis.construction_d3_count }}</strong></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      {% set is_production_active = filters.get('alert_type') == 'production_d2' %}
      {% set production_style = 'cursor: pointer; transition: all 0.2s;' %}
      {% if is_production_active %}
        {% set production_style = production_style + ' background-color: #f0f7ff;' %}
      {% endif %}
      <div class="card border-warning shadow-sm erp-alert-card {% if is_production_active %}border-primary border-2{% endif %}" data-alert-type="production_d2" style="{{ production_style }}" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='';">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold text-warning fs-6"><i class="fas fa-industry"></i> <strong>생산 D-2</strong></div>
            <span class="badge bg-warning text-dark fs-6 px-3 py-2"><strong>{{ kpis.production_d2_count }}</strong></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Process Map -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body py-3">
      <div class="fw-bold mb-2 text-dark" style="font-size: 1.35rem;"><i class="fas fa-project-diagram text-primary"></i> 프로세스 맵</div>
      <div class="row g-2">
        {% for step in process_steps %}
        <div class="col">
          {% set is_step_active = (filters.get('stage') or '') == step.label %}
          {% set step_bg = '#f0f7ff' if is_step_active else '#fff' %}
          <div
            class="border rounded p-2 text-center erp-process-step shadow-sm {% if is_step_active %}border-primary border-2{% else %}border-1{% endif %}"
            style="min-width: 120px; cursor: pointer; background: {{ step_bg }};"
            role="button"
            tabindex="0"
            data-stage="{{ step.label }}"
            title="클릭하면 '{{ step.label }}' 단계만 표시"
          >
            <div class="d-flex align-items-center justify-content-center gap-2 mb-1">
              <div class="fw-bold text-dark" style="font-size: 1.5rem;">{{ step.count }}</div>
              {% if step.overdue > 0 %}
              <span class="badge bg-danger fw-bold" title="지연" style="font-size: 0.9rem; padding: 0.3em 0.6em;">{{ step.overdue }}</span>
              {% endif %}
              {% if step.imminent > 0 %}
              <span class="badge bg-warning text-dark fw-bold" title="임박" style="font-size: 0.9rem; padding: 0.3em 0.6em;">{{ step.imminent }}</span>
              {% endif %}
            </div>
            <div class="text-muted fw-normal" style="font-size: 1.1rem;">{{ step.label }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 3-Panel Layout -->
  <style>
    .erp-row-selected { background: rgba(13,110,253,.08) !important; }
    .erp-detail-panel { position: sticky; top: 76px; max-height: calc(100vh - 92px); overflow: auto; }
    .erp-kv { display:flex; justify-content:space-between; gap:12px; }
    .erp-kv .k { color:#6c757d; }
    .erp-kv .v { font-weight:600; text-align:right; }
    
    /* 가독성 개선 스타일 - 텍스트 크기 증가 */
    #erp-grid {
      font-size: 1rem;
    }
    #erp-grid thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding: 1rem 0.75rem;
      white-space: nowrap;
      font-size: 1rem;
    }
    #erp-grid tbody td {
      padding: 1rem 0.75rem;
      vertical-align: middle;
      border-bottom: 1px solid #e9ecef;
      font-size: 1rem;
    }
    #erp-grid tbody tr:hover {
      background-color: #f8f9fa;
    }
    #erp-grid .fw-bold {
      font-weight: 600 !important;
      color: #212529;
      font-size: 1rem;
    }
    #erp-grid .text-muted {
      color: #6c757d !important;
      font-size: 0.95rem;
    }
    /* 키워드 강조 */
    #erp-grid .badge {
      font-weight: 600;
      padding: 0.5em 0.75em;
      font-size: 0.95rem;
    }
    #erp-grid .badge.bg-danger {
      background-color: #dc3545 !important;
      color: #fff !important;
    }
    #erp-grid .badge.bg-warning {
      background-color: #ffc107 !important;
      color: #000 !important;
    }
    #erp-grid .badge.bg-success {
      background-color: #198754 !important;
      color: #fff !important;
    }
    #erp-grid .badge.bg-secondary {
      background-color: #6c757d !important;
      color: #fff !important;
    }
    #erp-grid .badge.bg-info {
      background-color: #0dcaf0 !important;
      color: #000 !important;
    }
    #erp-grid .badge.bg-primary {
      background-color: #0d6efd !important;
      color: #fff !important;
    }
    /* 버튼 스타일 개선 */
    #erp-grid .btn-sm {
      font-weight: 500;
      padding: 0.4rem 0.75rem;
      font-size: 1rem;
    }
    /* 텍스트 가독성 */
    #erp-grid .text-truncate {
      max-width: 200px;
      font-size: 1rem;
    }
    /* 열기 버튼 잘림 방지 */
    #erp-grid .erp-open-btn {
      white-space: nowrap;
    }
    /* 작업 큐 가로 스크롤 및 최소 너비 확보 */
    #erp-grid {
      min-width: 1200px;
    }
    .table-responsive {
      overflow-x: auto;
    }
    @media (max-width: 992px) {
      #erp-grid {
        min-width: 1100px;
      }
    }
    @media (max-width: 1200px) {
      #erp-grid {
        min-width: 1100px;
        table-layout: fixed;
      }
      #erp-grid thead th,
      #erp-grid tbody td {
        padding: 0.6rem 0.5rem;
        font-size: 0.95rem;
        white-space: nowrap;
      }
      #erp-grid .erp-open-text {
        display: none;
      }
    }
    /* 전체 텍스트 크기 증가 */
    .card-body {
      font-size: 1rem;
    }
    .card-body .small {
      font-size: 0.95rem !important;
    }
    .card-body h5, .card-body h6 {
      font-size: 1.25rem;
    }
    .card-body .fw-bold {
      font-size: 1.1rem;
    }
    /* 프로세스 맵 호버 효과 */
    .erp-process-step {
      transition: all 0.2s ease;
    }
    .erp-process-step:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    }
  </style>

  <div class="row g-2">
    <!-- Left: Filters -->
    <div class="col-xl-1 col-lg-2 col-md-3 col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-3 text-dark" style="font-size: 1.15rem;"><i class="fas fa-filter text-primary"></i> 필터</div>
          <form method="get" action="{{ url_for('erp_dashboard') }}" class="d-grid gap-2" id="erp-filters-form">
            {% if filters.get('alert_type') %}
            <input type="hidden" name="alert_type" value="{{ filters.get('alert_type') }}">
            {% endif %}
            <input class="form-control" name="q" placeholder="검색(고객/연락/주소/담당)" value="{{ (filters.get('q') or '') }}" style="font-size: 1rem; padding: 0.5rem;">

            <select class="form-select" name="stage" style="font-size: 1rem; padding: 0.5rem;">
              <option value="">단계: 전체</option>
              <option value="주문접수" {% if filters.get('stage')=='주문접수' %}selected{% endif %}>주문접수</option>
              <option value="해피콜" {% if filters.get('stage')=='해피콜' %}selected{% endif %}>해피콜</option>
              <option value="실측" {% if filters.get('stage')=='실측' %}selected{% endif %}>실측</option>
              <option value="도면" {% if filters.get('stage')=='도면' %}selected{% endif %}>도면</option>
              <option value="고객컨펌" {% if filters.get('stage')=='고객컨펌' %}selected{% endif %}>고객컨펌</option>
              <option value="생산" {% if filters.get('stage')=='생산' %}selected{% endif %}>생산</option>
              <option value="시공" {% if filters.get('stage')=='시공' %}selected{% endif %}>시공</option>
            </select>

            <select class="form-select" name="team" style="font-size: 1rem; padding: 0.5rem;">
              <option value="">팀: 전체</option>
              <option value="CS" {% if filters.get('team')=='CS' %}selected{% endif %}>라홈팀</option>
              <option value="SALES" {% if filters.get('team')=='SALES' %}selected{% endif %}>영업팀</option>
              <option value="MEASURE" {% if filters.get('team')=='MEASURE' %}selected{% endif %}>실측팀</option>
              <option value="DRAWING" {% if filters.get('team')=='DRAWING' %}selected{% endif %}>도면팀</option>
              <option value="PRODUCTION" {% if filters.get('team')=='PRODUCTION' %}selected{% endif %}>생산팀</option>
              <option value="CONSTRUCTION" {% if filters.get('team')=='CONSTRUCTION' %}selected{% endif %}>시공팀</option>
            </select>
            {% if is_admin %}
            <div class="text-info" style="font-size: 1rem;"><i class="fas fa-info-circle"></i> 관리자는 모든 퀘스트에 접근 가능합니다.</div>
            {% endif %}

            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="f-urgent" name="urgent" {% if filters.get('urgent')=='1' %}checked{% endif %} style="width: 1.2em; height: 1.2em;">
              <label class="form-check-label fw-semibold" for="f-urgent" style="font-size: 1rem;">긴급만</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="f-has-alert" name="has_alert" {% if filters.get('has_alert')=='1' %}checked{% endif %} style="width: 1.2em; height: 1.2em;">
              <label class="form-check-label fw-semibold" for="f-has-alert" style="font-size: 1rem;">경보만</label>
            </div>

            <button class="btn btn-primary fw-semibold" type="submit" style="font-size: 1rem; padding: 0.6rem;"><i class="fas fa-search"></i> 적용</button>
            <a class="btn btn-outline-secondary fw-semibold" href="{{ url_for('erp_dashboard') }}" style="font-size: 1rem; padding: 0.6rem;">초기화</a>
          </form>
          <hr class="my-3">
        </div>
      </div>
    </div>

    <!-- Middle: Grid -->
    <div class="col-xl-11 col-lg-10 col-md-9 col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-table text-primary"></i> 작업 큐</h5>
              <small class="text-muted">주문 처리 및 퀘스트 관리</small>
            </div>
            <div>
              <span class="badge bg-primary fs-6 px-3 py-2">표시: <strong>{{ orders|length }}</strong>건</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle" id="erp-grid" style="table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  <th style="width: 10%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">경보</th>
                  <th style="width: 8%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">단계</th>
                  <th style="width: 15%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">퀘스트</th>
                  <th style="width: 10%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">고객</th>
                  <th style="width: 8%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">연락처</th>
                  <th style="width: 20%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">주소</th>
                  <th style="width: 8%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">실측일</th>
                  <th style="width: 8%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">시공일</th>
                  <th style="width: 8%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">담당</th>
                  <th style="width: 8%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">첨부</th>
                  <th style="width: 5%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">상세</th>
                  <th style="width: 5%; font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;"></th>
                </tr>
              </thead>
              <tbody>
                {% for o in orders %}
                <tr class="erp-main-row" data-order-id="{{ o.id }}">
                  <td data-label="경보">
                    {% if o.alerts.urgent %}<span class="badge bg-danger fw-bold" style="font-size: 1.1rem; padding: 0.5em 0.8em;">긴급</span>{% endif %}
                    {% if o.alerts.drawing_overdue %}<span class="badge bg-danger fw-bold" style="font-size: 1.1rem; padding: 0.5em 0.8em;">도면48h</span>{% endif %}
                    {% if o.alerts.measurement_d4 %}
                      {% set meas_d = o.alerts['measurement_days'] if 'measurement_days' in o.alerts else none %}
                      <span class="badge bg-warning text-dark fw-bold" style="font-size: 1.1rem; padding: 0.5em 0.8em;">실측D-{{ meas_d if meas_d is not none else '4' }}</span>
                    {% endif %}
                    {% if o.alerts.construction_d3 %}
                      {% set cons_d = o.alerts['construction_days'] if 'construction_days' in o.alerts else none %}
                      <span class="badge bg-warning text-dark fw-bold" style="font-size: 1.1rem; padding: 0.5em 0.8em;">시공D-{{ cons_d if cons_d is not none else '3' }}</span>
                    {% endif %}
                    {% if o.alerts.production_d2 %}
                      {% set prod_d = o.alerts['production_days'] if 'production_days' in o.alerts else none %}
                      <span class="badge bg-warning text-dark fw-bold" style="font-size: 1.1rem; padding: 0.5em 0.8em;">생산D-{{ prod_d if prod_d is not none else '2' }}</span>
                    {% endif %}
                  </td>
                  <td data-label="단계"><span class="badge bg-secondary" style="font-size: 1.1rem; padding: 0.5em 0.7em;">{{ o.stage }}</span></td>
                  <td data-label="퀘스트" class="erp-quest-cell">
                    {% if o.current_quest %}
                      <button class="btn btn-sm btn-outline-info fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#quest-collapse-{{ o.id }}" aria-expanded="false" aria-controls="quest-collapse-{{ o.id }}" style="font-size: 1.1rem; padding: 0.5em 0.8em;">
                        <i class="fas fa-chevron-down"></i> 
                        {% if o.current_quest.all_approved %}
                          <i class="fas fa-check-circle text-success"></i>
                        {% else %}
                          <i class="fas fa-circle-notch text-warning"></i>
                        {% endif %}
                        <strong>{{ o.current_quest.title }}</strong>
                      </button>
                      {% if o.current_quest.all_approved %}
                        <span class="badge bg-success ms-1" style="font-size: 1rem; padding: 0.4em 0.7em;">완료</span>
                      {% else %}
                        <span class="badge bg-warning ms-1" style="font-size: 1rem; padding: 0.4em 0.7em;">진행중</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted" style="font-size: 1.1rem;">-</span>
                    {% endif %}
                  </td>
                  <td data-label="고객" class="fw-bold" style="font-size: 1.1rem; color: #212529;">{{ o.customer_name }}</td>
                  <td data-label="연락처" style="font-size: 1.1rem; color: #495057;">{{ o.phone }}</td>
                  <td data-label="주소" style="font-size: 1.1rem; color: #495057; word-break: break-word;">{{ o.address }}</td>
                  <td data-label="실측일" class="fw-semibold" style="font-size: 1.1rem; color: #495057;">{{ o.measurement_date or '-' }}</td>
                  <td data-label="시공일" class="fw-semibold" style="font-size: 1.1rem; color: #495057;">{{ o.construction_date or '-' }}</td>
                  <td data-label="담당" style="font-size: 1.1rem; color: #495057;">{{ o.manager_name or '-' }}</td>
                  <td data-label="첨부">
                    {% if o.has_media %}
                      {% set order_id_att = o.id %}
                      <span class="badge bg-primary text-white fw-bold" style="cursor: pointer; font-size: 1.1rem; padding: 0.4em 0.5em; min-width: 2em; text-align: center; display: inline-block;" onclick="openAttachmentsPreview({{ order_id_att }})" title="첨부 파일 미리보기">{{ o.attachments_count }}</span>
                    {% else %}
                      <span class="text-muted" style="font-size: 1.1rem;">-</span>
                    {% endif %}
                  </td>
                  <td data-label="상세" class="text-center">
                    {% set order_id_detail = o.id %}
                    <a class="badge bg-info text-white fw-bold" href="{{ url_for('edit_order', order_id=order_id_detail) }}?open=erp-beta" title="제품 상세정보" style="cursor: pointer; font-size: 1.1rem; padding: 0.4em 0.5em; min-width: 2em; text-align: center; display: inline-block; text-decoration: none;">
                      <i class="fas fa-clipboard-list"></i>
                    </a>
                  </td>
                  <td data-label="열기" class="text-end erp-cell-actions">
                    <button class="btn btn-sm btn-outline-primary erp-open-btn" type="button" data-bs-toggle="collapse" data-bs-target="#order-detail-collapse-{{ o.id }}" aria-expanded="false" aria-controls="order-detail-collapse-{{ o.id }}">
                      <i class="fas fa-chevron-down"></i><span class="erp-open-text"> 열기</span>
                    </button>
                  </td>
                </tr>
                {% if o.current_quest %}
                <tr>
                  <td colspan="12" class="p-0">
                    <div class="collapse" id="quest-collapse-{{ o.id }}">
                      <div class="card card-body border-0 bg-light">
                        <div class="fw-bold mb-3" style="font-size: 1.2rem;"><i class="fas fa-flag-checkered text-primary"></i> 현재 단계 퀘스트</div>
                        <div class="text-muted mb-3" style="font-size: 1rem;">각 단계별 명확한 퀘스트 및 팀 승인</div>
                        <div class="card mb-3 shadow-sm">
                          <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                              <div>
                                <h5 class="card-title mb-2 fw-bold" style="font-size: 1.25rem;">{{ o.current_quest.title }}</h5>
                                <div class="text-muted" style="font-size: 1rem;">{{ o.current_quest.description }}</div>
                              </div>
                              <span class="badge {% if o.current_quest.all_approved %}bg-success{% else %}bg-warning{% endif %}" style="font-size: 1rem; padding: 0.5em 0.75em;">
                                {% if o.current_quest.all_approved %}완료{% else %}진행중{% endif %}
                              </span>
                            </div>
                            <div class="mb-3">
                              <div class="text-muted mb-2 fw-semibold" style="font-size: 1.05rem;">담당 팀</div>
                              <div class="fw-bold" style="font-size: 1.15rem;">{{ team_labels.get(o.current_quest.owner_team, o.current_quest.owner_team) }}</div>
                            </div>
                            <div class="mb-3">
                              <div class="text-muted mb-2 fw-semibold" style="font-size: 1.05rem;">팀별 승인</div>
                              <div id="quest-approvals-{{ o.id }}">
                                {% for team in o.current_quest.required_approvals %}
                                {% set approved = o.current_quest.team_approvals.get(team, False) %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                  <span class="fw-semibold" style="font-size: 1rem;">{{ team_labels.get(team, team) }}</span>
                                  {% if approved %}
                                    <span class="badge bg-success" style="font-size: 1rem; padding: 0.4em 0.7em;">승인완료</span>
                                  {% else %}
                                    {% set order_id_approve = o.id %}
                                    {% set team_name = team %}
                                    <button class="btn btn-primary fw-semibold" onclick="approveQuestTeam({{ order_id_approve }}, '{{ team_name }}')" style="font-size: 1rem; padding: 0.4rem 0.75rem;">승인</button>
                                  {% endif %}
                                </div>
                                {% endfor %}
                              </div>
                            </div>
                            <div class="d-flex gap-2">
                              {% set order_id_refresh = o.id %}
                              <button class="btn btn-outline-primary fw-semibold" type="button" onclick="refreshQuestStatus({{ order_id_refresh }})" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                <i class="fas fa-sync"></i> 상태 새로고침
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endif %}
                <!-- Order Detail Slide -->
                <tr>
                  <td colspan="12" class="p-0">
                    <div class="collapse" id="order-detail-collapse-{{ o.id }}">
                      <div class="card card-body border-0 bg-light">
                        <div class="fw-bold mb-3"><i class="fas fa-info-circle"></i> 주문 상세</div>
                        <div id="order-detail-content-{{ o.id }}" class="order-detail-content">
                          <div class="text-muted small">로딩 중...</div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- 첨부 파일 미리보기 모달 -->
  <div class="modal fade" id="erpAttachmentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 60vw; width: 60vw; height: 90vh; max-height: 90vh; margin: auto;">
      <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0; position: relative;">
          <h5 class="modal-title"><i class="fas fa-paperclip"></i> 첨부 미리보기 <span id="erp-attachment-preview-counter" class="badge bg-secondary ms-2"></span></h5>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="erp-attachment-preview-prev" style="display: none;" title="이전 파일">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="erp-attachment-preview-next" style="display: none;" title="다음 파일">
            <i class="fas fa-chevron-right"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="padding: 0; overflow: hidden; flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <div id="erp-attachment-preview-body" style="padding: 1rem; flex: 1; overflow: auto; display: flex; flex-direction: column;"></div>
        </div>
        <div class="modal-footer" style="flex-shrink: 0;">
          <a class="btn btn-primary" id="erp-attachment-preview-download" href="#" target="_blank" rel="noopener">
            <i class="fas fa-download"></i> 다운로드
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // 알람 바 클릭 이벤트 처리
    document.addEventListener('DOMContentLoaded', function() {
      const alertCards = document.querySelectorAll('.erp-alert-card');
      alertCards.forEach(card => {
        card.addEventListener('click', function() {
          const alertType = this.getAttribute('data-alert-type');
          if (alertType) {
            // 현재 URL 파라미터 가져오기
            const url = new URL(window.location.href);
            const currentAlertType = url.searchParams.get('alert_type');
            // 같은 알람 바를 다시 클릭하면 필터 해제
            if (currentAlertType === alertType) {
              url.searchParams.delete('alert_type');
            } else {
              url.searchParams.set('alert_type', alertType);
            }
            // 다른 필터는 유지하되 alert_type만 설정/해제
            window.location.href = url.toString();
          }
        });
      });
    });

    // === 표시용 한글 라벨(저장은 영문 코드 유지) ===
    const TEAM_LABELS = {{ team_labels|tojson|safe }};
    const STAGE_LABELS = {{ stage_labels|tojson|safe }};

    function label(map, code, fallback = '-') {
      if (!code) return fallback;
      return map[code] || code;
    }

    let __selectedOrderId = null;
    let __attachmentsCache = {};
    let __currentAttachmentList = [];
    let __currentAttachmentIndex = 0;

    // 첨부 파일 미리보기 모달 열기 (단일 파일)
    function openAttachmentPreviewModal(attachmentId, viewUrl, downloadUrl, filename, fileType) {
      const modalEl = document.getElementById('erpAttachmentPreviewModal');
      const body = document.getElementById('erp-attachment-preview-body');
      const dl = document.getElementById('erp-attachment-preview-download');
      if (!modalEl || !body || !dl) return;
      
      dl.href = downloadUrl || viewUrl || '#';
      
      if (fileType === 'video') {
        body.innerHTML = `<div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;"><video src="${viewUrl}" controls autoplay style="width:100%;height:100%;"></video></div><div class="small text-muted mt-2">${escapeHtml(filename || '')}</div>`;
      } else {
        // 이미지 줌 기능을 위한 구조 (윤곽 없이 전체 확대/축소)
        body.innerHTML = `
          <div class="position-relative" style="overflow: hidden; cursor: grab; user-select: none; height: 100%; display: flex; align-items: center; justify-content: center;" id="image-zoom-container">
            <img src="${viewUrl}" alt="${escapeHtml(filename || '')}" 
                 id="preview-zoom-image" 
                 style="display: block; max-width: 100%; max-height: 100%; transition: transform 0.1s ease-out; transform-origin: center center;"
                 draggable="false">
            <div class="position-absolute top-0 end-0 m-2">
              <div class="badge bg-dark bg-opacity-75" id="zoom-level-badge" style="display: none;">100%</div>
            </div>
          </div>
          <div class="small text-muted mt-2 text-center" style="flex-shrink: 0;">${escapeHtml(filename || '')} <span class="text-muted">(휠 스크롤로 줌 인/아웃)</span></div>
        `;
        
        // 이미지 줌 기능 초기화
        setupImageZoom();
      }
      
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      
      // 네비게이션 버튼 이벤트 리스너 등록
      const prevBtn = document.getElementById('erp-attachment-preview-prev');
      const nextBtn = document.getElementById('erp-attachment-preview-next');
      if (prevBtn) {
        prevBtn.onclick = showPreviousAttachment;
      }
      if (nextBtn) {
        nextBtn.onclick = showNextAttachment;
      }
      
      // 네비게이션 업데이트
      updateAttachmentNavigation();
      
      // 키보드 이벤트 리스너 (좌우 화살표 키)
      const handleKeyDown = (e) => {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          showPreviousAttachment();
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          showNextAttachment();
        }
      };
      
      // 모달이 열릴 때 키보드 이벤트 리스너 추가
      modalEl.addEventListener('keydown', handleKeyDown);
      
      // 모달이 닫힐 때 키보드 이벤트 리스너 제거
      modalEl.addEventListener('hidden.bs.modal', () => {
        modalEl.removeEventListener('keydown', handleKeyDown);
      }, { once: true });
      
      modal.show();
    }
    
    // 이미지 줌 기능 설정 (윤곽 없이 전체 확대/축소)
    function setupImageZoom() {
      const container = document.getElementById('image-zoom-container');
      const img = document.getElementById('preview-zoom-image');
      const badge = document.getElementById('zoom-level-badge');
      if (!container || !img || !badge) return;
      
      let scale = 1;
      let panX = 0;
      let panY = 0;
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let startPanX = 0;
      let startPanY = 0;
      
      // 초기 이미지 크기 저장
      let initialWidth = img.naturalWidth || img.width;
      let initialHeight = img.naturalHeight || img.height;
      
      // 이미지 로드 후 초기 크기 설정
      if (img.complete) {
        initialWidth = img.naturalWidth || img.width;
        initialHeight = img.naturalHeight || img.height;
      } else {
        img.addEventListener('load', () => {
          initialWidth = img.naturalWidth || img.width;
          initialHeight = img.naturalHeight || img.height;
        });
      }
      
      // 줌 레벨 표시 업데이트
      function updateZoomBadge() {
        badge.textContent = Math.round(scale * 100) + '%';
        badge.style.display = scale !== 1 ? 'block' : 'none';
      }
      
      // 이미지 변환 적용 (윤곽 없이 전체 확대)
      function applyTransform() {
        img.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        img.style.border = 'none';
        img.style.boxShadow = 'none';
        img.style.borderRadius = '0';
        img.style.padding = '0';
        img.style.background = 'transparent';
        updateZoomBadge();
      }
      
      // 줌 인/아웃 (마우스 위치 중심)
      function zoomAtPoint(delta, clientX, clientY) {
        const rect = container.getBoundingClientRect();
        const containerCenterX = rect.left + rect.width / 2;
        const containerCenterY = rect.top + rect.height / 2;
        
        // 마우스 위치를 컨테이너 중심 기준으로 변환
        const x = clientX - containerCenterX;
        const y = clientY - containerCenterY;
        
        const oldScale = scale;
        const zoomFactor = delta > 0 ? 0.9 : 1.1;
        scale = Math.max(0.5, Math.min(10, scale * zoomFactor));
        
        // 마우스 위치를 중심으로 줌
        if (scale !== oldScale) {
          const scaleChange = scale / oldScale;
          panX = x - (x - panX) * scaleChange;
          panY = y - (y - panY) * scaleChange;
        }
        
        applyTransform();
      }
      
      // 휠 스크롤로 줌 (모든 경우)
      container.addEventListener('wheel', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomAtPoint(e.deltaY, e.clientX, e.clientY);
      }, { passive: false });
      
      // 모달 body에도 휠 이벤트 추가 (이미지 영역 밖에서도 작동)
      const modalBody = document.querySelector('#erpAttachmentPreviewModal .modal-body');
      if (modalBody) {
        modalBody.addEventListener('wheel', (e) => {
          const target = e.target;
          if (target !== container && !container.contains(target)) {
            e.preventDefault();
            e.stopPropagation();
            const rect = modalBody.getBoundingClientRect();
            zoomAtPoint(e.deltaY, rect.left + rect.width / 2, rect.top + rect.height / 2);
          }
        }, { passive: false });
      }
      
      // 드래그로 패닝
      container.addEventListener('mousedown', (e) => {
        if (scale > 1) {
          isDragging = true;
          container.style.cursor = 'grabbing';
          startX = e.clientX;
          startY = e.clientY;
          startPanX = panX;
          startPanY = panY;
          e.preventDefault();
        }
      });
      
      document.addEventListener('mousemove', (e) => {
        if (isDragging && scale > 1) {
          panX = startPanX + (e.clientX - startX);
          panY = startPanY + (e.clientY - startY);
          applyTransform();
          e.preventDefault();
        }
      });
      
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          container.style.cursor = scale > 1 ? 'grab' : 'default';
        }
      });
      
      container.addEventListener('mouseleave', () => {
        if (isDragging) {
          isDragging = false;
          container.style.cursor = scale > 1 ? 'grab' : 'default';
        }
      });
      
      // 더블클릭으로 리셋
      container.addEventListener('dblclick', () => {
        scale = 1;
        panX = 0;
        panY = 0;
        applyTransform();
      });
      
      // 터치 제스처 지원 (모바일)
      let touchStartDistance = 0;
      let touchStartScale = 1;
      let touchStartPanX = 0;
      let touchStartPanY = 0;
      
      container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          startX = touch.clientX;
          startY = touch.clientY;
          startPanX = panX;
          startPanY = panY;
        } else if (e.touches.length === 2) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          touchStartDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          touchStartScale = scale;
          touchStartPanX = panX;
          touchStartPanY = panY;
        }
      }, { passive: true });
      
      container.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && scale > 1) {
          e.preventDefault();
          const touch = e.touches[0];
          panX = startPanX + (touch.clientX - startX);
          panY = startPanY + (touch.clientY - startY);
          applyTransform();
        } else if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const distance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          scale = Math.max(0.5, Math.min(10, touchStartScale * (distance / touchStartDistance)));
          applyTransform();
        }
      }, { passive: false });
      
      updateZoomBadge();
    }

    // 주문의 첨부 파일 미리보기 (첨부 배지 클릭 시) - 좌우 네비게이션 지원
    async function openAttachmentsPreview(orderId) {
      try {
        // 캐시 확인
        let aList = null;
        if (__attachmentsCache[orderId]) {
          aList = __attachmentsCache[orderId];
        } else {
          const res = await fetch(`/api/orders/${orderId}/attachments`);
          const data = await res.json();
          aList = (data && data.attachments) || [];
          __attachmentsCache[orderId] = aList;
        }
        
        if (aList.length > 0) {
          __currentAttachmentList = aList;
          __currentAttachmentIndex = 0;
          showAttachmentAtIndex(0);
        } else {
          alert('첨부 파일이 없습니다.');
        }
      } catch (err) {
        console.error('첨부 파일 로드 실패:', err);
        alert('첨부 파일을 불러올 수 없습니다.');
      }
    }

    // 특정 인덱스의 첨부 파일 표시
    function showAttachmentAtIndex(index) {
      if (!__currentAttachmentList || index < 0 || index >= __currentAttachmentList.length) {
        return;
      }
      
      __currentAttachmentIndex = index;
      const attachment = __currentAttachmentList[index];
      
      openAttachmentPreviewModal(
        attachment.id,
        attachment.view_url || '#',
        attachment.download_url || attachment.view_url || '#',
        attachment.filename || '',
        attachment.file_type || 'image'
      );
      
      // 네비게이션 버튼 및 카운터 업데이트
      updateAttachmentNavigation();
    }

    // 첨부 파일 네비게이션 업데이트
    function updateAttachmentNavigation() {
      const prevBtn = document.getElementById('erp-attachment-preview-prev');
      const nextBtn = document.getElementById('erp-attachment-preview-next');
      const counter = document.getElementById('erp-attachment-preview-counter');
      
      if (!prevBtn || !nextBtn || !counter) return;
      
      const total = __currentAttachmentList.length;
      const current = __currentAttachmentIndex + 1;
      
      // 카운터 표시
      counter.textContent = `${current} / ${total}`;
      
      // 이전/다음 버튼 표시
      if (total > 1) {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        prevBtn.disabled = (__currentAttachmentIndex === 0);
        nextBtn.disabled = (__currentAttachmentIndex === total - 1);
      } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }
    }

    // 이전 파일 보기
    function showPreviousAttachment() {
      if (__currentAttachmentIndex > 0) {
        showAttachmentAtIndex(__currentAttachmentIndex - 1);
      }
    }

    // 다음 파일 보기
    function showNextAttachment() {
      if (__currentAttachmentIndex < __currentAttachmentList.length - 1) {
        showAttachmentAtIndex(__currentAttachmentIndex + 1);
      }
    }

    function renderBadges(alerts) {
      const a = alerts || {};
      const out = [];
      if (a.urgent) out.push('<span class="badge bg-danger me-1">긴급</span>');
      if (a.drawing_overdue) out.push('<span class="badge bg-danger me-1">도면48h</span>');
      if (a.measurement_d4) out.push('<span class="badge bg-warning text-dark me-1">실측D-4</span>');
      if (a.construction_d3) out.push('<span class="badge bg-warning text-dark me-1">시공D-3</span>');
      if (a.production_d2) out.push('<span class="badge bg-warning text-dark me-1">생산D-2</span>');
      return out.join('') || '<span class="text-muted small">경보 없음</span>';
    }

    async function approveQuestTeam(orderId, team) {
      try {
        const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({team: team})
        });
        const data = await res.json();
        
        // success 필드 확인 (API는 success 필드를 반환함)
        if (!data.success) {
          alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
          return;
        }
        
        // 자동 단계 전환 알림
        if (data.auto_transitioned && data.next_stage) {
          const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
          alert('✅ 모든 팀 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
        } else if (data.all_approved) {
          alert('✅ 모든 팀 승인 완료!');
        } else {
          const missingTeams = data.missing_teams.map(t => label(TEAM_LABELS, t, t)).join(', ');
          alert('승인 완료. 남은 팀: ' + missingTeams);
        }
        
        // 슬라이드 내 Quest 정보 업데이트
        await loadQuestDetail(orderId);
        // 페이지 새로고침 (주문 목록 업데이트)
        window.location.reload();
      } catch (err) {
        console.error('승인 실패:', err);
        alert('승인 중 오류가 발생했습니다.');
      }
    }

    async function loadQuestDetail(orderId) {
      try {
        const res = await fetch(`/api/orders/${orderId}/quest`);
        const data = await res.json();
        if (data.error) {
          console.error('Quest 로드 실패:', data.error);
          return;
        }
        // 슬라이드 내 Quest 정보 업데이트
        const questContainer = document.querySelector(`#quest-collapse-${orderId} #quest-approvals-${orderId}`);
        if (questContainer) {
          const quest = data.quest || {};
          const requiredTeams = quest.required_approvals || [];
          const teamApprovalsRaw = quest.team_approvals || {};

          let html = '';
          for (const team of requiredTeams) {
            // team_approvals는 딕셔너리 형태일 수 있음: {team: {"approved": True, ...}} 또는 {team: True}
            const approvalData = teamApprovalsRaw[team];
            let approved = false;
            if (typeof approvalData === 'object' && approvalData !== null) {
              approved = approvalData.approved === true;
            } else {
              approved = Boolean(approvalData);
            }
            const teamLabel = label(TEAM_LABELS, team, team);
            html += `<div class="d-flex justify-content-between align-items-center mb-2">`;
            html += `<span class="small">${escapeHtml(teamLabel)}</span>`;
            if (approved) {
              html += `<span class="badge bg-success">승인완료</span>`;
            } else {
              html += `<button class="btn btn-sm btn-primary" onclick="approveQuestTeam(${orderId}, '${escapeHtml(team)}')">승인</button>`;
            }
            html += `</div>`;
          }
          questContainer.innerHTML = html;
        }
      } catch (err) {
        console.error('Quest 상세 로드 실패:', err);
      }
    }

    // 퀘스트 상태 새로고침 (서버에서 최신 상태를 가져와서 슬라이드와 작업 큐 모두 업데이트)
    async function refreshQuestStatus(orderId) {
      try {
        // Quest 정보를 서버에서 다시 가져와서 슬라이드 업데이트
        await loadQuestDetail(orderId);
        
        // 작업 큐의 퀘스트 버튼 상태도 업데이트하기 위해 해당 주문의 퀘스트 정보 다시 가져오기
        const res = await fetch(`/api/orders/${orderId}/quest`);
        const data = await res.json();
        if (data.error) {
          console.error('Quest 로드 실패:', data.error);
          return;
        }
        
        const quest = data.quest || {};
        const questStatus = quest.status || 'OPEN';
        const requiredTeams = quest.required_approvals || [];
        const teamApprovalsRaw = quest.team_approvals || {};
        
        // 모든 팀이 승인했는지 확인
        let allApproved = true;
        for (const team of requiredTeams) {
          const approvalData = teamApprovalsRaw[team];
          let approved = false;
          if (typeof approvalData === 'object' && approvalData !== null) {
            approved = approvalData.approved === true;
          } else {
            approved = Boolean(approvalData);
          }
          if (!approved) {
            allApproved = false;
            break;
          }
        }
        
        // 작업 큐의 퀘스트 버튼과 배지 업데이트
        const questRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
        if (questRow) {
          const questCell = questRow.querySelector('td:nth-child(3)'); // 퀘스트 컬럼
          if (questCell) {
            const questButton = questCell.querySelector('button[data-bs-toggle="collapse"]');
            const questBadge = questCell.querySelector('.badge');
            
            if (questButton) {
              // 버튼 내부 아이콘 업데이트
              const icon = questButton.querySelector('i.fa-check-circle, i.fa-circle-notch');
              if (icon) {
                if (questStatus === 'COMPLETED' || allApproved) {
                  icon.className = 'fas fa-check-circle text-success';
                } else {
                  icon.className = 'fas fa-circle-notch text-warning';
                }
              }
            }
            
            // 배지 업데이트
            if (questBadge) {
              if (questStatus === 'COMPLETED' || allApproved) {
                questBadge.className = 'badge bg-success ms-1';
                questBadge.style.fontSize = '1rem';
                questBadge.style.padding = '0.4em 0.7em';
                questBadge.textContent = '완료';
              } else {
                questBadge.className = 'badge bg-warning ms-1';
                questBadge.style.fontSize = '1rem';
                questBadge.style.padding = '0.4em 0.7em';
                questBadge.textContent = '진행중';
              }
            }
          }
        }
        
        // 성공 메시지 표시
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = '<i class="fas fa-check-circle"></i> 퀘스트 상태가 업데이트되었습니다. <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.appendChild(alertDiv);
        
        // 3초 후 자동으로 제거
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 3000);
      } catch (err) {
        console.error('퀘스트 상태 새로고침 실패:', err);
        alert('퀘스트 상태를 새로고침하는 중 오류가 발생했습니다: ' + err.message);
      }
    }

    async function loadOrderDetail(orderId) {
      const container = document.getElementById(`order-detail-content-${orderId}`);
      if (!container) return;
      
      try {
        container.innerHTML = '<div class="text-muted small">로딩 중...</div>';
        
        const [structured, attachments] = await Promise.all([
          fetch(`/api/orders/${orderId}/structured`).then(r => r.json()),
          fetch(`/api/orders/${orderId}/attachments`).then(r => r.json()),
        ]);

        const sd = (structured && structured.structured_data) || {};
        const customer = (((sd.parties||{}).customer||{}).name) || '-';
        const orderer = (((sd.parties||{}).orderer||{}).name) || '-';
        const phone = (((sd.parties||{}).customer||{}).phone) || '-';
        const address = ((sd.site||{}).address_full) || ((sd.site||{}).address_main) || '-';
        const addressNote = ((sd.site||{}).address_note) || '-';
        const phoneNote = (((sd.parties||{}).customer||{}).phone_note) || '-';
        const measureNote = (((sd.schedule||{}).measurement||{}).note) || '-';
        const measure = (((sd.schedule||{}).measurement||{}).date) || '-';
        const construct = (((sd.schedule||{}).construction||{}).date) || '-';
        const manager = (((sd.parties||{}).manager||{}).name) || '-';
        const stage = (((sd.workflow||{}).stage)) || '-';
        const urgent = ((sd.flags||{}).urgent) || false;
        
        // 담당팀: 현재 단계의 담당팀으로 자동 계산
        const STAGE_TO_TEAM = {
          'RECEIVED': 'CS',
          'HAPPYCALL': 'CS',
          'MEASURE': 'SALES',
          'DRAWING': 'DRAWING',
          'CONFIRM': 'SALES',
          'PRODUCTION': 'PRODUCTION',
          'CONSTRUCTION': 'CONSTRUCTION'
        };
        let ownerTeam = STAGE_TO_TEAM[stage] || '-';
        // 실측/고객컨펌에서 발주사에 '라홈' 포함 시 라홈팀(CS)으로 변경
        if (stage === 'MEASURE' || stage === 'CONFIRM') {
          const ordererName = (((sd.parties||{}).orderer||{}).name || '').trim();
          if (ordererName && ordererName.includes('라홈')) {
            ownerTeam = 'CS';
          }
        }

        // 제품 항목 (모든 상세 정보 표시)
        const items = (sd.items || []) || [];
        let itemsHtml = '';
        if (items.length > 0) {
          itemsHtml = '<div class="table-responsive mt-3"><table class="table table-bordered" style="font-size: 1.15rem;"><thead class="table-light"><tr><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">제품명</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem; width: 80px;">규격 W</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem; width: 80px;">규격 D</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem; width: 80px;">규격 H</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">내부</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">색상</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">옵션</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">손잡이</th><th style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">기타</th><th class="text-end" style="font-weight: 700; font-size: 1.2rem; color: #495057; background-color: #e9ecef; padding: 0.75rem;">금액</th></tr></thead><tbody>';
          items.forEach(item => {
            // 규격을 W, D, H로 분리
            let specW = item.spec_width || '';
            let specD = item.spec_depth || '';
            let specH = item.spec_height || '';
            // 기존 spec 필드가 있고 W, D, H가 없으면 파싱
            if (!specW && !specD && !specH && item.spec) {
              const specStr = String(item.spec || '').trim();
              const parts = specStr.split(/[xX*×]/).map(s => s.trim());
              if (parts.length >= 3) {
                specW = parts[0];
                specD = parts[1];
                specH = parts[2];
              } else if (parts.length === 2) {
                specW = parts[0];
                specD = parts[1];
              } else if (parts.length === 1) {
                specW = parts[0];
              }
            }
            itemsHtml += `<tr>
              <td class="fw-semibold" style="font-size: 1.15rem; color: #212529; padding: 0.75rem;">${escapeHtml(item.product_name || item.name || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem; width: 80px; text-align: center;">${escapeHtml(specW || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem; width: 80px; text-align: center;">${escapeHtml(specD || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem; width: 80px; text-align: center;">${escapeHtml(specH || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem;">${escapeHtml(item.internal || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem;">${escapeHtml(item.color || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem;">${escapeHtml(item.option_detail || item.options || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem;">${escapeHtml(item.handle || '-')}</td>
              <td style="font-size: 1.15rem; color: #495057; padding: 0.75rem;">${escapeHtml(item.misc || '-')}</td>
              <td class="text-end fw-bold" style="font-size: 1.15rem; color: #212529; padding: 0.75rem;">${escapeHtml(item.price ? item.price.toLocaleString('ko-KR') + '원' : '-')}</td>
            </tr>`;
          });
          itemsHtml += '</tbody></table></div>';
        } else {
          itemsHtml = '<div class="text-muted mt-3" style="font-size: 1rem;">제품 항목 없음</div>';
        }

        // 첨부 파일 (여백 최소화, 미리보기 기능)
        const aList = (attachments && attachments.attachments) || [];
        // 첨부 파일 캐시 저장
        __attachmentsCache[orderId] = aList;
        
        let attachmentsHtml = '';
        if (aList.length > 0) {
          attachmentsHtml = '<div class="d-flex flex-wrap gap-1 mt-2">';
          aList.forEach(a => {
            const name = escapeHtml(a.filename || '');
            const viewUrl = a.view_url || '#';
            const thumb = a.thumbnail_view_url || viewUrl;
            const downloadUrl = a.download_url || viewUrl;
            const fileType = a.file_type || 'image';
            if (fileType === 'video') {
              attachmentsHtml += `<div class="position-relative" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'video')">
                <div style="width: 80px; height: 60px; background: #000; display: flex; align-items: center; justify-content: center;">
                  <video src="${viewUrl}" preload="metadata" style="width:100%;height:100%;object-fit:cover;"></video>
                </div>
                <div class="position-absolute top-0 start-0 bg-dark bg-opacity-75 text-white p-1" style="font-size: 10px;"><i class="fas fa-play"></i></div>
              </div>`;
            } else {
              attachmentsHtml += `<div class="position-relative" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'image')">
                <img src="${thumb}" style="width: 80px; height: 60px; object-fit: cover; background:#fff; display: block;" alt="${name}">
              </div>`;
            }
          });
          attachmentsHtml += '</div>';
        } else {
          attachmentsHtml = '<div class="text-muted small mt-2">첨부 없음</div>';
        }

        container.innerHTML = `
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold" style="font-size: 1.4rem;"><i class="fas fa-info-circle text-primary"></i> 기본 정보</h5>
                  <div style="font-size: 1.15rem;">
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">주문번호:</strong> <span class="fw-bold" style="color: #212529; margin-left: 0.5rem;">#${orderId}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">고객명:</strong> <span class="fw-semibold" style="color: #212529; margin-left: 0.5rem;">${escapeHtml(customer)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">발주사:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(orderer)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">연락처:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(phone)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">주소:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(address)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">담당자:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(manager)}</span></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold" style="font-size: 1.4rem;"><i class="fas fa-calendar text-primary"></i> 일정 및 특이사항</h5>
                  <div style="font-size: 1.15rem;">
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">실측일:</strong> <span class="fw-semibold" style="color: #212529; margin-left: 0.5rem;">${escapeHtml(measure)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">시공일:</strong> <span class="fw-semibold" style="color: #212529; margin-left: 0.5rem;">${escapeHtml(construct)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">주소특이:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(addressNote)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">연락특이:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(phoneNote)}</span></div>
                    <div class="mb-3"><strong style="font-size: 1.2rem; color: #0d6efd;">실측특이:</strong> <span style="color: #495057; margin-left: 0.5rem;">${escapeHtml(measureNote)}</span></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-3" style="font-size: 1.4rem;"><i class="fas fa-box text-primary"></i> 제품 항목</h5>
                  ${itemsHtml}
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-3" style="font-size: 1.25rem;"><i class="fas fa-paperclip text-primary"></i> 첨부 파일 <span class="badge bg-secondary" style="font-size: 1rem;">${aList.length}개</span></h5>
                  ${attachmentsHtml}
                </div>
              </div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error('주문 상세 로드 실패:', err);
        container.innerHTML = '<div class="text-danger small">로드 실패: ' + escapeHtml(err.message) + '</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // 필터 폼 제출 시 alert_type 파라미터 유지
      const form = document.getElementById('erp-filters-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          const url = new URL(window.location.href);
          const currentAlertType = url.searchParams.get('alert_type');
          if (currentAlertType) {
            let alertTypeInput = this.querySelector('input[name="alert_type"]');
            if (!alertTypeInput) {
              alertTypeInput = document.createElement('input');
              alertTypeInput.type = 'hidden';
              alertTypeInput.name = 'alert_type';
              this.appendChild(alertTypeInput);
            }
            alertTypeInput.value = currentAlertType;
          }
        });
      }

      // 주문 상세 슬라이드 토글 이벤트
      document.querySelectorAll('[data-bs-target^="#order-detail-collapse-"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const targetId = this.getAttribute('data-bs-target');
          const orderId = targetId.replace('#order-detail-collapse-', '');
          const collapseEl = document.querySelector(targetId);
          
          if (collapseEl) {
            collapseEl.addEventListener('shown.bs.collapse', function() {
              loadOrderDetail(parseInt(orderId));
            }, { once: true });
          }
        });
      });

      // 프로세스 맵 클릭 → 좌측 필터(stage) 적용 후 리로드 (KPI/맵/그리드 모두 동기화)
      const stageSel = form ? form.querySelector('select[name="stage"]') : null;
      if (form && stageSel) {
        const applyStage = (stageLabel) => {
          const next = stageLabel || '';
          // 같은 단계를 다시 클릭하면 해제(전체)
          stageSel.value = ((stageSel.value || '') === next) ? '' : next;
          // alert_type 등 다른 필터 파라미터 유지
          const url = new URL(window.location.href);
          const currentAlertType = url.searchParams.get('alert_type');
          if (currentAlertType) {
            // alert_type을 hidden input으로 추가
            let alertTypeInput = form.querySelector('input[name="alert_type"]');
            if (!alertTypeInput) {
              alertTypeInput = document.createElement('input');
              alertTypeInput.type = 'hidden';
              alertTypeInput.name = 'alert_type';
              form.appendChild(alertTypeInput);
            }
            alertTypeInput.value = currentAlertType;
          }
          form.submit();
        };
        document.querySelectorAll('.erp-process-step[data-stage]').forEach(el => {
          el.addEventListener('click', () => applyStage(el.dataset.stage || ''));
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              applyStage(el.dataset.stage || '');
            }
          });
        });
      }
    });
  </script>
</div>
{% endblock %}

