{% extends "layout.html" %}

{% block title %}ERP 출고 설정{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0"><i class="fas fa-cog text-primary"></i> ERP 출고 설정</h1>
    <div>
      <a href="{{ url_for('erp_shipment_dashboard') }}" class="btn btn-primary">
        <i class="fas fa-truck-loading"></i> 출고 대시보드
      </a>
    </div>
  </div>
  <p class="text-muted small mb-3">출고 대시보드에서 직접 입력하거나 저장된 값을 불러올 수 있도록 목록을 관리합니다. (계산기 제품 설정과 동일한 방식)</p>

  <div class="row">
    <div class="col-12 col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold"><i class="fas fa-clock me-2"></i>시공시간</div>
        <div class="card-body">
          <ul id="list-construction_time" class="list-group list-group-flush mb-2">
            {% for v in (settings.construction_time or []) %}
            <li class="list-group-item d-flex gap-2 align-items-center px-0">
              <input type="text" class="form-control form-control-sm setting-input" data-key="construction_time" value="{{ v }}" placeholder="예: 10:00">
              <button type="button" class="btn btn-sm btn-outline-danger btn-remove-setting" title="삭제">&times;</button>
            </li>
            {% endfor %}
          </ul>
          <button type="button" class="btn btn-sm btn-outline-success btn-add-setting" data-key="construction_time"><i class="fas fa-plus me-1"></i>추가</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold"><i class="fas fa-user-tie me-2"></i>도면담당자</div>
        <div class="card-body">
          <ul id="list-drawing_manager" class="list-group list-group-flush mb-2">
            {% for v in (settings.drawing_manager or []) %}
            <li class="list-group-item d-flex gap-2 align-items-center px-0">
              <input type="text" class="form-control form-control-sm setting-input" data-key="drawing_manager" value="{{ v }}" placeholder="도면담당자">
              <button type="button" class="btn btn-sm btn-outline-danger btn-remove-setting" title="삭제">&times;</button>
            </li>
            {% endfor %}
          </ul>
          <button type="button" class="btn btn-sm btn-outline-success btn-add-setting" data-key="drawing_manager"><i class="fas fa-plus me-1"></i>추가</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold"><i class="fas fa-hard-hat me-2"></i>시공자</div>
        <div class="card-body">
          <ul id="list-construction_workers" class="list-group list-group-flush mb-2">
            {% for v in (settings.construction_workers or []) %}
            <li class="list-group-item d-flex gap-2 align-items-center px-0">
              <input type="text" class="form-control form-control-sm setting-input" data-key="construction_workers" value="{{ v }}" placeholder="시공자">
              <button type="button" class="btn btn-sm btn-outline-danger btn-remove-setting" title="삭제">&times;</button>
            </li>
            {% endfor %}
          </ul>
          <button type="button" class="btn btn-sm btn-outline-success btn-add-setting" data-key="construction_workers"><i class="fas fa-plus me-1"></i>추가</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold"><i class="fas fa-map-marker-alt me-2"></i>현장주소 추가 (저장 목록)</div>
        <div class="card-body">
          <ul id="list-site_extra" class="list-group list-group-flush mb-2">
            {% for v in (settings.site_extra or []) %}
            <li class="list-group-item d-flex gap-2 align-items-center px-0">
              <input type="text" class="form-control form-control-sm setting-input" data-key="site_extra" value="{{ v.get('text', '') if v is mapping else (v|string) }}" placeholder="추가 주소">
              <button type="button" class="btn btn-sm btn-outline-danger btn-remove-setting" title="삭제">&times;</button>
            </li>
            {% endfor %}
          </ul>
          <button type="button" class="btn btn-sm btn-outline-success btn-add-setting" data-key="site_extra"><i class="fas fa-plus me-1"></i>추가</button>
        </div>
      </div>
    </div>
  </div>

  <div class="mb-4">
    <button type="button" class="btn btn-primary" id="btn-save-settings">
      <i class="fas fa-save me-1"></i> 저장
    </button>
    <span id="save-status" class="ms-2 small text-muted"></span>
  </div>
</div>

<script>
(function() {
  function collectSettings() {
    var out = { construction_time: [], drawing_manager: [], construction_workers: [], site_extra: [] };
    ['construction_time', 'drawing_manager', 'construction_workers', 'site_extra'].forEach(function(key) {
      var ul = document.getElementById('list-' + key);
      if (!ul) return;
      ul.querySelectorAll('input.setting-input').forEach(function(inp) {
        var v = inp.value.trim();
        if (v) out[key].push(v);
      });
    });
    return out;
  }

  document.querySelectorAll('.btn-add-setting').forEach(function(btn) {
    var key = btn.dataset.key;
    var ul = document.getElementById('list-' + key);
    if (!ul) return;
    btn.addEventListener('click', function() {
      var li = document.createElement('li');
      li.className = 'list-group-item d-flex gap-2 align-items-center px-0';
      li.innerHTML = '<input type="text" class="form-control form-control-sm setting-input" data-key="' + key + '" value="" placeholder="' + (key === 'construction_time' ? '예: 10:00' : (key === 'site_extra' ? '추가 주소' : key === 'drawing_manager' ? '도면담당자' : '시공자')) + '">' +
        '<button type="button" class="btn btn-sm btn-outline-danger btn-remove-setting" title="삭제">&times;</button>';
      ul.appendChild(li);
      li.querySelector('.btn-remove-setting').addEventListener('click', function() { li.remove(); });
    });
  });

  document.querySelectorAll('.btn-remove-setting').forEach(function(btn) {
    btn.addEventListener('click', function() { btn.closest('li').remove(); });
  });

  document.getElementById('btn-save-settings').addEventListener('click', function() {
    var payload = collectSettings();
    var status = document.getElementById('save-status');
    status.textContent = '저장 중...';
    fetch('/api/erp/shipment-settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(payload)
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data && data.success) {
        status.textContent = '저장되었습니다.';
        status.classList.remove('text-danger');
        status.classList.add('text-success');
      } else {
        status.textContent = data && data.error ? data.error : '저장 실패';
        status.classList.remove('text-success');
        status.classList.add('text-danger');
      }
    }).catch(function() {
      status.textContent = '오류가 발생했습니다.';
      status.classList.remove('text-success');
      status.classList.add('text-danger');
    });
  });
})();
</script>
{% endblock %}
