{% extends "layout.html" %}

{% block content %}
<style>
  /* AS 방문일이 정해진 주문 셀: 옅은 연분홍 파스텔 */
  .erp-as-visit-cell--set { background-color: #ffd6e0 !important; }
  .erp-as-visit-row--set { background-color: #ffd6e0 !important; }
</style>
<div class="erp-pro">
  <!-- Modern Header -->
  <header class="erp-pro-header">
    <h1 class="erp-pro-header__title">
      <i class="fas fa-wrench"></i>
      <span>AS 대시보드</span>
    </h1>
    <div class="erp-pro-header__actions">
      <a class="erp-pro-btn erp-pro-btn--secondary" href="{{ url_for('erp_dashboard.erp_dashboard') }}">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-md-inline">ERP</span>
      </a>
    </div>
  </header>
  {% set erp_sub_nav_active = 'as' %}
  {% include 'partials/erp_sub_nav.html' %}

  {% if not erp_beta_enabled %}
  <div class="erp-pro-alert erp-pro-alert--warning">
    <div class="erp-pro-alert__icon"><i class="fas fa-exclamation-triangle"></i></div>
    <div class="erp-pro-alert__content">
      <span>ERP Beta 기능이 비활성입니다. (환경변수 <code>ERP_BETA_ENABLED=true</code> 필요)</span>
    </div>
  </div>
  {% else %}
  <div class="erp-pro-card">
    <div class="erp-pro-card__header erp-pro-card__header--filter">
      <form class="erp-pro-filter-form erp-pro-filter-form--inline-mobile" method="get">
        <div class="erp-pro-filter-group">
          <label class="erp-pro-filter-label">AS 상태</label>
          <select class="erp-pro-select" name="status">
            <option value="">전체</option>
            <option value="AS_RECEIVED" {% if status_filter=='AS_RECEIVED' %}selected{% endif %}>AS 접수</option>
            <option value="AS_COMPLETED" {% if status_filter=='AS_COMPLETED' %}selected{% endif %}>AS 완료</option>
          </select>
        </div>
        <div class="erp-pro-filter-group">
          <label class="erp-pro-filter-label">담당자</label>
          <input type="text" class="erp-pro-input" name="manager" value="{{ manager_filter }}" placeholder="예: 정다슬">
        </div>
        <div class="erp-pro-filter-actions">
          <button class="erp-pro-btn erp-pro-btn--primary" type="submit">
            <i class="fas fa-search"></i>
            <span>조회</span>
          </button>
          {% if selected_date %}
          <a class="erp-pro-btn erp-pro-btn--secondary"
            href="/erp/as?date={{ selected_date }}&status={{ status_filter }}&manager={{ manager_filter | urlencode }}&open_map=1">
            <i class="fas fa-map"></i>
            <span class="d-none d-sm-inline">지도</span>
          </a>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="erp-pro-card__body">
      <!-- PC Table View -->
      <div class="erp-pro-table-wrapper d-none d-md-block">
        <table class="erp-pro-table">
          <thead>
            <tr>
              <th style="width: 90px;">주문</th>
              <th style="width: 120px;">AS 접수일</th>
              <th style="width: 150px;">AS 방문일</th>
              <th style="width: 120px;">AS 완료일</th>
              <th style="width: 120px;">담당자</th>
              <th style="width: 120px;">고객</th>
              <th style="width: 450px;">주소</th>
              <th style="width: 450px;">AS 내용</th>
              <th style="width: 100px;">상태</th>
            </tr>
          </thead>
          <tbody>
            {% if rows %}
            {% for r in rows %}
            <tr>
              <td>
                {% if can_edit_erp|default(false) %}
                <a href="{{ url_for('order_edit.edit_order', order_id=r.id) }}?open=erp-beta" class="erp-pro-link">#{{ r.id }}</a>
                {% else %}
                #{{ r.id }} <span class="text-muted small">(권한없음)</span>
                {% endif %}
              </td>
              <td>{{ r.as_received_date or '-' }}</td>
              <td class="{% if r.scheduled_date %}erp-as-visit-cell--set{% endif %}">
                <input type="date" class="erp-pro-input editable-date-as" value="{{ r.scheduled_date or '' }}"
                  data-order-id="{{ r.id }}" data-field="as_visit_date" style="width: 100%;">
              </td>
              <td>{{ r.as_completed_date or '-' }}</td>
              <td>{{ r.manager_name or '-' }}</td>
              <td>
                <span class="d-block">{{ (r.customer_name or '-') }}</span>
                <span class="d-block small text-muted">{{ r.phone|format_phone }}</span>
              </td>
              <td class="erp-pro-table__cell--wrap">
                <div class="d-flex justify-content-between align-items-start">
                  <span>{{ r.address or '-' }}</span>
                  {% if r.address %}
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-1 find-schedule-btn p-0 px-1" 
                          data-address="{{ r.address }}" 
                          title="주변 일정 찾기"
                          style="font-size: 0.75rem; line-height: 1.5;">
                    <i class="fas fa-map-marker-alt"></i> 일정
                  </button>
                  {% endif %}
                </div>
              </td>
              <td>
                <textarea class="erp-pro-input as-content-input" placeholder="내용 입력..." data-order-id="{{ r.id }}"
                  style="width: 100%; min-height: 40px; height: auto; padding-top: 8px; padding-bottom: 8px; resize: vertical;">{{ (r.structured_data.get('shipment', {}).get('as_content', '')) if r.structured_data else '' }}</textarea>
              </td>
              <td>
                <span
                  class="erp-pro-badge {% if r.status == 'AS_COMPLETED' %}erp-pro-badge--success{% else %}erp-pro-badge--info{% endif %}">
                  {{ STATUS.get(r.status, r.status) }}
                </span>
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">데이터가 없습니다.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="erp-pro-order-cards d-md-none">
        {% if rows %}
        {% for r in rows %}
        <div class="erp-pro-order-card">
          <div class="erp-pro-order-card__header">
            {% if can_edit_erp|default(false) %}
            <a href="{{ url_for('order_edit.edit_order', order_id=r.id) }}?open=erp-beta" class="erp-pro-order-card__id">#{{ r.id }}</a>
            {% else %}
            <span class="erp-pro-order-card__id">#{{ r.id }} <span class="text-muted small">(권한없음)</span></span>
            {% endif %}
            <span
              class="erp-pro-badge {% if r.status == 'AS_COMPLETED' %}erp-pro-badge--success{% else %}erp-pro-badge--info{% endif %}">
              {{ STATUS.get(r.status, r.status) }}
            </span>
          </div>
          <div class="erp-pro-order-card__body">
            <div class="erp-pro-order-card__row">
              <span class="erp-pro-order-card__label">고객</span>
              <div class="erp-pro-order-card__value">
                <span class="d-block">{{ (r.customer_name or '-') }}</span>
                <span class="d-block small text-muted">{{ r.phone|format_phone }}</span>
              </div>
            </div>
            <div class="erp-pro-order-card__row">
              <span class="erp-pro-order-card__label">담당자</span>
              <span class="erp-pro-order-card__value">{{ r.manager_name or '-' }}</span>
            </div>
            <div class="erp-pro-order-card__row">
              <span class="erp-pro-order-card__label">AS 접수</span>
              <span class="erp-pro-order-card__value">{{ r.as_received_date or '-' }}</span>
            </div>
            <div class="erp-pro-order-card__row {% if r.scheduled_date %}erp-as-visit-row--set{% endif %}">
              <span class="erp-pro-order-card__label">AS 방문일</span>
              <input type="date" class="erp-pro-input editable-date-as" value="{{ r.scheduled_date or '' }}"
                data-order-id="{{ r.id }}" data-field="as_visit_date">
            </div>
            <div class="erp-pro-order-card__row">
              <span class="erp-pro-order-card__label">AS 완료</span>
              <span class="erp-pro-order-card__value">{{ r.as_completed_date or '-' }}</span>
            </div>
            <div class="erp-pro-order-card__row erp-pro-order-card__row--full">
              <span class="erp-pro-order-card__label">주소</span>
              <div class="d-flex justify-content-between align-items-start w-100">
                <span class="erp-pro-order-card__value mb-1">{{ r.address or '-' }}</span>
                {% if r.address %}
                <button type="button" class="btn btn-sm btn-outline-secondary find-schedule-btn ms-2 p-0 px-2" 
                        data-address="{{ r.address }}" 
                        title="주변 일정 찾기"
                        style="font-size: 0.75rem; white-space: nowrap;">
                  <i class="fas fa-map-marker-alt"></i> 일정
                </button>
                {% endif %}
              </div>
            </div>
            <div class="erp-pro-order-card__row erp-pro-order-card__row--full">
              <span class="erp-pro-order-card__label">AS 내용</span>
              <textarea class="erp-pro-input as-content-input mt-1" placeholder="내용 입력..." data-order-id="{{ r.id }}"
                style="min-height: 80px; resize: vertical;">{{ (r.structured_data.get('shipment', {}).get('as_content', '')) if r.structured_data else '' }}</textarea>
            </div>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="erp-pro-empty">
          <i class="fas fa-inbox"></i>
          <p>데이터가 없습니다.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div><!-- end erp-pro -->

<!-- Toast 알림 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1060;">
  <div id="saveToast" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert"
    aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body d-flex align-items-center">
        <i class="fas fa-check-circle me-2"></i>
        <span id="toastMessage">변경사항이 저장되었습니다.</span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
        aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Schedule Search Modal -->
<div class="modal fade" id="scheduleSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-map-marked-alt"></i> 가까운 일정 찾기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-light border mb-3">
          <small class="text-muted d-block mb-1">기준 주소</small>
          <strong id="scheduleSearchAddr" class="text-dark"></strong>
        </div>
        <div class="list-group" id="scheduleSearchResults">
          <!-- Results -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toastEl = document.getElementById('saveToast');
    const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
    const toastMsg = document.getElementById('toastMessage');

    // 일정 찾기 버튼 핸들러
    document.body.addEventListener('click', async function(e) {
      const btn = e.target.closest('.find-schedule-btn');
      if (!btn) return;

      const addr = btn.dataset.address;
      const addrEl = document.getElementById('scheduleSearchAddr');
      
      // 방어 코드: 요소가 없는 경우 (캐시 등 문제)
      if (!addrEl) {
        alert('화면 업데이트가 필요합니다. 페이지를 새로고침(F5) 해주세요.');
        location.reload();
        return;
      }

      addrEl.textContent = addr;
      const resList = document.getElementById('scheduleSearchResults');
      if (resList) {
        resList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2 text-muted small">주변 일정을 검색 중입니다...</div></div>';
      }
      
      const modalEl = document.getElementById('scheduleSearchModal');
      if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      } else {
        alert('오류: 모달창을 찾을 수 없습니다.');
        return;
      }

      try {
        const res = await fetch(`/api/orders/nearby?address=${encodeURIComponent(addr)}`);
        const data = await res.json();
        
        if (resList) {
            resList.innerHTML = '';
            
            if(!data.success || !data.results || data.results.length === 0) {
              resList.innerHTML = `
                <div class="text-center py-5 text-muted">
                  <i class="fas fa-calendar-times mb-2" style="font-size: 2rem;"></i>
                  <p>근처에 예정된 출고/시공 일정이 없습니다.</p>
                </div>`;
              return;
            }

            data.results.forEach(item => {
              const el = document.createElement('a');
              el.className = 'list-group-item list-group-item-action p-3';
              el.href = `/edit/${item.id}?open=erp-beta`; 
              
              let badgeClass = 'bg-secondary';
              if (item.type === '상차') badgeClass = 'bg-warning text-dark';
              else if (item.type === '시공') badgeClass = 'bg-success';

              // 날짜 포맷팅 (YYYY-MM-DD -> M월 D일)
              let dateDisplay = item.date;
              const dateMatch = item.date && item.date.match(/^(\d{4})-(\d{2})-(\d{2})$/);
              if (dateMatch) {
                  dateDisplay = `${parseInt(dateMatch[2])}월 ${parseInt(dateMatch[3])}일`;
              }

              el.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                  <div>
                    <span class="badge ${badgeClass} me-2">${item.type}</span>
                    <span class="fw-bold">${dateDisplay}</span>
                    <span class="mx-2 text-muted">|</span>
                    <span class="fw-semibold">${item.customer_name}</span>
                  </div>
                  <small class="text-muted">#${item.id}</small>
                </div>
                <p class="mb-1 text-dark">
                    <i class="fas fa-map-marker-alt text-danger me-1"></i> ${item.address}
                    ${item.score_text ? `<span class="badge bg-light text-dark border ms-2"><i class="fas fa-car-side me-1"></i>${item.score_text}</span>` : ''}
                </p>
                <div class="d-flex justify-content-between align-items-end mt-1">
                  <small class="text-muted">상태: ${item.status}</small>
                  <small class="text-primary fw-bold"><i class="fas fa-external-link-alt"></i> 바로가기</small>
                </div>
              `;
              resList.appendChild(el);
            });
        }
      } catch(err) {
        console.error(err);
        if (resList) resList.innerHTML = '<div class="text-center py-3 text-danger">오류가 발생했습니다.</div>';
      }
    });

    function showFeedback(msg, isError = false) {
      toastMsg.textContent = msg;
      toastEl.classList.remove('bg-success', 'bg-danger');
      toastEl.classList.add(isError ? 'bg-danger' : 'bg-success');
      toast.show();
    }

    // AS 방문일 자동 저장
    document.querySelectorAll('.editable-date-as').forEach(input => {
      input.addEventListener('change', function () {
        const orderId = this.dataset.orderId;
        const field = this.dataset.field;
        const value = this.value;

        this.style.backgroundColor = '#fff3cd';

        fetch('/api/update_order_field', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            order_id: orderId,
            field_name: field,
            new_value: value
          })
        })
          .then(res => res.json())
          .then(data => {
            this.style.backgroundColor = '';
            if (data.success) {
              const cell = this.closest('td');
              const cardRow = this.closest('.erp-pro-order-card__row');
              if (value) {
                if (cell) cell.classList.add('erp-as-visit-cell--set');
                if (cardRow) cardRow.classList.add('erp-as-visit-row--set');
              } else {
                if (cell) cell.classList.remove('erp-as-visit-cell--set');
                if (cardRow) cardRow.classList.remove('erp-as-visit-row--set');
              }
              showFeedback('방문일이 저장되었습니다.');
            } else {
              showFeedback('저장 실패: ' + data.message, true);
            }
          })
          .catch(err => {
            this.style.backgroundColor = '';
            showFeedback('네트워크 오류가 발생했습니다.', true);
          });
      });
    });

    // AS 내용 자동 저장 (Blur 시)
    document.querySelectorAll('.as-content-input').forEach(input => {
      let originalValue = input.value;

      input.addEventListener('blur', function () {
        if (this.value === originalValue) return;

        const orderId = this.dataset.orderId;
        const value = this.value.trim();

        this.style.backgroundColor = '#fff3cd';

        fetch('/api/update_order_field', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            order_id: orderId,
            field_name: 'as_content',
            new_value: value
          })
        })
          .then(res => res.json())
          .then(data => {
            this.style.backgroundColor = '';
            if (data.success) {
              originalValue = value;
              showFeedback('AS 내용이 저장되었습니다.');
            } else {
              showFeedback('저장 실패: ' + data.message, true);
            }
          })
          .catch(err => {
            this.style.backgroundColor = '';
            showFeedback('네트워크 오류가 발생했습니다.', true);
          });
      });

      input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey && this.tagName !== 'TEXTAREA') this.blur();
      });

      // Textarea 자동 높이 조절 (선택 사항)
      if (input.tagName === 'TEXTAREA') {
        input.style.overflow = 'hidden';
        input.addEventListener('input', function () {
          this.style.height = 'auto';
          this.style.height = (this.scrollHeight) + 'px';
        });
        // 초기 높이 설정
        input.style.height = 'auto';
        input.style.height = (input.scrollHeight) + 'px';
      }
    });
  });
</script>
{% endblock %}