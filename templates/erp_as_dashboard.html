{% extends "layout.html" %}

{% block content %}
<div class="erp-pro">
  <!-- Modern Header -->
  <header class="erp-pro-header">
    <h1 class="erp-pro-header__title">
      <i class="fas fa-wrench"></i>
      <span>AS 대시보드</span>
    </h1>
    <div class="erp-pro-header__actions">
      <a class="erp-pro-btn erp-pro-btn--secondary" href="{{ url_for('erp_dashboard') }}">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-md-inline">ERP</span>
      </a>
    </div>
  </header>
  {% set erp_sub_nav_active = 'as' %}
  {% include 'partials/erp_sub_nav.html' %}

  {% if not erp_beta_enabled %}
  <div class="erp-pro-alert erp-pro-alert--warning">
    <div class="erp-pro-alert__icon"><i class="fas fa-exclamation-triangle"></i></div>
    <div class="erp-pro-alert__content">
      <span>ERP Beta 기능이 비활성입니다. (환경변수 <code>ERP_BETA_ENABLED=true</code> 필요)</span>
    </div>
  </div>
  {% else %}
  <div class="erp-pro-card">
    <div class="erp-pro-card__header erp-pro-card__header--filter">
      <form class="erp-pro-filter-form erp-pro-filter-form--inline-mobile" method="get">
        <div class="erp-pro-filter-group">
          <label class="erp-pro-filter-label">AS 상태</label>
          <select class="erp-pro-select" name="status">
            <option value="">전체</option>
            <option value="AS_RECEIVED" {% if status_filter == 'AS_RECEIVED' %}selected{% endif %}>AS 접수</option>
            <option value="AS_COMPLETED" {% if status_filter == 'AS_COMPLETED' %}selected{% endif %}>AS 완료</option>
          </select>
        </div>
        <div class="erp-pro-filter-group">
          <label class="erp-pro-filter-label">담당자</label>
          <input type="text" class="erp-pro-input" name="manager" value="{{ manager_filter }}" placeholder="예: 정다슬">
        </div>
        <div class="erp-pro-filter-actions">
          <button class="erp-pro-btn erp-pro-btn--primary" type="submit">
            <i class="fas fa-search"></i>
            <span>조회</span>
          </button>
          {% if selected_date %}
          <a class="erp-pro-btn erp-pro-btn--secondary" href="/erp/as?date={{ selected_date }}&status={{ status_filter }}&manager={{ manager_filter | urlencode }}&open_map=1">
            <i class="fas fa-map"></i>
            <span class="d-none d-sm-inline">지도</span>
          </a>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="erp-pro-card__body">
      <!-- PC Table View -->
      <div class="erp-pro-table-wrapper d-none d-md-block">
        <table class="erp-pro-table">
          <thead>
            <tr>
              <th style="width: 90px;">주문</th>
              <th style="width: 120px;">AS 접수일</th>
              <th style="width: 120px;">AS 완료일</th>
              <th style="width: 120px;">담당자</th>
              <th style="width: 120px;">고객</th>
              <th>주소</th>
              <th style="width: 120px;">상태</th>
            </tr>
          </thead>
          <tbody>
          {% if rows %}
            {% for r in rows %}
            <tr>
              <td><a href="{{ url_for('edit_order', order_id=r.id) }}" class="erp-pro-link">#{{ r.id }}</a></td>
              <td>{{ r.as_received_date or '-' }}</td>
              <td>{{ r.as_completed_date or '-' }}</td>
              <td>{{ r.manager_name or '-' }}</td>
              <td>{{ r.customer_name or '-' }}</td>
              <td class="erp-pro-table__cell--wrap">{{ r.address or '-' }}</td>
              <td>
                <span class="erp-pro-badge {% if r.status == 'AS_COMPLETED' %}erp-pro-badge--success{% else %}erp-pro-badge--info{% endif %}">
                  {{ STATUS.get(r.status, r.status) }}
                </span>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-center text-muted py-4">데이터가 없습니다.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
      
      <!-- Mobile Card View -->
      <div class="erp-pro-order-cards d-md-none">
        {% if rows %}
          {% for r in rows %}
          <div class="erp-pro-order-card">
            <div class="erp-pro-order-card__header">
              <a href="{{ url_for('edit_order', order_id=r.id) }}" class="erp-pro-order-card__id">#{{ r.id }}</a>
              <span class="erp-pro-badge {% if r.status == 'AS_COMPLETED' %}erp-pro-badge--success{% else %}erp-pro-badge--info{% endif %}">
                {{ STATUS.get(r.status, r.status) }}
              </span>
            </div>
            <div class="erp-pro-order-card__body">
              <div class="erp-pro-order-card__row">
                <span class="erp-pro-order-card__label">고객</span>
                <span class="erp-pro-order-card__value">{{ r.customer_name or '-' }}</span>
              </div>
              <div class="erp-pro-order-card__row">
                <span class="erp-pro-order-card__label">담당자</span>
                <span class="erp-pro-order-card__value">{{ r.manager_name or '-' }}</span>
              </div>
              <div class="erp-pro-order-card__row">
                <span class="erp-pro-order-card__label">AS 접수</span>
                <span class="erp-pro-order-card__value">{{ r.as_received_date or '-' }}</span>
              </div>
              <div class="erp-pro-order-card__row">
                <span class="erp-pro-order-card__label">AS 완료</span>
                <span class="erp-pro-order-card__value">{{ r.as_completed_date or '-' }}</span>
              </div>
              <div class="erp-pro-order-card__row erp-pro-order-card__row--full">
                <span class="erp-pro-order-card__label">주소</span>
                <span class="erp-pro-order-card__value">{{ r.address or '-' }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="erp-pro-empty">
            <i class="fas fa-inbox"></i>
            <p>데이터가 없습니다.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div><!-- end erp-pro -->
{% endblock %}

