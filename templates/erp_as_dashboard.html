{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <span class="mb-1 fw-bold text-dark fs-6"><i class="fas fa-wrench text-primary"></i> ERP AS 대시보드</span>
    <div class="text-muted small"></div>
  </div>
</div>
{% set erp_sub_nav_active = 'as' %}
{% include 'partials/erp_sub_nav.html' %}

{% if not erp_beta_enabled %}
  <div class="alert alert-secondary">
    ERP Beta 기능이 비활성입니다. (환경변수 <code>ERP_BETA_ENABLED=true</code> 필요)
  </div>
{% else %}
  <div class="card">
    <div class="card-header bg-white">
      <form class="row g-2 align-items-end" method="get">
        <div class="col-md-3">
          <label class="form-label mb-1">AS 상태</label>
          <select class="form-select" name="status">
            <option value="">전체</option>
            <option value="AS_RECEIVED" {% if status_filter == 'AS_RECEIVED' %}selected{% endif %}>AS 접수</option>
            <option value="AS_COMPLETED" {% if status_filter == 'AS_COMPLETED' %}selected{% endif %}>AS 완료</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">담당자(부분 일치)</label>
          <input type="text" class="form-control" name="manager" value="{{ manager_filter }}" placeholder="예: 정다슬">
        </div>
        <div class="col-md-6 d-flex gap-2">
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-search"></i> 조회
          </button>
          {% if selected_date %}
          <a class="btn btn-outline-secondary" href="/erp/as?date={{ selected_date }}&status={{ status_filter }}&manager={{ manager_filter | urlencode }}&open_map=1">
            <i class="fas fa-map-marked-alt"></i> 지도 보기
          </a>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 90px;">주문</th>
              <th style="width: 120px;">AS 접수일</th>
              <th style="width: 120px;">AS 완료일</th>
              <th style="width: 120px;">담당자</th>
              <th style="width: 120px;">고객</th>
              <th>주소</th>
              <th style="width: 120px;">상태</th>
            </tr>
          </thead>
          <tbody>
          {% if rows %}
            {% for r in rows %}
              <tr>
                <td><a href="{{ url_for('edit_order', order_id=r.id) }}">#{{ r.id }}</a></td>
                <td>{{ r.as_received_date or '-' }}</td>
                <td>{{ r.as_completed_date or '-' }}</td>
                <td>{{ r.manager_name or '-' }}</td>
                <td>{{ r.customer_name or '-' }}</td>
                <td style="white-space: normal; word-break: break-word;">{{ r.address or '-' }}</td>
                <td>{{ STATUS.get(r.status, r.status) }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-center text-muted py-4">데이터가 없습니다.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

