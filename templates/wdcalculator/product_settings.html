{% extends "layout.html" %}

{% block title %}제품 설정 - 가구 견적 계산기{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* 참조 파일 스타일 반영 */
    .card-header button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-header button.active {
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .header-primary {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);
        color: white;
    }
    
    .border-left-primary {
        border-left: 4px solid #0dcaf0;
    }
    
    .product-row {
        background-color: rgba(13, 202, 240, 0.03) !important;
        border-left: 3px solid #0dcaf0;
    }
    
    .product-row:hover {
        background-color: rgba(13, 202, 240, 0.08) !important;
    }
    
    .price-input-group {
        display: none;
    }
    
    .price-input-group.show {
        display: block;
    }
    
    .additional-option-item {
        background-color: #f8f9fa;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    /* 작업 버튼 스타일 */
    .d-flex.gap-1 {
        gap: 0.25rem;
    }
    
    .d-flex.gap-1 .btn {
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    /* 테이블 작업 컬럼 스타일 */
    table th:last-child,
    table td:last-child {
        min-width: 180px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-cog text-info"></i> 제품 설정</h1>
        <div>
            <a href="{{ url_for('wdcalculator') }}" class="btn btn-info">
                <i class="fas fa-calculator"></i> 견적 계산기
            </a>
        </div>
    </div>

    <!-- 제품 추가 폼 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-primary">
                <div class="card-header py-3 header-primary">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-plus-circle me-2"></i>제품 추가
                    </h6>
                </div>
                <div class="card-body">
                    <form id="productForm">
                        <input type="hidden" id="productId" name="id" value="">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">제품명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="pricingType" class="form-label">가격 산정 옵션 <span class="text-danger">*</span></label>
                                <select class="form-select" id="pricingType" name="pricing_type" required>
                                    <option value="">선택하세요</option>
                                    <option value="1m">1m</option>
                                    <option value="30cm">30cm</option>
                                </select>
                            </div>
                        </div>

                        <!-- 1m 옵션 가격 입력 -->
                        <div class="row mb-3 price-input-group" id="price1mGroup">
                            <div class="col-md-6">
                                <label for="price1m" class="form-label">1m 비용 (원) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="price1m" name="price_1m" min="0" step="1">
                            </div>
                        </div>

                        <!-- 30cm 옵션 가격 입력 -->
                        <div class="row mb-3 price-input-group" id="price30cmGroup">
                            <div class="col-md-6">
                                <label for="price30cm" class="form-label">30cm 비용 (원) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="price30cm" name="price_30cm" min="0" step="1">
                            </div>
                            <div class="col-md-6">
                                <label for="price1cm" class="form-label">1cm 비용 (원) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="price1cm" name="price_1cm" min="0" step="1">
                            </div>
                        </div>

                        <!-- 쿠폰가 설정 -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="couponType" class="form-label">쿠폰가 타입</label>
                                <select class="form-select" id="couponType" name="coupon_type">
                                    <option value="percentage">할인율 (%)</option>
                                    <option value="fixed">고정 금액 (원)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="couponValue" class="form-label">쿠폰가 값</label>
                                <input type="number" class="form-control" id="couponValue" name="coupon_value" min="0" step="0.1" value="0">
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 저장
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetFormBtn">
                                <i class="fas fa-redo"></i> 초기화
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 제품 목록 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow border-left-primary">
                <div class="card-header py-3 header-primary">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-list me-2"></i>제품 목록 ({{ products|length }}개)
                    </h6>
                </div>
                <div class="card-body">
                    {% if products %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th>제품명</th>
                                    <th>가격 옵션</th>
                                    <th>비용 정보</th>
                                    <th>쿠폰가</th>
                                    <th style="width: 180px;">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr class="product-row" data-product-id="{{ product.id }}">
                                    <td>{{ product.id }}</td>
                                    <td><strong>{{ product.name }}</strong></td>
                                    <td>
                                        {% if product.pricing_type == '1m' %}
                                            <span class="badge bg-info">1m</span>
                                        {% else %}
                                            <span class="badge bg-warning">30cm</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if product.pricing_type == '1m' %}
                                            1m: {{ "{:,}".format(product.price_1m) }}원
                                        {% else %}
                                            30cm: {{ "{:,}".format(product.price_30cm) }}원<br>
                                            1cm: {{ "{:,}".format(product.price_1cm) }}원
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if product.coupon_type == 'percentage' %}
                                            {{ product.coupon_value }}%
                                        {% elif product.coupon_type == 'fixed' %}
                                            {{ "{:,}".format(product.coupon_value) }}원
                                        {% else %}
                                            <span class="text-muted">없음</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-primary edit-product-btn" data-product-id="{{ product.id }}" title="수정">
                                                <i class="fas fa-edit"></i> 수정
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-product-btn" data-product-id="{{ product.id }}" title="삭제">
                                                <i class="fas fa-trash"></i> 삭제
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-box-open text-muted fa-3x mb-3"></i>
                        <h5 class="text-muted">등록된 제품이 없습니다.</h5>
                        <p class="text-muted">위 폼을 사용하여 제품을 추가해주세요.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 구분선 -->
    <hr class="my-5" style="border-top: 3px solid #0dcaf0;">

    <!-- 추가 옵션 관리 섹션 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow" style="border-left: 4px solid #198754;">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #198754 0%, #157347 100%); color: white;">
                    <h5 class="m-0 font-weight-bold">
                        <i class="fas fa-list-ul me-2"></i>추가 옵션 관리
                        <small class="ms-2">({{ categories|length }}개 카테고리)</small>
                    </h5>
                    <small class="d-block mt-1 opacity-75">
                        <i class="fas fa-info-circle"></i> 추가 옵션은 견적 계산 시 독립적으로 선택할 수 있습니다.
                    </small>
                </div>
                <div class="card-body">
                    <!-- 추가 옵션 추가 폼 (제품 추가 폼과 동일한 구조) -->
                    <form id="additionalOptionForm">
                        <input type="hidden" id="additionalOptionId" name="id" value="">
                        <input type="hidden" id="additionalOptionCategoryId" name="category_id" value="">
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="additionalOptionCategoryName" class="form-label">카테고리명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="additionalOptionCategoryName" name="category_name" required placeholder="예: 화장대, EP마감">
                                <small class="form-text text-muted">대분류 카테고리명을 입력하세요</small>
                            </div>
                            <div class="col-md-4">
                                <label for="additionalOptionName" class="form-label">옵션명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="additionalOptionName" name="option_name" required placeholder="예: 화장대A, EP마감-흰색">
                                <small class="form-text text-muted">세부 옵션명을 입력하세요</small>
                            </div>
                            <div class="col-md-4">
                                <label for="additionalOptionPrice" class="form-label">가격 (원) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="additionalOptionPrice" name="option_price" min="0" step="1" required placeholder="가격을 입력하세요">
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> 저장
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetAdditionalOptionFormBtn">
                                <i class="fas fa-redo"></i> 초기화
                            </button>
                        </div>
                    </form>

                    <!-- 추가 옵션 목록 -->
                    <div class="mt-4">
                        <h6 class="mb-3">추가 옵션 목록</h6>
                        {% if categories %}
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px;">ID</th>
                                        <th>카테고리명</th>
                                        <th>옵션명</th>
                                        <th>가격</th>
                                        <th style="width: 180px;">작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                        {% for category in categories %}
                                        {% if category.options %}
                                        {% for option in category.options %}
                                        {% if option.id %}
                                        <tr data-category-id="{{ category.id }}" data-option-id="{{ option.id }}">
                                            <td>{{ option.id }}</td>
                                            <td><strong>{{ category.name }}</strong></td>
                                            <td>{{ option.name }}</td>
                                            <td>{{ "{:,}".format(option.price|int) }}원</td>
                                            <td>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-outline-primary edit-additional-option-btn" data-category-id="{{ category.id }}" data-option-id="{{ option.id }}" data-category-name="{{ category.name }}" title="수정">
                                                        <i class="fas fa-edit"></i> 수정
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger delete-additional-option-btn" data-category-id="{{ category.id }}" data-option-id="{{ option.id }}" title="삭제">
                                                        <i class="fas fa-trash"></i> 삭제
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                        {% endif %}
                                        {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-folder-open text-muted fa-3x mb-3"></i>
                            <h5 class="text-muted">등록된 추가 옵션이 없습니다.</h5>
                            <p class="text-muted">위 폼을 사용하여 추가 옵션을 추가해주세요.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast 컨테이너 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="status-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const products = {{ products|tojson }};
    let editingProductId = null;
    
    const toastElement = document.getElementById('status-toast');
    const toastBody = toastElement.querySelector('.toast-body');
    const toast = new bootstrap.Toast(toastElement);
    
    function showToast(message, isSuccess = true) {
        toastBody.textContent = message;
        toastElement.classList.remove('bg-danger', 'bg-success', 'text-white');
        if (isSuccess) {
            toastElement.classList.add('bg-success', 'text-white');
        } else {
            toastElement.classList.add('bg-danger', 'text-white');
        }
        toast.show();
    }
    
    // 가격 옵션 선택에 따른 입력 필드 표시/숨김
    document.getElementById('pricingType').addEventListener('change', function() {
        const pricingType = this.value;
        document.getElementById('price1mGroup').classList.remove('show');
        document.getElementById('price30cmGroup').classList.remove('show');
        
        if (pricingType === '1m') {
            document.getElementById('price1mGroup').classList.add('show');
            document.getElementById('price1m').required = true;
            document.getElementById('price30cm').required = false;
            document.getElementById('price1cm').required = false;
        } else if (pricingType === '30cm') {
            document.getElementById('price30cmGroup').classList.add('show');
            document.getElementById('price1m').required = false;
            document.getElementById('price30cm').required = true;
            document.getElementById('price1cm').required = true;
        } else {
            document.getElementById('price1m').required = false;
            document.getElementById('price30cm').required = false;
            document.getElementById('price1cm').required = false;
        }
    });
    
    // 폼 제출
    document.getElementById('productForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            id: editingProductId || null,
            name: document.getElementById('productName').value,
            pricing_type: document.getElementById('pricingType').value,
            additional_options: [],  // 추가 옵션은 더 이상 제품에 연결되지 않음
            coupon_type: document.getElementById('couponType').value,
            coupon_value: parseFloat(document.getElementById('couponValue').value) || 0
        };
        
        // 가격 정보 추가
        if (formData.pricing_type === '1m') {
            formData.price_1m = parseInt(document.getElementById('price1m').value) || 0;
        } else if (formData.pricing_type === '30cm') {
            formData.price_30cm = parseInt(document.getElementById('price30cm').value) || 0;
            formData.price_1cm = parseInt(document.getElementById('price1cm').value) || 0;
        }
        
        // API 호출
        fetch('/api/wdcalculator/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, true);
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast(data.message, false);
            }
        })
        .catch(error => {
            showToast('서버 통신 중 오류가 발생했습니다.', false);
        });
    });
    
    // 폼 초기화
    document.getElementById('resetFormBtn').addEventListener('click', function() {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        editingProductId = null;
        document.getElementById('price1mGroup').classList.remove('show');
        document.getElementById('price30cmGroup').classList.remove('show');
    });
    
    // 제품 수정
    document.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.dataset.productId);
            const product = products.find(p => p.id === productId);
            
            if (product) {
                editingProductId = productId;
                document.getElementById('productId').value = productId;
                document.getElementById('productName').value = product.name;
                document.getElementById('pricingType').value = product.pricing_type;
                document.getElementById('pricingType').dispatchEvent(new Event('change'));
                
                if (product.pricing_type === '1m') {
                    document.getElementById('price1m').value = product.price_1m || 0;
                } else if (product.pricing_type === '30cm') {
                    document.getElementById('price30cm').value = product.price_30cm || 0;
                    document.getElementById('price1cm').value = product.price_1cm || 0;
                }
                
                document.getElementById('couponType').value = product.coupon_type || 'percentage';
                document.getElementById('couponValue').value = product.coupon_value || 0;
                
                // 스크롤 to form
                document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
    
    // 제품 삭제
    document.querySelectorAll('.delete-product-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productIdStr = this.dataset.productId;
            const productRow = this.closest('tr');
            const productName = productRow ? productRow.querySelector('td:nth-child(2) strong')?.textContent || '이 제품' : '이 제품';
            
            if (!confirm(`정말 "${productName}" 제품을 삭제하시겠습니까?\n삭제된 제품은 복구할 수 없습니다.`)) {
                return;
            }
            
            if (!productIdStr || productIdStr === 'None') {
                showToast('제품 정보를 불러올 수 없습니다. 페이지를 새로고침해주세요.', false);
                return;
            }
            
            const productId = parseInt(productIdStr);
            
            if (isNaN(productId)) {
                showToast('제품 정보가 올바르지 않습니다.', false);
                return;
            }
            
            // 삭제 중 표시
            const deleteBtn = this;
            const originalHtml = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 삭제 중...';
            
            fetch(`/api/wdcalculator/products/${productId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message || '제품이 삭제되었습니다.', true);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || '제품 삭제에 실패했습니다.', false);
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                showToast('서버 통신 중 오류가 발생했습니다.', false);
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHtml;
            });
        });
    });

    // ==================== 추가 옵션 관리 ====================
    const categories = {{ (categories|default([]))|tojson|safe }};
    let editingAdditionalOptionId = null;
    let editingAdditionalOptionCategoryId = null;

    // 추가 옵션 폼 제출
    document.getElementById('additionalOptionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const categoryName = document.getElementById('additionalOptionCategoryName').value.trim();
        const optionName = document.getElementById('additionalOptionName').value.trim();
        const optionPrice = parseInt(document.getElementById('additionalOptionPrice').value) || 0;
        
        if (!categoryName || !optionName || optionPrice <= 0) {
            showToast('모든 필드를 올바르게 입력해주세요.', false);
            return;
        }
        
        // 카테고리 찾기 또는 생성
        let category = categories.find(c => c.name === categoryName);
        let categoryId = editingAdditionalOptionCategoryId;
        
        // 수정 모드가 아니면 카테고리명으로 검색
        if (!categoryId && category) {
            categoryId = category.id;
        }
        
        // 카테고리를 찾지 못했으면 새로 생성
        if (!categoryId && !category) {
            categoryId = null; // 새로 생성할 카테고리
        }
        
        // 옵션 데이터 준비
        const optionData = {
            id: editingAdditionalOptionId || null,
            name: optionName,
            price: optionPrice
        };
        
        // 카테고리가 있으면 옵션만 추가/수정, 없으면 카테고리와 옵션 함께 생성
        if (categoryId) {
            // 기존 카테고리에 옵션 추가/수정
            fetch(`/api/wdcalculator/additional-options/categories/${categoryId}/options`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(optionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, true);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message, false);
                }
            })
            .catch(error => {
                showToast('서버 통신 중 오류가 발생했습니다.', false);
            });
        } else {
            // 새 카테고리와 옵션 함께 생성
            const categoryData = {
                name: categoryName,
                options: [optionData]
            };
            
            fetch('/api/wdcalculator/additional-options/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(categoryData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, true);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message, false);
                }
            })
            .catch(error => {
                showToast('서버 통신 중 오류가 발생했습니다.', false);
            });
        }
    });

    // 추가 옵션 폼 초기화
    document.getElementById('resetAdditionalOptionFormBtn').addEventListener('click', function() {
        document.getElementById('additionalOptionForm').reset();
        document.getElementById('additionalOptionId').value = '';
        document.getElementById('additionalOptionCategoryId').value = '';
        editingAdditionalOptionId = null;
        editingAdditionalOptionCategoryId = null;
    });

    // 추가 옵션 수정
    document.querySelectorAll('.edit-additional-option-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const categoryIdStr = this.dataset.categoryId;
            const optionIdStr = this.dataset.optionId;
            const categoryName = this.dataset.categoryName;
            
            // None 값 처리
            if (!categoryIdStr || categoryIdStr === 'None' || !optionIdStr || optionIdStr === 'None') {
                showToast('옵션 정보를 불러올 수 없습니다. 페이지를 새로고침해주세요.', false);
                return;
            }
            
            const categoryId = parseInt(categoryIdStr);
            const optionId = parseInt(optionIdStr);
            
            if (isNaN(categoryId) || isNaN(optionId)) {
                showToast('옵션 정보가 올바르지 않습니다.', false);
                return;
            }
            
            const category = categories.find(c => c && c.id === categoryId);
            
            if (!category) {
                showToast('카테고리를 찾을 수 없습니다.', false);
                return;
            }
            
            if (!category.options || !Array.isArray(category.options)) {
                showToast('옵션 목록을 찾을 수 없습니다.', false);
                return;
            }
            
            const option = category.options.find(o => o && o.id === optionId);
            
            if (!option) {
                showToast('옵션을 찾을 수 없습니다.', false);
                return;
            }
            
            // 폼에 값 설정
            editingAdditionalOptionId = optionId;
            editingAdditionalOptionCategoryId = categoryId;
            
            document.getElementById('additionalOptionId').value = optionId;
            document.getElementById('additionalOptionCategoryId').value = categoryId;
            document.getElementById('additionalOptionCategoryName').value = categoryName || category.name;
            document.getElementById('additionalOptionName').value = option.name || '';
            document.getElementById('additionalOptionPrice').value = option.price || 0;
            
            // 폼으로 스크롤
            document.getElementById('additionalOptionForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    // 추가 옵션 삭제
    document.querySelectorAll('.delete-additional-option-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const categoryIdStr = this.dataset.categoryId;
            const optionIdStr = this.dataset.optionId;
            
            // None 값 처리
            if (!categoryIdStr || categoryIdStr === 'None' || !optionIdStr || optionIdStr === 'None') {
                showToast('옵션 정보를 불러올 수 없습니다. 페이지를 새로고침해주세요.', false);
                return;
            }
            
            const categoryId = parseInt(categoryIdStr);
            const optionId = parseInt(optionIdStr);
            
            if (isNaN(categoryId) || isNaN(optionId)) {
                showToast('옵션 정보가 올바르지 않습니다.', false);
                return;
            }
            
            // 옵션 정보 가져오기
            const optionRow = this.closest('tr');
            const categoryName = optionRow ? optionRow.querySelector('td:nth-child(2) strong')?.textContent || '' : '';
            const optionName = optionRow ? optionRow.querySelector('td:nth-child(3)')?.textContent || '' : '';
            
            const confirmMessage = categoryName && optionName 
                ? `정말 "${categoryName} > ${optionName}" 옵션을 삭제하시겠습니까?\n삭제된 옵션은 복구할 수 없습니다.`
                : '정말 이 옵션을 삭제하시겠습니까?\n삭제된 옵션은 복구할 수 없습니다.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // 삭제 중 표시
            const deleteBtn = this;
            const originalHtml = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 삭제 중...';
            
            fetch(`/api/wdcalculator/additional-options/categories/${categoryId}/options/${optionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message || '옵션이 삭제되었습니다.', true);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || '옵션 삭제에 실패했습니다.', false);
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                showToast('서버 통신 중 오류가 발생했습니다.', false);
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHtml;
            });
        });
    });
});
</script>
{% endblock %}

