{% extends "layout.html" %}

{% block title %}가구 견적 계산기{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* 참조 파일 스타일 반영 */
    .card-header button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-header button.active {
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .header-primary {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);
        color: white;
    }
    
    .header-success {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
        color: white;
    }
    
    .border-left-primary {
        border-left: 4px solid #0dcaf0;
    }
    
    .border-left-success {
        border-left: 4px solid #198754;
    }
    
    .estimate-card {
        background-color: rgba(13, 202, 240, 0.03) !important;
        border-left: 3px solid #0dcaf0;
    }
    
    .additional-option-item {
        background-color: #f8f9fa;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    /* 추가 옵션 행: 모든 컨트롤 높이를 동일하게 강제하여 하단 정렬 맞춤 */
    .additional-option-item select.form-select-sm,
    .additional-option-item input.form-control-sm,
    .additional-option-item button.btn-sm {
        height: 38px !important;
        min-height: 38px !important;
        max-height: 38px !important;
        padding: 0.375rem 0.5rem !important;
        font-size: 0.95rem !important;
        line-height: 1.25 !important;
        box-sizing: border-box !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: flex-start !important;
        vertical-align: middle !important;
    }
    
    /* 버튼 정렬 보조 */
    .additional-option-item [data-toggle-direct-input] {
        margin: 0 !important;
    }
    .additional-option-item .remove-option-btn {
        justify-content: center !important;
        white-space: nowrap !important;
    }
    
    /* 행과 내부 컨테이너를 모두 가운데 정렬 */
    .additional-option-item .row {
        align-items: center !important;
        margin-left: 0;
        margin-right: 0;
    }
    .additional-option-item .d-flex.gap-2 {
        align-items: center !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }
    
    /* 직접 입력 텍스트 박스를 드롭다운과 같은 위치에 배치하여 가격 입력 필드와 하단 라인 맞춤 */
    .additional-option-item .option-name-input {
        height: 38px !important;
        min-height: 38px !important;
        max-height: 38px !important;
        padding: 0.375rem 0.5rem !important;
        font-size: 0.95rem !important;
        line-height: 1.25 !important;
        box-sizing: border-box !important;
        vertical-align: middle !important;
    }
    
    /* label 높이 통일 */
    .additional-option-item .form-label.small {
        height: 20px;
        line-height: 20px;
        margin-bottom: 0.25rem;
        display: block;
    }
    
    /* 가격 박스 너비 20% 증가 (col-md-2에서 col-md-3로 변경하여 16.67% → 25%) */
    .additional-option-item .price-col {
        flex: 0 0 20% !important;
        max-width: 20% !important;
    }
    
    /* 수량 박스 너비 30% 증가 (col-md-1에서 col-md-2로 변경하여 8.33% → 16.67%) */
    .additional-option-item .quantity-col {
        flex: 0 0 13% !important;
        max-width: 13% !important;
    }
    
    
    .price-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: #198754;
    }
    
    .final-price-display {
        font-size: 2.4rem !important;
        font-weight: 900 !important; /* 더 강한 볼드 */
        color: #0d6efd !important; /* 더 진한 파란색, 우선순위 상승 */
        line-height: 1.1 !important;
        letter-spacing: -0.5px !important; /* 가독성 향상 */
    }
    
    .coupon-discount {
        color: #dc3545 !important; /* 빨간색 강조 */
        font-weight: 700 !important;
        font-size: 0.95rem !important;
    }

    /* 최종 견적 카드 내 텍스트 강화 */
    .final-summary-card h6 {
        font-weight: 800 !important;
        font-size: 1.1rem !important;
    }
    .final-summary-card .final-price-display {
        font-size: 2.6rem !important;
        font-weight: 900 !important;
        color: #0d6efd !important;
    }
    .final-summary-card small {
        display: block;
        margin-top: 6px;
        font-size: 0.9rem !important;
    }
    
    /* 인라인 스타일 우선순위 보장 */
    #finalPrice,
    #totalAllFinalPrice {
        font-size: 2.4rem !important;
        font-weight: 900 !important;
        color: #0d6efd !important;
    }
    
    #couponInfo,
    #totalAllCouponInfo {
        font-size: 0.95rem !important;
    }
    
    /* 견적 건 스타일 개선 - Bootstrap 스타일 우선순위 높이기 */
    .card-body .estimate-card-item {
        margin-bottom: 0.75rem !important;
    }
    
    /* 헤더 스타일 (기본 견적, 추가 옵션 합계, 비고) - 모두 파란색, 볼드체 */
    .card-body .estimate-header-base,
    .card-body span.estimate-header-base {
        color: #0d6efd !important; /* 파란색 */
        font-weight: 800 !important; /* 더 강한 볼드체 */
        font-size: 0.9rem !important;
        display: block !important;
        margin-bottom: 0.25rem !important;
        line-height: 1.4 !important;
    }
    
    .card-body .estimate-header-options,
    .card-body span.estimate-header-options {
        color: #0d6efd !important; /* 파란색 */
        font-weight: 800 !important; /* 더 강한 볼드체 */
        font-size: 0.9rem !important;
        display: block !important;
        margin-bottom: 0.25rem !important;
        line-height: 1.4 !important;
    }
    
    .card-body .estimate-header-notes,
    .card-body span.estimate-header-notes {
        color: #0d6efd !important; /* 파란색 */
        font-weight: 800 !important; /* 더 강한 볼드체 */
        font-size: 0.9rem !important;
        display: block !important;
        margin-bottom: 0.25rem !important;
        line-height: 1.4 !important;
    }
    
    /* 세부내역 스타일 - 모두 더 진한 초록색, 볼드체 */
    .card-body .estimate-detail-base,
    .card-body div.estimate-detail-base {
        color: #0d7a3d !important; /* 더 진한 초록색 */
        font-weight: 700 !important; /* 볼드체 */
        font-size: 0.85rem !important;
        line-height: 1.5 !important;
        margin-top: 0.25rem !important;
    }
    
    .card-body .estimate-detail-options,
    .card-body div.estimate-detail-options {
        color: #0d7a3d !important; /* 더 진한 초록색 */
        font-weight: 700 !important; /* 볼드체 */
        font-size: 0.85rem !important;
        line-height: 1.6 !important;
        margin-top: 0.25rem !important;
    }
    
    .card-body .estimate-detail-notes,
    .card-body div.estimate-detail-notes {
        color: #0d7a3d !important; /* 더 진한 초록색 */
        font-weight: 700 !important; /* 볼드체 */
        font-size: 0.85rem !important;
        line-height: 1.6 !important;
        white-space: pre-wrap !important;
        word-break: break-word !important;
        margin-top: 0.25rem !important;
    }
    
    /* 금액 표시 스타일 - 더 구체적인 선택자 사용 */
    .card-body .estimate-price,
    .card-body div.estimate-price {
        font-size: 1.1rem !important;
        font-weight: 700 !important;
        color: #212529 !important;
        margin-bottom: 0.25rem !important;
    }
    
    .card-body .estimate-total-price,
    .card-body div.estimate-total-price {
        font-size: 1.3rem !important;
        font-weight: 800 !important;
        color: #0d6efd !important;
        margin-top: 0.5rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- [LEFT] 저장된 견적 목록 사이드바 -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm sticky-top" style="top: 20px; max-height: calc(100vh - 40px); display: flex; flex-direction: column;">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-history text-info"></i> 저장된 견적</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshEstimatesBtn" title="새로고침">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body p-2 d-flex flex-column" style="overflow: hidden;">
                    <!-- 검색 -->
                    <div class="input-group mb-3 flex-shrink-0">
                        <input type="text" class="form-control" id="sidebarSearchInput" placeholder="고객명 검색...">
                        <button class="btn btn-outline-secondary" type="button" id="sidebarSearchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- 목록 (스크롤 영역) -->
                    <div class="flex-grow-1 overflow-auto" id="savedEstimatesListContainer" style="min-height: 0;">
                        <div class="text-center py-5 text-muted" id="savedEstimatesLoading">
                            <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                            <p>견적 목록을 불러오는 중...</p>
                        </div>
                        <div class="list-group list-group-flush" id="savedEstimatesList">
                            <!-- JS로 렌더링됨 -->
                        </div>
                        <div class="text-center py-5 text-muted" id="noSavedEstimates" style="display: none;">
                            <i class="far fa-folder-open fa-3x mb-3"></i>
                            <p>저장된 견적이 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- [RIGHT] 계산기 메인 영역 -->
        <div class="col-lg-9">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-calculator text-info"></i> 가구 견적 계산기</h1>
        <div>
            <a href="{{ url_for('wdcalculator_product_settings') }}" class="btn btn-info">
                <i class="fas fa-cog"></i> 제품 설정
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 입력 섹션 -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow border-left-primary">
                <div class="card-header py-3 header-primary">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-edit me-2"></i>견적 정보 입력
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">고객명</label>
                        <input type="text" class="form-control" id="customerName" placeholder="고객명을 입력하세요">
                    </div>

                    <div class="mb-3">
                        <label for="productSelect" class="form-label">제품 선택 <span class="text-danger">*</span></label>
                        <select class="form-select" id="productSelect" required>
                            <option value="">제품을 선택하세요</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="widthInput" class="form-label">가로넓이 (mm) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="widthInput" placeholder="가로넓이를 입력하세요" min="0" step="1" required>
                        <small class="form-text text-muted">밀리미터 단위로 입력하세요 (예: 2000, 3100)</small>
                    </div>

                    <!-- 제품 정보 표시 -->
                    <div id="productInfo" class="mb-3" style="display: none;">
                        <div class="alert alert-info">
                            <strong>선택된 제품 정보</strong>
                            <div id="productInfoContent"></div>
                        </div>
                    </div>

                    <!-- 기본 견적 표시 -->
                    <div id="baseEstimateSection" class="mb-3" style="display: none;">
                        <div class="card estimate-card">
                            <div class="card-body">
                                <h6 class="card-title">기본 견적</h6>
                                <div class="price-display" id="basePriceDisplay">0원</div>
                            </div>
                        </div>
                    </div>

                    <!-- 추가 옵션 섹션 -->
                    <div class="mb-3">
                        <label class="form-label">추가 옵션</label>
                        <div id="additionalOptionsContainer">
                            <!-- 동적으로 추가됨 -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-info" id="addOptionBtn">
                            <i class="fas fa-plus"></i> 옵션 추가
                        </button>
                    </div>

                    <!-- 비고 입력 -->
                    <div class="mb-3">
                        <label class="form-label">비고</label>
                        <div class="d-flex gap-2 align-items-start mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleNotesDirectInput" title="직접입력">
                                <i class="fas fa-keyboard"></i>
                            </button>
                            <select class="form-select flex-grow-1" id="notesSelect">
                                <option value="">저장된 비고 선택 또는 직접 입력</option>
                                </select>
                            </div>
                        <textarea class="form-control" id="notesInput" rows="3" placeholder="비고를 입력하세요 (직접 입력 또는 위에서 선택)" style="display: none;"></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 비고는 견적서에 표시됩니다.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 견적 결과 섹션 -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow border-left-success">
                <div class="card-header py-3 header-success">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-receipt me-2"></i>견적 결과
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>기본 견적:</span>
                            <strong id="totalBasePrice">0원</strong>
                        </div>
                                    <div class="text-muted small" id="baseEstimateDetail" style="padding-left: 0.5rem;"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>추가 옵션 합계:</span>
                            <strong id="totalAdditionalPrice">0원</strong>
                                    </div>
                                    <div class="text-muted small" id="additionalOptionsDetail" style="padding-left: 0.5rem;"></div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h5 mb-0">총견적:</span>
                            <strong class="price-display" id="totalPrice">0원</strong>
                        </div>
                    </div>

                    <div class="card bg-light final-summary-card text-center">
                        <div class="card-body">
                            <h6 class="card-title mb-3">총견적</h6>
                                <div class="final-price-display mb-2" id="finalPrice">0원</div>
                                <small class="text-muted" id="couponInfo">쿠폰가 미적용</small>
                        </div>
                    </div>

                    <!-- 비고 표시 -->
                    <div class="mt-3" id="notesDisplaySection" style="display: none;">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title mb-2">
                                    <i class="fas a-sticky-note text-warning me-2"></i>비고
                                </h6>
                                <p class="mb-0 text-muted small" id="notesDisplay" style="white-space: pre-wrap;"></p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="button" class="btn btn-success w-100" id="calculateBtn">
                            <i class="fas fa-calculator"></i> 견적 계산
                        </button>
                                <button type="button" class="btn btn-primary w-100 mt-2" id="addEstimateBtn" style="display: none;">
                                    <i class="fas fa-plus"></i> 견적 추가
                                </button>
                                <button type="button" class="btn btn-info w-100 mt-2" id="saveEstimateBtn" style="display: none;">
                                    <i class="fas fa-save"></i> 견적 저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
                
                <!-- 진행 중인 견적 목록 -->
                <div class="col-lg-12 mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-list"></i> 진행 중인 견적</h5>
    </div>
                        <div class="card-body">
                            <div id="estimatesListContainer">
                                <p class="text-muted text-center mb-0">추가된 견적이 없습니다.</p>
                            </div>
                            <!-- 전체 견적 총 합계는 renderEstimatesList()에서 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
            </div> <!-- 메인 컨텐츠 내부 row 종료 -->
        </div> <!-- col-lg-9 종료 -->
    </div> <!-- 최상위 row 종료 -->
    
    <!-- 쿠폰가 설정 (단독 카테고리) -->
    <div class="row mt-4">
        <div class="col-lg-9 offset-lg-3">
            <div class="card shadow border-left-info">
                <div class="card-header py-3 header-info">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-tag me-2"></i>쿠폰가 설정
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="globalCouponValue" class="form-label">할인 금액 (원)</label>
                        <input type="number" class="form-control" id="globalCouponValue" min="0" step="1" value="11000" placeholder="할인 금액을 입력하세요">
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 최종 견적에 적용될 고정 할인 금액입니다.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> <!-- container-fluid 종료 -->

<script>
    // Jinja2 템플릿 변수를 JavaScript 변수로 변환
    const wdCalculatorCategories = JSON.parse('{{ (categories|default([]))|tojson|safe }}');
    const wdNotesCategories = JSON.parse('{{ (notes_categories|default([]))|tojson|safe }}');
    let notesCategories = wdNotesCategories || []; // 비고 카테고리
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let products = [];
    let additionalOptions = [];
    let estimates = []; // 견적 목록 저장
    let editingEstimateId = null; // 수정 중인 견적 ID (내부 목록용)
    let currentDatabaseEstimateId = null; // DB에 저장된 견적 ID (수정 시 사용)
    const DEFAULT_COUPON_VALUE = 11000; // 기본 쿠폰 금액
    
    // 쿠폰 값을 가져오는 함수 (매번 DOM에서 직접 읽기 - 가장 확실한 방법)
    function getCouponValue() {
        const couponInput = document.getElementById('globalCouponValue');
        if (!couponInput) {
            console.warn('쿠폰 입력 필드를 찾을 수 없습니다. 기본값 사용:', DEFAULT_COUPON_VALUE);
            return DEFAULT_COUPON_VALUE;
        }
        const value = couponInput.value;
        if (!value || value === '') {
            return DEFAULT_COUPON_VALUE;
        }
        const numValue = parseInt(value, 10);
        if (isNaN(numValue) || numValue < 0) {
            console.warn('잘못된 쿠폰 값:', value, '기본값 사용:', DEFAULT_COUPON_VALUE);
            return DEFAULT_COUPON_VALUE;
        }
        return numValue;
    }
    
    // 최종 견적 금액 스타일 적용 함수 (인라인 스타일 직접 적용)
    function applyFinalPriceStyle(element) {
        if (!element) return;
        element.style.fontSize = '2.4rem';
        element.style.fontWeight = '900';
        element.style.color = '#0d6efd';
        element.style.lineHeight = '1.1';
        element.className = 'final-price-display mb-2';
    }
    
    // 쿠폰 할인 정보 스타일 적용 함수
    function applyCouponDiscountStyle(element, hasDiscount) {
        if (!element) return;
        if (hasDiscount) {
            element.style.color = '#dc3545';
            element.style.fontWeight = '700';
            element.className = 'coupon-discount';
        } else {
            element.style.color = '#6c757d';
            element.style.fontWeight = '400';
            element.className = 'text-muted';
        }
    }

    // 견적 ID 생성 함수 (통일된 형식)
    function generateEstimateId() {
        return 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // ID 비교를 위한 헬퍼 함수
    function isSameId(id1, id2) {
        return String(id1) === String(id2);
    }
    
    // ID를 문자열로 정규화
    function normalizeId(id) {
        if (!id) return null;
        return String(id);
    }
    
    // 가격 포맷팅 함수 (콤마 추가)
    function formatPrice(value) {
        if (!value) return '';
        // 숫자만 추출
        const numValue = value.toString().replace(/[^\d]/g, '');
        if (!numValue) return '';
        // 콤마 포맷팅
        return parseInt(numValue, 10).toLocaleString('ko-KR');
    }
    
    // 가격에서 콤마 제거 후 숫자로 변환
    function parsePrice(value) {
        if (!value) return 0;
        // 콤마 제거 후 숫자로 변환
        const numValue = value.toString().replace(/[^\d]/g, '');
        return parseFloat(numValue) || 0;
    }
    
    // XSS 방지를 위한 HTML 이스케이프 함수
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
    
    // 카테고리 데이터 확인 (디버깅)
    console.log('로드된 카테고리 데이터:', wdCalculatorCategories);
    if (wdCalculatorCategories && wdCalculatorCategories.length > 0) {
        console.log('카테고리 개수:', wdCalculatorCategories.length);
        wdCalculatorCategories.forEach((cat, idx) => {
            console.log(`카테고리 ${idx + 1}:`, cat.name, '옵션 개수:', cat.options ? cat.options.length : 0);
        });
    } else {
        console.warn('카테고리 데이터가 없습니다. 제품 설정에서 추가 옵션을 등록해주세요.');
    }
    
    // 비고 카테고리 로드
    function loadNotesCategories() {
        // 템플릿에서 전달된 비고 카테고리 사용
        notesCategories = wdNotesCategories || [];
        updateNotesSelect();
    }
    
    // 비고 드롭다운 업데이트
    function updateNotesSelect() {
        const select = document.getElementById('notesSelect');
        if (!select) return;
        
        // 기존 옵션 유지 (첫 번째 옵션만)
        const firstOption = select.options[0];
        select.innerHTML = '';
        if (firstOption) {
            select.appendChild(firstOption);
        }
        
        // 비고 카테고리 옵션 추가
        if (notesCategories && Array.isArray(notesCategories)) {
            notesCategories.forEach(category => {
                if (category && category.options && Array.isArray(category.options)) {
                    category.options.forEach(option => {
                        if (option && option.name) {
                            const optionElement = document.createElement('option');
                            optionElement.value = `${category.name} > ${option.name}`;
                            optionElement.textContent = `${category.name} > ${option.name}`;
                            select.appendChild(optionElement);
                        }
                    });
                }
            });
        }
    }
    
    // 비고 숫자 콤마 포맷터
    function formatNumbersInText(text) {
        return text.replace(/\d{4,}/g, (match) => {
            const num = Number(match);
            return Number.isFinite(num) ? num.toLocaleString('ko-KR') : match;
        });
    }
    
    // 비고 직접입력 토글
    const toggleNotesDirectInputBtn = document.getElementById('toggleNotesDirectInput');
    const notesSelect = document.getElementById('notesSelect');
    const notesInput = document.getElementById('notesInput');
    
    if (toggleNotesDirectInputBtn && notesSelect && notesInput) {
        toggleNotesDirectInputBtn.addEventListener('click', function() {
            if (notesInput.style.display === 'none') {
                // 직접 입력 모드로 전환
                notesInput.style.display = 'block';
                notesSelect.style.display = 'none';
                notesSelect.value = '';
                this.innerHTML = '<i class="fas fa-list"></i>';
                this.title = '선택 모드';
            } else {
                // 선택 모드로 전환
                notesInput.style.display = 'none';
                notesSelect.style.display = 'block';
                notesInput.value = '';
                this.innerHTML = '<i class="fas fa-keyboard"></i>';
                this.title = '직접입력';
            }
        });
        
        // 비고 선택 시
        notesSelect.addEventListener('change', function() {
            if (this.value && this.value !== '') {
                // 선택된 비고를 직접 입력 필드에도 표시 (선택사항)
                // notesInput.value = this.value;
            }
        });

        // 비고 입력 시 숫자에 자동 콤마 적용 (blur 시 반영)
        notesInput.addEventListener('blur', function() {
            const formatted = formatNumbersInText(notesInput.value);
            if (formatted !== notesInput.value) {
                notesInput.value = formatted;
            }
        });
    }
    
    // 비고 카테고리 로드
    loadNotesCategories();
    
    // 제품 목록 로드
    function loadProducts() {
        fetch('/api/wdcalculator/products')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    products = data.products;
                    updateProductSelect();
                }
            })
            .catch(error => {
                console.error('Error loading products:', error);
            });
    }
    
    // 제품 선택 드롭다운 업데이트
    function updateProductSelect() {
        const select = document.getElementById('productSelect');
        select.innerHTML = '<option value="">제품을 선택하세요</option>';
        
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            select.appendChild(option);
        });
    }
    
    // 제품 선택 시 정보 표시
    // 제품 선택 (null 체크 추가)
    const productSelect = document.getElementById('productSelect');
    if (productSelect) {
        productSelect.addEventListener('change', function() {
        const productId = parseInt(this.value);
        const product = products.find(p => p.id === productId);
        
        // 기존 추가 옵션 목록 초기화
        document.getElementById('additionalOptionsContainer').innerHTML = '';
        
        if (product) {
            showProductInfo(product);
            // 쿠폰가는 고정값(11,000원)으로 유지 - 제품 설정 무시
        } else {
            document.getElementById('productInfo').style.display = 'none';
            document.getElementById('baseEstimateSection').style.display = 'none';
        }
        
        calculateEstimate();
    });
    }
    
    // 제품 정보 표시
    function showProductInfo(product) {
        const infoDiv = document.getElementById('productInfo');
        const contentDiv = document.getElementById('productInfoContent');
        
        if (!infoDiv || !contentDiv) {
            console.warn('제품 정보 표시 요소를 찾을 수 없습니다.');
            return;
        }
        
        if (!product) {
            console.warn('제품 정보가 없습니다.');
            infoDiv.style.display = 'none';
            return;
        }
        
        let infoHtml = `<div><strong>${escapeHtml(product.name || '')}</strong></div>`;
        infoHtml += `<div>가격 옵션: ${product.pricing_type === '1m' ? '1m' : '30cm'}</div>`;
        
        if (product.pricing_type === '1m') {
            infoHtml += `<div>1m 비용: ${formatNumber(product.price_1m || 0)}원</div>`;
        } else {
            infoHtml += `<div>30cm 비용: ${formatNumber(product.price_30cm || 0)}원</div>`;
            infoHtml += `<div>1cm 비용: ${formatNumber(product.price_1cm || 0)}원</div>`;
        }
        
        if (product.additional_options && product.additional_options.length > 0) {
            infoHtml += `<div class="mt-2"><strong>사용 가능한 추가 옵션:</strong></div>`;
            product.additional_options.forEach(option => {
                infoHtml += `<div>- ${escapeHtml(option.name || '')}: ${formatNumber(option.price || 0)}원</div>`;
            });
            infoHtml += `<div class="mt-1"><small class="text-muted">※ 견적 계산 시 드롭다운에서 선택하거나 직접 입력할 수 있습니다.</small></div>`;
        }
        
        contentDiv.innerHTML = infoHtml;
        infoDiv.style.display = 'block';
    }
    
    // 가로넓이 입력 시 실시간 계산 (null 체크 추가)
    const widthInput = document.getElementById('widthInput');
    if (widthInput) {
        widthInput.addEventListener('input', function() {
        calculateEstimate();
    });
    }
    
    // 추가 옵션 추가 버튼 (null 체크 추가)
    const addOptionBtn = document.getElementById('addOptionBtn');
    if (addOptionBtn) {
        addOptionBtn.addEventListener('click', function() {
        const container = document.getElementById('additionalOptionsContainer');
        const optionId = Date.now();
        
        // 카테고리별 옵션 목록 생성 (먼저 생성)
        let allOptionsHtml = '<option value="">카테고리 > 옵션을 선택하세요</option>';
        if (wdCalculatorCategories && Array.isArray(wdCalculatorCategories)) {
        wdCalculatorCategories.forEach(category => {
                if (category && category.options && Array.isArray(category.options) && category.options.length > 0) {
                    category.options.forEach(option => {
                        if (option && option.id && option.name && option.price !== undefined) {
                            allOptionsHtml += `<option value="${category.name}|${option.name}|${option.price}">${category.name} > ${option.name} (${formatNumber(option.price)}원)</option>`;
                        }
                    });
                }
            });
        }
        
        // 옵션이 없으면 안내 메시지 추가
        if (allOptionsHtml === '<option value="">카테고리 > 옵션을 선택하세요</option>') {
            allOptionsHtml += '<option value="" disabled>등록된 옵션이 없습니다. 직접 입력해주세요.</option>';
        }
        
        const optionHtml = `
            <div class="additional-option-item" data-option-id="${optionId}">
                <div class="row gx-2 align-items-center">
                    <div class="col-md-5">
                        <label class="form-label small">카테고리 > 옵션 선택</label>
                        <div class="d-flex gap-2 align-items-center">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle-direct-input title="직접입력">
                                <i class="fas fa-keyboard"></i>
                            </button>
                            <select class="form-select form-select-sm category-option-select flex-grow-1" data-category-option-select>
                                ${allOptionsHtml}
                        </select>
                            <input type="text" class="form-control form-control-sm option-name-input flex-grow-1" placeholder="또는 옵션명 직접 입력 (예: 화장대 > 화장대A)" data-option-name style="display: none;">
                    </div>
                    </div>
                    <div class="col-md-3 price-col">
                        <label class="form-label small">가격 (원)</label>
                        <input type="text" class="form-control form-control-sm option-price-input" placeholder="가격을 입력하세요" data-option-price inputmode="numeric">
                    </div>
                    <div class="col-md-2 quantity-col">
                        <label class="form-label small">수량</label>
                        <input type="number" class="form-control form-control-sm option-quantity-input" placeholder="수량" min="1" step="1" value="1" data-option-quantity>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small" style="visibility: hidden;">작업</label>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-option-btn w-100" style="white-space: nowrap;">
                            <i class="fas fa-times"></i> 삭제
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', optionHtml);
        
        // 새로 추가된 옵션의 이벤트 리스너 추가
        const newOption = container.querySelector(`[data-option-id="${optionId}"]`);
        const categoryOptionSelect = newOption.querySelector('[data-category-option-select]');
        const nameInput = newOption.querySelector('[data-option-name]');
        const priceInput = newOption.querySelector('[data-option-price]');
        const quantityInput = newOption.querySelector('[data-option-quantity]');
        const toggleDirectInputBtn = newOption.querySelector('[data-toggle-direct-input]');
        
        // 카테고리 드롭다운과 직접입력 텍스트 박스 크기 동기화
        function syncInputSizes() {
            if (categoryOptionSelect && nameInput && priceInput) {
                // 직접입력 텍스트 박스의 너비를 기준으로 드롭다운 크기 맞추기
                const nameInputWidth = nameInput.offsetWidth || nameInput.clientWidth;
                if (nameInputWidth > 0) {
                    categoryOptionSelect.style.width = nameInputWidth + 'px';
                }
                // 가격 입력 박스는 CSS로 100%로 설정되어 있으므로 JavaScript에서 크기 설정하지 않음
                // priceInput.style.width는 CSS의 !important로 덮어쓰지 않도록 제거
            }
        }
        
        // 초기 크기 동기화 (직접입력 텍스트 박스가 숨겨져 있을 때는 드롭다운 크기 기준)
        function initSizes() {
            if (nameInput.style.display === 'none') {
                // 드롭다운이 보일 때
                setTimeout(() => {
                    if (categoryOptionSelect && nameInput && priceInput && quantityInput) {
                        const selectWidth = categoryOptionSelect.offsetWidth;
                        nameInput.style.width = selectWidth + 'px';
                        // 가격 입력 박스는 CSS로 100%로 설정되어 있으므로 JavaScript에서 크기 설정하지 않음
                        // priceInput.style.width는 CSS의 !important로 덮어쓰지 않도록 제거
                    }
                }, 10);
            } else {
                // 직접입력 텍스트 박스가 보일 때
                syncInputSizes();
            }
        }
        
        // 초기 크기 동기화
        setTimeout(initSizes, 10);
        
        // 윈도우 리사이즈 시 크기 동기화
        window.addEventListener('resize', initSizes);
        
        // 가격 입력 필드에 콤마 포맷팅 적용
        priceInput.addEventListener('input', function() {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const formattedValue = formatPrice(this.value);
            
            this.value = formattedValue;
            
            // 커서 위치 조정 (콤마 추가로 인한 위치 변화 보정)
            const diff = formattedValue.length - oldValue.length;
            const newPosition = Math.max(0, cursorPosition + diff);
            this.setSelectionRange(newPosition, newPosition);
            
            calculateEstimate();
        });
        
        // 가격 입력 필드 포커스 아웃 시 포맷팅 확정
        priceInput.addEventListener('blur', function() {
            if (this.value) {
                this.value = formatPrice(this.value);
            }
        });
        
        // 카테고리 > 옵션 선택 시
        categoryOptionSelect.addEventListener('change', function() {
            if (this.value && this.value !== '') {
                const [categoryName, optionName, price] = this.value.split('|');
                nameInput.value = `${categoryName} > ${optionName}`;
                priceInput.value = formatPrice(price);
                if (!quantityInput.value || quantityInput.value < 1) {
                    quantityInput.value = 1;
                }
                nameInput.style.display = 'none';
                categoryOptionSelect.style.display = 'block';
                calculateEstimate();
            } else {
                nameInput.value = '';
                priceInput.value = '';
            }
        });
        
        // 수량 변경 시 계산
        quantityInput.addEventListener('input', function() {
            if (this.value < 1) {
                this.value = 1;
            }
                calculateEstimate();
        });
        
        // 직접 입력 토글 버튼
        toggleDirectInputBtn.addEventListener('click', function() {
            if (nameInput.style.display === 'none') {
                // 직접 입력 모드로 전환
                nameInput.style.display = 'block';
                categoryOptionSelect.style.display = 'none';
                categoryOptionSelect.value = '';
                nameInput.value = '';
                priceInput.value = '';
                this.innerHTML = '<i class="fas fa-list"></i>';
                // 크기 동기화
                setTimeout(syncInputSizes, 10);
            } else {
                // 드롭다운 모드로 전환
                nameInput.style.display = 'none';
                categoryOptionSelect.style.display = 'block';
                nameInput.value = '';
                priceInput.value = '';
                this.innerHTML = '<i class="fas fa-keyboard"></i>';
                // 크기 동기화
                setTimeout(initSizes, 10);
            }
            calculateEstimate();
        });
        
        priceInput.addEventListener('input', calculateEstimate);
        nameInput.addEventListener('input', calculateEstimate);
        quantityInput.addEventListener('input', calculateEstimate);
    });
    }
    
    // 추가 옵션 삭제
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-option-btn')) {
            e.target.closest('.additional-option-item').remove();
            calculateEstimate();
        }
    });
    
    // 쿠폰가는 고정값이므로 변경 이벤트 제거
    // document.getElementById('couponType').addEventListener('change', calculateEstimate);
    // document.getElementById('couponValue').addEventListener('input', calculateEstimate);
    
    // 견적 계산 함수
    function calculateEstimate() {
        const productId = parseInt(document.getElementById('productSelect').value);
        const widthMm = parseFloat(document.getElementById('widthInput').value) || 0;
        
        if (!productId || widthMm <= 0) {
            document.getElementById('baseEstimateSection').style.display = 'none';
            document.getElementById('totalBasePrice').textContent = '0원';
            document.getElementById('totalAdditionalPrice').textContent = '0원';
            document.getElementById('totalPrice').textContent = '0원';
            document.getElementById('finalPrice').textContent = '0원';
            document.getElementById('baseEstimateDetail').textContent = '';
            document.getElementById('additionalOptionsDetail').textContent = '';
            return;
        }
        
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        // 기본 견적 계산
        let basePrice = 0;
        if (product.pricing_type === '1m') {
            // 1m 옵션: (가로넓이 / 1000) * 1m 비용
            const meters = widthMm / 1000;
            basePrice = meters * (product.price_1m || 0);
        } else if (product.pricing_type === '30cm') {
            // 30cm 옵션: (가로넓이 / 300) * 30cm 비용 + (나머지 / 10) * 1cm 비용
            // 예: 3100mm = 10 * 300mm + 100mm → (10 * 30cm 설정가) + (10 * 1cm 설정가)
            // 예: 3300mm = 11 * 300mm + 0mm → (11 * 30cm 설정가)
            const units30cm = Math.floor(widthMm / 300);
            const remainderMm = widthMm % 300;
            const units1cm = Math.floor(remainderMm / 10);
            basePrice = (units30cm * (product.price_30cm || 0)) + (units1cm * (product.price_1cm || 0));
        }
        
        // 기본 견적 상세 정보: 제품명 가로넓이
        const baseEstimateDetail = `${product.name} ${formatNumber(widthMm)}mm`;
        document.getElementById('baseEstimateDetail').textContent = baseEstimateDetail;
        
        // 추가 옵션 가격 합산
        let additionalPrice = 0;
        const additionalOptionsList = []; // 옵션명과 수량을 저장할 배열
        
        // 사용자가 선택/입력한 옵션만 계산 (수량 반영)
        document.querySelectorAll('.additional-option-item').forEach(item => {
            const priceInput = item.querySelector('[data-option-price]');
            const nameInput = item.querySelector('[data-option-name]');
            const quantityInput = item.querySelector('[data-option-quantity]');
            const categoryOptionSelect = item.querySelector('[data-category-option-select]');
            const price = parsePrice(priceInput.value);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // 카테고리 > 옵션 선택 또는 직접 입력한 경우
            let name = '';
            if (categoryOptionSelect && categoryOptionSelect.style.display !== 'none' && categoryOptionSelect.value && categoryOptionSelect.value !== '') {
                // 드롭다운에서 선택한 경우
                const parts = categoryOptionSelect.value.split('|');
                if (parts.length >= 2) {
                    name = `${parts[0]} > ${parts[1]}`;
                }
            } else if (nameInput && nameInput.style.display !== 'none' && nameInput.value) {
                // 직접 입력한 경우
                name = nameInput.value;
            }
            
            // 옵션명과 가격이 모두 입력된 경우만 계산 (가격 * 수량)
            if (name && price > 0) {
                additionalPrice += price * quantity;
                // 옵션명과 수량을 배열에 추가
                additionalOptionsList.push({
                    name: name,
                    quantity: quantity
                });
            }
        });
        
        // 추가 옵션 상세 정보 생성: 옵션명 + 수량 (같은 옵션이 여러 개면 합산)
        const optionMap = new Map();
        additionalOptionsList.forEach(option => {
            if (optionMap.has(option.name)) {
                optionMap.set(option.name, optionMap.get(option.name) + option.quantity);
            } else {
                optionMap.set(option.name, option.quantity);
            }
        });
        
        const additionalOptionsDetail = Array.from(optionMap.entries())
            .map(([name, qty]) => `${name} × ${qty}`)
            .join(', ');
        document.getElementById('additionalOptionsDetail').textContent = additionalOptionsDetail || '';
        
        const totalPrice = basePrice + additionalPrice;
        // 쿠폰 값은 매번 최신 값으로 읽기 (중요!)
        const couponValue = getCouponValue();
        console.log('calculateEstimate - 쿠폰 값:', couponValue, '총액:', totalPrice);
        const finalPrice = Math.max(0, totalPrice - couponValue);
        const couponInfoText = couponValue > 0 ? `${formatNumber(couponValue)}원 할인` : '쿠폰가 미적용';
        
        // 결과 표시
        document.getElementById('baseEstimateSection').style.display = 'block';
        document.getElementById('basePriceDisplay').textContent = formatNumber(basePrice) + '원';
        document.getElementById('totalBasePrice').textContent = formatNumber(basePrice) + '원';
        document.getElementById('totalAdditionalPrice').textContent = formatNumber(additionalPrice) + '원';
        document.getElementById('totalPrice').textContent = formatNumber(totalPrice) + '원';
        // 최종 견적 표시 (인라인 스타일 직접 적용 - CSS 우선순위 완전 우회)
        const finalPriceEl = document.getElementById('finalPrice');
        if (finalPriceEl) {
            finalPriceEl.textContent = formatNumber(finalPrice) + '원';
            applyFinalPriceStyle(finalPriceEl);
        }
        
        // 쿠폰 정보 표시 (인라인 스타일 직접 적용)
        const couponInfoEl = document.getElementById('couponInfo');
        if (couponInfoEl) {
            couponInfoEl.textContent = couponInfoText;
            applyCouponDiscountStyle(couponInfoEl, couponValue > 0);
        }
        
        // 견적 추가 버튼 표시
        // editingEstimateId가 설정되어 있으면 수정 모드이므로 버튼을 표시
        if (editingEstimateId) {
            // 수정 모드: 버튼 텍스트는 loadEstimateToInputForm에서 설정됨
            document.getElementById('addEstimateBtn').style.display = 'block';
        } else if (basePrice > 0 || additionalPrice > 0) {
            // 새 견적 추가 모드
            document.getElementById('addEstimateBtn').innerHTML = '<i class="fas fa-plus"></i> 견적 추가';
            document.getElementById('addEstimateBtn').style.display = 'block';
            // 견적 계산이 완료되면 저장 버튼도 표시 (진행 중인 견적이 있거나 현재 계산된 견적이 있으면)
            if (estimates.length > 0 || (productId && widthMm > 0)) {
                document.getElementById('saveEstimateBtn').style.display = 'block';
            }
        } else {
            document.getElementById('addEstimateBtn').style.display = 'none';
            // 진행 중인 견적이 있으면 저장 버튼은 유지
            if (estimates.length === 0) {
                document.getElementById('saveEstimateBtn').style.display = 'none';
            }
        }
    }
    
    // 현재 입력 폼의 견적 데이터 수집
    function collectCurrentEstimate() {
        const productId = parseInt(document.getElementById('productSelect').value);
        const widthMm = parseFloat(document.getElementById('widthInput').value) || 0;
        
        if (!productId || widthMm <= 0) {
            return null;
        }
        
        const product = products.find(p => p.id === productId);
        if (!product) return null;
        
        // 기본 견적 계산
        let basePrice = 0;
        if (product.pricing_type === '1m') {
            const meters = widthMm / 1000;
            basePrice = meters * (product.price_1m || 0);
        } else if (product.pricing_type === '30cm') {
            const units30cm = Math.floor(widthMm / 300);
            const remainderMm = widthMm % 300;
            const units1cm = Math.floor(remainderMm / 10);
            basePrice = (units30cm * (product.price_30cm || 0)) + (units1cm * (product.price_1cm || 0));
        }
        
        // 추가 옵션 수집
        const options = [];
        document.querySelectorAll('.additional-option-item').forEach(item => {
            const priceInput = item.querySelector('[data-option-price]');
            const nameInput = item.querySelector('[data-option-name]');
            const quantityInput = item.querySelector('[data-option-quantity]');
            const categoryOptionSelect = item.querySelector('[data-category-option-select]');
            const price = parsePrice(priceInput.value);
            const quantity = parseInt(quantityInput.value) || 1;
            
            let name = '';
            if (categoryOptionSelect && categoryOptionSelect.style.display !== 'none' && categoryOptionSelect.value && categoryOptionSelect.value !== '') {
                const parts = categoryOptionSelect.value.split('|');
                if (parts.length >= 2) {
                    name = `${parts[0]} > ${parts[1]}`;
                }
            } else if (nameInput && nameInput.style.display !== 'none' && nameInput.value) {
                name = nameInput.value;
            }
            
            if (name && price > 0) {
                options.push({
                    name: name,
                    price: price,
                    quantity: quantity
                });
            }
        });
        
        const additionalPrice = options.reduce((sum, opt) => sum + (opt.price * opt.quantity), 0);
        const totalPrice = basePrice + additionalPrice;
        
        // 비고 정보 수집
        const notesInput = document.getElementById('notesInput');
        const notesSelect = document.getElementById('notesSelect');
        let notes = '';
        if (notesInput && notesInput.style.display !== 'none' && notesInput.value.trim()) {
            notes = notesInput.value.trim();
        } else if (notesSelect && notesSelect.value && notesSelect.value !== '') {
            notes = notesSelect.value;
        }
        
        return {
            productId: productId,
            productName: product.name,
            widthMm: widthMm,
            basePrice: basePrice,
            options: options,
            additionalPrice: additionalPrice,
            totalPrice: totalPrice,
            notes: notes // 비고 정보 추가
        };
    }
    
    // 견적 목록 렌더링
    function renderEstimatesList() {
        const container = document.getElementById('estimatesListContainer');
        
        if (estimates.length === 0) {
            container.innerHTML = '<p class="text-muted text-center mb-0">추가된 견적이 없습니다.</p>';
            return;
        }
        
        let html = '<div class="row g-3">';
        estimates.forEach((estimate, index) => {
            // 추가 옵션을 줄바꿈으로 표시
            let optionsDetailHtml = '없음';
            if (estimate.options && estimate.options.length > 0) {
                optionsDetailHtml = estimate.options.map(opt => 
                    `<div style="color: #0d7a3d !important; font-weight: 700 !important; font-size: 0.85rem !important; line-height: 1.6 !important;">${escapeHtml(opt.name)} × ${opt.quantity}</div>`
                ).join('');
            }
            
            // ID를 문자열로 통일하여 HTML 속성에 저장 (XSS 방지를 위해 이스케이프)
            const estimateIdStr = escapeHtml(String(estimate.id));
            const productNameEscaped = escapeHtml(estimate.productName || '');
            
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100" data-estimate-id="${estimateIdStr}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>견적 ${index + 1}</strong>
                            <div>
                                <button class="btn btn-sm btn-outline-primary edit-estimate-btn" data-estimate-id="${estimateIdStr}" title="수정">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-estimate-btn" data-estimate-id="${estimateIdStr}" title="삭제">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3 estimate-card-item">
                                <span class="estimate-header-base" style="color: #0d6efd !important; font-weight: 800 !important; font-size: 0.9rem !important; display: block !important; margin-bottom: 0.25rem !important;">기본 견적:</span>
                                <div class="estimate-price mb-1" style="font-size: 1.1rem !important; font-weight: 700 !important; color: #212529 !important;">${formatNumber(estimate.basePrice)}원</div>
                                <div class="estimate-detail-base" style="color: #0d7a3d !important; font-weight: 700 !important; font-size: 0.85rem !important; line-height: 1.5 !important; margin-top: 0.25rem !important;">${productNameEscaped} ${formatNumber(estimate.widthMm)}mm</div>
                            </div>
                            <div class="mb-3 estimate-card-item">
                                <span class="estimate-header-options" style="color: #0d6efd !important; font-weight: 800 !important; font-size: 0.9rem !important; display: block !important; margin-bottom: 0.25rem !important;">추가 옵션 합계:</span>
                                <div class="estimate-price mb-1" style="font-size: 1.1rem !important; font-weight: 700 !important; color: #212529 !important;">${formatNumber(estimate.additionalPrice)}원</div>
                                <div class="estimate-detail-options" style="margin-top: 0.25rem !important;">${optionsDetailHtml}</div>
                            </div>
                            ${estimate.notes ? `
                            <div class="mb-3 estimate-card-item">
                                <span class="estimate-header-notes" style="color: #0d6efd !important; font-weight: 800 !important; font-size: 0.9rem !important; display: block !important; margin-bottom: 0.25rem !important;">비고:</span>
                                <div class="estimate-detail-notes" style="color: #0d7a3d !important; font-weight: 700 !important; font-size: 0.85rem !important; line-height: 1.6 !important; white-space: pre-wrap !important; word-break: break-word !important; margin-top: 0.25rem !important;">${escapeHtml(estimate.notes)}</div>
                            </div>
                            ` : ''}
                            <hr class="my-3">
                            <div class="mt-3">
                                <small class="text-muted d-block mb-1">총견적:</small>
                                <div class="estimate-total-price" style="font-size: 1.3rem !important; font-weight: 800 !important; color: #0d6efd !important; margin-top: 0.5rem !important;">${formatNumber(estimate.totalPrice)}원</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // 전체 견적 총 합계를 견적 카드들과 같은 row에 추가
        if (estimates.length > 0) {
            // 견적 개수에 따라 col 클래스 결정
            let colClass = 'col-md-12';
            if (estimates.length === 1) {
                colClass = 'col-md-6 col-lg-4'; // 견적 1건과 동일한 넓이
            } else if (estimates.length === 2) {
                colClass = 'col-md-12 col-lg-8'; // 견적 2건의 넓이 (lg에서 2/3)
            } else {
                colClass = 'col-md-12 col-lg-12'; // 견적 3건 이상의 넓이
            }
            
            // 견적 1개일 경우와 2개 이상일 경우 다른 레이아웃 사용
            if (estimates.length === 1) {
                // 견적 1개: 총 견적 합계 제거, 최종 견적을 그 자리에 배치
                html += `
                    <div class="${colClass} mt-3" id="totalEstimatesSummary">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator"></i> 전체 견적 총 합계</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>기본 견적 총합:</span>
                                    <strong id="totalAllBasePrice">0원</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span>추가 옵션 총합:</span>
                                    <strong id="totalAllAdditionalPrice">0원</strong>
                                </div>
                                <hr>
                                <div class="card bg-light final-summary-card text-center mt-3">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">최종 견적</h6>
                                        <div class="final-price-display mb-2" id="totalAllFinalPrice">0원</div>
                                        <small class="text-muted" id="totalAllCouponInfo">쿠폰가 미적용</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // 견적 2개 이상: 기존 레이아웃 유지 (2열 구조)
                html += `
                    <div class="${colClass} mt-3" id="totalEstimatesSummary">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator"></i> 전체 견적 총 합계</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>기본 견적 총합:</span>
                                            <strong id="totalAllBasePrice">0원</strong>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>추가 옵션 총합:</span>
                                            <strong id="totalAllAdditionalPrice">0원</strong>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="h5 mb-0">총 견적 합계:</span>
                                            <strong class="h4 text-primary mb-0" id="totalAllPrice">0원</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light final-summary-card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title mb-3">최종 견적</h6>
                                                <div class="final-price-display mb-2" id="totalAllFinalPrice">0원</div>
                                                <small class="text-muted" id="totalAllCouponInfo">쿠폰가 미적용</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        html += '</div>';
        container.innerHTML = html;
        
        // 동적으로 생성된 요소에 스타일 강제 적용 (CSS 우선순위 문제 해결)
        setTimeout(() => {
            container.querySelectorAll('.estimate-header-base').forEach(el => {
                el.style.setProperty('color', '#0d6efd', 'important');
                el.style.setProperty('font-weight', '800', 'important');
                el.style.setProperty('font-size', '0.9rem', 'important');
                el.style.setProperty('display', 'block', 'important');
                el.style.setProperty('margin-bottom', '0.25rem', 'important');
            });
            
            container.querySelectorAll('.estimate-header-options').forEach(el => {
                el.style.setProperty('color', '#0d6efd', 'important');
                el.style.setProperty('font-weight', '800', 'important');
                el.style.setProperty('font-size', '0.9rem', 'important');
                el.style.setProperty('display', 'block', 'important');
                el.style.setProperty('margin-bottom', '0.25rem', 'important');
            });
            
            container.querySelectorAll('.estimate-header-notes').forEach(el => {
                el.style.setProperty('color', '#0d6efd', 'important');
                el.style.setProperty('font-weight', '800', 'important');
                el.style.setProperty('font-size', '0.9rem', 'important');
                el.style.setProperty('display', 'block', 'important');
                el.style.setProperty('margin-bottom', '0.25rem', 'important');
            });
            
            container.querySelectorAll('.estimate-detail-base').forEach(el => {
                el.style.setProperty('color', '#0d7a3d', 'important');
                el.style.setProperty('font-weight', '700', 'important');
                el.style.setProperty('font-size', '0.85rem', 'important');
                el.style.setProperty('line-height', '1.5', 'important');
                el.style.setProperty('margin-top', '0.25rem', 'important');
            });
            
            // 추가 옵션 세부내역은 이미 HTML에 인라인 스타일이 포함되어 있으므로 별도 처리 불필요
            // 하지만 혹시 모를 경우를 대비해 스타일 확인
            container.querySelectorAll('.estimate-detail-options').forEach(el => {
                // 내부 div 요소들에 스타일 적용
                el.querySelectorAll('div').forEach(divEl => {
                    divEl.style.setProperty('color', '#0d7a3d', 'important');
                    divEl.style.setProperty('font-weight', '700', 'important');
                    divEl.style.setProperty('font-size', '0.85rem', 'important');
                    divEl.style.setProperty('line-height', '1.6', 'important');
                });
            });
            
            container.querySelectorAll('.estimate-detail-notes').forEach(el => {
                el.style.setProperty('color', '#0d7a3d', 'important');
                el.style.setProperty('font-weight', '700', 'important');
                el.style.setProperty('font-size', '0.85rem', 'important');
                el.style.setProperty('line-height', '1.6', 'important');
                el.style.setProperty('white-space', 'pre-wrap', 'important');
                el.style.setProperty('word-break', 'break-word', 'important');
                el.style.setProperty('margin-top', '0.25rem', 'important');
            });
            
            container.querySelectorAll('.estimate-price').forEach(el => {
                el.style.setProperty('font-size', '1.1rem', 'important');
                el.style.setProperty('font-weight', '700', 'important');
                el.style.setProperty('color', '#212529', 'important');
            });
            
            container.querySelectorAll('.estimate-total-price').forEach(el => {
                el.style.setProperty('font-size', '1.3rem', 'important');
                el.style.setProperty('font-weight', '800', 'important');
                el.style.setProperty('color', '#0d6efd', 'important');
            });
        }, 10);
        
        // 견적이 존재하면 저장 버튼을 노출 (수정/저장 가능)
        const saveBtnInList = document.getElementById('saveEstimateBtn');
        if (saveBtnInList) {
            saveBtnInList.style.display = estimates.length > 0 ? 'block' : saveBtnInList.style.display;
        }
        
        // 전체 견적 합계 계산 및 표시
        calculateTotalEstimates();
    }
    
    // 전체 견적 합계 계산 (쿠폰은 1번만 적용)
    function calculateTotalEstimates() {
        if (estimates.length === 0) {
            document.getElementById('totalBasePrice').textContent = '0원';
            document.getElementById('totalAdditionalPrice').textContent = '0원';
            document.getElementById('totalPrice').textContent = '0원';
            document.getElementById('finalPrice').textContent = '0원';
            document.getElementById('baseEstimateDetail').textContent = '';
            document.getElementById('additionalOptionsDetail').textContent = '';
            // 전체 견적 총 합계는 renderEstimatesList()에서 제거되므로 여기서는 처리 불필요
            return;
        }
        
        const totalBasePrice = estimates.reduce((sum, est) => sum + est.basePrice, 0);
        const totalAdditionalPrice = estimates.reduce((sum, est) => sum + est.additionalPrice, 0);
        const totalPrice = totalBasePrice + totalAdditionalPrice;
        
        // 쿠폰 적용 (매번 최신 값으로 읽기 - 중요!)
        const couponValue = getCouponValue();
        console.log('calculateTotalEstimates - 쿠폰 값:', couponValue, '총액:', totalPrice);
        const finalPrice = Math.max(0, totalPrice - couponValue);
        const couponInfoText = couponValue > 0 ? `${formatNumber(couponValue)}원 할인` : '쿠폰가 미적용';
        
        // 전체 견적 상세 정보
        const baseDetails = estimates.map(est => `${est.productName} ${formatNumber(est.widthMm)}mm`).join(', ');
        const optionMap = new Map();
        estimates.forEach(est => {
            est.options.forEach(opt => {
                if (optionMap.has(opt.name)) {
                    optionMap.set(opt.name, optionMap.get(opt.name) + opt.quantity);
                } else {
                    optionMap.set(opt.name, opt.quantity);
                }
            });
        });
        const additionalDetails = Array.from(optionMap.entries())
            .map(([name, qty]) => `${name} × ${qty}`)
            .join(', ');
        
        // 견적 결과 섹션 표시 (수정 모드가 아닐 때만 업데이트)
        // editingEstimateId가 설정되어 있으면 입력 폼의 calculateEstimate() 결과를 보존
        if (!editingEstimateId) {
            document.getElementById('totalBasePrice').textContent = formatNumber(totalBasePrice) + '원';
            document.getElementById('totalAdditionalPrice').textContent = formatNumber(totalAdditionalPrice) + '원';
            document.getElementById('totalPrice').textContent = formatNumber(totalPrice) + '원';
            
            // 최종 견적 표시 (인라인 스타일 직접 적용)
            const finalPriceEl = document.getElementById('finalPrice');
            if (finalPriceEl) {
                finalPriceEl.textContent = formatNumber(finalPrice) + '원';
                applyFinalPriceStyle(finalPriceEl);
            }
            
            // 쿠폰 정보 표시 (인라인 스타일 직접 적용)
            const couponInfoEl = document.getElementById('couponInfo');
            if (couponInfoEl) {
                couponInfoEl.textContent = couponInfoText;
                applyCouponDiscountStyle(couponInfoEl, couponValue > 0);
            }
            
            document.getElementById('baseEstimateDetail').textContent = baseDetails;
            document.getElementById('additionalOptionsDetail').textContent = additionalDetails || '';
            
            // 비고 표시
            const notesInput = document.getElementById('notesInput');
            const notesSelect = document.getElementById('notesSelect');
            const notesDisplaySection = document.getElementById('notesDisplaySection');
            const notesDisplay = document.getElementById('notesDisplay');
            let notes = '';
            if (notesInput && notesInput.style.display !== 'none' && notesInput.value.trim()) {
                notes = notesInput.value.trim();
            } else if (notesSelect && notesSelect.value && notesSelect.value !== '') {
                notes = notesSelect.value;
            }
            if (notes && notesDisplaySection && notesDisplay) {
                notesDisplay.textContent = notes;
                notesDisplaySection.style.display = 'block';
            } else if (notesDisplaySection) {
                notesDisplaySection.style.display = 'none';
            }
    }
        
        // 전체 견적 총 합계 섹션 표시
        // (넓이는 renderEstimatesList()에서 이미 설정되므로 여기서는 표시만 처리)
        const totalEstimatesSummaryEl = document.getElementById('totalEstimatesSummary');
        if (totalEstimatesSummaryEl) {
            totalEstimatesSummaryEl.style.display = 'block';
        }
        
        document.getElementById('totalAllBasePrice').textContent = formatNumber(totalBasePrice) + '원';
        document.getElementById('totalAllAdditionalPrice').textContent = formatNumber(totalAdditionalPrice) + '원';
        // 견적 1개일 경우 totalAllPrice 요소가 없을 수 있으므로 체크
        const totalAllPriceEl = document.getElementById('totalAllPrice');
        if (totalAllPriceEl) {
            totalAllPriceEl.textContent = formatNumber(totalPrice) + '원';
        }
        // 전체 최종 견적 표시 (인라인 스타일 직접 적용)
        const totalAllFinalPriceEl = document.getElementById('totalAllFinalPrice');
        if (totalAllFinalPriceEl) {
            totalAllFinalPriceEl.textContent = formatNumber(finalPrice) + '원';
            applyFinalPriceStyle(totalAllFinalPriceEl);
        }
        
        // 전체 쿠폰 정보 표시 (인라인 스타일 직접 적용)
        const totalAllCouponInfoEl = document.getElementById('totalAllCouponInfo');
        if (totalAllCouponInfoEl) {
            totalAllCouponInfoEl.textContent = couponValue > 0 ? `${formatNumber(couponValue)}할인(쿠폰적용)` : '쿠폰가 미적용';
            applyCouponDiscountStyle(totalAllCouponInfoEl, couponValue > 0);
        }
    }
    
    // 견적 추가 (null 체크 추가)
    const addEstimateBtnMain = document.getElementById('addEstimateBtn');
    if (addEstimateBtnMain) {
        addEstimateBtnMain.addEventListener('click', function() {
            const estimate = collectCurrentEstimate();
            if (!estimate) {
                alert('견적 정보를 입력해주세요.');
                return;
            }
            
            // editingEstimateId 확인
            const normalizedEditingId = normalizeId(editingEstimateId);
            
            if (normalizedEditingId) {
                // 수정 모드: 기존 견적 업데이트
                console.log('=== UPDATE MODE ===');
                console.log('editingEstimateId:', normalizedEditingId);
                console.log('Current estimates count:', estimates.length);
                
                const index = estimates.findIndex(est => isSameId(est.id, normalizedEditingId));
                
                if (index !== -1) {
                    console.log('Found estimate at index:', index, 'ID:', estimates[index].id);
                    // 원본 ID 유지 (절대 변경하지 않음!)
                    const originalId = estimates[index].id;
                    estimates[index] = { ...estimate, id: originalId };
                    console.log('Updated estimate:', estimates[index]);
                    editingEstimateId = null;
                    this.innerHTML = '<i class="fas fa-plus"></i> 견적 추가';
                } else {
                    console.error('견적을 찾을 수 없습니다.');
                    console.error('editingEstimateId:', normalizedEditingId);
                    console.error('Available IDs:', estimates.map(e => e.id));
                    alert('수정할 견적을 찾을 수 없습니다.');
                    return;
                }
            } else {
                // 추가 모드: 새 견적 추가
                console.log('=== ADD MODE ===');
                estimate.id = generateEstimateId();
                estimates.push(estimate);
                console.log('Added new estimate:', estimate);
            }
        
        renderEstimatesList();
        
        // 입력 폼 초기화
        document.getElementById('productSelect').value = '';
        document.getElementById('widthInput').value = '';
        document.getElementById('additionalOptionsContainer').innerHTML = '';
        document.getElementById('addEstimateBtn').style.display = 'none';
        
        // 제품 정보 및 견적 결과 초기화
        document.getElementById('productInfo').style.display = 'none';
        document.getElementById('baseEstimateSection').style.display = 'none';
        document.getElementById('totalBasePrice').textContent = '0원';
        document.getElementById('totalAdditionalPrice').textContent = '0원';
        document.getElementById('totalPrice').textContent = '0원';
        document.getElementById('finalPrice').textContent = '0원';
        document.getElementById('baseEstimateDetail').textContent = '';
        document.getElementById('additionalOptionsDetail').textContent = '';
        
        // 견적이 있으면 저장 버튼 표시
        if (estimates.length > 0) {
            document.getElementById('saveEstimateBtn').style.display = 'block';
        }
        
        // 합계 다시 계산 (초기화 후)
        calculateEstimate();
        calculateTotalEstimates();
        });
    }
    
    // 견적 수정/삭제 이벤트 위임 (document에 등록하여 동적 요소에도 작동)
    // 로딩 중 플래그로 중복 실행 방지
    let isLoadingEstimate = false;
    
    // document에 이벤트 위임 등록 (동적으로 생성되는 요소에도 작동)
    document.addEventListener('click', function(e) {
        // estimatesListContainer 내부의 요소인지 확인
        const container = document.getElementById('estimatesListContainer');
        if (!container || !container.contains(e.target)) {
            return;
        }
        
        // 로딩 중이면 무시
        if (isLoadingEstimate) {
            console.log('이미 견적을 로딩 중입니다. 대기 중...');
            return;
        }
        
        // 수정 버튼 클릭
        const editBtn = e.target.closest('.edit-estimate-btn');
        if (editBtn) {
            e.stopPropagation();
            e.preventDefault();
            isLoadingEstimate = true;
            const estimateId = normalizeId(editBtn.dataset.estimateId);
            console.log('Edit button clicked, ID:', estimateId);
            if (estimateId) {
                loadEstimateToInputForm(estimateId);
            } else {
                isLoadingEstimate = false;
            }
            return;
        }
        
        // 삭제 버튼 클릭
        const deleteBtn = e.target.closest('.delete-estimate-btn');
        if (deleteBtn) {
            e.stopPropagation();
            e.preventDefault();
            if (!confirm('이 견적을 삭제하시겠습니까?')) return;
            
            const estimateId = normalizeId(deleteBtn.dataset.estimateId);
            console.log('Delete button clicked, ID:', estimateId);
            
            if (estimateId) {
                estimates = estimates.filter(est => !isSameId(est.id, estimateId));
                
                if (isSameId(editingEstimateId, estimateId)) {
                    editingEstimateId = null;
                    const addBtn = document.getElementById('addEstimateBtn');
                    if (addBtn) {
                        addBtn.innerHTML = '<i class="fas fa-plus"></i> 견적 추가';
                    }
                }
                
                renderEstimatesList();
            }
            return;
        }
        
        // 카드 전체 클릭 시 수정 모드 진입 (버튼 클릭은 제외)
        const card = e.target.closest('.card[data-estimate-id]');
        if (card && !e.target.closest('button')) {
            isLoadingEstimate = true;
            const estimateId = normalizeId(card.dataset.estimateId);
            console.log('Card clicked, ID:', estimateId);
            if (estimateId) {
                loadEstimateToInputForm(estimateId);
            } else {
                isLoadingEstimate = false;
            }
        }
    });
    
    // 견적 데이터를 입력 폼에 로드하는 함수 (완전 재작성)
    function loadEstimateToInputForm(estimateId) {
        console.log('=== loadEstimateToInputForm START ===');
        console.log('Requested ID:', estimateId, 'Type:', typeof estimateId);
        
        // 다른 견적 수정 중인지 확인
        if (editingEstimateId) {
            const currentEstimate = estimates.find(est => isSameId(est.id, editingEstimateId));
            if (currentEstimate) {
                const hasChanges = confirm('현재 수정 중인 견적이 있습니다. 다른 견적을 불러오시겠습니까?\n(현재 수정 내용은 저장되지 않습니다)');
                if (!hasChanges) {
                    console.log('사용자가 취소했습니다.');
                    return;
                }
            }
        }
        
        // ID 정규화
        const normalizedId = normalizeId(estimateId);
        if (!normalizedId) {
            console.error('Invalid estimate ID');
            return;
        }
        
        // 견적 찾기
        const estimate = estimates.find(est => isSameId(est.id, normalizedId));
        
        if (!estimate) {
            console.error('견적을 찾을 수 없습니다.');
            console.error('Requested ID:', normalizedId);
            console.error('Available IDs:', estimates.map(e => e.id));
            alert(`견적을 찾을 수 없습니다. (ID: ${normalizedId})`);
            return;
        }

        console.log('Found estimate:', estimate);
        
        // 1. 폼 초기화
        document.getElementById('additionalOptionsContainer').innerHTML = '';
        
        // 2. 제품 선택 (재시도 로직 포함)
        const productSelect = document.getElementById('productSelect');
        const productId = estimate.productId;
        
        let checkInterval = null;
        
        function setProductSelection() {
            // 숫자/문자열 모두 시도
            productSelect.value = String(productId);
            
            if (!productSelect.value && productId) {
                // 모든 옵션 순회하며 찾기
                for (let i = 0; i < productSelect.options.length; i++) {
                    const optionValue = productSelect.options[i].value;
                    if (String(optionValue) === String(productId) || 
                        Number(optionValue) === Number(productId)) {
                        productSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // 제품 선택 성공 여부 확인
            const product = products.find(p => p.id === productId);
            if (product) {
                showProductInfo(product);
                console.log('제품 선택 성공:', product.name);
            } else {
                document.getElementById('productInfo').style.display = 'none';
                if (productId) {
                    console.warn('제품을 찾을 수 없습니다. ProductID:', productId);
                    // 제품 선택 실패 시에도 계속 진행하되 경고 표시
                    alert(`경고: 제품 ID ${productId}를 찾을 수 없습니다. 제품 정보가 표시되지 않을 수 있습니다.`);
                }
            }
        }
        
        // 제품 목록이 로드되지 않았으면 대기
        if (productSelect.options.length <= 1) {
            console.warn('제품 목록이 아직 로드되지 않았습니다. 대기 중...');
            checkInterval = setInterval(() => {
                if (productSelect.options.length > 1) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                    setProductSelection();
                }
            }, 100);
            
            // 최대 3초 대기 후 강제 실행
            setTimeout(() => {
                if (checkInterval) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                }
                setProductSelection();
            }, 3000);
        } else {
            setProductSelection();
        }
        
        // 3. 가로넓이 설정
        document.getElementById('widthInput').value = estimate.widthMm;
        console.log('Width set to:', estimate.widthMm);
        
        // 4. 추가 옵션 로드 (동기적으로 처리)
        const container = document.getElementById('additionalOptionsContainer');
        
        // 카테고리 옵션 목록 HTML 생성
        let allOptionsHtml = '<option value="">카테고리 > 옵션을 선택하세요</option>';
        if (wdCalculatorCategories && Array.isArray(wdCalculatorCategories)) {
            wdCalculatorCategories.forEach(category => {
                if (category && category.options && Array.isArray(category.options)) {
                    category.options.forEach(option => {
                        if (option && option.name && option.price !== undefined) {
                            allOptionsHtml += `<option value="${category.name}|${option.name}|${option.price}">${category.name} > ${option.name} (${formatNumber(option.price)}원)</option>`;
                        }
                    });
                }
            });
        }
        
        // 각 옵션을 순회하며 DOM에 추가
        if (estimate.options && Array.isArray(estimate.options) && estimate.options.length > 0) {
            estimate.options.forEach((opt, optIdx) => {
                if (!opt || !opt.name) return;
                
                const optionId = 'opt_' + Date.now() + '_' + optIdx;
                const escapedName = escapeHtml(opt.name || '');
                const optPrice = Math.max(0, parseFloat(opt.price) || 0);
                const optQuantity = Math.max(1, parseInt(opt.quantity) || 1);
                
                const optionHtml = `
                    <div class="additional-option-item" data-option-id="${optionId}">
                        <div class="row gx-2 align-items-center">
                            <div class="col-md-5">
                                <label class="form-label small">카테고리 > 옵션 선택</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle-direct-input title="직접입력">
                                        <i class="fas fa-keyboard"></i>
                                    </button>
                                    <select class="form-select form-select-sm category-option-select flex-grow-1" data-category-option-select style="display: none;">
                                        ${allOptionsHtml}
                                    </select>
                                    <input type="text" class="form-control form-control-sm option-name-input flex-grow-1" placeholder="또는 옵션명 직접 입력 (예: 화장대 > 화장대A)" data-option-name style="display: block;" value="${escapedName}">
                                </div>
                            </div>
                            <div class="col-md-3 price-col">
                                <label class="form-label small">가격 (원)</label>
                                <input type="text" class="form-control form-control-sm option-price-input" placeholder="가격을 입력하세요" data-option-price value="${formatPrice(optPrice)}" inputmode="numeric">
                            </div>
                            <div class="col-md-2 quantity-col">
                                <label class="form-label small">수량</label>
                                <input type="number" class="form-control form-control-sm option-quantity-input" placeholder="수량" min="1" step="1" value="${optQuantity}" data-option-quantity>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small" style="visibility: hidden;">작업</label>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-option-btn w-100" style="white-space: nowrap;">
                                    <i class="fas fa-times"></i> 삭제
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', optionHtml);
                
                // 즉시 이벤트 리스너 등록 (동기적으로)
                const item = container.lastElementChild;
                const select = item.querySelector('.category-option-select');
                const nameInput = item.querySelector('.option-name-input');
                const priceInput = item.querySelector('[data-option-price]');
                const quantityInput = item.querySelector('[data-option-quantity]');
                const toggleBtn = item.querySelector('[data-toggle-direct-input]');
                
                // 카테고리 선택 이벤트
                select.addEventListener('change', function() {
                    if (this.value && this.value !== '') {
                        const [categoryName, optionName, price] = this.value.split('|');
                        nameInput.value = `${categoryName} > ${optionName}`;
                        priceInput.value = formatPrice(price);
                        nameInput.style.display = 'none';
                        select.style.display = 'block';
                        calculateEstimate();
                    }
                });
                
                // 직접입력 토글 이벤트
                toggleBtn.addEventListener('click', function() {
                    if (nameInput.style.display === 'none') {
                        nameInput.style.display = 'block';
                        select.style.display = 'none';
                        select.value = '';
                        nameInput.value = '';
                        priceInput.value = '';
                        this.innerHTML = '<i class="fas fa-list"></i>';
                    } else {
                        nameInput.style.display = 'none';
                        select.style.display = 'block';
                        nameInput.value = '';
                        priceInput.value = '';
                        this.innerHTML = '<i class="fas fa-keyboard"></i>';
                    }
                    calculateEstimate();
                });
                
                // 가격 입력 필드에 콤마 포맷팅 적용
                priceInput.addEventListener('input', function() {
                    const cursorPosition = this.selectionStart;
                    const oldValue = this.value;
                    const formattedValue = formatPrice(this.value);
                    
                    this.value = formattedValue;
                    
                    // 커서 위치 조정 (콤마 추가로 인한 위치 변화 보정)
                    const diff = formattedValue.length - oldValue.length;
                    const newPosition = Math.max(0, cursorPosition + diff);
                    this.setSelectionRange(newPosition, newPosition);
                    
                    calculateEstimate();
                });
                
                // 가격 입력 필드 포커스 아웃 시 포맷팅 확정
                priceInput.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = formatPrice(this.value);
                    }
                });
                
                // 입력 이벤트
                nameInput.addEventListener('input', calculateEstimate);
                quantityInput.addEventListener('input', calculateEstimate);
                
                // 옵션 이름이 카테고리 목록에 있는지 확인
                let found = false;
                Array.from(select.options).forEach(option => {
                    const parts = option.value.split('|');
                    if (parts.length >= 2) {
                        const fullName = `${parts[0]} > ${parts[1]}`;
                        if (fullName === opt.name) {
                            select.value = option.value;
                            found = true;
                        }
                    }
                });
                
                // UI 업데이트
                if (found) {
                    nameInput.style.display = 'none';
                    select.style.display = 'block';
                    toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i>';
                } else {
                    nameInput.style.display = 'block';
                    select.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                }
            });
            console.log('Loaded', estimate.options.length, 'options');
        }
        
        // 4.5. 비고 정보 로드 (개별 견적의 비고)
        const notesInput = document.getElementById('notesInput');
        const notesSelect = document.getElementById('notesSelect');
        if (estimate.notes) {
            notesInput.value = estimate.notes;
            notesInput.style.display = 'block';
            notesSelect.style.display = 'none';
            notesSelect.value = '';
            const toggleBtn = document.getElementById('toggleNotesDirectInput');
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                toggleBtn.title = '선택 모드';
            }
        } else {
            notesInput.value = '';
            notesInput.style.display = 'none';
            notesSelect.style.display = 'block';
            notesSelect.value = '';
        }
        console.log('Notes loaded:', estimate.notes || '(empty)');
        
        // 5. editingEstimateId 설정 (원본 ID 유지)
        editingEstimateId = estimate.id;
        console.log('editingEstimateId set to:', editingEstimateId, 'Type:', typeof editingEstimateId);

        // 6. UI 업데이트
        document.getElementById('addEstimateBtn').innerHTML = '<i class="fas fa-save"></i> 견적 수정 적용'; 
        document.getElementById('addEstimateBtn').style.display = 'block';
        
        // 7. 스크롤 이동
        document.getElementById('productSelect').scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 8. 계산 수행
        calculateEstimate();
        
        console.log('=== loadEstimateToInputForm END ===');
        
        // 로딩 플래그 해제 (함수 완료 시)
        isLoadingEstimate = false;
    }
    
    // 견적 삭제는 이벤트 위임 패턴으로 estimatesListContainer에서 처리됨
    
    // 숫자 포맷팅 (천 단위 구분)
    function formatNumber(num) {
        return Math.round(num).toLocaleString('ko-KR');
    }
    
    // 계산 버튼 (null 체크 추가)
    const calculateBtn = document.getElementById('calculateBtn');
    if (calculateBtn) {
        calculateBtn.addEventListener('click', function() {
        calculateEstimate();
    });
    }
    
    // 초기 제품 목록 로드
    loadProducts();
    
    // 견적 검색 기능 (null 체크 추가)
    const searchEstimateBtn = document.getElementById('searchEstimateBtn');
    if (searchEstimateBtn) {
        searchEstimateBtn.addEventListener('click', function() {
            const searchCustomerNameInput = document.getElementById('searchCustomerName');
            if (!searchCustomerNameInput) {
                console.error('searchCustomerName element not found');
                return;
            }
            
            const customerName = searchCustomerNameInput.value.trim();
            if (!customerName) {
                alert('고객명을 입력해주세요.');
                return;
            }
            
            fetch(`/api/wdcalculator/search-estimates?customer_name=${encodeURIComponent(customerName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySearchResults(data.estimates);
                    } else {
                        alert(data.message || '검색 중 오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('검색 중 오류가 발생했습니다.');
                });
        });
    }
    // searchEstimateBtn은 사이드바 검색 기능이므로 없어도 정상 작동함 (경고 무시)
    
    // 검색 결과 표시
    function displaySearchResults(estimates) {
        const container = document.getElementById('searchResultsList');
        const resultsDiv = document.getElementById('searchResults');
        
        if (estimates.length === 0) {
            container.innerHTML = '<p class="text-muted">검색 결과가 없습니다.</p>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        let html = '<div class="list-group">';
        estimates.forEach(estimate => {
            const estimateData = estimate.estimate_data;
            const totalPrice = estimateData.totalPrice || 0;
            const basePrice = estimateData.basePrice || 0;
            const additionalPrice = estimateData.additionalPrice || 0;
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${estimate.customer_name}</h6>
                            <small class="text-muted">생성일: ${estimate.created_at}</small>
                            <div class="mt-2">
                                <small>기본 견적: ${formatNumber(basePrice)}원</small><br>
                                <small>추가 옵션: ${formatNumber(additionalPrice)}원</small><br>
                                <strong>총 견적: ${formatNumber(totalPrice)}원</strong>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary load-estimate-btn" data-estimate-id="${estimate.id}">
                                <i class="fas fa-download"></i> 불러오기
                            </button>
                            <button class="btn btn-sm btn-success match-order-btn mt-1" data-estimate-id="${estimate.id}" data-customer-name="${estimate.customer_name}">
                                <i class="fas fa-link"></i> 주문 매칭
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        resultsDiv.style.display = 'block';
    }
    
    // 견적 불러오기
    document.addEventListener('click', function(e) {
        if (e.target.closest('.load-estimate-btn')) {
            const estimateId = parseInt(e.target.closest('.load-estimate-btn').dataset.estimateId);
            const customerName = document.getElementById('searchCustomerName').value.trim();
            
            // 고객명으로 다시 검색하여 해당 견적 찾기
            fetch(`/api/wdcalculator/search-estimates?customer_name=${encodeURIComponent(customerName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const estimate = data.estimates.find(est => est.id === estimateId);
                        if (estimate) {
                            loadEstimateToForm(estimate);
                        } else {
                            alert('견적을 찾을 수 없습니다.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('견적을 불러오는 중 오류가 발생했습니다.');
                });
        }
    });
    
    // 견적을 폼에 로드
    function loadEstimateToForm(estimate) {
        currentDatabaseEstimateId = estimate.id; // DB ID 저장
        
        // 편집 모드 알림 표시
        const headerTitle = document.querySelector('.header-primary h6');
        if (headerTitle) {
            headerTitle.innerHTML = `<i class="fas fa-edit me-2"></i>견적 수정: ${estimate.customer_name} <span class="badge bg-warning text-dark ms-2">수정모드</span>`;
        }
        
        // 취소(새 견적 작성) 버튼 표시
        let resetBtn = document.getElementById('resetEstimateBtn');
        if (!resetBtn) {
            const btnContainer = document.querySelector('.header-primary');
            resetBtn = document.createElement('button');
            resetBtn.id = 'resetEstimateBtn';
            resetBtn.className = 'btn btn-sm btn-light float-end';
            resetBtn.innerHTML = '<i class="fas fa-undo"></i> 새 견적 작성';
            resetBtn.onclick = function() {
                if(confirm('현재 작성/수정 중인 내용을 초기화하고 새 견적을 작성하시겠습니까?')) {
                    location.reload();
                }
            };
            btnContainer.appendChild(resetBtn);
        }

        const estimateData = estimate.estimate_data;
        
        // 고객명 설정
        document.getElementById('customerName').value = estimate.customer_name;
        
        // 비고 정보 로드 (개별 견적의 비고를 우선 사용, 없으면 전체 견적의 비고 사용)
        const notesInput = document.getElementById('notesInput');
        const notesSelect = document.getElementById('notesSelect');
        // estimate 객체에 직접 notes가 있는지 확인 (개별 견적의 비고)
        // 없으면 estimateData.notes 사용 (전체 견적의 비고)
        const notesToLoad = estimate.notes || estimateData.notes || '';
        if (notesToLoad) {
            notesInput.value = notesToLoad;
            notesInput.style.display = 'block';
            notesSelect.style.display = 'none';
            notesSelect.value = '';
            const toggleBtn = document.getElementById('toggleNotesDirectInput');
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                toggleBtn.title = '선택 모드';
            }
        } else {
            notesInput.value = '';
            notesInput.style.display = 'none';
            notesSelect.style.display = 'block';
            notesSelect.value = '';
        }
        console.log('Notes loaded:', notesToLoad || '(empty)', 'from estimate.notes:', estimate.notes || '(none)', 'from estimateData.notes:', estimateData.notes || '(none)');
        
        // 견적 목록 초기화
        estimates = [];
        
        // 저장된 견적 데이터의 estimates 배열을 현재 견적 목록에 로드
        if (estimateData.estimates && estimateData.estimates.length > 0) {
            // 전체 견적의 비고 정보 (각 견적에 공통으로 적용)
            const globalNotes = estimateData.notes || '';
            
            estimates = estimateData.estimates.map((est, idx) => {
                // ID를 문자열로 통일 (저장된 ID가 있으면 사용, 없으면 새로 생성)
                const newId = est.id ? String(est.id) : generateEstimateId();
                console.log(`Loading estimate ${idx + 1}: ID=${newId} (original: ${est.id})`);
                return {
                    id: newId,
                    productId: est.productId,
                    productName: est.productName,
                    widthMm: est.widthMm,
                    basePrice: est.basePrice,
                    options: est.options || [],
                    additionalPrice: est.additionalPrice || 0,
                    totalPrice: est.totalPrice || 0,
                    notes: est.notes || globalNotes // 개별 비고가 있으면 사용, 없으면 전체 비고 사용
                };
            });
            console.log('Loaded estimates:', estimates.map(e => ({ id: e.id, type: typeof e.id })));
            
            // 견적 목록 렌더링
            renderEstimatesList();

            // 저장 버튼 표시 (불러온 직후에도 수정/저장 가능하게)
            const saveBtnAfterLoad = document.getElementById('saveEstimateBtn');
            if (saveBtnAfterLoad) {
                saveBtnAfterLoad.style.display = 'block';
            }
            
            // 입력 폼 초기화 (첫 번째 견적 자동 로드 제거)
            document.getElementById('productSelect').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('additionalOptionsContainer').innerHTML = '';
            document.getElementById('productInfo').style.display = 'none';
            document.getElementById('baseEstimateSection').style.display = 'none';
            // 버튼은 숨기지 않음 - 사용자가 견적을 선택하면 수정 적용 버튼이 표시됨
            document.getElementById('addEstimateBtn').innerHTML = '<i class="fas fa-plus"></i> 견적 추가';
            document.getElementById('addEstimateBtn').style.display = 'none';
            
            // 알림 메시지 제거 (중복 팝업 방지)
            // alert('견적을 불러왔습니다.\n아래 "진행 중인 견적" 목록에서 수정할 항목을 선택하세요.');
            
            // 계산 실행 (초기화 상태로)
            calculateEstimate();
            
            // 저장 버튼은 이미 표시되어 있음 (위에서 설정)
            // 수정 적용 버튼은 견적을 선택했을 때 표시됨
        }
    }
    
    // 주문 매칭 기능
    document.addEventListener('click', function(e) {
        if (e.target.closest('.match-order-btn')) {
            const estimateId = parseInt(e.target.closest('.match-order-btn').dataset.estimateId);
            const customerName = e.target.closest('.match-order-btn').dataset.customerName;
            
            // FOMS 주문 검색
            fetch(`/api/wdcalculator/search-orders?customer_name=${encodeURIComponent(customerName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.orders.length === 0) {
                            alert('해당 고객명의 주문이 없습니다.');
                            return;
                        }
                        
                        if (data.orders.length === 1) {
                            // 주문이 1개면 바로 매칭
                            matchEstimateToOrder(estimateId, data.orders[0].id);
                        } else {
                            // 주문이 여러 개면 선택
                            showOrderSelectionModal(estimateId, data.orders);
                        }
                    } else {
                        alert(data.message || '주문 검색 중 오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('주문 검색 중 오류가 발생했습니다.');
                });
        }
    });
    
    // 주문 선택 모달 표시
    function showOrderSelectionModal(estimateId, orders) {
        let html = '<div class="modal fade" id="orderSelectionModal" tabindex="-1">';
        html += '<div class="modal-dialog modal-lg"><div class="modal-content">';
        html += '<div class="modal-header"><h5 class="modal-title">주문 선택</h5>';
        html += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>';
        html += '<div class="modal-body"><div class="list-group">';
        
        orders.forEach(order => {
            html += `
                <button type="button" class="list-group-item list-group-item-action select-order-btn" 
                        data-estimate-id="${estimateId}" data-order-id="${order.id}">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>주문 #${order.id}</strong><br>
                            <small>고객명: ${order.customer_name}</small><br>
                            <small>전화번호: ${order.phone}</small><br>
                            <small>제품: ${order.product}</small><br>
                            <small>상태: ${order.status}</small>
                        </div>
                    </div>
                </button>
            `;
        });
        
        html += '</div></div></div></div></div>';
        
        // 기존 모달 제거
        const existingModal = document.getElementById('orderSelectionModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('orderSelectionModal'));
        modal.show();
        
        // 주문 선택 이벤트
        document.querySelectorAll('.select-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const estId = parseInt(this.dataset.estimateId);
                const ordId = parseInt(this.dataset.orderId);
                matchEstimateToOrder(estId, ordId);
                modal.hide();
            });
        });
    }
    
    // 견적과 주문 매칭
    function matchEstimateToOrder(estimateId, orderId) {
        fetch('/api/wdcalculator/match-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                estimate_id: estimateId,
                order_id: orderId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('견적과 주문이 매칭되었습니다.');
            } else {
                alert(data.message || '매칭 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('매칭 중 오류가 발생했습니다.');
        });
    }
    
    // 견적 저장 기능
    // 견적 저장 버튼 (null 체크 추가)
    const saveEstimateBtn = document.getElementById('saveEstimateBtn');
    if (saveEstimateBtn) {
        saveEstimateBtn.addEventListener('click', function() {
        const customerName = document.getElementById('customerName').value.trim();
        if (!customerName) {
            alert('고객명을 입력해주세요.');
            return;
        }
        
        // 현재 진행 중인 견적이 없으면 현재 계산된 견적을 추가
        let estimatesToSave = estimates;
        if (estimatesToSave.length === 0) {
            // 현재 폼의 견적을 수집
            const currentEstimate = collectCurrentEstimate();
            if (!currentEstimate) {
                alert('저장할 견적이 없습니다. 먼저 견적을 계산해주세요.');
                return;
            }
            // 현재 견적을 배열에 추가
            currentEstimate.id = generateEstimateId();
            estimatesToSave = [currentEstimate];
        }
        
        // 비고 정보 수집
        const notesInput = document.getElementById('notesInput');
        const notesSelect = document.getElementById('notesSelect');
        let notes = '';
        if (notesInput && notesInput.style.display !== 'none' && notesInput.value.trim()) {
            notes = notesInput.value.trim();
        } else if (notesSelect && notesSelect.value && notesSelect.value !== '') {
            notes = notesSelect.value;
        }
        
        // 현재 견적 목록을 저장
        const estimateData = {
            estimates: estimatesToSave,
            totalBasePrice: estimatesToSave.reduce((sum, est) => sum + est.basePrice, 0),
            totalAdditionalPrice: estimatesToSave.reduce((sum, est) => sum + est.additionalPrice, 0),
            totalPrice: estimatesToSave.reduce((sum, est) => sum + est.totalPrice, 0),
            notes: notes // 비고 정보 추가
        };
        
        fetch('/api/wdcalculator/save-estimate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                estimate_id: currentDatabaseEstimateId,
                customer_name: customerName,
                estimate_data: estimateData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // 서버 메시지 사용 (저장/수정 구분)
                // 저장된 견적을 진행 중인 견적 목록에 추가 (선택사항)
                // estimates = []; // 목록 초기화하지 않음 (사용자가 계속 추가할 수 있도록)
                renderEstimatesList();
                
                // 신규 저장이면 ID 업데이트하여 연속 수정 가능하게 함
                if (data.estimate_id) {
                    currentDatabaseEstimateId = data.estimate_id;
                    const headerTitle = document.querySelector('.header-primary h6');
                    if (headerTitle) {
                        headerTitle.innerHTML = `<i class="fas fa-edit me-2"></i>견적 수정: ${customerName} <span class="badge bg-warning text-dark ms-2">수정모드</span>`;
                    }
                }
                
                // 목록 새로고침
                setTimeout(() => loadSidebarEstimates(), 500);
            } else {
                alert(data.message || '견적 저장 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('견적 저장 중 오류가 발생했습니다.');
        });
        });
    } else {
        console.warn('saveEstimateBtn element not found');
    }
    
    // 견적 추가 시 저장 버튼 표시 (null 체크 추가)
    const addEstimateBtn = document.getElementById('addEstimateBtn');
    if (addEstimateBtn) {
        const originalAddEstimate = addEstimateBtn.onclick;
        addEstimateBtn.addEventListener('click', function() {
            if (originalAddEstimate) originalAddEstimate.call(this);
            if (estimates.length > 0) {
                const saveBtn = document.getElementById('saveEstimateBtn');
                if (saveBtn) {
                    saveBtn.style.display = 'block';
                }
            }
        });
    }
    
    // === 사이드바 견적 목록 기능 ===
    
    const sidebarSearchInput = document.getElementById('sidebarSearchInput');
    const sidebarSearchBtn = document.getElementById('sidebarSearchBtn');
    const refreshEstimatesBtn = document.getElementById('refreshEstimatesBtn');
    const savedEstimatesList = document.getElementById('savedEstimatesList');
    const savedEstimatesLoading = document.getElementById('savedEstimatesLoading');
    const noSavedEstimates = document.getElementById('noSavedEstimates');
    
    // 목록 불러오기 함수
    function loadSidebarEstimates(searchQuery = '') {
        if (!savedEstimatesList) return;
        
        savedEstimatesLoading.style.display = 'block';
        savedEstimatesList.innerHTML = '';
        noSavedEstimates.style.display = 'none';
        
        // 캐시 방지용 타임스탬프 추가
        let url = `/api/wdcalculator/search-estimates?_t=${Date.now()}`;
        if (searchQuery) {
            url += `&customer_name=${encodeURIComponent(searchQuery)}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                savedEstimatesLoading.style.display = 'none';
                
                if (data.success && data.estimates.length > 0) {
                    data.estimates.forEach(est => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item list-group-item-action p-3 border-bottom';
                        
                        // 날짜 포맷팅
                        const dateStr = est.created_at ? new Date(est.created_at).toLocaleDateString() : '';
                        
                        // 총 금액 계산 (데이터 구조에 따라 다름)
                        let totalPrice = 0;
                        let productNames = [];
                        
                        if (est.estimate_data) {
                            if (est.estimate_data.totalPrice) {
                                totalPrice = est.estimate_data.totalPrice;
                            }
                            
                            // 포함된 제품명 요약
                            if (est.estimate_data.estimates && Array.isArray(est.estimate_data.estimates)) {
                                productNames = est.estimate_data.estimates.map(e => e.productName || (e.product ? e.product.name : '알 수 없음'));
                            }
                        }
                        
                        const productNameStr = productNames.length > 0 
                            ? (productNames.length > 1 ? `${productNames[0]} 외 ${productNames.length - 1}건` : productNames[0])
                            : '제품 정보 없음';
                        
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 fw-bold text-truncate" style="max-width: 140px;">${est.customer_name}</h6>
                                <small class="text-muted">${dateStr}</small>
                            </div>
                            <p class="mb-1 small text-dark">${productNameStr}</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="fw-bold text-primary">${formatNumber(totalPrice)}원</span>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-xs btn-outline-primary load-estimate-btn" data-id="${est.id}" title="불러오기">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                    <button class="btn btn-xs btn-outline-success match-order-btn" data-estimate-id="${est.id}" data-customer-name="${est.customer_name}" title="주문 매칭">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button class="btn btn-xs btn-outline-danger delete-estimate-btn" data-id="${est.id}" title="삭제">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // 불러오기 버튼 이벤트
                        const loadBtn = item.querySelector('.load-estimate-btn');
                        loadBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // 부모 클릭 방지
                            if (confirm(`'${est.customer_name}' 님의 견적을 불러오시겠습니까?\n현재 작성 중인 내용은 사라질 수 있습니다.`)) {
                                loadEstimateToForm(est);
                            }
                        });
                        
                        // 삭제 버튼 이벤트
                        const deleteBtn = item.querySelector('.delete-estimate-btn');
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(`정말로 '${est.customer_name}' 님의 견적을 삭제하시겠습니까?`)) {
                                deleteEstimate(est.id);
                            }
                        });
                        
                        savedEstimatesList.appendChild(item);
                    });
                } else {
                    noSavedEstimates.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading estimates:', error);
                savedEstimatesLoading.style.display = 'none';
                savedEstimatesList.innerHTML = '<div class="text-center text-danger py-3">목록을 불러오는 중 오류가 발생했습니다.</div>';
            });
    }
    
    // 견적 삭제 함수
    function deleteEstimate(id) {
        fetch(`/api/wdcalculator/estimate/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert('삭제되었습니다.'); // 너무 잦은 알림 방지
                loadSidebarEstimates(sidebarSearchInput.value); // 목록 새로고침
            } else {
                alert(data.message || '삭제 실패');
            }
        })
        .catch(error => {
            console.error('Error deleting estimate:', error);
            alert('삭제 중 오류가 발생했습니다.');
        });
    }
    
    // 검색 이벤트
    if (sidebarSearchBtn) {
        sidebarSearchBtn.addEventListener('click', () => {
            loadSidebarEstimates(sidebarSearchInput.value);
        });
    }
    
    if (sidebarSearchInput) {
        sidebarSearchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                loadSidebarEstimates(sidebarSearchInput.value);
            }
        });
    }
    
    if (refreshEstimatesBtn) {
        refreshEstimatesBtn.addEventListener('click', () => {
            sidebarSearchInput.value = '';
            loadSidebarEstimates();
        });
    }
    
    // 초기 목록 로드
    loadSidebarEstimates();
    
    // 견적 저장 후 목록 새로고침 (기존 저장 로직에 연결)
    // 기존 fetch 성공 콜백 내부에 renderEstimatesList() 호출 부분이 있으므로,
    // 이벤트를 감지하거나 함수를 오버라이드 해야 함.
    // 가장 간단한 방법은 기존 저장 버튼 이벤트 리스너 내에서 loadSidebarEstimates()를 호출하도록 수정하는 것인데,
    // 이미 이벤트 리스너가 등록되어 있으므로, 여기서는 setInterval로 주기적 체크하거나
    // 사용자가 '저장'을 눌렀을 때 목록이 갱신되도록 saveEstimateBtn의 이벤트를 수정하는 게 좋음.
    
    // 기존 저장 버튼 이벤트에 목록 갱신 추가
    if (saveEstimateBtn) {
        // addEventListener는 중복 등록 가능하므로, 추가적인 동작만 등록
        saveEstimateBtn.addEventListener('click', function() {
            // 저장이 완료될 즈음 (약간의 지연 후) 목록 갱신 시도
            setTimeout(() => loadSidebarEstimates(), 1000);
        });
    }
    
    // URL 파라미터에서 estimate_id 읽기 및 자동 로드
    const urlParams = new URLSearchParams(window.location.search);
    const estimateIdFromUrl = urlParams.get('estimate_id');
    const orderIdFromUrl = urlParams.get('order_id');
    
    // order_id가 있으면 주문으로 돌아가기 버튼 표시
    if (orderIdFromUrl) {
        // 저장 버튼 옆에 "주문으로 돌아가기" 버튼 추가
        const saveBtnContainer = document.getElementById('saveEstimateBtn')?.parentElement;
        if (saveBtnContainer) {
            let backToOrderBtn = document.getElementById('backToOrderBtn');
            if (!backToOrderBtn) {
                backToOrderBtn = document.createElement('a');
                backToOrderBtn.id = 'backToOrderBtn';
                backToOrderBtn.className = 'btn btn-secondary ms-2';
                backToOrderBtn.href = `/edit/${orderIdFromUrl}`;
                backToOrderBtn.innerHTML = '<i class="fas fa-arrow-left"></i> 주문으로 돌아가기';
                saveBtnContainer.appendChild(backToOrderBtn);
            }
        }
    }
    
    // estimate_id가 있으면 해당 견적을 자동으로 로드
    if (estimateIdFromUrl) {
        console.log('URL에서 견적 ID 발견:', estimateIdFromUrl);
        
        // 제품 목록이 로드된 후 견적 로드
        const loadEstimateFromUrl = () => {
            console.log('견적 로드 시작, ID:', estimateIdFromUrl);
            fetch(`/api/wdcalculator/estimate/${estimateIdFromUrl}`)
                .then(response => {
                    console.log('API 응답 상태:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API 응답 데이터:', data);
                    if (data.success && data.estimate) {
                        console.log('견적 로드 성공:', data.estimate);
                        // 제품 목록이 로드되었는지 확인
                        if (products.length === 0) {
                            console.warn('제품 목록이 아직 로드되지 않았습니다. 잠시 대기 후 재시도합니다.');
                            setTimeout(() => {
                                if (products.length > 0) {
                                    loadEstimateToForm(data.estimate);
                                    setTimeout(() => loadSidebarEstimates(), 500);
                                } else {
                                    alert('제품 목록을 불러올 수 없어 견적을 로드할 수 없습니다. 페이지를 새로고침해주세요.');
                                }
                            }, 1000);
                        } else {
                            loadEstimateToForm(data.estimate);
                            // 사이드바도 새로고침
                            setTimeout(() => loadSidebarEstimates(), 500);
                        }
                    } else {
                        console.error('견적 로드 실패:', data);
                        alert('견적을 불러오는 중 오류가 발생했습니다: ' + (data.message || '알 수 없는 오류'));
                    }
                })
                .catch(error => {
                    console.error('견적 로드 중 오류:', error);
                    alert('견적을 불러오는 중 오류가 발생했습니다: ' + error.message);
                });
        };
        
        // 제품 목록이 이미 로드되었는지 확인
        if (products.length > 0) {
            // 이미 로드되었으면 바로 실행
            loadEstimateFromUrl();
        } else {
            // 아직 로드 중이면 제품 로드 완료를 기다림
            const checkProductsLoaded = setInterval(() => {
                if (products.length > 0) {
                    clearInterval(checkProductsLoaded);
                    loadEstimateFromUrl();
                }
            }, 100);
            
            // 최대 5초 대기
            setTimeout(() => {
                clearInterval(checkProductsLoaded);
                if (products.length === 0) {
                    console.warn('제품 목록 로드를 기다리는 중 시간 초과. 견적 로드를 시도합니다.');
                    loadEstimateFromUrl();
                }
            }, 5000);
        }
    }
    
    // 쿠폰 입력 필드 변경 시 자동 재계산 (강력한 이벤트 처리)
    const couponInputField = document.getElementById('globalCouponValue');
    if (couponInputField) {
        // 초기값 확인 및 설정
        if (!couponInputField.value || couponInputField.value === '0') {
            couponInputField.value = DEFAULT_COUPON_VALUE;
            console.log('쿠폰 입력 필드 초기값 설정:', DEFAULT_COUPON_VALUE);
        }
        
        // input 이벤트: 타이핑 중에도 실시간 반영
        couponInputField.addEventListener('input', function() {
            const newValue = this.value;
            console.log('쿠폰 값 변경됨 (input):', newValue);
            // 약간의 지연을 두어 연속 입력 처리
            setTimeout(() => {
                const currentValue = getCouponValue();
                console.log('재계산 실행 - 쿠폰 값:', currentValue);
                calculateEstimate();
                if (estimates.length > 0) {
                    calculateTotalEstimates();
                }
            }, 100);
        });
        
        // change 이벤트: 포커스 아웃 시 확정
        couponInputField.addEventListener('change', function() {
            const newValue = this.value;
            console.log('쿠폰 값 확정됨 (change):', newValue);
            const currentValue = getCouponValue();
            console.log('재계산 실행 - 쿠폰 값:', currentValue);
            calculateEstimate();
            if (estimates.length > 0) {
                calculateTotalEstimates();
            }
        });
        
        // blur 이벤트: 포커스를 잃을 때도 재계산
        couponInputField.addEventListener('blur', function() {
            const newValue = this.value;
            console.log('쿠폰 입력 필드 포커스 아웃 (blur):', newValue);
            const currentValue = getCouponValue();
            console.log('재계산 실행 - 쿠폰 값:', currentValue);
            calculateEstimate();
            if (estimates.length > 0) {
                calculateTotalEstimates();
            }
        });
        
        console.log('쿠폰 입력 필드 이벤트 리스너 등록 완료, 현재 값:', couponInputField.value);
        
        // 초기 로드 시 한 번 계산 실행 (스타일 적용 확인)
        setTimeout(() => {
            console.log('초기 로드 후 계산 실행');
            calculateEstimate();
            if (estimates.length > 0) {
                calculateTotalEstimates();
            }
        }, 500);
    } else {
        console.error('쿠폰 입력 필드를 찾을 수 없습니다!');
    }

});
</script>
{% endblock %}