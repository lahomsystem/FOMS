{% extends "layout.html" %}

{% block content %}
{% set filters = filters or {} %}
<div class="container-fluid erp-dashboard erp-pro">
  <!-- Modern Header -->
  <header class="erp-pro-header">
    <h1 class="erp-pro-header__title">
      <i class="fas fa-hammer"></i>
      <span>시공 대시보드</span>
    </h1>
    <div class="erp-pro-header__actions">
      <!-- 알림 버튼 -->
      <button class="erp-pro-btn erp-pro-btn--icon" id="notification-btn" title="알림"
        onclick="toggleNotificationPanel()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
      </button>
      <a class="erp-pro-btn erp-pro-btn--primary" href="{{ url_for('order_pages.add_order', open='erp-beta') }}">
        <i class="fas fa-plus"></i>
        <span>주문 생성</span>
      </a>
      <a class="erp-pro-btn erp-pro-btn--secondary" href="{{ url_for('order_pages.index') }}">
        <i class="fas fa-home"></i>
        <span class="d-none d-md-inline">홈</span>
      </a>
    </div>
  </header>
  {% set erp_sub_nav_active = 'construction' %}
  {% include 'partials/erp_sub_nav.html' %}

  <!-- Process Map - Modern Pipeline Design -->
  <div class="erp-pro-card">
    <div class="erp-pro-card__header erp-pro-card__header--with-alerts">
      <h3 class="erp-pro-card__title">
        <i class="fas fa-project-diagram"></i>
        프로세스 맵
      </h3>
      <div class="erp-pro-alerts">
        <div
          class="erp-pro-alert erp-pro-alert--danger {% if filters.get('alert_type') == 'urgent' %}erp-pro-alert--active{% endif %}"
          data-alert-type="urgent" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-bolt"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">긴급 발주</span>
            <span class="erp-pro-alert__value">{{ kpis.urgent_count }}</span>
          </div>
        </div>
        <div
          class="erp-pro-alert erp-pro-alert--warning {% if filters.get('alert_type') == 'measurement_d4' %}erp-pro-alert--active{% endif %}"
          data-alert-type="measurement_d4" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-ruler-combined"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">실측 D-4</span>
            <span class="erp-pro-alert__value">{{ kpis.measurement_d4_count }}</span>
          </div>
        </div>
        <div
          class="erp-pro-alert erp-pro-alert--warning {% if filters.get('alert_type') == 'construction_d3' %}erp-pro-alert--active{% endif %}"
          data-alert-type="construction_d3" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-tools"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">시공 D-3</span>
            <span class="erp-pro-alert__value">{{ kpis.construction_d3_count }}</span>
          </div>
        </div>
        <div
          class="erp-pro-alert erp-pro-alert--info {% if filters.get('alert_type') == 'production_d2' %}erp-pro-alert--active{% endif %}"
          data-alert-type="production_d2" role="button" tabindex="0">
          <div class="erp-pro-alert__icon">
            <i class="fas fa-industry"></i>
          </div>
          <div class="erp-pro-alert__content">
            <span class="erp-pro-alert__label">생산 D-2</span>
            <span class="erp-pro-alert__value">{{ kpis.production_d2_count }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="erp-pro-card__body">
      <div class="erp-pro-pipeline">
        {% for step in process_steps %}
        {% set is_step_active = (filters.get('stage') or '') == step.label %}
        <div class="erp-pro-pipeline__stage {% if is_step_active %}erp-pro-pipeline__stage--active{% endif %}"
          data-stage="{{ step.label }}" role="button" tabindex="0"
          title="클릭하면 '{{ step.display|default(step.label) }}' 단계만 표시">
          <div class="erp-pro-pipeline__count">
            {{ step.count }}
            {% if step.overdue > 0 %}
            <span class="erp-pro-badge erp-pro-badge--danger erp-pro-badge--sm" title="지연">{{ step.overdue }}</span>
            {% endif %}
            {% if step.imminent > 0 %}
            <span class="erp-pro-badge erp-pro-badge--warning erp-pro-badge--sm" title="임박">{{ step.imminent }}</span>
            {% endif %}
          </div>
          <div class="erp-pro-pipeline__label">{{ step.display|default(step.label) }}</div>
        </div>
        {% if not loop.last %}
        <div class="erp-pro-pipeline__connector">
          <i class="fas fa-chevron-right"></i>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 3-Panel Layout -->
  <style>
    /* ============================================
       제품 항목 테이블 - 모바일 스타일 기반 (PC는 그리드만 추가)
       ============================================ */
    .erp-row-selected {
      background: rgba(13, 110, 253, .08) !important;
    }

    .erp-detail-panel {
      position: sticky;
      top: 76px;
      max-height: calc(100vh - 92px);
      overflow: auto;
    }

    .erp-kv {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .erp-kv .k {
      color: #6c757d;
    }

    .erp-kv .v {
      font-weight: 600;
      text-align: right;
    }

    /* ERP 대시보드 내부 섹션에 padding 적용 */
    .erp-dashboard>.d-flex,
    .erp-dashboard>.row,
    .erp-dashboard>.card {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    /* 상단 알람 타일: 1줄 고정 레이아웃 */
    .erp-alert-row {
      flex-wrap: nowrap;
      overflow: hidden;
    }

    .erp-alert-col {
      flex: 0 0 25%;
      max-width: 25%;
    }

    /* erp-dashboard-layout은 전체 너비 사용, 내부 요소에 padding 적용 */
    .erp-dashboard-layout {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 16px;
      align-items: start;
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      padding-left: 1rem;
      padding-right: 1rem;
      box-sizing: border-box !important;
      margin: 0 !important;
    }

    .erp-dashboard-filters,
    .erp-dashboard-workqueue {
      min-width: 0;
    }

    .erp-dashboard-workqueue {
      min-width: 0;
      flex: 1;
    }

    @media (max-width: 1400px) {
      .erp-dashboard-layout {
        grid-template-columns: 240px minmax(0, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .erp-dashboard-layout {
        grid-template-columns: 220px minmax(0, 1fr);
      }
    }

    @media (max-width: 992px) {
      .erp-alert-row {
        --bs-gutter-x: 0.35rem;
        --bs-gutter-y: 0.35rem;
      }

      .erp-alert-col {
        flex: 0 0 25%;
        max-width: 25%;
      }

      .erp-process-row {
        overflow-x: auto;
      }

      .erp-dashboard-layout {
        grid-template-columns: 1fr;
        width: 100%;
        max-width: 100%;
        gap: 12px;
      }

      .erp-dashboard-workqueue {
        width: 100%;
        max-width: 100%;
      }
    }

    /* 제품 항목 카드 그리드 (모바일 + PC 공통, 전역) */
    .erp-product-items-grid {
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: 1rem !important;
      width: 100% !important;
    }

    .erp-product-items-card {
      border: 1px solid #dee2e6 !important;
      border-radius: 8px !important;
      padding: 1rem !important;
      background: #fff !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    }

    .erp-product-items-row {
      display: grid !important;
      grid-template-columns: 70px minmax(0, 1fr) !important;
      column-gap: 4px !important;
      padding: 0.4rem 0 !important;
      border-bottom: 1px solid #f0f0f0 !important;
    }

    .erp-product-items-row:last-child {
      border-bottom: none !important;
    }

    .erp-product-items-label {
      font-weight: 700 !important;
      color: #0d6efd !important;
      font-size: var(--erp-detail-font, 1.1rem) !important;
      white-space: nowrap !important;
    }

    .erp-product-items-value {
      color: #212529 !important;
      font-size: var(--erp-detail-font, 1.1rem) !important;
      font-weight: 700 !important;
      white-space: normal !important;
      word-break: normal !important;
      overflow-wrap: break-word !important;
      min-width: 0 !important;
    }

    @media (min-width: 993px) {
      .erp-product-items-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    }

    /* 가독성 개선 스타일 - 텍스트 크기 증가 */
    #erp-grid {
      font-size: 1rem;
    }

    #erp-grid thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      padding: 1rem 0.75rem;
      white-space: nowrap;
      font-size: 1rem;
    }

    #erp-grid thead th:last-child {
      border-right: none;
    }

    #erp-grid tbody td {
      padding: 1rem 0.75rem;
      vertical-align: middle;
      border-bottom: 1px solid #e9ecef;
      border-right: 1px solid #e9ecef;
      font-size: 1rem;
    }

    #erp-grid tbody td:last-child {
      border-right: none;
    }

    #erp-grid tbody tr:hover {
      background-color: #f8f9fa;
    }

    #erp-grid .fw-bold {
      font-weight: 600 !important;
      color: #212529;
      font-size: 1rem;
    }

    #erp-grid .text-muted {
      color: #6c757d !important;
      font-size: 0.95rem;
    }

    /* 키워드 강조 */
    #erp-grid .badge {
      font-weight: 600;
      padding: 0.5em 0.75em;
      font-size: 0.95rem;
    }

    #erp-grid .badge.bg-danger {
      background-color: #dc3545 !important;
      color: #fff !important;
    }

    #erp-grid .badge.bg-warning {
      background-color: #ffc107 !important;
      color: #000 !important;
    }

    #erp-grid .badge.bg-success {
      background-color: #198754 !important;
      color: #fff !important;
    }

    #erp-grid .badge.bg-secondary {
      background-color: #6c757d !important;
      color: #fff !important;
    }

    #erp-grid .badge.bg-info {
      background-color: #0dcaf0 !important;
      color: #000 !important;
    }

    #erp-grid .badge.bg-primary {
      background-color: #0d6efd !important;
      color: #fff !important;
    }

    /* 버튼 스타일 개선 */
    #erp-grid .btn-sm {
      font-weight: 500;
      padding: 0.4rem 0.75rem;
      font-size: 1rem;
    }

    /* 텍스트 가독성 */
    #erp-grid .text-truncate {
      max-width: 200px;
      font-size: 1rem;
    }

    /* 열기 버튼 잘림 방지 */
    #erp-grid .erp-open-btn-icon {
      white-space: nowrap;
    }

    /* 경보 컬럼: 배지 겹침 방지 및 세로 정렬 */
    #erp-grid tbody td:nth-child(1) {
      padding: 0.5rem 0.75rem;
      vertical-align: top;
    }

    #erp-grid tbody td:nth-child(1) .badge {
      font-size: 0.85rem !important;
      padding: 0.35em 0.6em !important;
      margin: 0 0 4px 0;
      white-space: nowrap;
      display: block;
      line-height: 1.2;
      width: fit-content;
    }

    #erp-grid tbody td:nth-child(1) .badge:last-child {
      margin-bottom: 0;
    }

    /* 단계 컬럼: 배지 겹침 방지 */
    #erp-grid tbody td:nth-child(2) {
      padding: 0.5rem 0.75rem;
      vertical-align: middle;
    }

    #erp-grid tbody td:nth-child(2) .badge {
      font-size: 0.85rem !important;
      padding: 0.35em 0.6em !important;
      margin: 0 0 4px 0;
      white-space: nowrap;
      display: block;
      line-height: 1.2;
      width: fit-content;
    }

    #erp-grid tbody td:nth-child(2) .badge:last-child {
      margin-bottom: 0;
    }

    /* 작업 큐 가로 스크롤 및 최소 너비 확보 */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }

    /* 제품 항목은 overflow-x 제외 (그리드 레이아웃 사용) */
    .table-responsive.erp-product-items-wrapper {
      overflow-x: visible !important;
    }


    /* PC 화면: 미니멀 테이블 디자인 (UI/UX Pro Max) */
    @media (min-width: 993px) {
      .table-responsive {
        overflow-x: auto !important;
        overflow-y: visible;
        width: 100% !important;
        max-width: 100% !important;
      }

      #erp-grid {
        width: 100% !important;
        table-layout: auto !important;
        border-collapse: separate;
        border-spacing: 0;
      }

      #erp-grid thead th {
        border-right: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
      }

      #erp-grid thead th:last-child {
        border-right: none;
      }

      #erp-grid thead th,
      #erp-grid tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        vertical-align: top;
      }

      #erp-grid tbody td {
        border-right: 1px solid #f0f0f0;
      }

      #erp-grid tbody td:last-child {
        border-right: none;
      }

      /* 경보 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(1),
      #erp-grid tbody td:nth-child(1) {
        width: 90px;
        min-width: 90px;
      }

      #erp-grid tbody td:nth-child(1) {
        vertical-align: top;
      }

      #erp-grid tbody td:nth-child(1) .badge {
        display: block;
        margin-bottom: 3px;
        font-size: 0.75rem;
        padding: 0.25rem 0.4rem;
      }

      #erp-grid tbody td:nth-child(1) .badge:last-child {
        margin-bottom: 0;
      }

      /* 단계 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(2),
      #erp-grid tbody td:nth-child(2) {
        width: 80px;
        min-width: 80px;
      }

      #erp-grid tbody td:nth-child(2) .badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.5rem;
      }

      /* 퀘스트 컬럼 - 중간 */
      #erp-grid thead th:nth-child(3),
      #erp-grid tbody td:nth-child(3) {
        width: 180px;
        min-width: 180px;
      }

      /* 고객 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(4),
      #erp-grid tbody td:nth-child(4) {
        width: 90px;
        min-width: 90px;
      }

      /* 연락처 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(5),
      #erp-grid tbody td:nth-child(5) {
        width: 120px;
        min-width: 120px;
      }

      /* 주소 컬럼 - 제일 넓게 */
      #erp-grid thead th:nth-child(6),
      #erp-grid tbody td:nth-child(6) {
        width: 280px;
        min-width: 280px;
        max-width: 350px;
      }

      /* 제품 컬럼 - 두 번째로 넓게 */
      #erp-grid thead th:nth-child(7),
      #erp-grid tbody td:nth-child(7) {
        width: 200px;
        min-width: 200px;
        max-width: 250px;
      }

      #erp-grid tbody td:nth-child(7) div {
        line-height: 1.4;
        margin-bottom: 2px;
      }

      #erp-grid tbody td:nth-child(7) div:last-child {
        margin-bottom: 0;
      }

      /* 실측일 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(8),
      #erp-grid tbody td:nth-child(8) {
        width: 100px;
        min-width: 100px;
      }

      /* 시공일 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(9),
      #erp-grid tbody td:nth-child(9) {
        width: 100px;
        min-width: 100px;
      }

      /* 담당 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(10),
      #erp-grid tbody td:nth-child(10) {
        width: 70px;
        min-width: 70px;
      }

      /* 첨부 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(11),
      #erp-grid tbody td:nth-child(11) {
        width: 60px;
        min-width: 60px;
        text-align: center;
      }

      /* 상세 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(12),
      #erp-grid tbody td:nth-child(12) {
        width: 60px;
        min-width: 60px;
        text-align: center;
      }

      /* 열기 컬럼 - 최소화 */
      #erp-grid thead th:nth-child(13),
      #erp-grid tbody td:nth-child(13) {
        width: 50px;
        min-width: 50px;
        text-align: center;
      }

      #erp-grid .erp-open-btn-icon {
        display: inline-flex;
      }

      #erp-grid .erp-quest-cell {
        white-space: normal !important;
      }

      /* 행 호버 효과 */
      #erp-grid tbody tr:hover {
        background-color: #f8f9fa;
      }
    }

    @media (min-width: 993px) and (max-width: 1600px) {
      #erp-grid {
        width: 100% !important;
      }

      #erp-grid .erp-open-btn-icon {
        display: inline-flex;
      }
    }


    /* 프로세스 맵 1줄 고정 */
    .erp-process-row {
      flex-wrap: nowrap;
      overflow-x: auto;
      align-items: stretch;
      padding-bottom: 2px;
    }

    .erp-process-col {
      flex: 0 0 auto;
      min-width: 100px;
    }

    .erp-pro-pipeline__stage {
      min-width: 100px;
      padding: 0.4rem !important;
      box-shadow: none !important;
    }

    .erp-pro-pipeline__stage .fw-bold {
      font-size: 1.05rem;
    }

    .erp-pro-pipeline__stage .text-muted {
      font-size: 0.9rem;
    }

    .erp-pro-pipeline__stage .badge {
      font-size: 0.75rem;
      padding: 0.2em 0.45em;
    }

    /* 상단 알람 타일 미니멀 */
    .erp-alert-card .card-body {
      padding: 0.4rem 0.5rem !important;
    }

    .erp-alert-card .fw-bold {
      font-size: 0.9rem !important;
    }

    .erp-alert-card .badge {
      font-size: 0.85rem !important;
      padding: 0.35em 0.6em !important;
    }

    /* 필터 1줄 레이아웃 */
    #erp-filters-form.erp-filter-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #erp-filters-form .erp-filter-main {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
    }

    #erp-filters-form .erp-filter-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: nowrap;
    }

    #erp-filters-form .collapse {
      width: 100%;
    }

    #erp-filters-form .erp-filter-advanced-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
    }

    #erp-filters-form .erp-filter-advanced-bottom {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }

    #erp-filters-form .form-control,
    #erp-filters-form .form-select,
    #erp-filters-form .btn {
      font-size: 0.85rem;
      padding: 0.3rem 0.45rem;
    }

    #erp-filters-form .form-control {
      max-width: 160px;
      min-width: 120px;
    }

    .erp-dashboard-filters .card-body {
      padding: 0.6rem 0.7rem;
    }

    .erp-dashboard-filters .fw-bold {
      font-size: 0.95rem;
    }

    /* 주문 상세 텍스트 크기 통일 */
    .erp-order-detail {
      --erp-detail-font: 1.2rem;
    }

    .erp-order-detail .erp-detail-label,
    .erp-order-detail .erp-detail-value,
    .erp-order-detail .erp-detail-text {
      font-size: var(--erp-detail-font) !important;
    }

    .order-detail-content {
      font-size: 1.2rem !important;
    }

    .erp-schedule-card .erp-detail-text,
    .erp-schedule-card .erp-detail-label,
    .erp-schedule-card .erp-detail-value {
      font-size: 0.9rem !important;
    }

    .erp-schedule-card .card-title {
      font-size: 0.95rem !important;
    }

    /* 열기 버튼: 아이콘만 */
    .erp-open-btn-icon {
      background: transparent !important;
      border: 0 !important;
      padding: 0 !important;
      color: #6c757d;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .erp-open-btn-icon i {
      font-size: 0.95rem;
    }

    /* 미니멀 아이콘/텍스트 크기 통일 */
    .erp-dashboard .fas,
    .erp-dashboard .far {
      font-size: 0.95rem;
    }

    @media (max-width: 992px) {
      .table-responsive {
        overflow-x: visible;
        width: 100%;
      }

      .erp-dashboard .row.g-3.mb-4 {
        --bs-gutter-x: 0.35rem;
        --bs-gutter-y: 0.35rem;
      }

      .erp-alert-card {
        border-radius: 8px !important;
      }

      .erp-alert-card .card-body {
        padding: 0.3rem 0.35rem !important;
      }

      .erp-alert-card .fw-bold {
        font-size: 0.65rem !important;
      }

      .erp-alert-card .badge {
        font-size: 0.6rem !important;
        padding: 0.18rem 0.35rem !important;
      }

      .erp-process-step {
        min-width: 64px !important;
        padding: 0.25rem !important;
        border-radius: 8px !important;
        box-shadow: none !important;
      }

      .erp-process-step .fw-bold {
        font-size: 0.75rem !important;
      }

      .erp-process-step .badge {
        font-size: 0.55rem !important;
        padding: 0.15em 0.3em !important;
      }

      .erp-process-step .text-muted {
        font-size: 0.6rem !important;
      }

      .erp-dashboard-workqueue .card-body {
        font-size: 0.8rem !important;
      }

      #erp-grid tbody tr.erp-main-row td {
        font-size: 0.78rem !important;
        grid-template-columns: 58px 1fr;
      }

      #erp-grid tbody tr.erp-main-row td .badge,
      #erp-grid tbody tr.erp-main-row td .btn,
      #erp-grid tbody tr.erp-main-row td a {
        font-size: 0.72rem !important;
      }

      .erp-product-items-label,
      .erp-product-items-value {
        font-size: 0.8rem !important;
      }

      /* 모바일: 카카오/채널톡 느낌으로 폰트/아이콘 축소 */
      .erp-dashboard .badge.fs-6 {
        font-size: 0.6rem !important;
        padding: 0.2rem 0.35rem !important;
      }

      .erp-process-step {
        min-width: 64px !important;
        padding: 0.25rem !important;
      }

      .erp-process-step .fw-bold {
        font-size: 0.75rem !important;
      }

      .erp-process-step .badge {
        font-size: 0.55rem !important;
        padding: 0.15em 0.3em !important;
      }

      .erp-process-step .text-muted {
        font-size: 0.6rem !important;
      }

      .erp-dashboard .btn,
      .erp-dashboard .form-select,
      .erp-dashboard .form-control {
        font-size: 0.78rem !important;
      }

      .erp-dashboard .btn i,
      .erp-dashboard .nav-link i {
        font-size: 0.78rem !important;
      }

      #erp-grid tbody tr.erp-main-row {
        padding: 0.5rem;
      }

      #erp-grid tbody tr.erp-main-row td {
        font-size: 0.78rem;
        grid-template-columns: 58px 1fr;
      }

      #erp-grid tbody tr.erp-main-row td .badge,
      #erp-grid tbody tr.erp-main-row td .btn,
      #erp-grid tbody tr.erp-main-row td a {
        font-size: 0.72rem !important;
      }

      .erp-product-items-label,
      .erp-product-items-value {
        font-size: 0.8rem !important;
      }

      .erp-dashboard-workqueue {
        width: 100%;
        max-width: 100%;
        padding: 0;
      }

      .erp-dashboard-workqueue .card {
        width: 100%;
        margin: 0;
      }

      .erp-dashboard-workqueue .card-body {
        padding: 1rem;
        width: 100%;
      }

      #erp-grid {
        min-width: 0;
        width: 100%;
        table-layout: auto;
        display: block;
      }

      #erp-grid thead {
        display: none;
      }

      #erp-grid,
      #erp-grid tbody,
      #erp-grid tr,
      #erp-grid td {
        display: block;
        width: 100%;
        max-width: 100%;
      }

      #erp-grid tr.erp-main-row {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fff;
        width: 100%;
        box-sizing: border-box;
      }

      /* 모바일 작업 큐: 라벨 80px 고정 + 값은 가상 세로선(2열)에 맞춤 (상위 CSS 무관) */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td {
        padding: 0.5rem 0;
        border: none;
        border-bottom: 1px solid #f0f0f0;
        font-size: 1rem;
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px;
        white-space: normal;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        align-items: start;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td:last-child {
        border-bottom: none;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td>* {
        grid-column: 2 !important;
        margin-left: 0 !important;
        padding-left: 0 !important;
        justify-self: start !important;
        max-width: 100%;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td .badge,
      .erp-dashboard #erp-grid tbody tr.erp-main-row td .btn,
      .erp-dashboard #erp-grid tbody tr.erp-main-row td a {
        margin-left: 0 !important;
        padding-left: 0 !important;
      }

      /* 모바일: 첨부, 상세, 열기 - grid 유지, 값 2열 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="첨부"],
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="상세"],
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="열기"] {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
        align-items: center;
      }

      /* 모바일: 열기 헤더 삭제 및 버튼 중앙 정렬 */
      #erp-grid tbody tr.erp-main-row td[data-label="열기"]::before {
        display: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        grid-template-columns: none !important;
        border-bottom: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon {
        margin: 0 auto;
        justify-self: center;
      }

      /* 모바일: 경보 컬럼 - grid 유지, 배지들을 값 영역(2열)에 정렬 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td:nth-child(1) {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
      }

      #erp-grid tbody tr.erp-main-row td:nth-child(1) .badge {
        display: inline-block !important;
        margin-right: 4px !important;
        margin-bottom: 0 !important;
        width: fit-content !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }

      #erp-grid tbody tr.erp-main-row td:nth-child(1) .badge:last-child {
        margin-right: 0 !important;
      }

      /* 모바일: 단계 컬럼 - 배지 정렬 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td:nth-child(2) {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
      }

      #erp-grid tbody tr.erp-main-row td:nth-child(2) .badge {
        display: inline-block;
        margin-right: 4px;
        margin-bottom: 0;
        width: fit-content;
      }

      /* 모바일: 퀘스트 컬럼 - grid 유지, 값 2열 정렬 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"] {
        display: grid !important;
        grid-template-columns: 80px minmax(0, 1fr) !important;
        gap: 8px !important;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"] .d-inline-flex {
        grid-column: 2 !important;
        justify-self: start;
        margin-left: 0 !important;
        padding-left: 0 !important;
      }

      /* 모바일: 헤더(라벨) 1열 고정, 값은 2열 가상 세로선에 맞춤 */
      .erp-dashboard #erp-grid tbody tr.erp-main-row td::before {
        content: attr(data-label);
        grid-column: 1 !important;
        width: 80px !important;
        max-width: 80px !important;
        min-width: 80px !important;
        box-sizing: border-box;
        color: #0d6efd;
        font-weight: 700;
        white-space: nowrap;
        font-size: 1rem;
        text-align: left;
        align-self: start;
        padding-right: 8px;
        min-height: 1.5em;
        overflow: hidden;
      }

      /* 모바일: 모든 값 텍스트 볼드체 적용 */
      #erp-grid tbody tr.erp-main-row td {
        font-weight: 700 !important;
        color: #212529 !important;
      }

      #erp-grid tbody tr.erp-main-row td span:not(.badge):not(.btn),
      #erp-grid tbody tr.erp-main-row td div,
      #erp-grid tbody tr.erp-main-row td text {
        font-weight: 700 !important;
        color: #212529 !important;
      }

      /* 모바일: 배지와 버튼도 볼드체 유지 */
      #erp-grid tbody tr.erp-main-row td .badge,
      #erp-grid tbody tr.erp-main-row td .btn {
        font-weight: 700 !important;
      }

      #erp-grid tbody tr:not(.erp-main-row) td {
        display: block;
        width: 100%;
        max-width: 100%;
        padding: 0;
        box-sizing: border-box;
      }

      #erp-grid tbody tr:not(.erp-main-row) td::before {
        content: none;
      }

      #erp-grid .erp-open-btn-icon {
        display: inline-flex;
      }

      #erp-grid .erp-cell-actions {
        justify-content: flex-end;
        align-items: center;
        grid-template-columns: 75px 1fr;
      }

      /* 모바일: 퀘스트 셀 - grid 유지, 값 정렬 */
      #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"]::before {
        grid-column: 1;
        align-self: start;
      }

      #erp-grid .erp-quest-cell .btn {
        white-space: normal;
        text-align: left;
        line-height: 1.25;
        width: auto !important;
        flex-shrink: 0 !important;
      }

      #erp-grid .erp-quest-cell .badge {
        margin-top: 0 !important;
        flex-shrink: 0 !important;
      }

      /* 모바일: 첨부, 상세, 열기 버튼 사이즈 고정 (진행중 배지 사이즈) - 992px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="첨부"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge i {
        font-size: 1rem !important;
        padding: 0.4em 0.7em !important;
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        display: inline-block !important;
      }

      /* 모바일: 상세 버튼 아이콘 크기 조정 (첨부 버튼과 동일한 크기) */
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge i {
        font-size: 0.85rem !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      /* 모바일: 상세 버튼 전체 크기 조정 (첨부와 동일) */
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge {
        padding: 0.4em 0.7em !important;
        min-width: 2.5em !important;
        max-width: 2.5em !important;
        width: 2.5em !important;
        height: 2.5em !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon,
      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon i {
        font-size: 1rem !important;
        padding: 0 !important;
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
      }

      /* 모바일: 필터 적용/초기화 버튼 사이즈 고정 - 992px 이하 */
      #erp-filters-form .btn-primary,
      #erp-filters-form .btn-outline-secondary {
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        font-size: 1rem !important;
        padding: 0.4em 0.7em !important;
      }

      /* 모바일: 다른 테이블 (제품 항목 제외) */
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) {
        overflow-x: auto;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) table {
        width: 100%;
        min-width: 100%;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) table,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) thead,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) tbody,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) tr,
      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td {
        display: block !important;
        width: 100% !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) thead {
        display: none !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) tr {
        border: 1px solid #dee2e6 !important;
        border-radius: 8px !important;
        margin-bottom: 1rem !important;
        padding: 0.75rem !important;
        background: #fff !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td {
        padding: 0.5rem 0 !important;
        border: none !important;
        display: grid !important;
        grid-template-columns: 80px 1fr !important;
        gap: 8px !important;
        width: 100% !important;
        max-width: 100% !important;
        font-size: 1.2rem !important;
        text-align: left !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td[data-label^="규격"] {
        text-align: left !important;
        width: 100% !important;
        max-width: 100% !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td[data-label]::before {
        content: attr(data-label) ":" !important;
        font-weight: 700 !important;
        color: #0d6efd !important;
        font-size: 1.2rem !important;
        display: block !important;
      }

      .order-detail-content .table-responsive:not(.erp-product-items-wrapper) td.text-end {
        text-align: left !important;
      }
    }

    @media (max-width: 576px) {
      .erp-dashboard-workqueue .card-body {
        padding: 0.75rem;
      }

      #erp-grid tbody tr.erp-main-row {
        padding: 0.875rem;
        margin-bottom: 0.875rem;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td {
        grid-template-columns: 70px minmax(0, 1fr) !important;
        gap: 10px;
        font-size: 0.95rem;
      }

      .erp-dashboard #erp-grid tbody tr.erp-main-row td::before {
        font-size: 0.9rem;
        text-align: left;
        align-self: start;
        padding-right: 8px;
        width: 70px !important;
        max-width: 70px !important;
        min-width: 70px !important;
      }

      /* 모바일: 퀘스트 셀을 flex로 변경하여 헤더와 버튼을 같은 줄에 배치 - 576px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"] {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        grid-template-columns: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="퀘스트"]::before {
        flex-shrink: 0 !important;
        margin-right: 0 !important;
      }

      #erp-grid .erp-quest-cell .btn {
        width: auto !important;
        flex-shrink: 0 !important;
      }

      #erp-grid .erp-quest-cell .badge {
        margin-top: 0 !important;
        flex-shrink: 0 !important;
      }

      /* 모바일: 열기 헤더 삭제 및 버튼 중앙 정렬 - 576px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="열기"]::before {
        display: none !important;
      }

      #erp-grid tbody tr.erp-main-row td[data-label="열기"] {
        justify-content: center !important;
      }

      #erp-grid .erp-cell-actions {
        grid-template-columns: 70px 1fr;
      }

      /* 모바일: 경보/단계 배지 작게 */
      #erp-grid tbody td:nth-child(1) .badge,
      #erp-grid tbody td:nth-child(2) .badge {
        font-size: 0.7rem !important;
        padding: 0.2em 0.45em !important;
        line-height: 1.1;
      }

      /* 모바일: 첨부, 상세, 열기 버튼 사이즈 고정 (진행중 배지 사이즈) - 576px 이하 */
      #erp-grid tbody tr.erp-main-row td[data-label="첨부"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge,
      #erp-grid tbody tr.erp-main-row td[data-label="상세"] .badge i,
      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon,
      #erp-grid tbody tr.erp-main-row td[data-label="열기"] .erp-open-btn-icon i {
        font-size: 1rem !important;
        padding: 0 !important;
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
      }

      /* 모바일: 필터 적용/초기화 버튼 사이즈 고정 - 576px 이하 */
      #erp-filters-form .btn-primary,
      #erp-filters-form .btn-outline-secondary {
        width: fit-content !important;
        min-width: auto !important;
        max-width: none !important;
        font-size: 1rem !important;
        padding: 0.4em 0.7em !important;
      }

      #erp-grid tbody td:nth-child(1),
      #erp-grid tbody td:nth-child(2) {
        gap: 2px;
        padding: 0.3rem 0.5rem;
      }
    }

    /* 전체 텍스트 크기 증가 */
    .card-body {
      font-size: 0.95rem;
    }

    .card-body .small {
      font-size: 0.9rem !important;
    }

    .card-body h5,
    .card-body h6 {
      font-size: 1.1rem;
    }

    .card-body .fw-bold {
      font-size: 1rem;
    }

    /* 프로세스 맵 호버 효과 */
    .erp-pro-pipeline__stage {
      transition: all 0.2s ease;
    }

    .erp-pro-pipeline__stage:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
    }
  </style>

  <div class="erp-dashboard-layout">
    <!-- Left: Filters -->
    <div class="erp-dashboard-filters">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-3 text-dark" style="font-size: 1.15rem;"><i class="fas fa-filter text-primary"></i> 필터
          </div>
          <form method="get" action="{{ url_for('erp.erp_dashboard') }}" class="erp-filter-row"
            id="erp-filters-form">
            {% if filters.get('alert_type') %}
            <input type="hidden" name="alert_type" value="{{ filters.get('alert_type') }}">
            {% endif %}
            <div class="erp-filter-main">
              <input class="form-control form-control-sm" name="q" placeholder="검색(고객/연락/주소/담당)"
                value="{{ (filters.get('q') or '') }}">
              <div class="erp-filter-actions">
                <button class="btn btn-primary btn-sm fw-semibold" type="submit" aria-label="검색">
                  <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm fw-semibold" type="button" data-bs-toggle="collapse"
                  data-bs-target="#erp-filter-advanced" aria-expanded="false" aria-label="필터 상세">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
            </div>
            <div class="collapse" id="erp-filter-advanced">
              <div class="erp-filter-advanced-row mt-2">
                <select class="form-select form-select-sm" name="stage">
                  <option value="">단계: 전체</option>
                  <option value="주문접수" {% if filters.get('stage')=='주문접수' %}selected{% endif %}>주문접수</option>
                  <option value="해피콜" {% if filters.get('stage')=='해피콜' %}selected{% endif %}>해피콜</option>
                  <option value="실측" {% if filters.get('stage')=='실측' %}selected{% endif %}>실측</option>
                  <option value="도면" {% if filters.get('stage')=='도면' %}selected{% endif %}>도면</option>
                  <option value="고객컨펌" {% if filters.get('stage')=='고객컨펌' %}selected{% endif %}>고객컨펌</option>
                  <option value="생산" {% if filters.get('stage')=='생산' %}selected{% endif %}>생산</option>
                  <option value="시공" {% if filters.get('stage')=='시공' %}selected{% endif %}>시공</option>
                </select>

                <select class="form-select form-select-sm" name="team">
                  <option value="">팀: 전체</option>
                  <option value="CS" {% if filters.get('team')=='CS' %}selected{% endif %}>라홈팀</option>
                  <option value="SALES" {% if filters.get('team')=='SALES' %}selected{% endif %}>영업팀</option>
                  <option value="MEASURE" {% if filters.get('team')=='MEASURE' %}selected{% endif %}>실측팀</option>
                  <option value="DRAWING" {% if filters.get('team')=='DRAWING' %}selected{% endif %}>도면팀</option>
                  <option value="PRODUCTION" {% if filters.get('team')=='PRODUCTION' %}selected{% endif %}>생산팀</option>
                  <option value="CONSTRUCTION" {% if filters.get('team')=='CONSTRUCTION' %}selected{% endif %}>시공팀
                  </option>
                </select>
                {% if is_admin %}

                {% endif %}
              </div>
              <div class="erp-filter-advanced-bottom mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="f-urgent" name="urgent" {% if
                    filters.get('urgent')=='1' %}checked{% endif %} style="width: 1.2em; height: 1.2em;">
                  <label class="form-check-label fw-semibold" for="f-urgent" style="font-size: 0.9rem;">긴급만</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="f-has-alert" name="has_alert" {% if
                    filters.get('has_alert')=='1' %}checked{% endif %} style="width: 1.2em; height: 1.2em;">
                  <label class="form-check-label fw-semibold" for="f-has-alert" style="font-size: 0.9rem;">경보만</label>
                </div>
                <a class="btn btn-outline-secondary btn-sm fw-semibold"
                  href="{{ url_for('erp.erp_dashboard') }}">초기화</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Middle: Grid -->
    <div class="erp-dashboard-workqueue">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-table text-primary"></i> 작업 큐</h5>
              <small class="text-muted">주문 처리 및 퀘스트 관리</small>
            </div>
            <div>
              <span class="badge bg-primary fs-6 px-3 py-2">표시: <strong>{{ orders|length }}</strong>건</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle" id="erp-grid">
              <thead>
                <tr>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">경보</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">단계</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">퀘스트</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">고객</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">연락처</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">주소</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">제품</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">실측일</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">시공일</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">담당</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">첨부</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;">상세</th>
                  <th style="font-size: 1.1rem; font-weight: 700; color: #495057; background-color: #e9ecef;"></th>
                </tr>
              </thead>
              <tbody>
                {% for o in orders %}
                <tr class="erp-main-row" data-order-id="{{ o.id }}">
                  <td data-label="경보">
                    {% if o.alerts.urgent %}<span class="badge bg-danger fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">긴급</span>{% endif %}
                    {% if o.alerts.drawing_overdue %}<span class="badge bg-danger fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">도면48h</span>{% endif %}
                    {% if o.alerts.measurement_d4 %}
                    {% set meas_d = o.alerts['measurement_days'] if 'measurement_days' in o.alerts else none %}
                    <span class="badge bg-warning text-dark fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">실측D-{{ meas_d if meas_d is not none else '4'
                      }}</span>
                    {% endif %}
                    {% if o.alerts.construction_d3 %}
                    {% set cons_d = o.alerts['construction_days'] if 'construction_days' in o.alerts else none %}
                    <span class="badge bg-warning text-dark fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">시공D-{{ cons_d if cons_d is not none else '3'
                      }}</span>
                    {% endif %}
                    {% if o.alerts.production_d2 %}
                    {% set prod_d = o.alerts['production_days'] if 'production_days' in o.alerts else none %}
                    <span class="badge bg-warning text-dark fw-bold"
                      style="font-size: 1.1rem; padding: 0.5em 0.8em;">생산D-{{ prod_d if prod_d is not none else '2'
                      }}</span>
                    {% endif %}
                  </td>
                  <td data-label="단계"><span class="badge bg-secondary"
                      style="font-size: 1.1rem; padding: 0.5em 0.7em;">{{ o.stage }}</span></td>
                  <td data-label="퀘스트" class="erp-quest-cell erp-wrap">
                    {% if o.current_quest %}
                    <div class="d-inline-flex align-items-center gap-2">
                      {% if o.current_quest.all_approved %}
                      <span class="badge bg-success" style="font-size: 1rem; padding: 0.4em 0.7em;">완료</span>
                      {% else %}
                      <span class="badge bg-warning" style="font-size: 1rem; padding: 0.4em 0.7em;">진행중</span>
                      {% endif %}
                      <button class="btn btn-sm btn-outline-info fw-semibold" type="button" data-bs-toggle="collapse"
                        data-bs-target="#quest-collapse-{{ o.id }}" aria-expanded="false"
                        aria-controls="quest-collapse-{{ o.id }}" style="font-size: 1.1rem; padding: 0.5em 0.8em;">
                        <i class="fas fa-chevron-down"></i>
                        {% if o.current_quest.all_approved %}
                        <i class="fas fa-check-circle text-success"></i>
                        {% endif %}
                        <strong>{{ o.current_quest.title }}</strong>
                      </button>
                    </div>
                    <div class="collapse mt-2" id="quest-collapse-{{ o.id }}">
                      <div class="card card-body border-0 bg-light">
                        <div class="fw-bold mb-3" style="font-size: 1.05rem;"><i
                            class="fas fa-flag-checkered text-primary"></i> 현재 단계 퀘스트</div>

                        <div class="card mb-3 shadow-sm">
                          <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                              <div>
                                <h5 class="card-title mb-2 fw-bold" style="font-size: 1.05rem;">{{ o.current_quest.title
                                  }}</h5>

                              </div>
                              <span
                                class="badge {% if o.current_quest.all_approved %}bg-success{% else %}bg-warning{% endif %}"
                                style="font-size: 0.9rem; padding: 0.4em 0.6em;">
                                {% if o.current_quest.all_approved %}완료{% else %}진행중{% endif %}
                              </span>
                            </div>
                            <div class="mb-3">
                              <div class="text-muted mb-2 fw-semibold" style="font-size: 0.9rem;">담당 팀</div>
                              <div class="fw-bold" style="font-size: 1rem;">{{
                                team_labels.get(o.current_quest.owner_team, o.current_quest.owner_team) }}</div>
                            </div>
                            <div class="mb-3">
                              <div class="text-muted mb-2 fw-semibold" style="font-size: 0.9rem;">팀별 승인</div>
                              <div id="quest-approvals-{{ o.id }}">
                                {% for team in o.current_quest.required_approvals %}
                                {% set approved = o.current_quest.team_approvals.get(team, False) %}
                                <div class="mb-2">
                                  <span class="fw-semibold" style="font-size: 0.9rem;">{{ team_labels.get(team, team)
                                    }}</span>
                                  {% if approved %}
                                  <span class="badge bg-success ms-2"
                                    style="font-size: 0.9rem; padding: 0.3em 0.6em;">승인완료</span>
                                  {% else %}
                                  {% set order_id_approve = o.id %}
                                  {% set team_name = team %}
                                  <button class="btn btn-primary fw-semibold ms-2 erp-btn-approve-team"
                                    data-order-id="{{ order_id_approve }}" data-team="{{ team_name }}"
                                    style="font-size: 0.9rem; padding: 0.3rem 0.6rem;">승인</button>
                                  {% endif %}
                                </div>
                                {% endfor %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% else %}
                    <span class="text-muted" style="font-size: 1.1rem;">-</span>
                    {% endif %}
                  </td>
                  <td data-label="고객" class="fw-bold erp-wrap" style="font-size: 1.1rem; color: #212529;">{{
                    o.customer_name }}</td>
                  <td data-label="연락처" style="font-size: 1.1rem; color: #495057;">{{ o.phone }}</td>
                  <td data-label="주소" class="erp-wrap"
                    style="font-size: 1.1rem; color: #495057; word-break: break-word;">{{ o.address }}</td>
                  <td data-label="제품" class="erp-wrap"
                    style="font-size: 1.1rem; color: #495057; word-break: break-word;">
                    {% if o.is_erp_beta and o.structured_data and o.structured_data.get('items') %}
                    {% set items = o.structured_data.get('items', []) %}
                    {% for item in items %}
                    <div>{{ item.get('product_name', '-') }}</div>
                    {% endfor %}
                    {% else %}
                    {{ o.product or '-' }}
                    {% endif %}
                  </td>
                  <td data-label="실측일" class="fw-semibold" style="font-size: 1.1rem; color: #495057;">{{
                    o.measurement_date or '-' }}</td>
                  <td data-label="시공일" class="fw-semibold" style="font-size: 1.1rem; color: #495057;">{{
                    o.construction_date or '-' }}</td>
                  <td data-label="담당" style="font-size: 1.1rem; color: #495057;">{{ o.manager_name or '-' }}</td>
                  <td data-label="첨부">
                    {% if o.has_media %}
                    {% set order_id_att = o.id %}
                    <span class="badge bg-primary text-white fw-bold erp-btn-attachments-preview"
                      style="cursor: pointer; font-size: 1rem !important; padding: 0.4em 0.7em !important; text-align: center; display: inline-block;"
                      data-order-id="{{ order_id_att }}" title="첨부 파일 미리보기">{{ o.attachments_count
                      }}</span>
                    {% else %}
                    <span class="text-muted" style="font-size: 1.1rem;">-</span>
                    {% endif %}
                  </td>
                  <td data-label="상세" class="text-center">
                    {% set order_id_detail = o.id %}
                    {% if can_edit_erp|default(false) %}
                    <a class="badge bg-info text-white fw-bold"
                      href="{{ url_for('order_pages.edit_order', order_id=order_id_detail) }}?open=erp-beta" title="제품 상세정보"
                      style="cursor: pointer; font-size: 1rem !important; padding: 0.4em 0.7em !important; text-align: center; display: inline-block; text-decoration: none;">
                      <i class="fas fa-clipboard-list" style="font-size: 1rem !important;"></i>
                    </a>
                    {% else %}
                    <span class="text-muted small">(수정 권한 없음)</span>
                    {% endif %}
                  </td>
                  <td data-label="열기" class="text-end erp-cell-actions">
                    <button class="erp-open-btn-icon" type="button" data-bs-toggle="collapse"
                      data-bs-target="#order-detail-collapse-{{ o.id }}" aria-expanded="false"
                      aria-controls="order-detail-collapse-{{ o.id }}" title="열기">
                      <i class="fas fa-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Order Detail Slide -->
                <tr>
                  <td colspan="12" class="p-0">
                    <div class="collapse" id="order-detail-collapse-{{ o.id }}">
                      <div class="card card-body border-0 bg-light">
                        <div class="fw-bold mb-3 erp-order-detail-title"><i class="fas fa-info-circle"></i> 주문 상세</div>
                        <div id="order-detail-content-{{ o.id }}" class="order-detail-content">
                          <div class="text-muted small">로딩 중...</div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- 첨부 파일 카테고리 모달 -->
  <div class="modal fade" id="erpAttachmentsCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-paperclip"></i> 첨부 파일</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex flex-wrap gap-2 mb-3" id="erp-attachments-category-tabs"></div>
          <div class="row g-2" id="erp-attachments-category-gallery"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 첨부 파일 단일 미리보기 모달 -->
  <div class="modal fade" id="erpAttachmentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"
      style="max-width: 60vw; width: 60vw; height: 90vh; max-height: 90vh; margin: auto;">
      <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0; position: relative;">
          <h5 class="modal-title"><i class="fas fa-paperclip"></i> 첨부 미리보기 <span id="erp-attachment-preview-counter"
              class="badge bg-secondary ms-2"></span></h5>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="erp-attachment-preview-prev"
            style="display: none;" title="이전 파일">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="erp-attachment-preview-next"
            style="display: none;" title="다음 파일">
            <i class="fas fa-chevron-right"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body"
          style="padding: 0; overflow: hidden; flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <div id="erp-attachment-preview-body"
            style="padding: 1rem; flex: 1; overflow: auto; display: flex; flex-direction: column;"></div>
        </div>
        <div class="modal-footer" style="flex-shrink: 0;">
          <a class="btn btn-primary" id="erp-attachment-preview-download" href="#" target="_blank" rel="noopener">
            <i class="fas fa-download"></i> 다운로드
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }


    // === 표시용 한글 라벨(저장은 영문 코드 유지) ===
    const TEAM_LABELS = JSON.parse('{{ team_labels| tojson | safe }}');
    const STAGE_LABELS = JSON.parse('{{ stage_labels| tojson | safe }}');

    function label(map, code, fallback = '-') {
      if (!code) return fallback;
      return map[code] || code;
    }

    let __selectedOrderId = null;
    let __attachmentsCache = {};
    let __currentAttachmentList = [];
    let __currentAttachmentIndex = 0;
    let __activeAttachmentCategory = 'measurement';
    let __attachmentsByCategory = {
      measurement: [],
      drawing: [],
      construction: []
    };

    const ATTACHMENT_CATEGORY_META = {
      measurement: { label: '실측', icon: 'fa-ruler-combined' },
      drawing: { label: '도면', icon: 'fa-drafting-compass' },
      construction: { label: '시공', icon: 'fa-hammer' }
    };

    function normalizeAttachmentCategory(category) {
      const c = String(category || '').trim().toLowerCase();
      if (c === 'drawing' || c === 'construction') return c;
      return 'measurement';
    }

    function getAttachmentCategoryLabel(category) {
      const key = normalizeAttachmentCategory(category);
      return (ATTACHMENT_CATEGORY_META[key] || ATTACHMENT_CATEGORY_META.measurement).label;
    }

    function renderAttachmentCategoryTabs() {
      const tabsEl = document.getElementById('erp-attachments-category-tabs');
      if (!tabsEl) return;
      const keys = ['measurement', 'drawing', 'construction'];
      tabsEl.innerHTML = keys.map((key) => {
        const meta = ATTACHMENT_CATEGORY_META[key];
        const count = (__attachmentsByCategory[key] || []).length;
        const isActive = key === __activeAttachmentCategory;
        const activeCls = isActive ? 'btn-primary' : 'btn-outline-primary';
        return `
          <button type="button" class="btn btn-sm ${activeCls}" onclick="selectAttachmentCategory('${key}')">
            <i class="fas ${meta.icon}"></i> ${meta.label}
            <span class="badge ${isActive ? 'bg-light text-dark' : 'bg-primary text-white'} ms-1">${count}</span>
          </button>
        `;
      }).join('');
    }

    function renderAttachmentCategoryGallery() {
      const galleryEl = document.getElementById('erp-attachments-category-gallery');
      if (!galleryEl) return;
      const list = __attachmentsByCategory[__activeAttachmentCategory] || [];
      if (!list.length) {
        galleryEl.innerHTML = `
          <div class="col-12">
            <div class="text-muted small p-3 border rounded bg-light">
              ${getAttachmentCategoryLabel(__activeAttachmentCategory)} 카테고리에 첨부 파일이 없습니다.
            </div>
          </div>
        `;
        return;
      }

      galleryEl.innerHTML = list.map((a, index) => {
        const name = escapeHtml(a.filename || '');
        const type = a.file_type || 'file';
        const thumb = a.thumbnail_view_url || a.view_url || '#';
        const viewUrl = a.view_url || '#';
        const downloadUrl = a.download_url || '#';

        const mediaHtml = (type === 'video')
          ? `<div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;">
              <video src="${viewUrl}" controls preload="metadata" style="width:100%;height:100%;"></video>
            </div>`
          : `<img src="${thumb}" alt="${name}" class="img-fluid rounded"
              style="max-height: 180px; object-fit: contain; width:100%; cursor: zoom-in; background:#fff; padding:4px;"
              onclick="openAttachmentFromCategory('${__activeAttachmentCategory}', ${index})">`;

        return `
          <div class="col-md-4 col-sm-6 col-12">
            <div class="card h-100">
              <div class="card-body p-2">
                ${mediaHtml}
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <div class="small text-truncate" title="${name}" style="max-width: 70%;">${name}</div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" type="button" title="미리보기"
                      onclick="openAttachmentFromCategory('${__activeAttachmentCategory}', ${index})">
                      <i class="fas fa-eye"></i>
                    </button>
                    <a class="btn btn-outline-primary" href="${downloadUrl}" title="다운로드" target="_blank" rel="noopener">
                      <i class="fas fa-download"></i>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectAttachmentCategory(category) {
      __activeAttachmentCategory = normalizeAttachmentCategory(category);
      renderAttachmentCategoryTabs();
      renderAttachmentCategoryGallery();
    }

    function openAttachmentFromCategory(category, index) {
      const key = normalizeAttachmentCategory(category);
      const list = __attachmentsByCategory[key] || [];
      if (!list.length) return;
      __activeAttachmentCategory = key;
      __currentAttachmentList = list;
      showAttachmentAtIndex(index);
    }

    // 첨부 파일 미리보기 모달 열기 (단일 파일)
    function openAttachmentPreviewModal(attachmentId, viewUrl, downloadUrl, filename, fileType) {
      if (window.GlobalImageViewer) {
        const singleFile = {
          view_url: viewUrl,
          download_url: downloadUrl,
          filename: filename,
          file_type: fileType
        };

        // 같은 주문의 첨부 캐시가 있으면 이미지 묶음으로 열어 좌우 이동 가능하게 처리
        const orderMatch = String(viewUrl || '').match(/\/orders\/(\d+)\//);
        const orderId = orderMatch ? Number(orderMatch[1]) : 0;
        const cached = orderId ? (__attachmentsCache[orderId] || []) : [];

        const isImage = (a) => {
          if (!a) return false;
          const ft = String(a.file_type || '').toLowerCase();
          if (ft === 'image') return true;
          const probe = String(a.view_url || a.filename || '').toLowerCase();
          return /\.(jpg|jpeg|png|gif|webp|bmp|svg|heic|heif)(\?|$)/.test(probe);
        };

        if (String(fileType || '').toLowerCase() === 'image' && Array.isArray(cached) && cached.length > 1) {
          const imageFiles = cached
            .filter(isImage)
            .map((a) => ({
              view_url: a.view_url || '',
              download_url: a.download_url || (a.view_url || ''),
              filename: a.filename || '이미지',
              file_type: 'image'
            }))
            .filter((a) => !!a.view_url);

          if (imageFiles.length > 1) {
            let startIndex = 0;
            if (attachmentId) {
              const idxById = cached.filter(isImage).findIndex((a) => Number(a.id || 0) === Number(attachmentId));
              if (idxById >= 0) startIndex = idxById;
            }
            if (startIndex === 0) {
              const idxByUrl = imageFiles.findIndex((a) => String(a.view_url) === String(viewUrl));
              if (idxByUrl >= 0) startIndex = idxByUrl;
            }
            window.GlobalImageViewer.open(imageFiles, startIndex);
            return;
          }
        }

        // 기본: 단일 파일로 열기
        window.GlobalImageViewer.open([singleFile], 0);
      } else {
        console.error('GlobalImageViewer not found');
        alert('이미지 뷰어를 불러올 수 없습니다.');
      }
    }

    // 이미지 줌 기능 설정 (윤곽 없이 전체 확대/축소)
    function setupImageZoom() {
      const container = document.getElementById('image-zoom-container');
      const img = document.getElementById('preview-zoom-image');
      const badge = document.getElementById('zoom-level-badge');
      if (!container || !img || !badge) return;

      let scale = 1;
      let panX = 0;
      let panY = 0;
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let startPanX = 0;
      let startPanY = 0;

      // 초기 이미지 크기 저장
      let initialWidth = img.naturalWidth || img.width;
      let initialHeight = img.naturalHeight || img.height;

      // 이미지 로드 후 초기 크기 설정
      if (img.complete) {
        initialWidth = img.naturalWidth || img.width;
        initialHeight = img.naturalHeight || img.height;
      } else {
        img.addEventListener('load', () => {
          initialWidth = img.naturalWidth || img.width;
          initialHeight = img.naturalHeight || img.height;
        });
      }

      // 줌 레벨 표시 업데이트
      function updateZoomBadge() {
        badge.textContent = Math.round(scale * 100) + '%';
        badge.style.display = scale !== 1 ? 'block' : 'none';
      }

      // 이미지 변환 적용 (윤곽 없이 전체 확대)
      function applyTransform() {
        img.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        img.style.border = 'none';
        img.style.boxShadow = 'none';
        img.style.borderRadius = '0';
        img.style.padding = '0';
        img.style.background = 'transparent';
        updateZoomBadge();
      }

      // 줌 인/아웃 (마우스 위치 중심)
      function zoomAtPoint(delta, clientX, clientY) {
        const rect = container.getBoundingClientRect();
        const containerCenterX = rect.left + rect.width / 2;
        const containerCenterY = rect.top + rect.height / 2;

        // 마우스 위치를 컨테이너 중심 기준으로 변환
        const x = clientX - containerCenterX;
        const y = clientY - containerCenterY;

        const oldScale = scale;
        const zoomFactor = delta > 0 ? 0.9 : 1.1;
        scale = Math.max(0.5, Math.min(10, scale * zoomFactor));

        // 마우스 위치를 중심으로 줌
        if (scale !== oldScale) {
          const scaleChange = scale / oldScale;
          panX = x - (x - panX) * scaleChange;
          panY = y - (y - panY) * scaleChange;
        }

        applyTransform();
      }

      // 휠 스크롤로 줌 (모든 경우)
      container.addEventListener('wheel', (e) => {
        e.preventDefault();
        e.stopPropagation();
        zoomAtPoint(e.deltaY, e.clientX, e.clientY);
      }, { passive: false });

      // 모달 body에도 휠 이벤트 추가 (이미지 영역 밖에서도 작동)
      const modalBody = document.querySelector('#erpAttachmentPreviewModal .modal-body');
      if (modalBody) {
        modalBody.addEventListener('wheel', (e) => {
          const target = e.target;
          if (target !== container && !container.contains(target)) {
            e.preventDefault();
            e.stopPropagation();
            const rect = modalBody.getBoundingClientRect();
            zoomAtPoint(e.deltaY, rect.left + rect.width / 2, rect.top + rect.height / 2);
          }
        }, { passive: false });
      }

      // 드래그로 패닝
      container.addEventListener('mousedown', (e) => {
        if (scale > 1) {
          isDragging = true;
          container.style.cursor = 'grabbing';
          startX = e.clientX;
          startY = e.clientY;
          startPanX = panX;
          startPanY = panY;
          e.preventDefault();
        }
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging && scale > 1) {
          panX = startPanX + (e.clientX - startX);
          panY = startPanY + (e.clientY - startY);
          applyTransform();
          e.preventDefault();
        }
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          container.style.cursor = scale > 1 ? 'grab' : 'default';
        }
      });

      container.addEventListener('mouseleave', () => {
        if (isDragging) {
          isDragging = false;
          container.style.cursor = scale > 1 ? 'grab' : 'default';
        }
      });

      // 더블클릭으로 리셋
      container.addEventListener('dblclick', () => {
        scale = 1;
        panX = 0;
        panY = 0;
        applyTransform();
      });

      // 터치 제스처 지원 (모바일)
      let touchStartDistance = 0;
      let touchStartScale = 1;
      let touchStartPanX = 0;
      let touchStartPanY = 0;

      container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          startX = touch.clientX;
          startY = touch.clientY;
          startPanX = panX;
          startPanY = panY;
        } else if (e.touches.length === 2) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          touchStartDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          touchStartScale = scale;
          touchStartPanX = panX;
          touchStartPanY = panY;
        }
      }, { passive: true });

      container.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && scale > 1) {
          e.preventDefault();
          const touch = e.touches[0];
          panX = startPanX + (touch.clientX - startX);
          panY = startPanY + (touch.clientY - startY);
          applyTransform();
        } else if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const distance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
          scale = Math.max(0.5, Math.min(10, touchStartScale * (distance / touchStartDistance)));
          applyTransform();
        }
      }, { passive: false });

      updateZoomBadge();
    }

    // 주문의 첨부 파일 미리보기 (첨부 배지 클릭 시) - 좌우 네비게이션 지원
    async function openAttachmentsPreview(orderId, initialCategory = 'measurement') {
      try {
        // 캐시 확인
        let aList = null;
        if (__attachmentsCache[orderId]) {
          aList = __attachmentsCache[orderId];
        } else {
          const res = await fetch(`/api/orders/${orderId}/attachments`);
          const data = await res.json();
          aList = (data && data.attachments) || [];
          __attachmentsCache[orderId] = aList;
        }

        if (aList.length > 0) {
          __attachmentsByCategory = { measurement: [], drawing: [], construction: [] };
          aList.forEach((a) => {
            const key = normalizeAttachmentCategory(a.category);
            const normalized = Object.assign({}, a, { category: key });
            if (!__attachmentsByCategory[key]) __attachmentsByCategory[key] = [];
            __attachmentsByCategory[key].push(normalized);
          });

          let targetCategory = normalizeAttachmentCategory(initialCategory);
          const targetList = __attachmentsByCategory[targetCategory] || [];
          if (!targetList.length) {
            if (__attachmentsByCategory.drawing.length) targetCategory = 'drawing';
            else if (__attachmentsByCategory.measurement.length) targetCategory = 'measurement';
            else if (__attachmentsByCategory.construction.length) targetCategory = 'construction';
          }
          __activeAttachmentCategory = targetCategory;

          renderAttachmentCategoryTabs();
          renderAttachmentCategoryGallery();
          const modalEl = document.getElementById('erpAttachmentsCategoryModal');
          if (modalEl) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          }
        } else {
          alert('첨부 파일이 없습니다.');
        }
      } catch (err) {
        console.error('첨부 파일 로드 실패:', err);
        alert('첨부 파일을 불러올 수 없습니다.');
      }
    }

    // 특정 인덱스의 첨부 파일 표시
    function showAttachmentAtIndex(index) {
      if (!__currentAttachmentList || index < 0 || index >= __currentAttachmentList.length) {
        return;
      }

      __currentAttachmentIndex = index;
      
      if (window.GlobalImageViewer) {
        window.GlobalImageViewer.open(__currentAttachmentList, index);
      } else {
        console.error('GlobalImageViewer not found');
        alert('이미지 뷰어를 불러올 수 없습니다.');
      }
    }

    // 첨부 파일 네비게이션 업데이트
    function updateAttachmentNavigation() {
      const prevBtn = document.getElementById('erp-attachment-preview-prev');
      const nextBtn = document.getElementById('erp-attachment-preview-next');
      const counter = document.getElementById('erp-attachment-preview-counter');

      if (!prevBtn || !nextBtn || !counter) return;

      const total = __currentAttachmentList.length;
      const current = __currentAttachmentIndex + 1;

      // 카운터 표시
      counter.textContent = `${current} / ${total}`;

      // 이전/다음 버튼 표시
      if (total > 1) {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        prevBtn.disabled = (__currentAttachmentIndex === 0);
        nextBtn.disabled = (__currentAttachmentIndex === total - 1);
      } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }
    }

    // 이전 파일 보기
    function showPreviousAttachment() {
      if (__currentAttachmentIndex > 0) {
        showAttachmentAtIndex(__currentAttachmentIndex - 1);
      }
    }

    function showNextAttachment() {
      if (__currentAttachmentIndex < __currentAttachmentList.length - 1) {
        showAttachmentAtIndex(__currentAttachmentIndex + 1);
      }
    }

    async function startConstruction(orderId) {
      if (!confirm('시공을 시작하시겠습니까? (로그가 기록됩니다)')) return;

      try {
        const res = await fetch(`/api/orders/${orderId}/construction/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();

        if (data.success) {
          alert(data.message);
          window.location.reload();
        } else {
          alert('오류: ' + data.message);
        }
      } catch (err) {
        console.error('Construction start error:', err);
        alert('처리 중 오류가 발생했습니다.');
      }
    }

    async function completeConstruction(orderId) {
      if (!confirm('시공을 완료하시겠습니까? (상태가 완료(AS대기)로 변경됩니다)')) return;

      try {
        const res = await fetch(`/api/orders/${orderId}/construction/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();

        if (data.success) {
          alert(data.message);
          window.location.reload();
        } else {
          alert('오류: ' + data.message);
        }
      } catch (err) {
        console.error('Construction complete error:', err);
        alert('처리 중 오류가 발생했습니다.');
      }
    }

    function renderBadges(alerts) {
      const a = alerts || {};
      const out = [];
      if (a.urgent) out.push('<span class="badge bg-danger me-1">긴급</span>');
      if (a.drawing_overdue) out.push('<span class="badge bg-danger me-1">도면48h</span>');
      if (a.measurement_d4) out.push('<span class="badge bg-warning text-dark me-1">실측D-4</span>');
      if (a.construction_d3) out.push('<span class="badge bg-warning text-dark me-1">시공D-3</span>');
      if (a.production_d2) out.push('<span class="badge bg-warning text-dark me-1">생산D-2</span>');
      return out.join('') || '<span class="text-muted small">경보 없음</span>';
    }

    async function approveQuestTeam(orderId, team) {
      try {
        const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ team: team })
        });
        const data = await res.json();

        // success 필드 확인 (API는 success 필드를 반환함)
        if (!data.success) {
          alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
          return;
        }

        // 자동 단계 전환 알림
        if (data.auto_transitioned && data.next_stage) {
          const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
          alert('✅ 모든 팀 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
        } else if (data.all_approved) {
          alert('✅ 모든 팀 승인 완료!');
        } else {
          const missingTeams = data.missing_teams.map(t => label(TEAM_LABELS, t, t)).join(', ');
          alert('승인 완료. 남은 팀: ' + missingTeams);
        }

        // 슬라이드 내 Quest 정보 업데이트
        await loadQuestDetail(orderId);
        // 페이지 새로고침 (주문 목록 업데이트)
        window.location.reload();
      } catch (err) {
        console.error('승인 실패:', err);
        alert('승인 중 오류가 발생했습니다.');
      }
    }

    async function loadQuestDetail(orderId) {
      try {
        const res = await fetch(`/api/orders/${orderId}/quest`);
        const data = await res.json();
        if (data.error) {
          console.error('Quest 로드 실패:', data.error);
          return;
        }
        // 슬라이드 내 Quest 정보 업데이트
        const questContainer = document.querySelector(`#quest-collapse-${orderId} #quest-approvals-${orderId}`);
        if (questContainer) {
          const quest = data.quest || {};
          const requiredTeams = quest.required_approvals || [];
          const teamApprovalsRaw = quest.team_approvals || {};

          let html = '';
          for (const team of requiredTeams) {
            // team_approvals는 딕셔너리 형태일 수 있음: {team: {"approved": True, ...}} 또는 {team: True}
            const approvalData = teamApprovalsRaw[team];
            let approved = false;
            if (typeof approvalData === 'object' && approvalData !== null) {
              approved = approvalData.approved === true;
            } else {
              approved = Boolean(approvalData);
            }
            const teamLabel = label(TEAM_LABELS, team, team);
            html += `<div class="mb-2">`;
            html += `<span class="fw-semibold" style="font-size: 1rem;">${escapeHtml(teamLabel)}</span>`;
            if (approved) {
              html += `<span class="badge bg-success ms-2" style="font-size: 1rem; padding: 0.4em 0.7em;">승인완료</span>`;
            } else {
              html += `<button class="btn btn-primary fw-semibold ms-2" onclick="approveQuestTeam(${orderId}, '${escapeHtml(team)}')" style="font-size: 1rem; padding: 0.4rem 0.75rem;">승인</button>`;
            }
            html += `</div>`;
          }
          questContainer.innerHTML = html;
        }
      } catch (err) {
        console.error('Quest 상세 로드 실패:', err);
      }
    }

    async function loadOrderDetail(orderId) {
      const container = document.getElementById(`order-detail-content-${orderId}`);
      if (!container) return;

      try {
        container.innerHTML = '<div class="text-muted small">로딩 중...</div>';

        const [structured, attachments] = await Promise.all([
          fetch(`/api/orders/${orderId}/structured`).then(r => r.json()).catch(err => {
            console.error('Structured data fetch error:', err);
            return { success: false, structured_data: {} };
          }),
          fetch(`/api/orders/${orderId}/attachments`).then(r => r.json()).catch(err => {
            console.error('Attachments fetch error:', err);
            return { success: false, attachments: [] };
          }),
        ]);

        const sd = (structured && structured.structured_data) || {};
        const customer = (((sd.parties || {}).customer || {}).name) || '-';
        const orderer = (((sd.parties || {}).orderer || {}).name) || '-';
        const phone = (((sd.parties || {}).customer || {}).phone) || '-';
        // 주소: address_full 우선, 없으면 address_main + address_detail 조합, 없으면 address_main만
        const site = sd.site || {};
        const addressFull = site.address_full || '';
        const addressMain = site.address_main || '';
        const addressDetail = site.address_detail || '';
        const address = addressFull || (addressMain && addressDetail ? `${addressMain} ${addressDetail}`.trim() : addressMain) || addressDetail || '-';
        // 특이사항: notes 객체에서 읽기 (erpbeta 저장 경로와 일치)
        const notes = sd.notes || {};
        const addressNote = (notes.address_note || '').trim();
        const phoneNote = (notes.phone_note || '').trim();
        const measureNote = (notes.measurement_note || '').trim();
        const measure = (((sd.schedule || {}).measurement || {}).date) || '-';
        const construct = (((sd.schedule || {}).construction || {}).date) || '-';
        const manager = (((sd.parties || {}).manager || {}).name) || '-';
        const stage = (((sd.workflow || {}).stage)) || '-';
        const urgent = ((sd.flags || {}).urgent) || false;

        // 담당팀: 현재 단계의 담당팀으로 자동 계산
        const STAGE_TO_TEAM = {
          'RECEIVED': 'CS',
          'HAPPYCALL': 'CS',
          'MEASURE': 'SALES',
          'DRAWING': 'DRAWING',
          'CONFIRM': 'SALES',
          'PRODUCTION': 'PRODUCTION',
          'CONSTRUCTION': 'CONSTRUCTION',
          'CS': 'CS',
          'COMPLETED': 'CS',
          'AS': 'CS'
        };
        let ownerTeam = STAGE_TO_TEAM[stage] || '-';
        // 실측/고객컨펌에서 발주사에 '라홈' 포함 시 라홈팀(CS)으로 변경
        if (stage === 'MEASURE' || stage === 'CONFIRM') {
          const ordererName = (((sd.parties || {}).orderer || {}).name || '').trim();
          if (ordererName && ordererName.includes('라홈')) {
            ownerTeam = 'CS';
          }
        }

        // 제품 항목 (모든 상세 정보 표시)
        const items = (sd.items || []) || [];
        let itemsHtml = '';
        if (items.length > 0) {
          let gridHtml = '<div class="erp-product-items-grid mt-3">';
          items.forEach(item => {
            // 규격을 W, D, H로 분리
            let specW = item.spec_width || '';
            let specD = item.spec_depth || '';
            let specH = item.spec_height || '';
            // 기존 spec 필드가 있고 W, D, H가 없으면 파싱
            if (!specW && !specD && !specH && item.spec) {
              const specStr = String(item.spec || '').trim();
              const parts = specStr.split(/[xX*×]/).map(s => s.trim());
              if (parts.length >= 3) {
                specW = parts[0];
                specD = parts[1];
                specH = parts[2];
              } else if (parts.length === 2) {
                specW = parts[0];
                specD = parts[1];
              } else if (parts.length === 1) {
                specW = parts[0];
              }
            }
            // 규격을 한 줄로 통합 (모바일용)
            const specParts = [];
            if (specW && specW !== '-') specParts.push(`W:${specW}`);
            if (specD && specD !== '-') specParts.push(`D:${specD}`);
            if (specH && specH !== '-') specParts.push(`H:${specH}`);
            const specCombined = specParts.length > 0 ? specParts.join(' × ') : '-';
            const priceText = item.price ? item.price.toLocaleString('ko-KR') + '원' : '-';

            // 값이 빈 문자열이거나 null/undefined일 때 '-'로 표시
            const safeValue = (val) => {
              if (val === null || val === undefined || val === '') return '-';
              return String(val).trim() || '-';
            };

            gridHtml += `<div class="erp-product-items-card">
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">제품명:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.product_name || item.name))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">규격:</span>
                <span class="erp-product-items-value">${escapeHtml(specCombined)}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">내부:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.internal))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">색상:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.color))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">옵션:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.option_detail || item.options))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">손잡이:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.handle))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">기타:</span>
                <span class="erp-product-items-value">${escapeHtml(safeValue(item.misc))}</span>
              </div>
              <div class="erp-product-items-row">
                <span class="erp-product-items-label">금액:</span>
                <span class="erp-product-items-value">${escapeHtml(priceText)}</span>
              </div>
            </div>`;
          });
          gridHtml += '</div>';
          itemsHtml = gridHtml;
        } else {
          itemsHtml = '<div class="text-muted mt-3" style="font-size: 1rem;">제품 항목 없음</div>';
        }

        // 첨부 파일 (여백 최소화, 미리보기 기능)
        // API 응답 구조 확인: attachments.attachments 또는 attachments (배열 직접 반환)
        let aList = [];
        if (attachments) {
          if (Array.isArray(attachments)) {
            aList = attachments;
          } else if (attachments.attachments && Array.isArray(attachments.attachments)) {
            aList = attachments.attachments;
          } else if (attachments.success !== false && attachments.attachments) {
            // success가 true이고 attachments가 있는 경우
            aList = attachments.attachments;
          } else if (attachments.success === false) {
            console.warn('Attachments API returned error:', attachments.message || 'Unknown error');
            aList = [];
          } else {
            // 디버깅: 응답 구조 확인
            console.log('Attachments API response structure:', attachments);
            aList = [];
          }
        } else {
          console.warn('Attachments response is null or undefined');
        }
        // 첨부 파일 캐시 저장
        __attachmentsCache[orderId] = aList;

        let attachmentsHtml = '';
        if (aList.length > 0) {
          attachmentsHtml = '<div class="d-flex flex-wrap gap-1 mt-2">';
          aList.forEach(a => {
            const name = escapeHtml(a.filename || '');
            const viewUrl = a.view_url || '#';
            const thumb = a.thumbnail_view_url || viewUrl;
            const downloadUrl = a.download_url || viewUrl;
            const fileType = a.file_type || 'image';
            if (fileType === 'video') {
              attachmentsHtml += `<div class="position-relative" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'video')">
                <div style="width: 80px; height: 60px; background: #000; display: flex; align-items: center; justify-content: center;">
                  <video src="${viewUrl}" preload="metadata" style="width:100%;height:100%;object-fit:cover;"></video>
                </div>
                <div class="position-absolute top-0 start-0 bg-dark bg-opacity-75 text-white p-1" style="font-size: 10px;"><i class="fas fa-play"></i></div>
              </div>`;
            } else {
              attachmentsHtml += `<div class="position-relative" style="width: 80px; height: 60px; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;" onclick="openAttachmentPreviewModal(${a.id}, '${viewUrl.replace(/'/g, "\\'")}', '${downloadUrl.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', 'image')">
                <img src="${thumb}" style="width: 80px; height: 60px; object-fit: cover; background:#fff; display: block;" alt="${name}">
              </div>`;
            }
          });
          attachmentsHtml += '</div>';
        } else {
          attachmentsHtml = '<div class="text-muted small mt-2">첨부 없음</div>';
        }

        // 모바일 여부 확인 (992px 이하)
        const isMobile = window.innerWidth <= 992;

        const basicInfoHtml = isMobile ? '' : `
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold"><i class="fas fa-info-circle text-primary"></i> 기본 정보</h5>
                  <div class="erp-detail-text">
                    <div class="mb-3"><strong class="erp-detail-label">고객명:</strong> <span class="erp-detail-value">${escapeHtml(customer)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">발주사:</strong> <span class="erp-detail-value">${escapeHtml(orderer)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">연락처:</strong> <span class="erp-detail-value">${escapeHtml(phone)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">주소:</strong> <span class="erp-detail-value">${escapeHtml(address)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">담당자:</strong> <span class="erp-detail-value">${escapeHtml(manager)}</span></div>
                  </div>
                </div>
              </div>
            </div>`;

        const noteRows = [];
        if (addressNote) {
          noteRows.push(`<div class="mb-3"><strong class="erp-detail-label">주소특이:</strong> <span class="erp-detail-value">${escapeHtml(addressNote)}</span></div>`);
        }
        if (phoneNote) {
          noteRows.push(`<div class="mb-3"><strong class="erp-detail-label">연락특이:</strong> <span class="erp-detail-value">${escapeHtml(phoneNote)}</span></div>`);
        }
        if (measureNote) {
          noteRows.push(`<div class="mb-3"><strong class="erp-detail-label">실측특이:</strong> <span class="erp-detail-value">${escapeHtml(measureNote)}</span></div>`);
        }
        const notesHtml = noteRows.join('');

        const scheduleHtml = `
            <div class="${isMobile ? 'col-12' : 'col-md-6'}">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold"><i class="fas fa-calendar text-primary"></i> 일정 및 특이사항</h5>
                  <div class="erp-detail-text">
                    ${isMobile ? '' : `<div class="mb-3"><strong class="erp-detail-label">실측일:</strong> <span class="erp-detail-value">${escapeHtml(measure)}</span></div>
                    <div class="mb-3"><strong class="erp-detail-label">시공일:</strong> <span class="erp-detail-value">${escapeHtml(construct)}</span></div>`}
                    ${notesHtml}
                  </div>
                </div>
              </div>
            </div>`;

        // 도면 전달 버튼 (DRAWING 단계일 때만)
        // 시공 관련 버튼
        let actionHtml = '';
        if (stage === 'CONSTRUCTION' || stage === '시공' || stage === '시공대기' || stage === '시공중') {
          actionHtml = `
            <div class="col-12">
              <div class="card bg-light border-primary">
                <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div>
                    <h5 class="card-title fw-bold text-primary mb-1"><i class="fas fa-hammer"></i> 시공 관리</h5>
                    <p class="mb-0 text-muted small">시공 일정 및 완료 여부를 관리하세요.</p>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="startConstruction(${orderId})">
                      <i class="fas fa-play"></i> 시공 시작
                    </button>
                    <button class="btn btn-success" onclick="completeConstruction(${orderId})">
                      <i class="fas fa-check"></i> 시공 완료
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        }

        container.innerHTML = `
          <div class="row g-3 erp-order-detail">
            ${basicInfoHtml}
            ${scheduleHtml}
            ${actionHtml}
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-3"><i class="fas fa-box text-primary"></i> 제품 항목</h5>
                  ${itemsHtml}
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title fw-bold mb-3"><i class="fas fa-paperclip text-primary"></i> 첨부 파일 <span class="badge bg-secondary" style="font-size: 1rem;">${aList.length}개</span></h5>
                  ${attachmentsHtml}
                </div>
              </div>
            </div>
          </div>
        `;

      } catch (err) {
        console.error('주문 상세 로드 실패:', err);
        container.innerHTML = '<div class="text-danger small">로드 실패: ' + escapeHtml(err.message) + '</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // 필터 폼 제출 시 alert_type 파라미터 유지
      const form = document.getElementById('erp-filters-form');
      if (form) {
        form.addEventListener('submit', function (e) {
          const url = new URL(window.location.href);
          const currentAlertType = url.searchParams.get('alert_type');
          if (currentAlertType) {
            let alertTypeInput = this.querySelector('input[name="alert_type"]');
            if (!alertTypeInput) {
              alertTypeInput = document.createElement('input');
              alertTypeInput.type = 'hidden';
              alertTypeInput.name = 'alert_type';
              this.appendChild(alertTypeInput);
            }
            alertTypeInput.value = currentAlertType;
          }
        });
      }

      // 주문 상세 collapse 오픈 시: 상세 로드 완료 후 navbar 바로 아래로 정렬
      document.querySelectorAll('.collapse[id^="order-detail-collapse-"]').forEach(collapseEl => {
        collapseEl.addEventListener('shown.bs.collapse', async function () {
          const orderId = this.id.replace('order-detail-collapse-', '');

          const alignDetailUnderNavbar = () => {
            const nav = document.querySelector('nav.navbar');
            const navHeight = nav ? nav.offsetHeight : 56;
            const titleEl = this.querySelector('.erp-order-detail-title') || this;
            const targetTop = window.scrollY + titleEl.getBoundingClientRect().top - navHeight - 8;
            window.scrollTo({ top: Math.max(0, targetTop), behavior: 'auto' });
          };

          // 1차: collapse 오픈 직후 정렬
          alignDetailUnderNavbar();

          // 2차: 상세 내용 렌더 완료 후 다시 정렬 (높이 변동 보정)
          await loadOrderDetail(parseInt(orderId, 10));
          requestAnimationFrame(alignDetailUnderNavbar);
          setTimeout(alignDetailUnderNavbar, 120);
        });
      });

      // 프로세스 맵 & 알림 타일 클릭 → 필터 적용 후 리로드
      const applyFilter = (name, value) => {
        if (!form) return;
        let input = form.querySelector(`[name="${name}"]`);

        // input이 없으면 (특히 alert_type hidden input이 초기 상태에서 없을 수 있음) 생성
        if (!input) {
          input = document.createElement('input');
          input.type = 'hidden';
          input.name = name;
          form.appendChild(input);
        }

        const current = input.value || '';
        const next = value || '';

        // 같은 값을 다시 클릭하면 해제(전체보기)
        input.value = (current === next) ? '' : next;

        form.submit();
      };

      // 프로세스 맵 (Pipeline Stages)
      document.querySelectorAll('.erp-pro-pipeline__stage[data-stage]').forEach(el => {
        const handler = () => applyFilter('stage', el.dataset.stage || '');
        el.addEventListener('click', handler);
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handler();
          }
        });
      });

      // 알림 타일 (Alert Tiles)
      document.querySelectorAll('.erp-pro-alert[data-alert-type]').forEach(el => {
        const handler = () => applyFilter('alert_type', el.dataset.alertType || '');
        el.addEventListener('click', handler);
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handler();
          }
        });
      });

      // 이벤트 위임: 퀘스트 승인, 첨부 미리보기 등
      document.body.addEventListener('click', function (e) {
        // 승인 버튼
        const approveBtn = e.target.closest('.erp-btn-approve-team');
        if (approveBtn) {
          const orderId = approveBtn.dataset.orderId;
          const team = approveBtn.dataset.team;
          if (typeof approveQuestTeam === 'function') {
            approveQuestTeam(Number(orderId), team);
          } else {
            console.warn('approveQuestTeam is not defined');
          }
        }

        // 첨부파일 미리보기 버튼
        const attBtn = e.target.closest('.erp-btn-attachments-preview');
        if (attBtn) {
          const orderId = attBtn.dataset.orderId;
          if (typeof openAttachmentsPreview === 'function') {
            openAttachmentsPreview(Number(orderId));
          }
        }
      });
    });
  </script>

  <!-- 알림 패널 -->
  <div id="notification-panel" class="notification-panel" style="display: none;">
    <div class="notification-panel__header">
      <h4><i class="fas fa-bell"></i> 알림</h4>
      <button class="notification-panel__close" onclick="toggleNotificationPanel()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="notification-panel__actions">
      <button class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsRead()">
        <i class="fas fa-check-double"></i> 모두 읽음
      </button>
    </div>
    <div class="notification-panel__list" id="notification-list">
      <div class="notification-empty">알림이 없습니다.</div>
    </div>
  </div>

  <style>
    /* 알림 배지 */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .erp-pro-btn--icon {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .erp-pro-btn--icon:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* 알림 패널 */
    .notification-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      width: 380px;
      max-height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      overflow: hidden;
    }

    .notification-panel__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .notification-panel__header h4 {
      margin: 0;
      font-size: 16px;
    }

    .notification-panel__close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.8;
    }

    .notification-panel__close:hover {
      opacity: 1;
    }

    .notification-panel__actions {
      padding: 10px 20px;
      border-bottom: 1px solid #eee;
      text-align: right;
    }

    .notification-panel__list {
      max-height: 380px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 14px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notification-item:hover {
      background: #f8f9fa;
    }

    .notification-item--unread {
      background: #f0f5ff;
      border-left: 3px solid #667eea;
    }

    .notification-item__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .notification-item__title {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .notification-item__time {
      font-size: 11px;
      color: #999;
    }

    .notification-item__message {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    .notification-item__target {
      margin-top: 6px;
      font-size: 11px;
      color: #667eea;
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: #999;
    }
  </style>

  <script>
    // 알림 시스템 JavaScript
    let notificationPanelOpen = false;

    async function loadNotificationBadge() {
      try {
        const res = await fetch('/erp/api/notifications/badge');
        if (!res.ok) return;
        const contentType = res.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) return;
        const data = await res.json();
        const badge = document.getElementById('notification-badge');
        if (badge) {
          if (data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.style.display = 'block';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('Notification badge error:', e);
      }
    }

    async function loadNotifications() {
      const list = document.getElementById('notification-list');
      try {
        const res = await fetch('/erp/api/notifications?limit=20');
        if (!res.ok) {
          if (res.status === 429 && list) {
            list.innerHTML = '<div class="notification-empty">요청이 많아 잠시 후 다시 시도해 주세요.</div>';
          }
          return;
        }
        const contentType = res.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          if (list) list.innerHTML = '<div class="notification-empty">알림을 불러올 수 없습니다.</div>';
          return;
        }
        const data = await res.json();

        if (!data.success || !data.notifications || data.notifications.length === 0) {
          list.innerHTML = '<div class="notification-empty">알림이 없습니다.</div>';
          return;
        }

        list.innerHTML = data.notifications.map(n => `
          <div class="notification-item ${n.is_read ? '' : 'notification-item--unread'}" 
               data-id="${n.id}" 
               data-order-id="${n.order_id}"
               onclick="handleNotificationClick(${n.id}, ${n.order_id}, '${String(n.notification_type || '').replace(/'/g, "\\'")}', '${String(n.deep_tab || '').replace(/'/g, "\\'")}', '${String(n.deep_event_id || '').replace(/'/g, "\\'")}', '${String(n.deep_target_no || '').replace(/'/g, "\\'")}')">
            <div class="notification-item__header">
              <span class="notification-item__title">${escapeHtml(n.title)}</span>
              <span class="notification-item__time">${formatNotificationTime(n.created_at)}</span>
            </div>
            <div class="notification-item__message">${escapeHtml(n.message)}</div>
            <div class="notification-item__target">
              ${n.target_manager_name ? '담당: ' + escapeHtml(n.target_manager_name) : (n.target_team ? '팀: ' + escapeHtml(n.target_team) : '')}
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Load notifications error:', e);
      }
    }

    function toggleNotificationPanel() {
      const panel = document.getElementById('notification-panel');
      notificationPanelOpen = !notificationPanelOpen;
      panel.style.display = notificationPanelOpen ? 'block' : 'none';

      if (notificationPanelOpen) {
        loadNotifications();
      }
    }

    async function handleNotificationClick(notificationId, orderId, notificationType, deepTab, deepEventId, deepTargetNo) {
      // 읽음 처리
      try {
        await fetch(`/erp/api/notifications/${notificationId}/read`, { method: 'POST' });
        loadNotificationBadge();

        // 해당 주문 상세로 이동
        if (orderId) {
          if (notificationType === 'DRAWING_TRANSFERRED' || notificationType === 'DRAWING_REVISION') {
            const tab = deepTab || (notificationType === 'DRAWING_REVISION' ? 'requests' : 'timeline');
            let url = `/erp/drawing-workbench/${orderId}?tab=${encodeURIComponent(tab)}`;
            if (deepEventId) url += `&event_id=${encodeURIComponent(deepEventId)}`;
            if (deepTargetNo) url += `&target_no=${encodeURIComponent(deepTargetNo)}`;
            window.location.href = url;
          } else {
            window.location.href = `/edit/${orderId}`;
          }
        }
      } catch (e) {
        console.error('Notification click error:', e);
      }
    }

    async function markAllNotificationsRead() {
      try {
        const res = await fetch('/erp/api/notifications/read-all', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          loadNotificationBadge();
          loadNotifications();
        }
      } catch (e) {
        console.error('Mark all read error:', e);
      }
    }

    function formatNotificationTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr.replace(' ', 'T'));
      const now = new Date();
      const diff = (now - date) / 1000;

      if (diff < 60) return '방금';
      if (diff < 3600) return Math.floor(diff / 60) + '분 전';
      if (diff < 86400) return Math.floor(diff / 3600) + '시간 전';
      if (diff < 604800) return Math.floor(diff / 86400) + '일 전';

      return dateStr.split(' ')[0];
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // 페이지 로드 시 배지 업데이트
    document.addEventListener('DOMContentLoaded', function () {
      loadNotificationBadge();

      // 60초마다 배지 업데이트 (rate-limit 여유 확보)
      setInterval(loadNotificationBadge, 60000);
    });

    // 패널 외부 클릭 시 닫기
    document.addEventListener('click', function (e) {
      const panel = document.getElementById('notification-panel');
      const btn = document.getElementById('notification-btn');
      if (notificationPanelOpen && !panel.contains(e.target) && !btn.contains(e.target)) {
        toggleNotificationPanel();
      }
    });
  </script>
</div>
{% endblock %}