{% extends "layout.html" %}

{% block head %}
{% if socketio_available %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endif %}
<script>
    // Socket.IO 사용 가능 여부는 DOM에서 가져옴
</script>
{% endblock %}

{% block styles %}
<style>
    /* 채팅방 카드 스타일 (calculator.html 참고) */
    .chat-sidebar-card {
        display: flex;
        flex-direction: column;
    }
    
    .chat-sidebar-card .card-body {
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-rooms-list {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    
    .chat-room-item {
        padding: 12px;
        margin-bottom: 8px;
        background-color: white;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 1px solid #e0e0e0;
    }
    
    .chat-room-item:hover {
        background-color: #f0f0f0;
    }
    
    .chat-room-item.active {
        background-color: #e3f2fd;
        border-color: #2196f3;
    }
    
    .chat-room-item .room-name {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .chat-room-item .room-last-message {
        font-size: 0.9rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-room-item .room-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 4px;
        font-size: 0.85rem;
        color: #999;
    }
    
    .unread-badge {
        background-color: #f44336;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* 메인 채팅 카드 스타일 */
    .chat-main-card {
        display: flex;
        flex-direction: column;
    }
    
    .chat-main-card .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 0;
    }
    
    .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: white;
    }
    
    .chat-order-widget-container {
        position: sticky;
        top: 0;
        z-index: 99;
        background-color: white;
        border-bottom: 1px solid #ddd;
        padding: 0;
    }
    
    .chat-order-widget-table {
        margin: 0;
        font-size: 0.875rem;
    }
    
    .chat-order-widget-table table {
        margin: 0;
        border: 1px solid #ddd;
    }
    
    .chat-order-widget-table .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 8px 12px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .chat-order-widget-table .table td {
        padding: 8px 12px;
        vertical-align: middle;
    }
    
    /* 고객명, 주소, 제품 컬럼 반응형 설정 - 줄바꿈 허용 */
    .chat-order-widget-table .table td:nth-child(2),
    .chat-order-widget-table .table td:nth-child(3),
    .chat-order-widget-table .table td:nth-child(4) {
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
        max-width: 0;  /* 반응형 테이블을 위한 설정 */
    }
    
    .chat-order-widget-table .table th:nth-child(2),
    .chat-order-widget-table .table th:nth-child(3),
    .chat-order-widget-table .table th:nth-child(4) {
        white-space: normal;
    }
    
    .chat-order-widget-table .unprocessed-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .chat-order-widget-table .badge {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    
    .chat-order-widget-table .status-dropdown {
        font-size: 0.75rem;
        padding: 4px 8px;
        min-width: 100px;
        color: #212529 !important;  /* 기본 텍스트 색상 (검은색) */
        background-color: white !important;  /* 기본 배경색 */
        border: 1px solid #ced4da !important;
    }
    
    /* 상태별 배경색 클래스 - 글자색은 흰색 */
    .chat-order-widget-table .status-dropdown.status-received {
        background-color: #1976d2 !important;
        color: white !important;
        border-color: #1565c0 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-measured {
        background-color: #f57c00 !important;
        color: white !important;
        border-color: #ef6c00 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-regional_measured {
        background-color: #8e24aa !important;
        color: white !important;
        border-color: #7b1fa2 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-scheduled {
        background-color: #d32f2f !important;
        color: white !important;
        border-color: #c62828 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-shipped_pending {
        background-color: #17a2b8 !important;
        color: white !important;
        border-color: #138496 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-completed {
        background-color: #2e7d32 !important;
        color: white !important;
        border-color: #1b5e20 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-as_received {
        background-color: #7b1fa2 !important;
        color: white !important;
        border-color: #6a1b9a !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-as_completed {
        background-color: #00695c !important;
        color: white !important;
        border-color: #004d40 !important;
    }
    
    .chat-order-widget-table .status-dropdown.status-on_hold {
        background-color: #616161 !important;
        color: white !important;
        border-color: #424242 !important;
    }
    
    /* option 요소는 항상 검은색 텍스트 */
    .chat-order-widget-table .status-dropdown option {
        color: #212529 !important;
        background-color: white !important;
    }
    
    .chat-order-widget-table .form-control-sm,
    .chat-order-widget-table .form-select-sm {
        font-size: 0.75rem;
        padding: 4px 8px;
        height: 28px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f5f5f5;
        min-height: 0;
    }
    
    .message-item {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    
    .message-item.own {
        align-items: flex-end;
    }
    
    .message-item.other {
        align-items: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message-item.own .message-bubble {
        background-color: #2196f3;
        color: white;
    }
    
    /* 자신의 메시지 버블 내 파일 링크 버튼 스타일 */
    .message-item.own .message-bubble .btn-outline-primary {
        background-color: white !important;
        color: #2196f3 !important;
        border-color: white !important;
    }
    
    .message-item.own .message-bubble .btn-outline-primary:hover {
        background-color: #f5f5f5 !important;
        color: #1976d2 !important;
        border-color: #f5f5f5 !important;
    }
    
    .message-item.other .message-bubble {
        background-color: white;
        color: #333;
        border: 1px solid #e0e0e0;
    }
    
    .message-meta {
        font-size: 0.75rem;
        color: #999;
        margin-top: 4px;
        padding: 0 5px;
    }
    
    .message-file {
        margin-top: 8px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
    }
    
    .message-file img {
        max-width: 100%;
        border-radius: 8px;
        background-color: white;
        padding: 4px;
    }
    
    .chat-input-area {
        padding: 15px 20px;
        border-top: 1px solid #ddd;
        background-color: white;
    }
    
    .chat-input-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    
    .chat-input-wrapper textarea {
        flex: 1;
        resize: none;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 10px 15px;
        min-height: 40px;
        max-height: 120px;
    }
    
    .file-preview {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        display: none;
    }
    
    .file-preview.active {
        display: block;
    }
    
    .file-preview img,
    .file-preview video {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        background-color: white;
    }
    
    .btn-new-room {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .typing-indicator {
        font-size: 0.9rem;
        color: #999;
        font-style: italic;
        padding: 5px 15px;
    }
    
    /* 채널톡 스타일 추가 기능 */
    .read-receipt {
        font-size: 0.7rem;
        color: #999;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .read-receipt .read-icon {
        color: #2196f3;
    }
    
    .message-search {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
    }
    
    .message-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
    }
    
    .online-indicator {
        width: 8px;
        height: 8px;
        background-color: #4caf50;
        border-radius: 50%;
        display: inline-block;
        margin-left: 5px;
    }
    
    .message-reaction {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background-color: #f0f0f0;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-left: 5px;
        cursor: pointer;
    }
    
    .message-reaction:hover {
        background-color: #e0e0e0;
    }
    
    .order-widget {
        margin: 15px;
        padding: 15px;
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
    }
    
    .order-widget h6 {
        margin-bottom: 10px;
        color: #856404;
    }
    
    .order-widget .order-info {
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .order-widget .order-info strong {
        color: #856404;
    }
    
    .estimates-list {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ffc107;
    }
    
    .estimate-item {
        padding: 8px;
        margin-bottom: 5px;
        background-color: white;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    /* 이미지 확대 모달 (Lightbox) */
    .image-lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        cursor: zoom-out;
        overflow: hidden;
    }
    
    .image-lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-lightbox-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        transition: transform 0.3s ease;
        cursor: grab;
    }
    
    .image-lightbox-content:active {
        cursor: grabbing;
    }
    
    .image-lightbox-content img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        user-select: none;
        -webkit-user-drag: none;
    }
    
    .image-lightbox-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10001;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
    }
    
    .image-lightbox-close:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    .image-lightbox-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 10001;
    }
    
    .image-lightbox-controls button {
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .image-lightbox-controls button:hover {
        background: rgba(0, 0, 0, 0.8);
    }
    
    /* 드래그 앤 드롭 스타일 */
    .chat-input-area.drag-over {
        background-color: #e3f2fd;
        border: 2px dashed #2196f3;
        border-radius: 8px;
    }
    
    .drag-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(33, 150, 243, 0.1);
        border: 3px dashed #2196f3;
        z-index: 9999;
        pointer-events: none;
    }
    
    .drag-overlay.active {
        display: block;
    }
    
    .drag-overlay-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #2196f3;
        font-size: 24px;
        font-weight: bold;
    }
    
    .drag-overlay-content i {
        font-size: 64px;
        margin-bottom: 20px;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<!-- container-fluid py-4 제거: layout.html이 이미 감싸고 있음 -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="fas fa-comments text-primary"></i> 채팅</h2>
</div>

<div class="row">
    <!-- 사이드바: 채팅방 목록 -->
    <div class="col-lg-3 mb-4">
            <div class="card shadow-sm sticky-top chat-sidebar-card" 
                 data-sticky-top="true"
                 data-socketio-available="{% if socketio_available %}true{% else %}false{% endif %}"
                 data-user-id="{% if session.get('user_id') %}{{ session.get('user_id') }}{% else %}0{% endif %}"
                 style="top: 100px; max-height: calc(100vh - 150px);">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-comments text-primary"></i> 채팅방</h5>
                    <button class="btn btn-primary btn-sm" onclick="showCreateRoomModal()" title="새 채팅방">
                        <i class="fas fa-plus"></i> 새 채팅방
                    </button>
                </div>
                <div class="card-body p-2 d-flex flex-column">
                    <!-- 전역 검색 -->
                    <div class="input-group mb-2 flex-shrink-0">
                        <input type="text" id="global-search-input" class="form-control form-control-sm" 
                               placeholder="전체 검색 (메시지, 주문 정보 등)" 
                               onkeyup="performGlobalSearch(this.value)">
                    </div>
                    <div id="global-search-results" class="mb-2 flex-shrink-0" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background-color: white;"></div>
                    
                    <!-- 채팅방 목록 -->
                    <div class="chat-rooms-list" id="rooms-list">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                            <p>채팅방 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 메인 영역: 메시지 -->
        <div class="col-lg-9">
            <div class="card shadow-sm chat-main-card" data-min-height="true" style="min-height: calc(100vh - 150px);">
                <div class="card-header bg-white d-flex justify-content-between align-items-center chat-header" id="chat-header">
                    <div class="text-center text-muted py-4" style="flex: 1;">
                        채팅방을 선택하세요
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleSearch()" title="메시지 검색" style="display: none;" id="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <!-- 연결된 주문 정보 영역 (고정) -->
                <div id="chat-order-widget-container" class="chat-order-widget-container" style="display: none;"></div>
                <div class="card-body">
                    <!-- 메시지 검색 (숨김) -->
                    <div id="message-search" class="px-3 pt-2 pb-2 border-bottom flex-shrink-0" style="display: none;">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="메시지 검색..." onkeyup="searchMessages(this.value)">
                            <button class="btn btn-sm btn-link" type="button" onclick="closeSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 메시지 영역 -->
                    <div class="chat-messages" id="messages-container">
                        <!-- 메시지가 여기에 표시됩니다 -->
                    </div>
                    
                    <!-- 입력 영역 (숨김) -->
                    <div id="chat-input-area" class="p-3 border-top flex-shrink-0" style="display: none;">
                        <div id="file-preview" class="mb-2"></div>
                        <div class="chat-input-wrapper">
                            <input type="file" id="file-input" multiple style="display: none;" 
                                   accept="image/*,video/*,.pdf,.doc,.docx,.xlsx">
                            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('file-input').click()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <textarea id="message-input" class="form-control" rows="1" placeholder="메시지 입력..." onkeyup="handleTyping()"></textarea>
                            <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i> 전송
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이미지 확대 모달 (Lightbox) -->
<div class="image-lightbox" id="image-lightbox" onclick="closeImageLightbox(event)">
    <div class="image-lightbox-close" onclick="closeImageLightbox(event)">&times;</div>
    <div class="image-lightbox-content" id="image-lightbox-content">
        <img id="image-lightbox-img" src="" alt="확대 이미지">
    </div>
    <div class="image-lightbox-controls">
        <button onclick="resetImageZoom()">원본 크기</button>
        <button onclick="closeImageLightbox(event)">닫기</button>
    </div>
</div>

<!-- 드래그 앤 드롭 오버레이 -->
<div class="drag-overlay" id="drag-overlay">
    <div class="drag-overlay-content">
        <i class="fas fa-cloud-upload-alt"></i>
        <div>파일을 여기에 놓으세요</div>
    </div>
</div>

<!-- 새 채팅방 생성 모달 -->
<div class="modal fade" id="createRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 채팅방 만들기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">채팅방 이름</label>
                    <input type="text" class="form-control" id="room-name" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">설명 (선택)</label>
                    <textarea class="form-control" id="room-description" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">주문 연결 (선택)</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="order-search" placeholder="고객명 또는 주문 ID로 검색..." onkeyup="searchOrdersForRoom(this.value)">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearOrderSelection()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="order-search-results" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; margin-top: 5px; border-radius: 4px; display: none; background-color: white;"></div>
                    <div id="selected-order" style="margin-top: 5px; display: none;">
                        <div class="alert alert-info py-2 mb-0">
                            <i class="fas fa-check"></i> 선택된 주문: <span id="selected-order-name"></span>
                            <button type="button" class="btn-close float-end" onclick="clearOrderSelection()"></button>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">멤버 초대</label>
                    <div id="user-select-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #f8f9fa;">
                        <div class="text-center text-muted py-2">
                            <i class="fas fa-spinner fa-spin"></i> 사용자 목록 로딩 중...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createRoom()">생성</button>
            </div>
        </div>
    </div>
</div>

<!-- 주문 연결 모달 -->
<div class="modal fade" id="connectOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">주문 연결</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">주문 검색</label>
                    <input type="text" class="form-control" id="connect-order-search" placeholder="고객명 또는 주문 ID로 검색..." onkeyup="searchOrdersForConnect(this.value)">
                </div>
                <div id="connect-order-results" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: white;">
                    <div class="text-center text-muted py-2">검색어를 입력하세요</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>

<script>
// 설정 정보를 DOM에서 가져오기
const chatContainer = document.querySelector('.chat-sidebar-card');
const socketioAvailable = chatContainer ? chatContainer.getAttribute('data-socketio-available') === 'true' : false;
const userIdFromData = chatContainer ? parseInt(chatContainer.getAttribute('data-user-id') || '0', 10) : 0;

let socket = null;
let currentRoomId = null;
let currentUserId = userIdFromData;
window.SOCKETIO_AVAILABLE = window.SOCKETIO_AVAILABLE || socketioAvailable;

// ============================================
// 이미지 확대/축소 기능 (Lightbox) - 전역 스코프
// ============================================
let imageZoom = {
    scale: 1,
    minScale: 0.5,
    maxScale: 5,
    translateX: 0,
    translateY: 0,
    lastTranslateX: 0,
    lastTranslateY: 0
};

function openImageLightbox(imageUrl) {
    const lightbox = document.getElementById('image-lightbox');
    const img = document.getElementById('image-lightbox-img');
    
    if (!lightbox || !img) {
        console.error('라이트박스 요소를 찾을 수 없습니다.');
        return;
    }
    
    // 이미지 로드 후 transform 적용
    img.onload = function() {
        imageZoom.scale = 1;
        imageZoom.translateX = 0;
        imageZoom.translateY = 0;
        imageZoom.lastTranslateX = 0;
        imageZoom.lastTranslateY = 0;
        updateImageTransform();
    };
    
    // 이미지가 이미 로드되어 있는 경우
    if (img.complete) {
        img.onload();
    }
    
    img.src = imageUrl;
    lightbox.classList.add('active');
    
    // ESC 키로 닫기
    document.addEventListener('keydown', handleLightboxKeydown);
}

function closeImageLightbox(event) {
    // 이벤트가 없거나 배경/닫기 버튼을 클릭한 경우
    if (!event || 
        event.target.id === 'image-lightbox' || 
        event.target.id === 'image-lightbox-close' || 
        event.target.closest('.image-lightbox-controls')) {
        
        const lightbox = document.getElementById('image-lightbox');
        if (lightbox) {
            lightbox.classList.remove('active');
        }
        document.removeEventListener('keydown', handleLightboxKeydown);
    }
}

function handleLightboxKeydown(e) {
    if (e.key === 'Escape') {
        closeImageLightbox(e);
    }
}

function resetImageZoom() {
    imageZoom.scale = 1;
    imageZoom.translateX = 0;
    imageZoom.translateY = 0;
    imageZoom.lastTranslateX = 0;
    imageZoom.lastTranslateY = 0;
    updateImageTransform();
}

function updateImageTransform() {
    const content = document.getElementById('image-lightbox-content');
    if (content) {
        content.style.transform = `translate(${imageZoom.translateX}px, ${imageZoom.translateY}px) scale(${imageZoom.scale})`;
    }
}

// Socket.IO 연결
document.addEventListener('DOMContentLoaded', function() {
    // 네비게이션 바 높이 계산 및 sticky-top 요소 위치 조정
    function adjustStickyPositions() {
        const header = document.querySelector('header');
        const nav = document.querySelector('nav.navbar');
        
        if (header && nav) {
            const headerHeight = header.offsetHeight;
            const navHeight = nav.offsetHeight;
            const totalHeight = headerHeight + navHeight + 20; // 여유 공간 20px
            
            // sticky-top 요소들 위치 조정
            const stickyCards = document.querySelectorAll('[data-sticky-top="true"]');
            stickyCards.forEach(card => {
                card.style.top = totalHeight + 'px';
                card.style.maxHeight = `calc(100vh - ${totalHeight + 40}px)`;
            });
            
            // min-height가 필요한 요소들 조정
            const minHeightCards = document.querySelectorAll('[data-min-height="true"]');
            minHeightCards.forEach(card => {
                card.style.minHeight = `calc(100vh - ${totalHeight + 40}px)`;
            });
        } else {
            // 네비게이션 바가 없는 경우 기본값 사용
            const stickyCards = document.querySelectorAll('[data-sticky-top="true"]');
            stickyCards.forEach(card => {
                card.style.top = '20px';
                card.style.maxHeight = 'calc(100vh - 40px)';
            });
            
            const minHeightCards = document.querySelectorAll('[data-min-height="true"]');
            minHeightCards.forEach(card => {
                card.style.minHeight = 'calc(100vh - 40px)';
            });
        }
    }
    
    // 초기 위치 조정
    adjustStickyPositions();
    
    // 윈도우 리사이즈 시 다시 조정
    window.addEventListener('resize', adjustStickyPositions);
    
    // Socket.IO 연결 시도
    try {
        if (typeof io !== 'undefined') {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Socket.IO 연결됨');
                loadRooms();
            });
            
            socket.on('disconnect', function() {
                console.log('Socket.IO 연결 해제됨');
            });
            
            socket.on('connect_error', function(error) {
                console.warn('Socket.IO 연결 오류:', error);
                // Socket.IO 없이도 기본 기능은 작동하도록 계속 진행
                loadRooms();
            });
            
            socket.on('new_message', function(data) {
                if (data.room_id == currentRoomId) {
                    appendMessage(data);
                    scrollToBottom();
                    
                    // 새 메시지 수신 시 읽음 상태 업데이트
                    if (socket && socket.connected) {
                        socket.emit('mark_read', { room_id: currentRoomId });
                    } else {
                        fetch(`/api/chat/rooms/${currentRoomId}/mark-read`, {
                            method: 'POST'
                        }).catch(err => console.error('읽음 상태 업데이트 오류:', err));
                    }
                }
            });
            
            socket.on('message_read', function(data) {
                // 다른 사용자가 읽었을 때 읽음 상태 업데이트
                if (data.room_id == currentRoomId) {
                    // 메시지 목록 새로고침하여 읽음 상태 업데이트
                    loadRoomDetail(currentRoomId);
                }
            });
            
    socket.on('user_typing', function(data) {
        // 타이핑 인디케이터 표시 (채널톡 스타일)
        if (data.room_id == currentRoomId && data.user_id != currentUserId) {
            showTypingIndicator(data.user_id, data.is_typing);
        }
    });
        } else {
            console.warn('Socket.IO가 로드되지 않았습니다. 실시간 기능이 제한됩니다.');
            loadRooms();
        }
    } catch (error) {
        console.error('Socket.IO 초기화 오류:', error);
        // Socket.IO 없이도 기본 기능은 작동하도록 계속 진행
        loadRooms();
    }
    
    // Enter 키로 메시지 전송
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // 파일 선택 이벤트
    document.getElementById('file-input').addEventListener('change', function(e) {
        handleFileSelect(e.target.files);
    });
    
    // 마우스 휠로 확대/축소 (라이트박스가 활성화된 경우에만)
    const lightbox = document.getElementById('image-lightbox');
    if (lightbox) {
        lightbox.addEventListener('wheel', function(e) {
            // 라이트박스가 활성화되어 있는지 확인
            if (!lightbox.classList.contains('active')) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newScale = Math.max(imageZoom.minScale, 
                                     Math.min(imageZoom.maxScale, imageZoom.scale + delta));
            
            // 마우스 위치를 중심으로 확대/축소
            const rect = lightbox.getBoundingClientRect();
            const mouseX = e.clientX - rect.left - rect.width / 2;
            const mouseY = e.clientY - rect.top - rect.height / 2;
            
            const scaleChange = newScale / imageZoom.scale;
            imageZoom.translateX = imageZoom.translateX * scaleChange + mouseX * (1 - scaleChange);
            imageZoom.translateY = imageZoom.translateY * scaleChange + mouseY * (1 - scaleChange);
            
            imageZoom.scale = newScale;
            updateImageTransform();
        }, { passive: false });
    }
    
    // 이미지 드래그로 이동
    const lightboxContent = document.getElementById('image-lightbox-content');
    if (lightboxContent) {
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let startTranslateX = 0;
        let startTranslateY = 0;
        
        lightboxContent.addEventListener('mousedown', function(e) {
            if (e.button === 0 && lightbox.classList.contains('active')) { // 왼쪽 마우스 버튼만
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                startTranslateX = imageZoom.translateX;
                startTranslateY = imageZoom.translateY;
                lightboxContent.style.cursor = 'grabbing';
                e.preventDefault();
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging && lightbox.classList.contains('active')) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                imageZoom.translateX = startTranslateX + deltaX;
                imageZoom.translateY = startTranslateY + deltaY;
                updateImageTransform();
            }
        });
        
        document.addEventListener('mouseup', function(e) {
            if (isDragging) {
                isDragging = false;
                lightboxContent.style.cursor = 'grab';
            }
        });
        
        // 터치 제스처 지원 (모바일)
        let touchStartDistance = 0;
        let touchStartScale = 1;
        let touchStartX = 0;
        let touchStartY = 0;
        
        lightboxContent.addEventListener('touchstart', function(e) {
            if (!lightbox.classList.contains('active')) return;
            
            if (e.touches.length === 1) {
                // 단일 터치: 이동
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                startTranslateX = imageZoom.translateX;
                startTranslateY = imageZoom.translateY;
            } else if (e.touches.length === 2) {
                // 핀치 줌
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                touchStartDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                touchStartScale = imageZoom.scale;
            }
        });
        
        lightboxContent.addEventListener('touchmove', function(e) {
            if (!lightbox.classList.contains('active')) return;
            
            e.preventDefault();
            
            if (e.touches.length === 1) {
                // 단일 터치: 이동
                const deltaX = e.touches[0].clientX - touchStartX;
                const deltaY = e.touches[0].clientY - touchStartY;
                imageZoom.translateX = startTranslateX + deltaX;
                imageZoom.translateY = startTranslateY + deltaY;
                updateImageTransform();
            } else if (e.touches.length === 2) {
                // 핀치 줌
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                const scaleChange = currentDistance / touchStartDistance;
                imageZoom.scale = Math.max(imageZoom.minScale, 
                                         Math.min(imageZoom.maxScale, touchStartScale * scaleChange));
                updateImageTransform();
            }
        });
    }
    
    // ============================================
    // 드래그 앤 드롭 기능
    // ============================================
    const chatInputArea = document.getElementById('chat-input-area');
    const dragOverlay = document.getElementById('drag-overlay');
    
    // 드래그 오버 이벤트
    chatInputArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        chatInputArea.classList.add('drag-over');
        dragOverlay.classList.add('active');
    });
    
    chatInputArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        // 드래그가 자식 요소로 이동한 경우는 제외
        if (!chatInputArea.contains(e.relatedTarget)) {
            chatInputArea.classList.remove('drag-over');
            dragOverlay.classList.remove('active');
        }
    });
    
    // 드롭 이벤트
    chatInputArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        chatInputArea.classList.remove('drag-over');
        dragOverlay.classList.remove('active');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files);
        }
    });
    
    // 전체 화면 드래그 오버 (채팅 영역 밖에서도)
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
        // 채팅 입력 영역이 보이는 경우에만 오버레이 표시
        if (chatInputArea.style.display !== 'none') {
            dragOverlay.classList.add('active');
        }
    });
    
    document.addEventListener('dragleave', function(e) {
        e.preventDefault();
        // 드래그가 완전히 벗어난 경우
        if (!e.relatedTarget || e.relatedTarget === document.body) {
            dragOverlay.classList.remove('active');
        }
    });
    
    document.addEventListener('drop', function(e) {
        e.preventDefault();
        dragOverlay.classList.remove('active');
        
        // 채팅 입력 영역이 보이는 경우에만 파일 처리
        if (chatInputArea.style.display !== 'none' && e.dataTransfer.files.length > 0) {
            const files = e.dataTransfer.files;
            handleFileSelect(files);
        }
    });
});

// 채팅방 목록 로드
function loadRooms() {
    fetch('/api/chat/rooms')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderRooms(data.rooms);
            }
        })
        .catch(error => {
            console.error('채팅방 목록 로드 오류:', error);
        });
}

// 채팅방 목록 렌더링
function renderRooms(rooms) {
    const container = document.getElementById('rooms-list');
    
    if (rooms.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">채팅방이 없습니다</div>';
        return;
    }
    
    container.innerHTML = rooms.map(room => {
        const lastMessage = room.last_message ? 
            (room.last_message.content || '파일') : '메시지가 없습니다';
        const unreadBadge = room.unread_count > 0 ? 
            `<span class="unread-badge">${room.unread_count}</span>` : '';
        
        return `
            <div class="chat-room-item" onclick="selectRoom(${room.id})" data-room-id="${room.id}">
                <div class="room-name">${escapeHtml(room.name)}</div>
                <div class="room-last-message">${escapeHtml(lastMessage)}</div>
                <div class="room-meta">
                    <span>${formatDate(room.updated_at || room.created_at)}</span>
                    ${unreadBadge}
                </div>
            </div>
        `;
    }).join('');
}

// 채팅방 선택
function selectRoom(roomId) {
    currentRoomId = roomId;
    
    // UI 업데이트
    document.querySelectorAll('.chat-room-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // null 체크 추가
    const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
    if (roomElement) {
        roomElement.classList.add('active');
    }
    
    // Socket.IO 방 입장 (socket이 존재할 때만)
    if (socket && socket.connected) {
        socket.emit('join_room', { room_id: roomId });
    }
    
    // 채팅방 상세 정보 로드
    loadRoomDetail(roomId);
}

// 채팅방 상세 정보 로드
function loadRoomDetail(roomId) {
    fetch(`/api/chat/rooms/${roomId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderRoomHeader(data.room);
                renderMessages(data.room.messages);
                document.getElementById('chat-input-area').style.display = 'block';
                updateChatHeader();  // 검색 버튼 표시
                scrollToBottom();
                
                // 채팅방 입장 시 읽음 상태 업데이트
                if (socket && socket.connected) {
                    socket.emit('mark_read', { room_id: roomId });
                } else {
                    // REST API로 읽음 상태 업데이트
                    fetch(`/api/chat/rooms/${roomId}/mark-read`, {
                        method: 'POST'
                    }).catch(err => console.error('읽음 상태 업데이트 오류:', err));
                }
            }
        })
        .catch(error => {
            console.error('채팅방 상세 로드 오류:', error);
        });
}

// 채팅방 헤더 렌더링
function renderRoomHeader(room) {
    const header = document.getElementById('chat-header');
    const orderWidgetContainer = document.getElementById('chat-order-widget-container');
    let orderWidget = '';
    
    // 주문 정보 위젯 (Quest 12) - 테이블 형식으로 표시
    if (room.order) {
        const order = room.order;
        
        // 미처리 항목 확인
        let unprocessedBadges = '';
        const unprocessedItems = [];
        if (!order.manager_name) {
            unprocessedItems.push('<span class="badge bg-danger">담당자 미지정</span>');
        }
        if (!order.scheduled_date) {
            unprocessedItems.push('<span class="badge bg-danger">설치일 미지정</span>');
        }
        unprocessedBadges = unprocessedItems.length > 0 
            ? `<div class="unprocessed-badges">${unprocessedItems.join('')}</div>` 
            : '-';
        
        // 상태 옵션 생성
        const statusList = {
            'RECEIVED': '접수',
            'MEASURED': '실측',
            'REGIONAL_MEASURED': '지방실측',
            'SCHEDULED': '설치 예정',
            'SHIPPED_PENDING': '상차 예정',
            'COMPLETED': '완료',
            'AS_RECEIVED': 'AS 접수',
            'AS_COMPLETED': 'AS 완료',
            'ON_HOLD': '보류'
        };
        
        // order.status 값 정규화 및 디버깅
        const currentStatus = (order.status || 'RECEIVED').toString().trim().toUpperCase();
        console.log('Order ID:', order.id, 'Current Status:', currentStatus, 'Raw Status:', order.status);
        
        let statusOptions = '';
        for (const [code, name] of Object.entries(statusList)) {
            const codeUpper = code.toUpperCase();
            const selected = (currentStatus === codeUpper) ? 'selected' : '';
            statusOptions += `<option value="${code}" ${selected}>${name}</option>`;
        }
        
        // statusOptions가 비어있는 경우 기본값 설정
        if (!statusOptions) {
            console.warn('Status options is empty, using default');
            statusOptions = '<option value="RECEIVED" selected>접수</option>';
        }
        
        console.log('Generated status options:', statusOptions.substring(0, 200));
        
        orderWidget = `
            <div class="chat-order-widget-table">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0" style="table-layout: auto; width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">번호</th>
                                <th>고객명</th>
                                <th>주소</th>
                                <th>제품</th>
                                <th style="width: 100px;">상태</th>
                                <th style="width: 100px;">실측일</th>
                                <th style="width: 150px;">미처리 항목</th>
                                <th style="width: 120px;">담당자</th>
                                <th style="width: 140px;">설치 예정일</th>
                                <th style="width: 80px;">작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>#${order.id}</td>
                                <td>
                                    <div>${escapeHtml(order.customer_name || '-')}</div>
                                    <small class="text-muted">${escapeHtml(order.phone || '-')}</small>
                                </td>
                                <td title="${escapeHtml(order.address || '-')}">
                                    ${escapeHtml(order.address || '-')}
                                </td>
                                <td title="${escapeHtml(order.product || '-')}">
                                    ${escapeHtml(order.product || '-')}
                                </td>
                                <td>
                                    <select class="form-select form-select-sm status-dropdown status-${(currentStatus || 'RECEIVED').toLowerCase().replace(/_/g, '_')}" 
                                            data-order-id="${order.id}" 
                                            data-current-status="${currentStatus || 'RECEIVED'}"
                                            onchange="updateOrderStatus(${order.id}, this.value); if(typeof applyStatusColor === 'function') applyStatusColor(this);">
                                        ${statusOptions || '<option value="RECEIVED" selected>접수</option>'}
                                    </select>
                                </td>
                                <td>${order.measurement_date || '-'}</td>
                                <td>${unprocessedBadges}</td>
                                <td>
                                    <input type="text" 
                                           class="form-control form-control-sm" 
                                           value="${escapeHtml(order.manager_name || '')}"
                                           placeholder="담당자 입력"
                                           data-order-id="${order.id}"
                                           data-field="manager_name"
                                           onblur="updateOrderField(${order.id}, 'manager_name', this.value)">
                                </td>
                                <td>
                                    <input type="date" 
                                           class="form-control form-control-sm" 
                                           value="${order.scheduled_date || ''}"
                                           data-order-id="${order.id}"
                                           data-field="scheduled_date"
                                           onchange="updateOrderField(${order.id}, 'scheduled_date', this.value)">
                                </td>
                                <td>
                                    <a href="/edit/${order.id}" 
                                       class="btn btn-sm btn-outline-secondary" 
                                       title="수정"
                                       target="_blank">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        orderWidgetContainer.innerHTML = orderWidget;
        orderWidgetContainer.style.display = 'block';
        // order-widget-container의 top을 chat-header 높이로 설정
        const headerHeight = header.offsetHeight;
        orderWidgetContainer.style.top = headerHeight + 'px';
    } else {
        orderWidgetContainer.innerHTML = '';
        orderWidgetContainer.style.display = 'none';
    }
    
    // 멤버 목록 표시
    const membersHtml = room.members ? room.members.map(m => {
        const userName = m.user_name || (m.user ? m.user.name : '알 수 없음');
        return `<span class="badge bg-secondary me-1">${escapeHtml(userName)}</span>`;
    }).join('') : '';
    
    // 헤더에는 채팅방 정보와 버튼만 표시
    header.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h5 class="mb-0">${escapeHtml(room.name)}</h5>
                ${room.description ? `<small class="text-muted">${escapeHtml(room.description)}</small>` : ''}
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleSearch()" title="메시지 검색">
                    <i class="fas fa-search"></i>
                </button>
                ${room.created_by == currentUserId ? `<button class="btn btn-sm btn-outline-secondary me-1" onclick="showEditRoomNameModal(${room.id}, '${escapeHtml(room.name)}')" title="이름 수정">
                    <i class="fas fa-edit"></i>
                </button>` : ''}
                ${!room.order ? `<button class="btn btn-sm btn-outline-info me-1" onclick="showConnectOrderModal(${room.id})" title="주문 연결">
                    <i class="fas fa-link"></i> 주문 연결
                </button>` : `<button class="btn btn-sm btn-outline-warning me-1" onclick="disconnectOrder(${room.id})" title="주문 연결 해제">
                    <i class="fas fa-unlink"></i> 연결 해제
                </button>`}
                <button class="btn btn-sm btn-outline-primary me-1" onclick="showInviteMemberModal(${room.id})" title="멤버 초대">
                    <i class="fas fa-user-plus"></i> 초대
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRoom(${room.id})" title="채팅방 삭제">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        ${membersHtml ? `<div class="mb-0"><small class="text-muted">멤버: </small>${membersHtml}</div>` : ''}
    `;
}

// 메시지 목록 렌더링
function renderMessages(messages) {
    const container = document.getElementById('messages-container');
    container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
}

// 메시지 렌더링
function renderMessage(msg) {
    const isOwn = msg.user_id == currentUserId;
    const className = isOwn ? 'own' : 'other';
    const userName = msg.user_name || '알 수 없음';
    
    let content = '';
    if (msg.message_type === 'text') {
        content = escapeHtml(msg.content || '');
    } else if (msg.attachments && msg.attachments.length > 0) {
        const attachment = msg.attachments[0];
        if (attachment.file_type === 'image') {
            const imageUrl = attachment.url || attachment.storage_url;
            content = `<div class="message-file">
                          <img src="${attachment.thumbnail_url || imageUrl}" 
                               onclick="openImageLightbox('${imageUrl}')" 
                               style="cursor: zoom-in;">
                       </div>`;
        } else if (attachment.file_type === 'video') {
            const videoUrl = attachment.url || attachment.storage_url;
            content = `<video controls style="max-width: 300px;">
                          <source src="${videoUrl}">
                       </video>`;
        } else {
            const fileUrl = attachment.url || attachment.storage_url;
            content = `<a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-download"></i> ${escapeHtml(attachment.filename)}
                       </a>`;
        }
    }
    
    // 읽음 표시 (채널톡 스타일 - 실제 읽음 상태 확인)
    let readReceipt = '';
    if (isOwn && msg.read_status) {
        if (msg.read_status === 'no_other_members') {
            // 다른 멤버가 없으면 표시하지 않음
            readReceipt = '';
        } else if (msg.read_status === 'unread') {
            // 아직 아무도 읽지 않음
            readReceipt = '<div class="read-receipt" style="color: #999;"><i class="fas fa-check"></i> 전송됨</div>';
        } else if (msg.read_status === 'all_read') {
            // 모두 읽음
            readReceipt = '<div class="read-receipt"><i class="fas fa-check read-icon"></i> 읽음</div>';
        } else if (msg.read_status === 'some_read') {
            // 일부 읽음
            readReceipt = `<div class="read-receipt"><i class="fas fa-check read-icon"></i> ${msg.read_count}/${msg.total_other_members}명 읽음</div>`;
        }
    }
    
    return `
        <div class="message-item ${className}" data-message-id="${msg.id}">
            <div class="message-bubble">
                ${content}
            </div>
            <div class="message-meta">
                ${!isOwn ? userName + ' · ' : ''}${formatDateTime(msg.created_at)}
            </div>
            ${readReceipt}
        </div>
    `;
}

// 메시지 추가 (실시간)
function appendMessage(msg) {
    const container = document.getElementById('messages-container');
    container.innerHTML += renderMessage(msg);
}

// 메시지 전송
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!currentRoomId) {
        alert('채팅방을 선택하세요');
        return;
    }
    
    if (!message && !previewFile) {
        return;
    }
    
    const messageData = {
        room_id: currentRoomId,
        message_type: previewFile ? previewFile.type : 'text',
        content: message,
        file_info: previewFile ? previewFile.info : null
    };
    
    // Socket.IO가 연결되어 있으면 사용, 아니면 REST API로 전송
    if (socket && socket.connected) {
        socket.emit('send_message', messageData);
    } else {
        // REST API로 메시지 전송 (폴백)
        fetch('/api/chat/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(messageData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 메시지 목록 새로고침
                loadRoomDetail(currentRoomId);
            } else {
                alert('메시지 전송 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('메시지 전송 오류:', error);
            alert('메시지 전송 중 오류가 발생했습니다.');
        });
    }
    
    // 입력 필드 초기화
    input.value = '';
    removePreview();
}

// 파일 미리보기
let previewFile = null;

function handleFileSelect(files) {
    if (files.length === 0) return;
    
    // 채팅방이 선택되지 않았으면 경고
    if (!currentRoomId) {
        alert('채팅방을 먼저 선택해주세요.');
        return;
    }
    
    const file = files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', currentRoomId);
    
    // 로딩 표시
    const preview = document.getElementById('file-preview');
    const content = document.getElementById('preview-content');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // chat-input-area 표시 보장
    if (chatInputArea && chatInputArea.style.display === 'none') {
        chatInputArea.style.display = 'block';
    }
    
    content.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 업로드 중...';
    preview.classList.add('active');
    
    // 파일 업로드
    fetch('/api/chat/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewFile = {
                type: data.file_info.file_type,
                info: data.file_info
            };
            showPreview(data.file_info);
        } else {
            preview.classList.remove('active');
            alert('파일 업로드 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('파일 업로드 오류:', error);
        preview.classList.remove('active');
        alert('파일 업로드 중 오류가 발생했습니다.');
    });
}

function showPreview(fileInfo) {
    const preview = document.getElementById('file-preview');
    const content = document.getElementById('preview-content');
    const chatInputArea = document.getElementById('chat-input-area');
    
    // chat-input-area가 숨겨져 있으면 표시
    if (chatInputArea && chatInputArea.style.display === 'none') {
        chatInputArea.style.display = 'block';
    }
    
    if (fileInfo.file_type === 'image') {
        const imageUrl = fileInfo.thumbnail_url || fileInfo.url || fileInfo.storage_url;
        content.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; background-color: white; padding: 4px;">`;
    } else if (fileInfo.file_type === 'video') {
        const videoUrl = fileInfo.url || fileInfo.storage_url;
        content.innerHTML = `<video controls style="max-width: 200px;"><source src="${videoUrl}"></video>`;
    } else {
        content.innerHTML = `<i class="fas fa-file"></i> ${fileInfo.filename}`;
    }
    
    preview.classList.add('active');
}

function removePreview() {
    previewFile = null;
    document.getElementById('file-preview').classList.remove('active');
    document.getElementById('file-input').value = '';
}

// 사용자 목록 로드 함수
function loadUsers() {
    fetch('/api/chat/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderUserList(data.users);
            } else {
                document.getElementById('user-select-container').innerHTML = 
                    '<div class="text-center text-muted py-2">사용자 목록을 불러올 수 없습니다.</div>';
            }
        })
        .catch(error => {
            console.error('사용자 목록 로드 오류:', error);
            document.getElementById('user-select-container').innerHTML = 
                '<div class="text-center text-danger py-2">사용자 목록 로드 중 오류가 발생했습니다.</div>';
        });
}

function renderUserList(users) {
    const container = document.getElementById('user-select-container');
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-2">초대할 사용자가 없습니다.</div>';
        return;
    }
    container.innerHTML = users.map(user => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${user.id}" id="user-${user.id}">
            <label class="form-check-label" for="user-${user.id}">
                ${escapeHtml(user.name)} (${escapeHtml(user.username)})
            </label>
        </div>
    `).join('');
}

// 새 채팅방 생성
function showCreateRoomModal() {
    loadUsers();  // 사용자 목록 로드
    clearOrderSelection();  // 주문 선택 초기화
    const modal = new bootstrap.Modal(document.getElementById('createRoomModal'));
    modal.show();
}

function createRoom() {
    const name = document.getElementById('room-name').value.trim();
    const description = document.getElementById('room-description').value.trim();
    
    if (!name) {
        alert('채팅방 이름을 입력하세요');
        return;
    }
    
    // 선택된 멤버 ID 수집
    const selectedUsers = Array.from(document.querySelectorAll('#user-select-container input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));
    
    fetch('/api/chat/rooms', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            description: description,
            member_ids: selectedUsers,  // 멤버 ID 배열 추가
            order_id: selectedOrderId || null  // 주문 ID 추가
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createRoomModal')).hide();
            document.getElementById('room-name').value = '';
            document.getElementById('room-description').value = '';
            // 체크박스 초기화
            document.querySelectorAll('#user-select-container input[type="checkbox"]').forEach(cb => cb.checked = false);
            clearOrderSelection();  // 주문 선택 초기화
            loadRooms();
            selectRoom(data.room.id);
        } else {
            alert('채팅방 생성 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('채팅방 생성 오류:', error);
        alert('채팅방 생성 중 오류가 발생했습니다.');
    });
}

// 유틸리티 함수
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return '방금';
    if (minutes < 60) return `${minutes}분 전`;
    if (hours < 24) return `${hours}시간 전`;
    if (days < 7) return `${days}일 전`;
    
    return date.toLocaleDateString('ko-KR');
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

// 주문 상세 보기 (Quest 12)
function viewOrderDetail(orderId) {
    window.open(`/edit/${orderId}`, '_blank');
}

// 주문 상태 업데이트
function updateOrderStatus(orderId, newStatus) {
    fetch('/api/update_order_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: orderId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('주문 상태가 업데이트되었습니다.');
            // 상태 드롭다운 색상 업데이트
            const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
            if (selectElement) {
                // 기존 상태 클래스 제거
                selectElement.classList.remove('status-received', 'status-measured', 'status-regional_measured', 
                                              'status-scheduled', 'status-shipped_pending', 'status-completed', 
                                              'status-as_received', 'status-as_completed', 'status-on_hold');
                // 새로운 상태 클래스 추가
                if (newStatus) {
                    selectElement.classList.add('status-' + newStatus.toLowerCase());
                }
                // applyStatusColor 함수가 있으면 호출
                if (typeof applyStatusColor === 'function') {
                    applyStatusColor(selectElement);
                }
            }
            // 주문이 연결된 경우 헤더를 다시 렌더링
            if (currentRoomId) {
                loadRoomDetail(currentRoomId);
            }
        } else {
            alert('주문 상태 업데이트 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('주문 상태 업데이트 오류:', error);
        alert('주문 상태 업데이트 중 오류가 발생했습니다.');
    });
}

// 주문 필드 업데이트 (담당자, 설치 예정일 등)
function updateOrderField(orderId, field, value) {
    fetch('/api/update_order_field', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: orderId,
            field: field,
            value: value || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`주문 ${field}가 업데이트되었습니다.`);
            // 주문이 연결된 경우 헤더를 다시 렌더링
            if (currentRoomId) {
                loadRoomDetail(currentRoomId);
            }
        } else {
            alert(`주문 ${field} 업데이트 실패: ` + data.message);
        }
    })
    .catch(error => {
        console.error(`주문 ${field} 업데이트 오류:`, error);
        alert(`주문 ${field} 업데이트 중 오류가 발생했습니다.`);
    });
}

// 주문 연결 관련 함수들
let selectedOrderId = null;
let connectRoomId = null;

function searchOrdersForRoom(query) {
    if (!query || query.length < 2) {
        document.getElementById('order-search-results').style.display = 'none';
        return;
    }
    
    fetch(`/api/chat/search-orders?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('order-search-results');
            if (data.success && data.orders.length > 0) {
                resultsDiv.innerHTML = data.orders.map(order => `
                    <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectOrderForRoom(${order.id}, '${escapeHtml(order.customer_name)}', '${escapeHtml(order.product || '-')}')">
                        <strong>주문 #${order.id}</strong> - ${escapeHtml(order.customer_name)}<br>
                        <small class="text-muted">${escapeHtml(order.product || '-')} | ${escapeHtml(order.status || '-')}</small>
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-2">검색 결과가 없습니다</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('주문 검색 오류:', error);
        });
}

function selectOrderForRoom(orderId, customerName, product) {
    selectedOrderId = orderId;
    document.getElementById('selected-order').style.display = 'block';
    document.getElementById('selected-order-name').textContent = `주문 #${orderId} - ${customerName} (${product})`;
    document.getElementById('order-search-results').style.display = 'none';
    document.getElementById('order-search').value = '';
}

function clearOrderSelection() {
    selectedOrderId = null;
    document.getElementById('selected-order').style.display = 'none';
    document.getElementById('order-search').value = '';
    document.getElementById('order-search-results').style.display = 'none';
}

function showConnectOrderModal(roomId) {
    connectRoomId = roomId;
    selectedOrderId = null;
    document.getElementById('connect-order-search').value = '';
    document.getElementById('connect-order-results').innerHTML = '<div class="text-center text-muted py-2">검색어를 입력하세요</div>';
    const modal = new bootstrap.Modal(document.getElementById('connectOrderModal'));
    modal.show();
}

function searchOrdersForConnect(query) {
    if (!query || query.length < 2) {
        document.getElementById('connect-order-results').innerHTML = '<div class="text-center text-muted py-2">검색어를 입력하세요</div>';
        return;
    }
    
    fetch(`/api/chat/search-orders?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('connect-order-results');
            if (data.success && data.orders.length > 0) {
                resultsDiv.innerHTML = data.orders.map(order => `
                    <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="connectOrderToRoom(${order.id}, '${escapeHtml(order.customer_name)}')">
                        <strong>주문 #${order.id}</strong> - ${escapeHtml(order.customer_name)}<br>
                        <small class="text-muted">${escapeHtml(order.product || '-')} | ${escapeHtml(order.status || '-')}</small>
                    </div>
                `).join('');
            } else {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-2">검색 결과가 없습니다</div>';
            }
        })
        .catch(error => {
            console.error('주문 검색 오류:', error);
        });
}

function connectOrderToRoom(orderId, customerName) {
    if (!connectRoomId) return;
    
    fetch(`/api/chat/rooms/${connectRoomId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: orderId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('connectOrderModal')).hide();
            loadRoomDetail(connectRoomId);
        } else {
            alert('주문 연결 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('주문 연결 오류:', error);
        alert('주문 연결 중 오류가 발생했습니다.');
    });
}

function disconnectOrder(roomId) {
    if (!confirm('주문 연결을 해제하시겠습니까?')) {
        return;
    }
    
    fetch(`/api/chat/rooms/${roomId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRoomDetail(roomId);
        } else {
            alert('주문 연결 해제 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('주문 연결 해제 오류:', error);
        alert('주문 연결 해제 중 오류가 발생했습니다.');
    });
}

// 채팅방 이름 수정
function showEditRoomNameModal(roomId, currentName) {
    const newName = prompt('채팅방 이름을 입력하세요:', currentName);
    if (!newName || newName.trim() === '' || newName.trim() === currentName) {
        return;
    }
    
    fetch(`/api/chat/rooms/${roomId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: newName.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRoomDetail(roomId);
            loadRooms(); // 채팅방 목록도 업데이트
        } else {
            alert('이름 수정 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('이름 수정 오류:', error);
        alert('이름 수정 중 오류가 발생했습니다.');
    });
}

// 멤버 초대 관련 함수들
let inviteRoomId = null;

function showInviteMemberModal(roomId) {
    inviteRoomId = roomId;
    loadUsersForInvite(roomId);
    const modal = new bootstrap.Modal(document.getElementById('inviteMemberModal'));
    modal.show();
}

function loadUsersForInvite(roomId) {
    // 현재 멤버 목록 가져오기
    fetch(`/api/chat/rooms/${roomId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const currentMemberIds = data.room.members.map(m => m.user_id);
                loadUsersForInviteList(currentMemberIds);
            } else {
                document.getElementById('invite-user-select-container').innerHTML = 
                    '<div class="text-center text-danger py-2">채팅방 정보를 불러올 수 없습니다.</div>';
            }
        })
        .catch(error => {
            console.error('채팅방 정보 로드 오류:', error);
            document.getElementById('invite-user-select-container').innerHTML = 
                '<div class="text-center text-danger py-2">채팅방 정보 로드 중 오류가 발생했습니다.</div>';
        });
}

function loadUsersForInviteList(excludeIds) {
    fetch('/api/chat/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 이미 멤버인 사용자 제외
                const availableUsers = data.users.filter(u => !excludeIds.includes(u.id));
                renderInviteUserList(availableUsers);
            } else {
                document.getElementById('invite-user-select-container').innerHTML = 
                    '<div class="text-center text-danger py-2">사용자 목록을 불러올 수 없습니다.</div>';
            }
        })
        .catch(error => {
            console.error('사용자 목록 로드 오류:', error);
            document.getElementById('invite-user-select-container').innerHTML = 
                '<div class="text-center text-danger py-2">사용자 목록 로드 중 오류가 발생했습니다.</div>';
        });
}

function renderInviteUserList(users) {
    const container = document.getElementById('invite-user-select-container');
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-2">초대할 사용자가 없습니다.</div>';
        return;
    }
    container.innerHTML = users.map(user => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${user.id}" id="invite-user-${user.id}">
            <label class="form-check-label" for="invite-user-${user.id}">
                ${escapeHtml(user.name)} (${escapeHtml(user.username)})
            </label>
        </div>
    `).join('');
}

function inviteMembers() {
    if (!inviteRoomId) {
        alert('채팅방 정보가 없습니다.');
        return;
    }
    
    const selectedUsers = Array.from(document.querySelectorAll('#invite-user-select-container input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));
    
    if (selectedUsers.length === 0) {
        alert('초대할 사용자를 선택하세요');
        return;
    }
    
    // 여러 사용자를 한 번에 초대
    Promise.all(selectedUsers.map(userId => 
        fetch(`/api/chat/rooms/${inviteRoomId}/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId })
        })
    ))
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(results => {
        const failed = results.filter(r => !r.success);
        const successCount = results.length - failed.length;
        
        if (failed.length > 0) {
            alert(`${successCount}명 초대 완료. ${failed.length}명 실패: ${failed.map(f => f.message).join(', ')}`);
        } else {
            alert(`${successCount}명이 초대되었습니다.`);
        }
        
        bootstrap.Modal.getInstance(document.getElementById('inviteMemberModal')).hide();
        // 체크박스 초기화
        document.querySelectorAll('#invite-user-select-container input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // 채팅방 정보 새로고침
        if (currentRoomId === inviteRoomId) {
            loadRoomDetail(inviteRoomId);
        }
        loadRooms();
    })
    .catch(error => {
        console.error('멤버 초대 오류:', error);
        alert('멤버 초대 중 오류가 발생했습니다.');
    });
}

// 채팅방 삭제 함수
function deleteRoom(roomId) {
    if (!confirm('정말 이 채팅방을 삭제하시겠습니까?\n모든 메시지와 파일이 삭제되며 복구할 수 없습니다.')) {
        return;
    }
    
    fetch(`/api/chat/rooms/${roomId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('채팅방이 삭제되었습니다.');
            currentRoomId = null;
            document.getElementById('chat-header').innerHTML = '<div class="text-center text-muted py-4" style="flex: 1;">채팅방을 선택하세요</div><button class="btn btn-sm btn-outline-secondary" onclick="toggleSearch()" title="메시지 검색" style="display: none;" id="search-btn"><i class="fas fa-search"></i></button>';
            document.getElementById('chat-order-widget-container').innerHTML = '';
            document.getElementById('chat-order-widget-container').style.display = 'none';
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('chat-input-area').style.display = 'none';
            loadRooms();
        } else {
            alert('채팅방 삭제 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('채팅방 삭제 오류:', error);
        alert('채팅방 삭제 중 오류가 발생했습니다.');
    });
}

// 채널톡 스타일 추가 기능

// 타이핑 인디케이터
let typingTimeout = null;
let typingUsers = {};

function handleTyping() {
    if (!currentRoomId || !socket || !socket.connected) return;
    
    // 타이핑 중 이벤트 전송
    socket.emit('typing', {
        room_id: currentRoomId,
        is_typing: true
    });
    
    // 3초 후 타이핑 중지
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        if (socket && socket.connected) {
            socket.emit('typing', {
                room_id: currentRoomId,
                is_typing: false
            });
        }
    }, 3000);
}

function showTypingIndicator(userId, isTyping) {
    const container = document.getElementById('messages-container');
    let indicator = document.getElementById('typing-indicator');
    
    if (isTyping) {
        typingUsers[userId] = true;
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'typing-indicator';
            container.appendChild(indicator);
        }
        // 사용자 이름 가져오기 (간단히 처리)
        indicator.textContent = '입력 중...';
    } else {
        delete typingUsers[userId];
        if (Object.keys(typingUsers).length === 0 && indicator) {
            indicator.remove();
        }
    }
}

// 메시지 검색 기능
function toggleSearch() {
    const searchDiv = document.getElementById('message-search');
    if (searchDiv.style.display === 'none') {
        searchDiv.style.display = 'block';
        document.getElementById('search-input').focus();
    } else {
        closeSearch();
    }
}

function closeSearch() {
    document.getElementById('message-search').style.display = 'none';
    document.getElementById('search-input').value = '';
    // 검색 결과 초기화
    if (currentRoomId) {
        loadRoomDetail(currentRoomId);
    }
}

function searchMessages(query) {
    if (!currentRoomId || !query.trim()) {
        return;
    }
    
    // 간단한 클라이언트 사이드 검색
    const messages = document.querySelectorAll('.message-item');
    messages.forEach(msg => {
        const text = msg.textContent.toLowerCase();
        if (text.includes(query.toLowerCase())) {
            msg.style.backgroundColor = '#fff3cd';
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            msg.style.backgroundColor = '';
        }
    });
}

// 전역 검색 기능
function performGlobalSearch(query) {
    const resultsDiv = document.getElementById('global-search-results');
    const roomsList = document.getElementById('rooms-list');
    
    if (!query || query.length < 2) {
        resultsDiv.style.display = 'none';
        roomsList.style.display = 'block';
        return;
    }
    
    fetch(`/api/chat/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                resultsDiv.innerHTML = data.results.map(result => {
                    let html = '';
                    if (result.type === 'message') {
                        const contentPreview = result.content ? escapeHtml(result.content.substring(0, 50)) + (result.content.length > 50 ? '...' : '') : '메시지';
                        html = `
                            <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectRoomAndHighlight(${result.room_id}, ${result.message_id})">
                                <strong>${escapeHtml(result.room_name || '알 수 없음')}</strong><br>
                                <small>메시지: ${contentPreview}</small><br>
                                <small class="text-muted">${escapeHtml(result.user_name || '알 수 없음')} | ${result.created_at || ''}</small>
                            </div>
                        `;
                    } else if (result.type === 'room') {
                        html = `
                            <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectRoom(${result.room_id})">
                                <strong>채팅방: ${escapeHtml(result.room_name)}</strong>
                                ${result.description ? `<br><small class="text-muted">${escapeHtml(result.description)}</small>` : ''}
                            </div>
                        `;
                    } else if (result.type === 'order') {
                        html = `
                            <div class="p-2 border-bottom" style="cursor: pointer; background-color: white;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'" onclick="selectRoom(${result.room_id})">
                                <strong>${escapeHtml(result.room_name || '알 수 없음')}</strong><br>
                                <small>주문 #${result.order_id}: ${escapeHtml(result.customer_name || '-')} | ${escapeHtml(result.phone || '-')} | ${escapeHtml(result.address || '-')}</small>
                            </div>
                        `;
                    }
                    return html;
                }).join('');
                resultsDiv.style.display = 'block';
                roomsList.style.display = 'none';
            } else {
                resultsDiv.innerHTML = '<div class="text-center text-muted py-2">검색 결과가 없습니다</div>';
                resultsDiv.style.display = 'block';
                roomsList.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('전체 검색 오류:', error);
            resultsDiv.innerHTML = '<div class="text-center text-danger py-2">검색 중 오류가 발생했습니다</div>';
            resultsDiv.style.display = 'block';
        });
}

function selectRoomAndHighlight(roomId, messageId) {
    selectRoom(roomId);
    setTimeout(() => {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            messageElement.style.backgroundColor = '#fff3cd';
            setTimeout(() => {
                messageElement.style.backgroundColor = '';
            }, 3000);
        }
    }, 500);
}

// 채팅방 헤더에 검색 버튼 표시
function updateChatHeader() {
    const searchBtn = document.getElementById('search-btn');
    if (currentRoomId && searchBtn) {
        searchBtn.style.display = 'block';
    } else if (searchBtn) {
        searchBtn.style.display = 'none';
    }
}
</script>
{% endblock %}
