{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 class="mb-0"><i class="fas fa-cube"></i> ERP 주문 상세</h4>
      <div class="small text-muted">Object Page (ERP Beta)</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('erp_beta.erp_dashboard') }}">
        <i class="fas fa-arrow-left"></i> 대시보드
      </a>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_order', order_id=order_id) }}?open=erp-beta">
        <i class="fas fa-edit"></i> 편집(ERP Beta)
      </a>
    </div>
  </div>

  <style>
    .obj-header { position: sticky; top: 64px; z-index: 5; background: #fff; border: 1px solid rgba(0,0,0,.08); border-radius: .5rem; }
    .obj-kv { display:flex; justify-content:space-between; gap:12px; }
    .obj-kv .k { color:#6c757d; }
    .obj-kv .v { font-weight:600; text-align:right; }
    .obj-section-title { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .obj-media-thumb { background:#fff; padding:4px; border-radius: .5rem; border: 1px solid rgba(0,0,0,.08); cursor: pointer; }
    .obj-media-thumb:hover { border-color: rgba(13,110,253,.4); }
  </style>

  <!-- Sticky header summary -->
  <div class="obj-header p-3 mb-3">
    <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
      <div>
        <div class="fw-bold" id="h-customer">-</div>
        <div class="small text-muted">
          <span class="me-2" id="h-phone">-</span>
          <span class="me-2">·</span>
          <span id="h-address">-</span>
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap justify-content-end">
        <span class="badge bg-secondary" id="h-stage">-</span>
        <span class="badge bg-light text-dark" id="h-owner-team">-</span>
        <span class="badge bg-danger" id="h-urgent" style="display:none;">긴급</span>
      </div>
    </div>
    <hr class="my-2">
    <div class="row g-2">
      <div class="col-md-4"><div class="obj-kv"><div class="k">주문번호</div><div class="v">#{{ order_id }}</div></div></div>
      <div class="col-md-4"><div class="obj-kv"><div class="k">실측일</div><div class="v" id="h-measure">-</div></div></div>
      <div class="col-md-4"><div class="obj-kv"><div class="k">시공일</div><div class="v" id="h-construct">-</div></div></div>
    </div>
  </div>

  <div class="row g-2">
    <!-- Left -->
    <div class="col-xl-7 col-lg-7">
      <div class="card mb-2">
        <div class="card-body">
          <div class="obj-section-title">
            <div class="fw-bold"><i class="fas fa-info-circle"></i> 요약</div>
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="copySummary()">
              <i class="fas fa-copy"></i> 복사
            </button>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-md-6">
              <div class="obj-kv"><div class="k">고객명</div><div class="v" id="v-customer">-</div></div>
              <div class="obj-kv"><div class="k">연락처</div><div class="v" id="v-phone">-</div></div>
              <div class="obj-kv"><div class="k">발주사</div><div class="v" id="v-orderer">-</div></div>
              <div class="obj-kv"><div class="k">담당자</div><div class="v" id="v-manager">-</div></div>
            </div>
            <div class="col-md-6">
              <div class="obj-kv"><div class="k">주소</div><div class="v" id="v-address">-</div></div>
              <div class="obj-kv"><div class="k">주소특이</div><div class="v" id="v-address-note">-</div></div>
              <div class="obj-kv"><div class="k">연락특이</div><div class="v" id="v-phone-note">-</div></div>
              <div class="obj-kv"><div class="k">실측특이</div><div class="v" id="v-measure-note">-</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-2">
        <div class="card-body">
          <div class="fw-bold mb-2"><i class="fas fa-box"></i> 제품 항목</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>제품명</th>
                  <th>규격</th>
                  <th>색상</th>
                  <th>옵션</th>
                  <th>기타</th>
                  <th class="text-end">금액</th>
                </tr>
              </thead>
              <tbody id="items-tbody">
                <tr><td colspan="6" class="text-muted small">로딩 중...</td></tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="5" class="text-end fw-bold">합계</td>
                  <td class="text-end fw-bold" id="items-total">-</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

    </div>

    <!-- Right -->
    <div class="col-xl-5 col-lg-5">
      <div class="card mb-2">
        <div class="card-body">
          <div class="obj-section-title">
            <div class="fw-bold"><i class="fas fa-paperclip"></i> 도면 / 사진 / 영상</div>
            <div class="small text-muted" id="media-count">-</div>
          </div>
          <div class="row g-2 mt-1" id="media-grid">
            <div class="col-12"><div class="text-muted small">로딩 중...</div></div>
          </div>
        </div>
      </div>

      <!-- Quest Slide -->
      <div class="card mb-2">
        <div class="card-body">
          <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#quest-collapse-object" aria-expanded="false" aria-controls="quest-collapse-object">
            <i class="fas fa-chevron-down"></i> 
            <i class="fas fa-flag-checkered"></i> 현재 단계 퀘스트
            <span id="quest-status-badge" class="badge ms-2"></span>
          </button>
          <div class="collapse mt-3" id="quest-collapse-object">
            <div id="quest-content" class="text-muted small">로딩 중...</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="erpAttachmentPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-paperclip"></i> 첨부 미리보기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="erp-attachment-preview-body"></div>
        </div>
        <div class="modal-footer">
          <a class="btn btn-primary" id="erp-attachment-preview-download" href="#" target="_blank" rel="noopener">
            <i class="fas fa-download"></i> 다운로드
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const ORDER_ID = {{ order_id }};
  const TEAM_LABELS = { CS:'라홈팀', SALES:'영업팀', MEASURE:'실측팀', DRAWING:'도면팀', PRODUCTION:'생산팀', CONSTRUCTION:'시공팀' };
  const STAGE_LABELS = { RECEIVED:'주문접수', HAPPYCALL:'해피콜', MEASURE:'실측', DRAWING:'도면', CONFIRM:'고객컨펌', PRODUCTION:'생산', CONSTRUCTION:'시공' };

  function label(map, code, fallback='-') { if (!code) return fallback; return map[code] || code; }
  function escapeHtml(text) { if (!text) return ''; const div=document.createElement('div'); div.textContent=String(text); return div.innerHTML; }
  function moneyKRW(num){ const n=Number(num); if(!Number.isFinite(n)) return '-'; return `${Math.round(n).toLocaleString('ko-KR')}원`; }

  let __attachments = [];

  function openAttachmentPreview(attachmentId) {
    const a = (__attachments || []).find(x => x.id === attachmentId);
    if (!a) return;
    const modalEl = document.getElementById('erpAttachmentPreviewModal');
    const body = document.getElementById('erp-attachment-preview-body');
    const dl = document.getElementById('erp-attachment-preview-download');
    if (!modalEl || !body || !dl) return;
    const viewUrl = a.view_url || '#';
    const downloadUrl = a.download_url || '#';
    dl.href = downloadUrl;
    if (a.file_type === 'video') {
      body.innerHTML = `<div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;"><video src="${viewUrl}" controls autoplay style="width:100%;height:100%;"></video></div><div class="small text-muted mt-2">${escapeHtml(a.filename || '')}</div>`;
    } else {
      body.innerHTML = `<img src="${viewUrl}" alt="${escapeHtml(a.filename || '')}" class="img-fluid rounded" style="background:#fff; padding:4px;"><div class="small text-muted mt-2">${escapeHtml(a.filename || '')}</div>`;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  function copySummary() {
    const lines = [];
    lines.push(`주문 #${ORDER_ID}`);
    lines.push(`고객명: ${document.getElementById('v-customer').textContent || '-'}`);
    lines.push(`연락처: ${document.getElementById('v-phone').textContent || '-'}`);
    lines.push(`주소: ${document.getElementById('v-address').textContent || '-'}`);
    lines.push(`단계: ${document.getElementById('h-stage').textContent || '-'}`);
    lines.push(`오너팀: ${document.getElementById('h-owner-team').textContent || '-'}`);
    navigator.clipboard?.writeText(lines.join('\\n'));
  }

  function renderItems(sd) {
    const tb = document.getElementById('items-tbody');
    const items = Array.isArray(sd.items) ? sd.items : [];
    if (!items.length) { tb.innerHTML = `<tr><td colspan="6" class="text-muted small">항목 없음</td></tr>`; document.getElementById('items-total').textContent='-'; return; }
    tb.innerHTML = items.map(it => {
      const price = (typeof it.price === 'number') ? it.price : Number(String(it.price||'').replace(/[^0-9]/g,'')||'0');
      return `<tr><td class="fw-bold">${escapeHtml(it.product_name||'')}</td><td>${escapeHtml(it.spec||'')}</td><td>${escapeHtml(it.color||'')}</td><td>${escapeHtml(it.option_detail||'')}</td><td>${escapeHtml(it.misc||'')}</td><td class="text-end">${moneyKRW(price)}</td></tr>`;
    }).join('');
    document.getElementById('items-total').textContent = moneyKRW(((sd.totals||{}).items_total));
  }

  function renderMedia(list) {
    const wrap = document.getElementById('media-grid');
    const items = Array.isArray(list) ? list : [];
    document.getElementById('media-count').textContent = `${items.length}개`;
    if (!items.length) { wrap.innerHTML = `<div class="col-12"><div class="text-muted small">첨부 없음</div></div>`; return; }
    wrap.innerHTML = items.map(a => {
      const name = escapeHtml(a.filename || '');
      const viewUrl = a.view_url || '#';
      const thumb = a.thumbnail_view_url || viewUrl;
      if (a.file_type === 'video') {
        return `<div class="col-12"><div class="ratio ratio-16x9 bg-dark rounded" style="overflow:hidden;"><video src="${viewUrl}" controls preload="metadata" style="width:100%;height:100%;"></video></div><div class="small text-muted">${name}</div></div>`;
      }
      return `<div class="col-6"><img src="${thumb}" class="img-fluid obj-media-thumb" alt="${name}" onclick="openAttachmentPreview(${a.id})"><div class="small text-muted text-truncate">${name}</div></div>`;
    }).join('');
  }

  async function loadQuest() {
    try {
      const res = await fetch(`/api/orders/${ORDER_ID}/quest`);
      const data = await res.json();
      if (data.error || !data.quest) {
        document.getElementById('quest-content').innerHTML = '<div class="text-muted small">퀘스트 없음</div>';
        document.getElementById('quest-status-badge').textContent = '';
        return;
      }
      
      const quest = data.quest;
      const requiredTeams = quest.required_approvals || [];
      const teamApprovalsRaw = quest.team_approvals || {};
      const allApproved = quest.all_approved || false;
      
      // 상태 배지 업데이트
      const statusBadge = document.getElementById('quest-status-badge');
      if (allApproved) {
        statusBadge.className = 'badge bg-success ms-2';
        statusBadge.textContent = '완료';
      } else {
        statusBadge.className = 'badge bg-warning ms-2';
        statusBadge.textContent = '진행중';
      }
      
      // 퀘스트 내용 렌더링
      let html = `
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="card-title mb-1">${escapeHtml(quest.title || '')}</h6>
                <small class="text-muted">${escapeHtml(quest.description || '')}</small>
              </div>
              <span class="badge ${allApproved ? 'bg-success' : 'bg-warning'}">
                ${allApproved ? '완료' : '진행중'}
              </span>
            </div>
            <div class="mb-3">
              <div class="small text-muted mb-1">담당 팀</div>
              <div class="fw-bold">${escapeHtml(label(TEAM_LABELS, quest.owner_team, quest.owner_team || '-'))}</div>
            </div>
            <div class="mb-3">
              <div class="small text-muted mb-2">팀별 승인</div>
              <div id="quest-approvals-object">
      `;
      
      for (const team of requiredTeams) {
        const approvalData = teamApprovalsRaw[team];
        let approved = false;
        if (typeof approvalData === 'object' && approvalData !== null) {
          approved = approvalData.approved === true;
        } else {
          approved = Boolean(approvalData);
        }
        const teamLabel = label(TEAM_LABELS, team, team);
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small">${escapeHtml(teamLabel)}</span>
            ${approved 
              ? '<span class="badge bg-success">승인완료</span>'
              : `<button class="btn btn-sm btn-primary" onclick="approveQuestTeam(${ORDER_ID}, '${escapeHtml(team)}')">승인</button>`
            }
          </div>
        `;
      }
      
      html += `
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" type="button" onclick="loadQuest()">
                <i class="fas fa-sync"></i> 상태 업데이트
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('quest-content').innerHTML = html;
    } catch (err) {
      console.error('Quest 로드 실패:', err);
      document.getElementById('quest-content').innerHTML = '<div class="text-danger small">로드 실패</div>';
    }
  }
  
  async function approveQuestTeam(orderId, team) {
    try {
      const res = await fetch(`/api/orders/${orderId}/quest/approve`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({team: team})
      });
      const data = await res.json();
      
      if (!data.success) {
        alert('승인 실패: ' + (data.message || data.error || '알 수 없는 오류'));
        return;
      }
      
      if (data.auto_transitioned && data.next_stage) {
        const nextStageLabel = label(STAGE_LABELS, data.next_stage, data.next_stage);
        alert('✅ 모든 팀 승인 완료! 다음 단계(' + nextStageLabel + ')로 자동 전환되었습니다.');
      } else if (data.all_approved) {
        alert('✅ 모든 팀 승인 완료!');
      } else {
        const missingTeams = data.missing_teams.map(t => label(TEAM_LABELS, t, t)).join(', ');
        alert('승인 완료. 남은 팀: ' + missingTeams);
      }
      
      await loadQuest();
      window.location.reload();
    } catch (err) {
      console.error('승인 실패:', err);
      alert('승인 중 오류가 발생했습니다.');
    }
  }

  async function loadAll() {
    const [structured, attachments] = await Promise.all([
      fetch(`/api/orders/${ORDER_ID}/structured`).then(r => r.json()),
      fetch(`/api/orders/${ORDER_ID}/attachments`).then(r => r.json()),
    ]);
    const sd = (structured && structured.structured_data) || {};
    const customer = (((sd.parties||{}).customer||{}).name) || '-';
    const phone = (((sd.parties||{}).customer||{}).phone) || '-';
    const address = ((sd.site||{}).address_full) || ((sd.site||{}).address_main) || '-';
    const orderer = (((sd.parties||{}).orderer||{}).name) || '-';
    const manager = (((sd.parties||{}).manager||{}).name) || '-';
    const measure = (((sd.schedule||{}).measurement||{}).date) || '-';
    const construct = (((sd.schedule||{}).construction||{}).date) || '-';
    const stage = (sd.workflow||{}).stage || '';
    const ownerTeam = (sd.assignments||{}).owner_team || '';
    const urgent = !!((sd.flags||{}).urgent);

    document.getElementById('h-customer').textContent = customer;
    document.getElementById('h-phone').textContent = phone;
    document.getElementById('h-address').textContent = address;
    document.getElementById('h-measure').textContent = measure;
    document.getElementById('h-construct').textContent = construct;
    document.getElementById('h-stage').textContent = label(STAGE_LABELS, stage, '-');
    document.getElementById('h-owner-team').textContent = label(TEAM_LABELS, ownerTeam, '-');
    document.getElementById('h-urgent').style.display = urgent ? '' : 'none';

    document.getElementById('v-customer').textContent = customer;
    document.getElementById('v-phone').textContent = phone;
    document.getElementById('v-address').textContent = address;
    document.getElementById('v-orderer').textContent = orderer;
    document.getElementById('v-manager').textContent = manager;
    document.getElementById('v-address-note').textContent = ((sd.notes||{}).address_note) || '-';
    document.getElementById('v-phone-note').textContent = ((sd.notes||{}).phone_note) || '-';
    document.getElementById('v-measure-note').textContent = ((sd.notes||{}).measurement_note) || '-';

    renderItems(sd);
    __attachments = (attachments && attachments.attachments) || [];
    renderMedia(__attachments);
    
    // 퀘스트 로드
    loadQuest();
  }

  document.addEventListener('DOMContentLoaded', () => loadAll());
</script>
{% endblock %}

