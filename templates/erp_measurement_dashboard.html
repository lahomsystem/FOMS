{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-1"><i class="fas fa-ruler-combined"></i> ERP Beta - 실측 대시보드</h4>
    <div class="text-muted small">구조화 데이터(ERP Beta) 기반으로 실측/시공 일정 운영을 시작합니다.</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/calendar">
      <i class="fas fa-calendar"></i> 기존 캘린더
    </a>
  </div>
</div>

{% if not erp_beta_enabled %}
  <div class="alert alert-secondary">
    ERP Beta 기능이 비활성입니다. (환경변수 <code>ERP_BETA_ENABLED=true</code> 필요)
  </div>
{% else %}
  <div class="card">
    <div class="card-header bg-white">
      <form class="row g-2 align-items-end" method="get">
        <div class="col-md-3">
          <label class="form-label mb-1">기준 날짜(실측일)</label>
          <input type="date" class="form-control" name="date" value="{{ selected_date }}">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">담당자(부분 일치)</label>
          <input type="text" class="form-control" name="manager" value="{{ manager_filter }}" placeholder="예: 정다슬">
        </div>
        <div class="col-md-6 d-flex gap-2">
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-search"></i> 조회
          </button>
          <a class="btn btn-outline-secondary" href="/erp/measurement?date={{ selected_date }}&manager={{ manager_filter | urlencode }}&open_map=1">
            <i class="fas fa-map-marked-alt"></i> 지도 보기(실측)
          </a>
          <button class="btn btn-outline-primary" type="button" id="btn-route-plan">
            <i class="fas fa-route"></i> 동선 추천
          </button>
        </div>
      </form>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 90px;">주문</th>
              <th style="width: 120px;">실측일</th>
              <th style="width: 90px;">실측시간</th>
              <th style="width: 120px;">담당자</th>
              <th style="width: 120px;">고객</th>
              <th>주소</th>
              <th style="width: 120px;">상태</th>
            </tr>
          </thead>
          <tbody>
          {% if rows %}
            {% for r in rows %}
              <tr>
                <td><a href="{{ url_for('edit_order', order_id=r.id) }}">#{{ r.id }}</a></td>
                <td>{{ r.measurement_date or '-' }}</td>
                <td>{{ r.measurement_time or '-' }}</td>
                <td>{{ r.manager_name or '-' }}</td>
                <td>{{ r.customer_name or '-' }}</td>
                <td style="white-space: normal; word-break: break-word;">{{ r.address or '-' }}</td>
                <td>{{ STATUS.get(r.status, r.status) }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-center text-muted py-4">데이터가 없습니다.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}

<!-- 동선 추천 모달 -->
<div class="modal fade" id="routePlanModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-route"></i> 동선 추천 (MVP)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-2" id="route-plan-meta"></div>
        <div id="route-plan-loading" class="py-4 text-center text-muted" style="display:none;">
          <i class="fas fa-spinner fa-spin"></i> 계산 중...
        </div>
        <div id="route-plan-error" class="alert alert-danger" style="display:none;"></div>
        <div id="route-plan-result" style="display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">추천 방문 순서</div>
            <div class="small text-muted" id="route-plan-distance"></div>
          </div>
          <ol class="mb-0" id="route-plan-list"></ol>
          <div class="small text-muted mt-2" id="route-plan-note"></div>
        </div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-secondary" href="/map_view?date={{ selected_date }}&status=MEASURED" target="_blank">
          <i class="fas fa-map-marked-alt"></i> 지도(핀) 보기
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> 닫기
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    // escapeHtml helper (이 페이지 단독으로도 안전하게 동작하도록)
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    if (!{{ 'true' if erp_beta_enabled else 'false' }}) return;

    const btn = document.getElementById('btn-route-plan');
    const modalEl = document.getElementById('routePlanModal');
    if (!btn || !modalEl) return;
    const modal = new bootstrap.Modal(modalEl);

    function setVisible(id, visible) {
      const el = document.getElementById(id);
      if (el) el.style.display = visible ? '' : 'none';
    }
    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text || '';
    }

    async function loadRoutePlan() {
      setVisible('route-plan-error', false);
      setVisible('route-plan-result', false);
      setVisible('route-plan-loading', true);

      const date = {{ selected_date|tojson }};
      const manager = {{ manager_filter|tojson }};

      setText('route-plan-meta', `기준일: ${date} / 담당자: ${manager || '-'} / 방식: 근사(직선거리)`);

      try {
        // 기존 카카오 내비 API 기반으로 구간 거리/시간 계산 (호출 수 제한 포함)
        const qs = new URLSearchParams({ date, manager, limit: '20', use_kakao: '1', kakao_max_legs: '12' });
        const res = await fetch(`/api/erp/measurement/route?${qs.toString()}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '동선 계산 실패');

        const list = document.getElementById('route-plan-list');
        list.innerHTML = '';

        (data.route || []).forEach((p, idx) => {
          const li = document.createElement('li');
          const time = p.measurement_time ? `(${p.measurement_time}) ` : '';
          li.innerHTML = `${time}<a href="/edit/${p.id}">주문 #${p.id}</a> - ${escapeHtml(String(p.customer_name || '-'))} / ${escapeHtml(String(p.address || '-'))}`;
          list.appendChild(li);
        });

        const dur = data.total_duration_min ? ` / 총 시간: ${data.total_duration_min}분` : '';
        setText('route-plan-distance', `총 거리: ${data.total_distance_km || 0} km${dur} / 지점: ${data.total_points || 0}`);
        setText('route-plan-note', data.note || '');

        setVisible('route-plan-loading', false);
        setVisible('route-plan-result', true);
      } catch (e) {
        setVisible('route-plan-loading', false);
        setText('route-plan-error', String(e?.message || e));
        setVisible('route-plan-error', true);
      }
    }

    btn.addEventListener('click', function () {
      modal.show();
      loadRoutePlan();
    });
  })();
</script>
{% endblock %}

