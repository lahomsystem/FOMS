{% extends "layout.html" %}

{% block content %}
<div class="erp-pro" data-erp-beta-active="{{ 'true' if erp_beta_enabled else 'false' }}"
  data-today-date="{{ today_date }}" data-selected-date="{{ selected_date }}"
  data-manager-filter="{{ manager_filter }}">
  <!-- Modern Header -->
  <header class="erp-pro-header">
    <h1 class="erp-pro-header__title">
      <i class="fas fa-ruler-combined"></i>
      <span>실측 대시보드</span>
    </h1>
    <div class="erp-pro-header__actions">
      <a class="erp-pro-btn erp-pro-btn--secondary" href="{{ url_for('erp_beta.erp_dashboard') }}">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-md-inline">ERP</span>
      </a>
    </div>
  </header>
  {% set erp_sub_nav_active = 'measurement' %}
  {% include 'partials/erp_sub_nav.html' %}

  {% if not erp_beta_enabled %}
  <div class="erp-pro-alert erp-pro-alert--warning">
    <div class="erp-pro-alert__icon"><i class="fas fa-exclamation-triangle"></i></div>
    <div class="erp-pro-alert__content">
      <span>ERP Beta 기능이 비활성입니다. (환경변수 <code>ERP_BETA_ENABLED=true</code> 필요)</span>
    </div>
  </div>
  {% else %}
  <div class="erp-pro-card">
    <div class="erp-pro-card__header erp-pro-card__header--filter">
      <form class="erp-pro-filter-form erp-pro-filter-form--inline-mobile" method="get">
        <div class="erp-pro-filter-group">
          <label class="erp-pro-filter-label">기준 날짜</label>
          <input type="date" class="erp-pro-input" name="date" value="{{ selected_date }}">
        </div>
        <div class="erp-pro-filter-group">
          <label class="erp-pro-filter-label">담당자</label>
          <input type="text" class="erp-pro-input" name="manager" value="{{ manager_filter }}" placeholder="예: 정다슬">
        </div>
        <div class="erp-pro-filter-actions">
          <button class="erp-pro-btn erp-pro-btn--primary" type="submit">
            <i class="fas fa-search"></i>
            <span>조회</span>
          </button>
          <a class="erp-pro-btn erp-pro-btn--secondary"
            href="/erp/measurement?date={{ selected_date }}&manager={{ manager_filter | urlencode }}&open_map=1">
            <i class="fas fa-map"></i>
            <span class="d-none d-sm-inline">지도</span>
          </a>
          <button class="erp-pro-btn erp-pro-btn--outline" type="button" id="btn-route-plan">
            <i class="fas fa-route"></i>
            <span class="d-none d-sm-inline">동선</span>
          </button>
        </div>
      </form>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-xl-2 col-lg-2">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-1 px-2 d-flex justify-content-between align-items-center flex-wrap">
              <div class="fw-bold small"><i class="fas fa-calendar-day"></i> 날짜별 실측</div>
              <div class="d-flex align-items-center gap-1">
                <a href="{{ url_for('erp_beta.erp_measurement_dashboard', date=today_date, manager=manager_filter or '') }}"
                  class="btn btn-sm btn-outline-primary py-0 px-1" title="오늘">오늘</a>
                <span class="badge bg-primary">{{ selected_date }}</span>
              </div>
            </div>
            <div class="card-body p-1">
              <div class="measurement-panel-list">
                {% for item in measurement_panel_dates %}
                {% set day_label = ['월','화','수','목','금','토','일'][item.weekday] %}
                <a id="date-{{ item.date }}"
                  class="measurement-panel-item measurement-panel-item-oneline {% if item.is_selected %}is-selected{% endif %} {% if item.is_weekend %}is-weekend{% endif %} {% if item.is_holiday %}is-holiday{% endif %} {% if item.date == today_date %}is-today{% endif %}"
                  href="{{ url_for('erp_beta.erp_measurement_dashboard', date=item.date, manager=manager_filter or '') }}#date-{{ item.date }}">
                  <div class="d-flex align-items-center justify-content-between gap-1 w-100 flex-nowrap">
                    <span class="measurement-panel-date">{{ item.date }}</span>
                    <span class="measurement-panel-day">({{ day_label }})</span>
                    {% if item.is_holiday %}<span class="badge bg-danger">휴일</span>{% elif item.is_weekend %}<span
                      class="badge bg-warning text-dark">주말</span>{% endif %}
                    <span class="badge badge-count ms-auto">{{ item.count }}</span>
                  </div>
                </a>
                {% endfor %}
              </div>
              <div class="small text-muted mt-1 px-1">60일 기준</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-10 col-lg-10">
          <div class="table-responsive">
            <style>
              .measurement-row {
                border-bottom: 1px solid #e9ecef;
              }

              .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
              }

              .measurement-table {
                min-width: 980px;
                font-size: 0.875rem;
              }

              .measurement-table th,
              .measurement-table td {
                white-space: nowrap;
                font-size: 0.875rem;
              }

              .measurement-table .cell-wrap {
                white-space: normal;
                word-break: break-word;
              }

              .measurement-table .measurement-address-cell {
                font-size: 0.875rem;
                min-width: 280px;
              }

              .measurement-table .measurement-product-cell {
                max-width: 140px;
              }

              /* 모바일: 제품 컬럼 가로 확장 → 행 높이 최소화, 가로 스크롤로 확인 */
              @media (max-width: 768px) {
                .measurement-table .measurement-product-cell {
                  min-width: 240px !important;
                  max-width: none !important;
                }

                .measurement-table {
                  min-width: 100%;
                }
              }

              .manager-cell {
                font-weight: 500;
                text-align: center;
              }

              /* 다른 CSS 오버라이드 방지 */
              .manager-cell[style*="background-color"] {
                color: #000000 !important;
              }

              /* hover 상태에서도 원래 배경색 유지 - Bootstrap table-hover 및 전역 CSS 오버라이드 */
              .table-hover tbody tr:hover .manager-cell,
              .table-hover tbody tr:hover .manager-cell[style*="background-color"],
              .manager-cell[style*="background-color"]:hover,
              tbody tr:hover td.manager-cell,
              tbody tr:hover .manager-cell,
              .table tbody tr:hover .manager-cell,
              div.table-responsive table.table tbody tr:hover td.manager-cell,
              div.table-responsive table.table.table-hover tbody tr:hover td.manager-cell {
                background-color: inherit !important;
                background: inherit !important;
                color: #000000 !important;
              }

              /* 전역 tr:hover 스타일 오버라이드 */
              div.table-responsive table tbody tr:hover td.manager-cell[data-manager-bg-color] {
                background-color: var(--manager-bg-color, inherit) !important;
                background: var(--manager-bg-color, inherit) !important;
                color: #000000 !important;
              }

              .measurement-panel-list {
                max-height: 520px;
                overflow-y: auto;
                padding: 4px;
              }

              .measurement-panel-item {
                display: block;
                padding: 10px 12px;
                border-radius: 10px;
                text-decoration: none;
                color: #212529;
                border: 1px solid #f1f3f5;
                background: #ffffff;
                margin-bottom: 6px;
                transition: all 0.15s ease-in-out;
              }

              .measurement-panel-item-oneline {
                padding: 5px 8px;
                margin-bottom: 4px;
                border-radius: 6px;
              }

              .measurement-panel-item-oneline .measurement-panel-date {
                font-size: 0.85rem;
                white-space: nowrap;
              }

              .measurement-panel-item-oneline .measurement-panel-day {
                font-size: 0.8rem;
                color: #6c757d;
              }

              .measurement-panel-item-oneline .badge-count {
                font-size: 0.85rem;
                min-width: 28px;
                padding: 2px 6px;
              }

              .measurement-panel-item:hover {
                background: #f8f9fa;
                border-color: #dee2e6;
              }

              .measurement-panel-item.is-selected {
                border-color: #0d6efd;
                box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.2);
              }

              .measurement-panel-item.is-weekend {
                background: #fff7e6;
              }

              .measurement-panel-item.is-holiday {
                background: #fff1f1;
              }

              .measurement-panel-item.is-today {
                border-color: #198754;
                box-shadow: 0 0 0 1px rgba(25, 135, 84, 0.25);
              }

              .measurement-panel-item {
                scroll-margin-top: 16px;
              }

              .badge-count {
                background-color: #0d6efd;
                color: #ffffff;
                font-size: 0.95rem;
                min-width: 42px;
                text-align: center;
                padding: 6px 10px;
              }

              .btn-measure-action {
                font-size: 0.95rem;
                padding: 6px 12px;
              }

              .measurement-filter-row .btn {
                height: 38px;
              }

              .measurement-filter-actions {
                align-self: flex-end;
                padding-top: 24px;
              }

              .measurement-filter-row .form-label {
                min-height: 18px;
                line-height: 1;
                margin-bottom: 6px;
              }

              .measurement-filter-row .form-control,
              .measurement-filter-row .btn {
                height: 38px;
              }

              @media (max-width: 768px) {
                .card-header .row.g-2:not(.measurement-filter-row)>[class^="col-"] {
                  width: 100%;
                  max-width: 100%;
                  flex: 0 0 100%;
                }

                .measurement-filter-row>.col-6 {
                  width: 50%;
                  max-width: 50%;
                  flex: 0 0 50%;
                }

                .card-header .row.g-2 .d-flex {
                  flex-wrap: wrap;
                  gap: 8px;
                }

                .card-header .row.g-2 .d-flex .btn {
                  flex: 1 1 auto;
                  min-width: 140px;
                }

                .measurement-panel-list {
                  max-height: 240px;
                }
              }
            </style>
            <table class="table table-sm table-hover align-middle measurement-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 70px; border-right: 1px solid #e0e0e0;">상세</th>
                  <th style="width: 120px; border-right: 1px solid #e0e0e0;">고객</th>
                  <th style="width: 120px; border-right: 1px solid #e0e0e0;">발주사</th>
                  <th style="border-right: 1px solid #e0e0e0;">주소</th>
                  <th style="width: 120px; border-right: 1px solid #e0e0e0;">전화번호</th>
                  <th style="width: 90px; border-right: 1px solid #e0e0e0;">시간</th>
                  <th class="measurement-product-cell" style="max-width: 140px; border-right: 1px solid #e0e0e0;">제품
                  </th>
                  <th style="width: 120px;">담당자</th>
                </tr>
              </thead>
              <tbody>
                {% if rows %}
                {# 담당자 목록 수집 및 색상 할당 (검정 글자가 잘 보이는 밝은 원색) #}
                {% set manager_list = [] %}
                {% set color_list = ['#FF0000', '#0080FF', '#FFFF00', '#00FF00', '#FF00FF', '#00FFFF', '#FF8000',
                '#FF1493', '#00FF80', '#FF69B4'] %}
                {% for r in rows %}
                {% set temp_manager = r.manager_name %}
                {% if r.is_erp_beta and r.structured_data and r.structured_data.parties and
                r.structured_data.parties.manager and r.structured_data.parties.manager.name %}
                {% set temp_manager = r.structured_data.parties.manager.name %}
                {% endif %}
                {% set temp_manager = (temp_manager or '')|trim %}
                {% if temp_manager and temp_manager not in manager_list %}
                {% set _ = manager_list.append(temp_manager) %}
                {% endif %}
                {% endfor %}

                {% for r in rows %}
                {% set customer = r.customer_name %}
                {% set orderer = r.orderer_name or '-' %}
                {% set address = r.address %}
                {% set phone = r.phone %}
                {% set meas_time = r.measurement_time %}
                {% set product = r.product %}
                {% set manager = r.manager_name %}

                {# 담당자 색상 결정 (manager 변수가 최종 설정된 후) #}
                {% set manager_key = (manager or '')|trim %}
                {% set manager_index = -1 %}
                {% for m in manager_list %}
                {% if m == manager_key %}
                {% set manager_index = loop.index0 %}
                {% endif %}
                {% endfor %}
                {% if manager_index >= 0 %}
                {% set manager_bg_color = color_list[manager_index % color_list|length] %}
                {% else %}
                {% set manager_bg_color = '#CCCCCC' %}
                {% endif %}

                {# 배경색에 따라 텍스트 색상 자동 결정 #}
                {% set text_color = '#000000' %}

                <tr data-order-id="{{ r.id }}" data-is-erp-beta="{{ 'true' if r.is_erp_beta else 'false' }}"
                  data-manager="{{ manager or '' }}" class="measurement-row">
                  <td class="text-center" style="border-right: 1px solid #e0e0e0;">
                    <a href="{{ url_for('edit_order', order_id=r.id, return_to='erp_measurement_dashboard') }}?open=erp-beta"
                      class="btn btn-sm btn-outline-primary" title="주문 상세">
                      <i class="fas fa-edit"></i>
                    </a>
                  </td>
                  <td style="border-right: 1px solid #e0e0e0;">{{ customer or '-' }}</td>
                  <td style="border-right: 1px solid #e0e0e0;">{{ orderer or '-' }}</td>
                  <td class="editable-cell cell-wrap measurement-address-cell" data-field="address"
                    style="border-right: 1px solid #e0e0e0;">{{ address or '-' }}</td>
                  <td class="editable-cell" data-field="phone" style="border-right: 1px solid #e0e0e0;">{{
                    phone|format_phone }}</td>
                  <td style="border-right: 1px solid #e0e0e0;">{{ meas_time or '-' }}</td>
                  <td class="cell-wrap measurement-product-cell" style="border-right: 1px solid #e0e0e0;">{{ (product or
                    '-')|strip_product_w or '-' }}</td>
                  <td class="editable-cell manager-cell" data-field="manager"
                    style="background-color: {{ manager_bg_color }}; color: {{ text_color }};">
                    {{ manager or '-' }}
                  </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">데이터가 없습니다.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div><!-- end erp-pro -->

<!-- 동선 추천 모달 -->
<div class="modal fade" id="routePlanModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-route"></i> 동선 추천 (MVP)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-2" id="route-plan-meta"></div>
        <div id="route-plan-loading" class="py-4 text-center text-muted" style="display:none;">
          <i class="fas fa-spinner fa-spin"></i> 계산 중...
        </div>
        <div id="route-plan-error" class="alert alert-danger" style="display:none;"></div>
        <div id="route-plan-result" style="display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">추천 방문 순서</div>
            <div class="small text-muted" id="route-plan-distance"></div>
          </div>
          <ol class="mb-0" id="route-plan-list"></ol>
          <div class="small text-muted mt-2" id="route-plan-note"></div>
        </div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-secondary" href="/map_view?date={{ selected_date }}&status=MEASURED" target="_blank">
          <i class="fas fa-map-marked-alt"></i> 지도(핀) 보기
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> 닫기
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/erp/common_utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/erp/measurement.js') }}"></script>
{% endblock %}